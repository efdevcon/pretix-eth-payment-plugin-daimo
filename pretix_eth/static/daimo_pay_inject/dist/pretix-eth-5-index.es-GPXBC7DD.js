import{a as sr,b as Ro,c as pl,d as No,e as Us,f as ar,g as qo,h as Zt,i as qe,j as Ie,k as Do,l as jt,m as Lt,n as Fo,o as Uo,p as jo}from"./pretix-eth-5-chunk-U6NSFY34.js";import{a as or,b as Co,c as es,d as $t,e as Oe,f as me,g as ko,i as mt,j as Rt,k as nt,l as Mt,m as ui,p as ks,q as js,r as Je,s as Ve,t as cr,u as xe,v as De}from"./pretix-eth-5-chunk-MCYRL7OX.js";import{a as ir,b as rr,c as xo,d as nr,e as To,f as Ao}from"./pretix-eth-5-chunk-AMQZMTA7.js";import"./pretix-eth-5-chunk-OWY5K5LW.js";import{a as Oo}from"./pretix-eth-5-chunk-OKFWZUDU.js";import"./pretix-eth-5-chunk-AHVGFHZN.js";import"./pretix-eth-5-chunk-RYOKWQSX.js";import"./pretix-eth-5-chunk-E4YN6HJG.js";import{a as Fs}from"./pretix-eth-5-chunk-64QJEAS7.js";import{f as Ye}from"./pretix-eth-5-chunk-BIK4PATU.js";var cl=Ye(Fs());var Et=Ye(sr()),Ze=Ye(Ro()),Ia=Ye(pl());function Lo(s){let e=To(`0x${s.substring(4)}`).substring(26);return Ao(`0x${e}`)}async function Mo({hash:s,signature:e}){let t=ir(s)?s:nr(s),{secp256k1:i}=await import("./pretix-eth-5-secp256k1-SN7RLBBU.js");return`0x${(()=>{if(typeof e=="object"&&"r"in e&&"s"in e){let{r:h,s:l,v:p,yParity:u}=e,d=Number(u??p),g=$o(d);return new i.Signature(rr(h),rr(l)).addRecoveryBit(g)}let o=ir(e)?e:nr(e),a=xo(`0x${o.slice(130)}`),c=$o(a);return i.Signature.fromCompact(o.substring(2,130)).addRecoveryBit(c)})().recoverPublicKey(t.substring(2)).toHex(!1)}`}function $o(s){if(s===0||s===1)return s;if(s===27)return 0;if(s===28)return 1;throw new Error("Invalid yParityOrV value")}async function hr({hash:s,signature:e}){return Lo(await Mo({hash:s,signature:e}))}function ul(s){if(s.length>=255)throw new TypeError("Alphabet too long");let e=new Uint8Array(256);for(let h=0;h<e.length;h++)e[h]=255;for(let h=0;h<s.length;h++){let l=s.charAt(h),p=l.charCodeAt(0);if(e[p]!==255)throw new TypeError(l+" is ambiguous");e[p]=h}let t=s.length,i=s.charAt(0),r=Math.log(t)/Math.log(256),n=Math.log(256)/Math.log(t);function o(h){if(h instanceof Uint8Array||(ArrayBuffer.isView(h)?h=new Uint8Array(h.buffer,h.byteOffset,h.byteLength):Array.isArray(h)&&(h=Uint8Array.from(h))),!(h instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(h.length===0)return"";let l=0,p=0,u=0,d=h.length;for(;u!==d&&h[u]===0;)u++,l++;let g=(d-u)*n+1>>>0,y=new Uint8Array(g);for(;u!==d;){let m=h[u],b=0;for(let _=g-1;(m!==0||b<p)&&_!==-1;_--,b++)m+=256*y[_]>>>0,y[_]=m%t>>>0,m=m/t>>>0;if(m!==0)throw new Error("Non-zero carry");p=b,u++}let f=g-p;for(;f!==g&&y[f]===0;)f++;let w=i.repeat(l);for(;f<g;++f)w+=s.charAt(y[f]);return w}function a(h){if(typeof h!="string")throw new TypeError("Expected String");if(h.length===0)return new Uint8Array;let l=0,p=0,u=0;for(;h[l]===i;)p++,l++;let d=(h.length-l)*r+1>>>0,g=new Uint8Array(d);for(;l<h.length;){let m=h.charCodeAt(l);if(m>255)return;let b=e[m];if(b===255)return;let _=0;for(let T=d-1;(b!==0||_<u)&&T!==-1;T--,_++)b+=t*g[T]>>>0,g[T]=b%256>>>0,b=b/256>>>0;if(b!==0)throw new Error("Non-zero carry");u=_,l++}let y=d-u;for(;y!==d&&g[y]===0;)y++;let f=new Uint8Array(p+(d-y)),w=p;for(;y!==d;)f[w++]=g[y++];return f}function c(h){let l=a(h);if(l)return l;throw new Error("Non-base"+t+" character")}return{encode:o,decodeUnsafe:a,decode:c}}var Bo=ul;var dl="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz",Vo=Bo(dl);var gl=":";function qt(s){let[e,t]=s.split(gl);return{namespace:e,reference:t}}function Dr(s,e=[]){let t=[];return Object.keys(s).forEach(i=>{if(e.length&&!e.includes(i))return;let r=s[i];t.push(...r.accounts)}),t}function _a(s,e){return s.includes(":")?[s]:e.chains||[]}var fl=Object.defineProperty,ml=Object.defineProperties,yl=Object.getOwnPropertyDescriptors,zo=Object.getOwnPropertySymbols,wl=Object.prototype.hasOwnProperty,bl=Object.prototype.propertyIsEnumerable,Ho=(s,e,t)=>e in s?fl(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ko=(s,e)=>{for(var t in e||(e={}))wl.call(e,t)&&Ho(s,t,e[t]);if(zo)for(var t of zo(e))bl.call(e,t)&&Ho(s,t,e[t]);return s},vl=(s,e)=>ml(s,yl(e)),El="ReactNative",Ae={reactNative:"react-native",node:"node",browser:"browser",unknown:"unknown"};var Il="js";function Ks(){return typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"}function It(){return!(0,Ze.getDocument)()&&!!(0,Ze.getNavigator)()&&navigator.product===El}function Pa(){return It()&&typeof global<"u"&&typeof(global==null?void 0:global.Platform)<"u"&&(global==null?void 0:global.Platform.OS)==="android"}function Sa(){return It()&&typeof global<"u"&&typeof(global==null?void 0:global.Platform)<"u"&&(global==null?void 0:global.Platform.OS)==="ios"}function Gt(){return!Ks()&&!!(0,Ze.getNavigator)()&&!!(0,Ze.getDocument)()}function Gs(){return It()?Ae.reactNative:Ks()?Ae.node:Gt()?Ae.browser:Ae.unknown}function Fr(){var s;try{return It()&&typeof global<"u"&&typeof(global==null?void 0:global.Application)<"u"?(s=global.Application)==null?void 0:s.applicationId:void 0}catch{return}}function _l(s,e){let t=new URLSearchParams(s);for(let i of Object.keys(e).sort())if(e.hasOwnProperty(i)){let r=e[i];r!==void 0&&t.set(i,r)}return t.toString()}function Oa(s){var e,t;let i=Ur();try{return s!=null&&s.url&&i.url&&new URL(s.url).host!==new URL(i.url).host&&(console.warn(`The configured WalletConnect 'metadata.url':${s.url} differs from the actual page url:${i.url}. This is probably unintended and can lead to issues.`),s.url=i.url),(e=s?.icons)!=null&&e.length&&s.icons.length>0&&(s.icons=s.icons.filter(r=>r!=="")),vl(Ko(Ko({},i),s),{url:s?.url||i.url,name:s?.name||i.name,description:s?.description||i.description,icons:(t=s?.icons)!=null&&t.length&&s.icons.length>0?s.icons:i.icons})}catch(r){return console.warn("Error populating app metadata",r),s||i}}function Ur(){return(0,Ia.getWindowMetadata)()||{name:"",description:"",url:"",icons:[""]}}function Pl(){if(Gs()===Ae.reactNative&&typeof global<"u"&&typeof(global==null?void 0:global.Platform)<"u"){let{OS:t,Version:i}=global.Platform;return[t,i].join("-")}let s=Oo();if(s===null)return"unknown";let e=s.os?s.os.replace(" ","").toLowerCase():"unknown";return s.type==="browser"?[e,s.name,s.version].join("-"):[e,s.version].join("-")}function Sl(){var s;let e=Gs();return e===Ae.browser?[e,((s=(0,Ze.getLocation)())==null?void 0:s.host)||"unknown"].join(":"):e}function kr(s,e,t){let i=Pl(),r=Sl();return[[s,e].join("-"),[Il,t].join("-"),i,r].join("/")}function Ra({protocol:s,version:e,relayUrl:t,sdkVersion:i,auth:r,projectId:n,useOnCloseEvent:o,bundleId:a,packageName:c}){let h=t.split("?"),l=kr(s,e,i),p={auth:r,ua:l,projectId:n,useOnCloseEvent:o||void 0,packageName:c||void 0,bundleId:a||void 0},u=_l(h[1]||"",p);return h[0]+"?"+u}function Vt(s,e){return s.filter(t=>e.includes(t)).length===s.length}function wi(s){return Object.fromEntries(s.entries())}function bi(s){return new Map(Object.entries(s))}function _t(s=Et.FIVE_MINUTES,e){let t=(0,Et.toMiliseconds)(s||Et.FIVE_MINUTES),i,r,n,o;return{resolve:a=>{n&&i&&(clearTimeout(n),i(a),o=Promise.resolve(a))},reject:a=>{n&&r&&(clearTimeout(n),r(a))},done:()=>new Promise((a,c)=>{if(o)return a(o);n=setTimeout(()=>{let h=new Error(e);o=Promise.reject(h),c(h)},t),i=a,r=c})}}function Pt(s,e,t){return new Promise(async(i,r)=>{let n=setTimeout(()=>r(new Error(t)),e);try{let o=await s;i(o)}catch(o){r(o)}clearTimeout(n)})}function xa(s,e){if(typeof e=="string"&&e.startsWith(`${s}:`))return e;if(s.toLowerCase()==="topic"){if(typeof e!="string")throw new Error('Value must be "string" for expirer target type: topic');return`topic:${e}`}else if(s.toLowerCase()==="id"){if(typeof e!="number")throw new Error('Value must be "number" for expirer target type: id');return`id:${e}`}throw new Error(`Unknown expirer target type: ${s}`)}function Ta(s){return xa("topic",s)}function Aa(s){return xa("id",s)}function vi(s){let[e,t]=s.split(":"),i={id:void 0,topic:void 0};if(e==="topic"&&typeof t=="string")i.topic=t;else if(e==="id"&&Number.isInteger(Number(t)))i.id=Number(t);else throw new Error(`Invalid target, expected id:number or topic:string, got ${e}:${t}`);return i}function re(s,e){return(0,Et.fromMiliseconds)((e||Date.now())+(0,Et.toMiliseconds)(s))}function at(s){return Date.now()>=(0,Et.toMiliseconds)(s)}function G(s,e){return`${s}${e?`:${e}`:""}`}function Xe(s=[],e=[]){return[...new Set([...s,...e])]}async function Ca({id:s,topic:e,wcDeepLink:t}){var i;try{if(!t)return;let r=typeof t=="string"?JSON.parse(t):t,n=r?.href;if(typeof n!="string")return;let o=Ol(n,s,e),a=Gs();if(a===Ae.browser){if(!((i=(0,Ze.getDocument)())!=null&&i.hasFocus())){console.warn("Document does not have focus, skipping deeplink.");return}Rl(o)}else a===Ae.reactNative&&typeof(global==null?void 0:global.Linking)<"u"&&await global.Linking.openURL(o)}catch(r){console.error(r)}}function Ol(s,e,t){let i=`requestId=${e}&sessionTopic=${t}`;s.endsWith("/")&&(s=s.slice(0,-1));let r=`${s}`;if(s.startsWith("https://t.me")){let n=s.includes("?")?"&startapp=":"?startapp=";r=`${r}${n}${Al(i,!0)}`}else r=`${r}/wc?${i}`;return r}function Rl(s){let e="_self";Tl()?e="_top":(xl()||s.startsWith("https://")||s.startsWith("http://"))&&(e="_blank"),window.open(s,e,"noreferrer noopener")}async function Na(s,e){let t="";try{if(Gt()&&(t=localStorage.getItem(e),t))return t;t=await s.getItem(e)}catch(i){console.error(i)}return t}function jr(s,e){if(!s.includes(e))return null;let t=s.split(/([&,?,=])/),i=t.indexOf(e);return t[i+2]}function Lr(){return typeof crypto<"u"&&crypto!=null&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/gu,s=>{let e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)})}function Ws(){return typeof process<"u"&&process.env.IS_VITEST==="true"}function xl(){return typeof window<"u"&&(!!window.TelegramWebviewProxy||!!window.Telegram||!!window.TelegramWebviewProxyProto)}function Tl(){try{return window.self!==window.top}catch{return!1}}function Al(s,e=!1){let t=Buffer.from(s).toString("base64");return e?t.replace(/[=]/g,""):t}function qa(s){return Buffer.from(s,"base64").toString("utf-8")}function Da(s){return new Promise(e=>setTimeout(e,s))}function Ms(s){if(!Number.isSafeInteger(s)||s<0)throw new Error("positive integer expected, got "+s)}function Cl(s){return s instanceof Uint8Array||ArrayBuffer.isView(s)&&s.constructor.name==="Uint8Array"}function Ys(s,...e){if(!Cl(s))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(s.length))throw new Error("Uint8Array expected of length "+e+", got length="+s.length)}function $r(s){if(typeof s!="function"||typeof s.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");Ms(s.outputLen),Ms(s.blockLen)}function rs(s,e=!0){if(s.destroyed)throw new Error("Hash instance has been destroyed");if(e&&s.finished)throw new Error("Hash#digest() has already been called")}function Fa(s,e){Ys(s);let t=e.outputLen;if(s.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}var di=BigInt(2**32-1),Go=BigInt(32);function Nl(s,e=!1){return e?{h:Number(s&di),l:Number(s>>Go&di)}:{h:Number(s>>Go&di)|0,l:Number(s&di)|0}}function ql(s,e=!1){let t=new Uint32Array(s.length),i=new Uint32Array(s.length);for(let r=0;r<s.length;r++){let{h:n,l:o}=Nl(s[r],e);[t[r],i[r]]=[n,o]}return[t,i]}var Dl=(s,e,t)=>s<<t|e>>>32-t,Fl=(s,e,t)=>e<<t|s>>>32-t,Ul=(s,e,t)=>e<<t-32|s>>>64-t,kl=(s,e,t)=>s<<t-32|e>>>64-t,ts=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;function jl(s){return new Uint32Array(s.buffer,s.byteOffset,Math.floor(s.byteLength/4))}function lr(s){return new DataView(s.buffer,s.byteOffset,s.byteLength)}function ot(s,e){return s<<32-e|s>>>e}var Wo=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function Ll(s){return s<<24&4278190080|s<<8&16711680|s>>>8&65280|s>>>24&255}function Yo(s){for(let e=0;e<s.length;e++)s[e]=Ll(s[e])}function $l(s){if(typeof s!="string")throw new Error("utf8ToBytes expected string, got "+typeof s);return new Uint8Array(new TextEncoder().encode(s))}function ns(s){return typeof s=="string"&&(s=$l(s)),Ys(s),s}function Ml(...s){let e=0;for(let i=0;i<s.length;i++){let r=s[i];Ys(r),e+=r.length}let t=new Uint8Array(e);for(let i=0,r=0;i<s.length;i++){let n=s[i];t.set(n,r),r+=n.length}return t}var Bs=class{clone(){return this._cloneInto()}};function Ua(s){let e=i=>s().update(ns(i)).digest(),t=s();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>s(),e}function ps(s=32){if(ts&&typeof ts.getRandomValues=="function")return ts.getRandomValues(new Uint8Array(s));if(ts&&typeof ts.randomBytes=="function")return ts.randomBytes(s);throw new Error("crypto.getRandomValues must be defined")}var ka=[],ja=[],La=[],Bl=BigInt(0),Ls=BigInt(1),Vl=BigInt(2),zl=BigInt(7),Hl=BigInt(256),Kl=BigInt(113);for(let s=0,e=Ls,t=1,i=0;s<24;s++){[t,i]=[i,(2*t+3*i)%5],ka.push(2*(5*i+t)),ja.push((s+1)*(s+2)/2%64);let r=Bl;for(let n=0;n<7;n++)e=(e<<Ls^(e>>zl)*Kl)%Hl,e&Vl&&(r^=Ls<<(Ls<<BigInt(n))-Ls);La.push(r)}var[Gl,Wl]=ql(La,!0),Jo=(s,e,t)=>t>32?Ul(s,e,t):Dl(s,e,t),Qo=(s,e,t)=>t>32?kl(s,e,t):Fl(s,e,t);function Yl(s,e=24){let t=new Uint32Array(10);for(let i=24-e;i<24;i++){for(let o=0;o<10;o++)t[o]=s[o]^s[o+10]^s[o+20]^s[o+30]^s[o+40];for(let o=0;o<10;o+=2){let a=(o+8)%10,c=(o+2)%10,h=t[c],l=t[c+1],p=Jo(h,l,1)^t[a],u=Qo(h,l,1)^t[a+1];for(let d=0;d<50;d+=10)s[o+d]^=p,s[o+d+1]^=u}let r=s[2],n=s[3];for(let o=0;o<24;o++){let a=ja[o],c=Jo(r,n,a),h=Qo(r,n,a),l=ka[o];r=s[l],n=s[l+1],s[l]=c,s[l+1]=h}for(let o=0;o<50;o+=10){for(let a=0;a<10;a++)t[a]=s[o+a];for(let a=0;a<10;a++)s[o+a]^=~t[(a+2)%10]&t[(a+4)%10]}s[0]^=Gl[i],s[1]^=Wl[i]}t.fill(0)}var Er=class s extends Bs{constructor(e,t,i,r=!1,n=24){if(super(),this.blockLen=e,this.suffix=t,this.outputLen=i,this.enableXOF=r,this.rounds=n,this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,Ms(i),0>=this.blockLen||this.blockLen>=200)throw new Error("Sha3 supports only keccak-f1600 function");this.state=new Uint8Array(200),this.state32=jl(this.state)}keccak(){Wo||Yo(this.state32),Yl(this.state32,this.rounds),Wo||Yo(this.state32),this.posOut=0,this.pos=0}update(e){rs(this);let{blockLen:t,state:i}=this;e=ns(e);let r=e.length;for(let n=0;n<r;){let o=Math.min(t-this.pos,r-n);for(let a=0;a<o;a++)i[this.pos++]^=e[n++];this.pos===t&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;let{state:e,suffix:t,pos:i,blockLen:r}=this;e[i]^=t,t&128&&i===r-1&&this.keccak(),e[r-1]^=128,this.keccak()}writeInto(e){rs(this,!1),Ys(e),this.finish();let t=this.state,{blockLen:i}=this;for(let r=0,n=e.length;r<n;){this.posOut>=i&&this.keccak();let o=Math.min(i-this.posOut,n-r);e.set(t.subarray(this.posOut,this.posOut+o),r),this.posOut+=o,r+=o}return e}xofInto(e){if(!this.enableXOF)throw new Error("XOF is not possible for this instance");return this.writeInto(e)}xof(e){return Ms(e),this.xofInto(new Uint8Array(e))}digestInto(e){if(Fa(e,this),this.finished)throw new Error("digest() was already called");return this.writeInto(e),this.destroy(),e}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,this.state.fill(0)}_cloneInto(e){let{blockLen:t,suffix:i,outputLen:r,rounds:n,enableXOF:o}=this;return e||(e=new s(t,i,r,o,n)),e.state32.set(this.state32),e.pos=this.pos,e.posOut=this.posOut,e.finished=this.finished,e.rounds=n,e.suffix=i,e.outputLen=r,e.enableXOF=o,e.destroyed=this.destroyed,e}},Jl=(s,e,t)=>Ua(()=>new Er(e,s,t)),Ql=Jl(1,136,256/8),Xl="https://rpc.walletconnect.org/v1";function $a(s){let e=`Ethereum Signed Message:
${s.length}`,t=new TextEncoder().encode(e+s);return"0x"+Buffer.from(Ql(t)).toString("hex")}async function Zl(s,e,t,i,r,n){switch(t.t){case"eip191":return await ep(s,e,t.s);case"eip1271":return await tp(s,e,t.s,i,r,n);default:throw new Error(`verifySignature failed: Attempted to verify CacaoSignature with unknown type: ${t.t}`)}}async function ep(s,e,t){return(await hr({hash:$a(e),signature:t})).toLowerCase()===s.toLowerCase()}async function tp(s,e,t,i,r,n){let o=qt(i);if(!o.namespace||!o.reference)throw new Error(`isValidEip1271Signature failed: chainId must be in CAIP-2 format, received: ${i}`);try{let a="0x1626ba7e",c="0000000000000000000000000000000000000000000000000000000000000040",h="0000000000000000000000000000000000000000000000000000000000000041",l=t.substring(2),p=$a(e).substring(2),u=a+p+c+h+l,d=await fetch(`${n||Xl}/?chainId=${i}&projectId=${r}`,{method:"POST",body:JSON.stringify({id:sp(),jsonrpc:"2.0",method:"eth_call",params:[{to:s,data:u},"latest"]})}),{result:g}=await d.json();return g?g.slice(0,a.length).toLowerCase()===a.toLowerCase():!1}catch(a){return console.error("isValidEip1271Signature: ",a),!1}}function sp(){return Date.now()+Math.floor(Math.random()*1e3)}function Ma(s){let e=atob(s),t=new Uint8Array(e.length);for(let o=0;o<e.length;o++)t[o]=e.charCodeAt(o);let i=t[0];if(i===0)throw new Error("No signatures found");let r=1+i*64;if(t.length<r)throw new Error("Transaction data too short for claimed signature count");if(t.length<100)throw new Error("Transaction too short");let n=Buffer.from(s,"base64").slice(1,65);return Vo.encode(n)}var ip=Object.defineProperty,rp=Object.defineProperties,np=Object.getOwnPropertyDescriptors,Xo=Object.getOwnPropertySymbols,op=Object.prototype.hasOwnProperty,ap=Object.prototype.propertyIsEnumerable,Zo=(s,e,t)=>e in s?ip(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,cp=(s,e)=>{for(var t in e||(e={}))op.call(e,t)&&Zo(s,t,e[t]);if(Xo)for(var t of Xo(e))ap.call(e,t)&&Zo(s,t,e[t]);return s},hp=(s,e)=>rp(s,np(e)),lp="did:pkh:",Mr=s=>s?.split(":"),pp=s=>{let e=s&&Mr(s);if(e)return s.includes(lp)?e[3]:e[1]},Ei=s=>{let e=s&&Mr(s);if(e)return e[2]+":"+e[3]},Js=s=>{let e=s&&Mr(s);if(e)return e.pop()};async function Br(s){let{cacao:e,projectId:t}=s,{s:i,p:r}=e,n=Vr(r,r.iss),o=Js(r.iss);return await Zl(o,n,i,Ei(r.iss),t)}var Vr=(s,e)=>{let t=`${s.domain} wants you to sign in with your Ethereum account:`,i=Js(e);if(!s.aud&&!s.uri)throw new Error("Either `aud` or `uri` is required to construct the message");let r=s.statement||void 0,n=`URI: ${s.aud||s.uri}`,o=`Version: ${s.version}`,a=`Chain ID: ${pp(e)}`,c=`Nonce: ${s.nonce}`,h=`Issued At: ${s.iat}`,l=s.exp?`Expiration Time: ${s.exp}`:void 0,p=s.nbf?`Not Before: ${s.nbf}`:void 0,u=s.requestId?`Request ID: ${s.requestId}`:void 0,d=s.resources?`Resources:${s.resources.map(y=>`
- ${y}`).join("")}`:void 0,g=Qs(s.resources);if(g){let y=Vs(g);r=wp(r,y)}return[t,i,"",r,"",n,o,a,c,h,l,p,u,d].filter(y=>y!=null).join(`
`)};function up(s){return Buffer.from(JSON.stringify(s)).toString("base64")}function dp(s){return JSON.parse(Buffer.from(s,"base64").toString("utf-8"))}function Ht(s){if(!s)throw new Error("No recap provided, value is undefined");if(!s.att)throw new Error("No `att` property found");let e=Object.keys(s.att);if(!(e!=null&&e.length))throw new Error("No resources found in `att` property");e.forEach(t=>{let i=s.att[t];if(Array.isArray(i))throw new Error(`Resource must be an object: ${t}`);if(typeof i!="object")throw new Error(`Resource must be an object: ${t}`);if(!Object.keys(i).length)throw new Error(`Resource object is empty: ${t}`);Object.keys(i).forEach(r=>{let n=i[r];if(!Array.isArray(n))throw new Error(`Ability limits ${r} must be an array of objects, found: ${n}`);if(!n.length)throw new Error(`Value of ${r} is empty array, must be an array with objects`);n.forEach(o=>{if(typeof o!="object")throw new Error(`Ability limits (${r}) must be an array of objects, found: ${o}`)})})})}function gp(s,e,t,i={}){return t?.sort((r,n)=>r.localeCompare(n)),{att:{[s]:fp(e,t,i)}}}function fp(s,e,t={}){e=e?.sort((r,n)=>r.localeCompare(n));let i=e.map(r=>({[`${s}/${r}`]:[t]}));return Object.assign({},...i)}function Ba(s){return Ht(s),`urn:recap:${up(s).replace(/=/g,"")}`}function Vs(s){let e=dp(s.replace("urn:recap:",""));return Ht(e),e}function Va(s,e,t){let i=gp(s,e,t);return Ba(i)}function mp(s){return s&&s.includes("urn:recap:")}function za(s,e){let t=Vs(s),i=Vs(e),r=yp(t,i);return Ba(r)}function yp(s,e){Ht(s),Ht(e);let t=Object.keys(s.att).concat(Object.keys(e.att)).sort((r,n)=>r.localeCompare(n)),i={att:{}};return t.forEach(r=>{var n,o;Object.keys(((n=s.att)==null?void 0:n[r])||{}).concat(Object.keys(((o=e.att)==null?void 0:o[r])||{})).sort((a,c)=>a.localeCompare(c)).forEach(a=>{var c,h;i.att[r]=hp(cp({},i.att[r]),{[a]:((c=s.att[r])==null?void 0:c[a])||((h=e.att[r])==null?void 0:h[a])})})}),i}function wp(s="",e){Ht(e);let t="I further authorize the stated URI to perform the following actions on my behalf: ";if(s.includes(t))return s;let i=[],r=0;Object.keys(e.att).forEach(a=>{let c=Object.keys(e.att[a]).map(p=>({ability:p.split("/")[0],action:p.split("/")[1]}));c.sort((p,u)=>p.action.localeCompare(u.action));let h={};c.forEach(p=>{h[p.ability]||(h[p.ability]=[]),h[p.ability].push(p.action)});let l=Object.keys(h).map(p=>(r++,`(${r}) '${p}': '${h[p].join("', '")}' for '${a}'.`));i.push(l.join(", ").replace(".,","."))});let n=i.join(" "),o=`${t}${n}`;return`${s?s+" ":""}${o}`}function zr(s){var e;let t=Vs(s);Ht(t);let i=(e=t.att)==null?void 0:e.eip155;return i?Object.keys(i).map(r=>r.split("/")[1]):[]}function Hr(s){let e=Vs(s);Ht(e);let t=[];return Object.values(e.att).forEach(i=>{Object.values(i).forEach(r=>{var n;(n=r?.[0])!=null&&n.chains&&t.push(r[0].chains)})}),[...new Set(t.flat())]}function Qs(s){if(!s)return;let e=s?.[s.length-1];return mp(e)?e:void 0}function pr(s){if(!Number.isSafeInteger(s)||s<0)throw new Error("positive integer expected, got "+s)}function Ha(s){return s instanceof Uint8Array||ArrayBuffer.isView(s)&&s.constructor.name==="Uint8Array"}function Ue(s,...e){if(!Ha(s))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(s.length))throw new Error("Uint8Array expected of length "+e+", got length="+s.length)}function ea(s,e=!0){if(s.destroyed)throw new Error("Hash instance has been destroyed");if(e&&s.finished)throw new Error("Hash#digest() has already been called")}function bp(s,e){Ue(s);let t=e.outputLen;if(s.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function ta(s){if(typeof s!="boolean")throw new Error(`boolean expected, not ${s}`)}var At=s=>new Uint32Array(s.buffer,s.byteOffset,Math.floor(s.byteLength/4)),vp=s=>new DataView(s.buffer,s.byteOffset,s.byteLength),Ep=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!Ep)throw new Error("Non little-endian hardware is not supported");function Ip(s){if(typeof s!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(s))}function Ir(s){if(typeof s=="string")s=Ip(s);else if(Ha(s))s=_r(s);else throw new Error("Uint8Array expected, got "+typeof s);return s}function _p(s,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(s,e)}function Pp(s,e){if(s.length!==e.length)return!1;let t=0;for(let i=0;i<s.length;i++)t|=s[i]^e[i];return t===0}var Sp=(s,e)=>{function t(i,...r){if(Ue(i),s.nonceLength!==void 0){let h=r[0];if(!h)throw new Error("nonce / iv required");s.varSizeNonce?Ue(h):Ue(h,s.nonceLength)}let n=s.tagLength;n&&r[1]!==void 0&&Ue(r[1]);let o=e(i,...r),a=(h,l)=>{if(l!==void 0){if(h!==2)throw new Error("cipher output not supported");Ue(l)}},c=!1;return{encrypt(h,l){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,Ue(h),a(o.encrypt.length,l),o.encrypt(h,l)},decrypt(h,l){if(Ue(h),n&&h.length<n)throw new Error("invalid ciphertext length: smaller than tagLength="+n);return a(o.decrypt.length,l),o.decrypt(h,l)}}}return Object.assign(t,s),t};function sa(s,e,t=!0){if(e===void 0)return new Uint8Array(s);if(e.length!==s)throw new Error("invalid output length, expected "+s+", got: "+e.length);if(t&&!Op(e))throw new Error("invalid output, must be aligned");return e}function ia(s,e,t,i){if(typeof s.setBigUint64=="function")return s.setBigUint64(e,t,i);let r=BigInt(32),n=BigInt(4294967295),o=Number(t>>r&n),a=Number(t&n),c=i?4:0,h=i?0:4;s.setUint32(e+c,o,i),s.setUint32(e+h,a,i)}function Op(s){return s.byteOffset%4===0}function _r(s){return Uint8Array.from(s)}function os(...s){for(let e=0;e<s.length;e++)s[e].fill(0)}var Ka=s=>Uint8Array.from(s.split("").map(e=>e.charCodeAt(0))),Rp=Ka("expand 16-byte k"),xp=Ka("expand 32-byte k"),Tp=At(Rp),Ap=At(xp);function K(s,e){return s<<e|s>>>32-e}function Pr(s){return s.byteOffset%4===0}var gi=64,Cp=16,Ga=2**32-1,ra=new Uint32Array;function Np(s,e,t,i,r,n,o,a){let c=r.length,h=new Uint8Array(gi),l=At(h),p=Pr(r)&&Pr(n),u=p?At(r):ra,d=p?At(n):ra;for(let g=0;g<c;o++){if(s(e,t,i,l,o,a),o>=Ga)throw new Error("arx: counter overflow");let y=Math.min(gi,c-g);if(p&&y===gi){let f=g/4;if(g%4!==0)throw new Error("arx: invalid block position");for(let w=0,m;w<Cp;w++)m=f+w,d[m]=u[m]^l[w];g+=gi;continue}for(let f=0,w;f<y;f++)w=g+f,n[w]=r[w]^h[f];g+=y}}function qp(s,e){let{allowShortKeys:t,extendNonceFn:i,counterLength:r,counterRight:n,rounds:o}=_p({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof s!="function")throw new Error("core must be a function");return pr(r),pr(o),ta(n),ta(t),(a,c,h,l,p=0)=>{Ue(a),Ue(c),Ue(h);let u=h.length;if(l===void 0&&(l=new Uint8Array(u)),Ue(l),pr(p),p<0||p>=Ga)throw new Error("arx: counter overflow");if(l.length<u)throw new Error(`arx: output (${l.length}) is shorter than data (${u})`);let d=[],g=a.length,y,f;if(g===32)d.push(y=_r(a)),f=Ap;else if(g===16&&t)y=new Uint8Array(32),y.set(a),y.set(a,16),f=Tp,d.push(y);else throw new Error(`arx: invalid 32-byte key, got length=${g}`);Pr(c)||d.push(c=_r(c));let w=At(y);if(i){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");i(f,w,At(c.subarray(0,16)),w),c=c.subarray(16)}let m=16-r;if(m!==c.length)throw new Error(`arx: nonce must be ${m} or 16 bytes`);if(m!==12){let _=new Uint8Array(12);_.set(c,n?0:12-c.length),c=_,d.push(c)}let b=At(c);return Np(s,f,w,b,h,l,p,o),os(...d),l}}var ye=(s,e)=>s[e++]&255|(s[e++]&255)<<8,Sr=class{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=Ir(e),Ue(e,32);let t=ye(e,0),i=ye(e,2),r=ye(e,4),n=ye(e,6),o=ye(e,8),a=ye(e,10),c=ye(e,12),h=ye(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|i<<3)&8191,this.r[2]=(i>>>10|r<<6)&7939,this.r[3]=(r>>>7|n<<9)&8191,this.r[4]=(n>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|h<<8)&8191,this.r[9]=h>>>5&127;for(let l=0;l<8;l++)this.pad[l]=ye(e,16+2*l)}process(e,t,i=!1){let r=i?0:2048,{h:n,r:o}=this,a=o[0],c=o[1],h=o[2],l=o[3],p=o[4],u=o[5],d=o[6],g=o[7],y=o[8],f=o[9],w=ye(e,t+0),m=ye(e,t+2),b=ye(e,t+4),_=ye(e,t+6),T=ye(e,t+8),P=ye(e,t+10),O=ye(e,t+12),C=ye(e,t+14),v=n[0]+(w&8191),k=n[1]+((w>>>13|m<<3)&8191),q=n[2]+((m>>>10|b<<6)&8191),F=n[3]+((b>>>7|_<<9)&8191),L=n[4]+((_>>>4|T<<12)&8191),I=n[5]+(T>>>1&8191),x=n[6]+((T>>>14|P<<2)&8191),R=n[7]+((P>>>11|O<<5)&8191),N=n[8]+((O>>>8|C<<8)&8191),D=n[9]+(C>>>5|r),S=0,j=S+v*a+k*(5*f)+q*(5*y)+F*(5*g)+L*(5*d);S=j>>>13,j&=8191,j+=I*(5*u)+x*(5*p)+R*(5*l)+N*(5*h)+D*(5*c),S+=j>>>13,j&=8191;let $=S+v*c+k*a+q*(5*f)+F*(5*y)+L*(5*g);S=$>>>13,$&=8191,$+=I*(5*d)+x*(5*u)+R*(5*p)+N*(5*l)+D*(5*h),S+=$>>>13,$&=8191;let M=S+v*h+k*c+q*a+F*(5*f)+L*(5*y);S=M>>>13,M&=8191,M+=I*(5*g)+x*(5*d)+R*(5*u)+N*(5*p)+D*(5*l),S+=M>>>13,M&=8191;let Z=S+v*l+k*h+q*c+F*a+L*(5*f);S=Z>>>13,Z&=8191,Z+=I*(5*y)+x*(5*g)+R*(5*d)+N*(5*u)+D*(5*p),S+=Z>>>13,Z&=8191;let J=S+v*p+k*l+q*h+F*c+L*a;S=J>>>13,J&=8191,J+=I*(5*f)+x*(5*y)+R*(5*g)+N*(5*d)+D*(5*u),S+=J>>>13,J&=8191;let ne=S+v*u+k*p+q*l+F*h+L*c;S=ne>>>13,ne&=8191,ne+=I*a+x*(5*f)+R*(5*y)+N*(5*g)+D*(5*d),S+=ne>>>13,ne&=8191;let pe=S+v*d+k*u+q*p+F*l+L*h;S=pe>>>13,pe&=8191,pe+=I*c+x*a+R*(5*f)+N*(5*y)+D*(5*g),S+=pe>>>13,pe&=8191;let Ee=S+v*g+k*d+q*u+F*p+L*l;S=Ee>>>13,Ee&=8191,Ee+=I*h+x*c+R*a+N*(5*f)+D*(5*y),S+=Ee>>>13,Ee&=8191;let ae=S+v*y+k*g+q*d+F*u+L*p;S=ae>>>13,ae&=8191,ae+=I*l+x*h+R*c+N*a+D*(5*f),S+=ae>>>13,ae&=8191;let ce=S+v*f+k*y+q*g+F*d+L*u;S=ce>>>13,ce&=8191,ce+=I*p+x*l+R*h+N*c+D*a,S+=ce>>>13,ce&=8191,S=(S<<2)+S|0,S=S+j|0,j=S&8191,S=S>>>13,$+=S,n[0]=j,n[1]=$,n[2]=M,n[3]=Z,n[4]=J,n[5]=ne,n[6]=pe,n[7]=Ee,n[8]=ae,n[9]=ce}finalize(){let{h:e,pad:t}=this,i=new Uint16Array(10),r=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=r,r=e[a]>>>13,e[a]&=8191;e[0]+=r*5,r=e[0]>>>13,e[0]&=8191,e[1]+=r,r=e[1]>>>13,e[1]&=8191,e[2]+=r,i[0]=e[0]+5,r=i[0]>>>13,i[0]&=8191;for(let a=1;a<10;a++)i[a]=e[a]+r,r=i[a]>>>13,i[a]&=8191;i[9]-=8192;let n=(r^1)-1;for(let a=0;a<10;a++)i[a]&=n;n=~n;for(let a=0;a<10;a++)e[a]=e[a]&n|i[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let o=e[0]+t[0];e[0]=o&65535;for(let a=1;a<8;a++)o=(e[a]+t[a]|0)+(o>>>16)|0,e[a]=o&65535;os(i)}update(e){ea(this);let{buffer:t,blockLen:i}=this;e=Ir(e);let r=e.length;for(let n=0;n<r;){let o=Math.min(i-this.pos,r-n);if(o===i){for(;i<=r-n;n+=i)this.process(e,n);continue}t.set(e.subarray(n,n+o),this.pos),this.pos+=o,n+=o,this.pos===i&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){os(this.h,this.r,this.buffer,this.pad)}digestInto(e){ea(this),bp(e,this),this.finished=!0;let{buffer:t,h:i}=this,{pos:r}=this;if(r){for(t[r++]=1;r<16;r++)t[r]=0;this.process(t,0,!0)}this.finalize();let n=0;for(let o=0;o<8;o++)e[n++]=i[o]>>>0,e[n++]=i[o]>>>8;return e}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let i=e.slice(0,t);return this.destroy(),i}};function Dp(s){let e=(i,r)=>s(r).update(Ir(i)).digest(),t=s(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=i=>s(i),e}var Fp=Dp(s=>new Sr(s));function Up(s,e,t,i,r,n=20){let o=s[0],a=s[1],c=s[2],h=s[3],l=e[0],p=e[1],u=e[2],d=e[3],g=e[4],y=e[5],f=e[6],w=e[7],m=r,b=t[0],_=t[1],T=t[2],P=o,O=a,C=c,v=h,k=l,q=p,F=u,L=d,I=g,x=y,R=f,N=w,D=m,S=b,j=_,$=T;for(let Z=0;Z<n;Z+=2)P=P+k|0,D=K(D^P,16),I=I+D|0,k=K(k^I,12),P=P+k|0,D=K(D^P,8),I=I+D|0,k=K(k^I,7),O=O+q|0,S=K(S^O,16),x=x+S|0,q=K(q^x,12),O=O+q|0,S=K(S^O,8),x=x+S|0,q=K(q^x,7),C=C+F|0,j=K(j^C,16),R=R+j|0,F=K(F^R,12),C=C+F|0,j=K(j^C,8),R=R+j|0,F=K(F^R,7),v=v+L|0,$=K($^v,16),N=N+$|0,L=K(L^N,12),v=v+L|0,$=K($^v,8),N=N+$|0,L=K(L^N,7),P=P+q|0,$=K($^P,16),R=R+$|0,q=K(q^R,12),P=P+q|0,$=K($^P,8),R=R+$|0,q=K(q^R,7),O=O+F|0,D=K(D^O,16),N=N+D|0,F=K(F^N,12),O=O+F|0,D=K(D^O,8),N=N+D|0,F=K(F^N,7),C=C+L|0,S=K(S^C,16),I=I+S|0,L=K(L^I,12),C=C+L|0,S=K(S^C,8),I=I+S|0,L=K(L^I,7),v=v+k|0,j=K(j^v,16),x=x+j|0,k=K(k^x,12),v=v+k|0,j=K(j^v,8),x=x+j|0,k=K(k^x,7);let M=0;i[M++]=o+P|0,i[M++]=a+O|0,i[M++]=c+C|0,i[M++]=h+v|0,i[M++]=l+k|0,i[M++]=p+q|0,i[M++]=u+F|0,i[M++]=d+L|0,i[M++]=g+I|0,i[M++]=y+x|0,i[M++]=f+R|0,i[M++]=w+N|0,i[M++]=m+D|0,i[M++]=b+S|0,i[M++]=_+j|0,i[M++]=T+$|0}var kp=qp(Up,{counterRight:!1,counterLength:4,allowShortKeys:!1}),jp=new Uint8Array(16),na=(s,e)=>{s.update(e);let t=e.length%16;t&&s.update(jp.subarray(t))},Lp=new Uint8Array(32);function oa(s,e,t,i,r){let n=s(e,t,Lp),o=Fp.create(n);r&&na(o,r),na(o,i);let a=new Uint8Array(16),c=vp(a);ia(c,0,BigInt(r?r.length:0),!0),ia(c,8,BigInt(i.length),!0),o.update(a);let h=o.digest();return os(n,a),h}var $p=s=>(e,t,i)=>({encrypt(r,n){let o=r.length;n=sa(o+16,n,!1),n.set(r);let a=n.subarray(0,-16);s(e,t,a,a,1);let c=oa(s,e,t,a,i);return n.set(c,o),os(c),n},decrypt(r,n){n=sa(r.length-16,n,!1);let o=r.subarray(0,-16),a=r.subarray(-16),c=oa(s,e,t,o,i);if(!Pp(a,c))throw new Error("invalid tag");return n.set(r.subarray(0,-16)),s(e,t,n,n,1),os(c),n}}),Wa=Sp({blockSize:64,nonceLength:12,tagLength:16},$p(kp)),mi=class extends Bs{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,$r(e);let i=ns(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let r=this.blockLen,n=new Uint8Array(r);n.set(i.length>r?e.create().update(i).digest():i);for(let o=0;o<n.length;o++)n[o]^=54;this.iHash.update(n),this.oHash=e.create();for(let o=0;o<n.length;o++)n[o]^=106;this.oHash.update(n),n.fill(0)}update(e){return rs(this),this.iHash.update(e),this}digestInto(e){rs(this),Ys(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){let e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));let{oHash:t,iHash:i,finished:r,destroyed:n,blockLen:o,outputLen:a}=this;return e=e,e.finished=r,e.destroyed=n,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=i._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},Ii=(s,e,t)=>new mi(s,e).update(t).digest();Ii.create=(s,e)=>new mi(s,e);function Mp(s,e,t){return $r(s),t===void 0&&(t=new Uint8Array(s.outputLen)),Ii(s,ns(t),ns(e))}var ur=new Uint8Array([0]),aa=new Uint8Array;function Bp(s,e,t,i=32){if($r(s),Ms(i),i>255*s.outputLen)throw new Error("Length should be <= 255*HashLen");let r=Math.ceil(i/s.outputLen);t===void 0&&(t=aa);let n=new Uint8Array(r*s.outputLen),o=Ii.create(s,e),a=o._cloneInto(),c=new Uint8Array(o.outputLen);for(let h=0;h<r;h++)ur[0]=h+1,a.update(h===0?aa:c).update(t).update(ur).digestInto(c),n.set(c,s.outputLen*h),o._cloneInto(a);return o.destroy(),a.destroy(),c.fill(0),ur.fill(0),n.slice(0,i)}var Vp=(s,e,t,i,r)=>Bp(s,Mp(s,e,t),i,r);function zp(s,e,t,i){if(typeof s.setBigUint64=="function")return s.setBigUint64(e,t,i);let r=BigInt(32),n=BigInt(4294967295),o=Number(t>>r&n),a=Number(t&n),c=i?4:0,h=i?0:4;s.setUint32(e+c,o,i),s.setUint32(e+h,a,i)}function Hp(s,e,t){return s&e^~s&t}function Kp(s,e,t){return s&e^s&t^e&t}var Or=class extends Bs{constructor(e,t,i,r){super(),this.blockLen=e,this.outputLen=t,this.padOffset=i,this.isLE=r,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=lr(this.buffer)}update(e){rs(this);let{view:t,buffer:i,blockLen:r}=this;e=ns(e);let n=e.length;for(let o=0;o<n;){let a=Math.min(r-this.pos,n-o);if(a===r){let c=lr(e);for(;r<=n-o;o+=r)this.process(c,o);continue}i.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===r&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){rs(this),Fa(e,this),this.finished=!0;let{buffer:t,view:i,blockLen:r,isLE:n}=this,{pos:o}=this;t[o++]=128,this.buffer.subarray(o).fill(0),this.padOffset>r-o&&(this.process(i,0),o=0);for(let p=o;p<r;p++)t[p]=0;zp(i,r-8,BigInt(this.length*8),n),this.process(i,0);let a=lr(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let h=c/4,l=this.get();if(h>l.length)throw new Error("_sha2: outputLen bigger than state");for(let p=0;p<h;p++)a.setUint32(4*p,l[p],n)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let i=e.slice(0,t);return this.destroy(),i}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:i,length:r,finished:n,destroyed:o,pos:a}=this;return e.length=r,e.pos=a,e.finished=n,e.destroyed=o,r%t&&e.buffer.set(i),e}},Gp=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),xt=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Tt=new Uint32Array(64),Rr=class extends Or{constructor(){super(64,32,8,!1),this.A=xt[0]|0,this.B=xt[1]|0,this.C=xt[2]|0,this.D=xt[3]|0,this.E=xt[4]|0,this.F=xt[5]|0,this.G=xt[6]|0,this.H=xt[7]|0}get(){let{A:e,B:t,C:i,D:r,E:n,F:o,G:a,H:c}=this;return[e,t,i,r,n,o,a,c]}set(e,t,i,r,n,o,a,c){this.A=e|0,this.B=t|0,this.C=i|0,this.D=r|0,this.E=n|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let p=0;p<16;p++,t+=4)Tt[p]=e.getUint32(t,!1);for(let p=16;p<64;p++){let u=Tt[p-15],d=Tt[p-2],g=ot(u,7)^ot(u,18)^u>>>3,y=ot(d,17)^ot(d,19)^d>>>10;Tt[p]=y+Tt[p-7]+g+Tt[p-16]|0}let{A:i,B:r,C:n,D:o,E:a,F:c,G:h,H:l}=this;for(let p=0;p<64;p++){let u=ot(a,6)^ot(a,11)^ot(a,25),d=l+u+Hp(a,c,h)+Gp[p]+Tt[p]|0,g=(ot(i,2)^ot(i,13)^ot(i,22))+Kp(i,r,n)|0;l=h,h=c,c=a,a=o+d|0,o=n,n=r,r=i,i=d+g|0}i=i+this.A|0,r=r+this.B|0,n=n+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,h=h+this.G|0,l=l+this.H|0,this.set(i,r,n,o,a,c,h,l)}roundClean(){Tt.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}},Xs=Ua(()=>new Rr);var _i=BigInt(0),Pi=BigInt(1),Wp=BigInt(2);function Kt(s){return s instanceof Uint8Array||ArrayBuffer.isView(s)&&s.constructor.name==="Uint8Array"}function Zs(s){if(!Kt(s))throw new Error("Uint8Array expected")}function as(s,e){if(typeof e!="boolean")throw new Error(s+" boolean expected, got "+e)}var Yp=Array.from({length:256},(s,e)=>e.toString(16).padStart(2,"0"));function cs(s){Zs(s);let e="";for(let t=0;t<s.length;t++)e+=Yp[s[t]];return e}function is(s){let e=s.toString(16);return e.length&1?"0"+e:e}function Kr(s){if(typeof s!="string")throw new Error("hex string expected, got "+typeof s);return s===""?_i:BigInt("0x"+s)}var yt={_0:48,_9:57,A:65,F:70,a:97,f:102};function ca(s){if(s>=yt._0&&s<=yt._9)return s-yt._0;if(s>=yt.A&&s<=yt.F)return s-(yt.A-10);if(s>=yt.a&&s<=yt.f)return s-(yt.a-10)}function hs(s){if(typeof s!="string")throw new Error("hex string expected, got "+typeof s);let e=s.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);let i=new Uint8Array(t);for(let r=0,n=0;r<t;r++,n+=2){let o=ca(s.charCodeAt(n)),a=ca(s.charCodeAt(n+1));if(o===void 0||a===void 0){let c=s[n]+s[n+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+n)}i[r]=o*16+a}return i}function zt(s){return Kr(cs(s))}function zs(s){return Zs(s),Kr(cs(Uint8Array.from(s).reverse()))}function ls(s,e){return hs(s.toString(16).padStart(e*2,"0"))}function Si(s,e){return ls(s,e).reverse()}function Jp(s){return hs(is(s))}function Fe(s,e,t){let i;if(typeof e=="string")try{i=hs(e)}catch(n){throw new Error(s+" must be hex string or Uint8Array, cause: "+n)}else if(Kt(e))i=Uint8Array.from(e);else throw new Error(s+" must be hex string or Uint8Array");let r=i.length;if(typeof t=="number"&&r!==t)throw new Error(s+" of length "+t+" expected, got "+r);return i}function Hs(...s){let e=0;for(let i=0;i<s.length;i++){let r=s[i];Zs(r),e+=r.length}let t=new Uint8Array(e);for(let i=0,r=0;i<s.length;i++){let n=s[i];t.set(n,r),r+=n.length}return t}function Qp(s,e){if(s.length!==e.length)return!1;let t=0;for(let i=0;i<s.length;i++)t|=s[i]^e[i];return t===0}function Xp(s){if(typeof s!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(s))}var dr=s=>typeof s=="bigint"&&_i<=s;function Oi(s,e,t){return dr(s)&&dr(e)&&dr(t)&&e<=s&&s<t}function vt(s,e,t,i){if(!Oi(e,t,i))throw new Error("expected valid "+s+": "+t+" <= n < "+i+", got "+e)}function Ya(s){let e;for(e=0;s>_i;s>>=Pi,e+=1);return e}function Zp(s,e){return s>>BigInt(e)&Pi}function eu(s,e,t){return s|(t?Pi:_i)<<BigInt(e)}var Gr=s=>(Wp<<BigInt(s-1))-Pi,gr=s=>new Uint8Array(s),ha=s=>Uint8Array.from(s);function Ja(s,e,t){if(typeof s!="number"||s<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");let i=gr(s),r=gr(s),n=0,o=()=>{i.fill(1),r.fill(0),n=0},a=(...l)=>t(r,i,...l),c=(l=gr())=>{r=a(ha([0]),l),i=a(),l.length!==0&&(r=a(ha([1]),l),i=a())},h=()=>{if(n++>=1e3)throw new Error("drbg: tried 1000 values");let l=0,p=[];for(;l<e;){i=a();let u=i.slice();p.push(u),l+=i.length}return Hs(...p)};return(l,p)=>{o(),c(l);let u;for(;!(u=p(h()));)c();return o(),u}}var tu={bigint:s=>typeof s=="bigint",function:s=>typeof s=="function",boolean:s=>typeof s=="boolean",string:s=>typeof s=="string",stringOrUint8Array:s=>typeof s=="string"||Kt(s),isSafeInteger:s=>Number.isSafeInteger(s),array:s=>Array.isArray(s),field:(s,e)=>e.Fp.isValid(s),hash:s=>typeof s=="function"&&Number.isSafeInteger(s.outputLen)};function us(s,e,t={}){let i=(r,n,o)=>{let a=tu[n];if(typeof a!="function")throw new Error("invalid validator function");let c=s[r];if(!(o&&c===void 0)&&!a(c,s))throw new Error("param "+String(r)+" is invalid. Expected "+n+", got "+c)};for(let[r,n]of Object.entries(e))i(r,n,!1);for(let[r,n]of Object.entries(t))i(r,n,!0);return s}var su=()=>{throw new Error("not implemented")};function xr(s){let e=new WeakMap;return(t,...i)=>{let r=e.get(t);if(r!==void 0)return r;let n=s(t,...i);return e.set(t,n),n}}var iu=Object.freeze({__proto__:null,isBytes:Kt,abytes:Zs,abool:as,bytesToHex:cs,numberToHexUnpadded:is,hexToNumber:Kr,hexToBytes:hs,bytesToNumberBE:zt,bytesToNumberLE:zs,numberToBytesBE:ls,numberToBytesLE:Si,numberToVarBytesBE:Jp,ensureBytes:Fe,concatBytes:Hs,equalBytes:Qp,utf8ToBytes:Xp,inRange:Oi,aInRange:vt,bitLen:Ya,bitGet:Zp,bitSet:eu,bitMask:Gr,createHmacDrbg:Ja,validateObject:us,notImplemented:su,memoized:xr}),de=BigInt(0),ie=BigInt(1),Bt=BigInt(2),ru=BigInt(3),Tr=BigInt(4),la=BigInt(5),pa=BigInt(8);function Te(s,e){let t=s%e;return t>=de?t:e+t}function Qa(s,e,t){if(e<de)throw new Error("invalid exponent, negatives unsupported");if(t<=de)throw new Error("invalid modulus");if(t===ie)return de;let i=ie;for(;e>de;)e&ie&&(i=i*s%t),s=s*s%t,e>>=ie;return i}function Qe(s,e,t){let i=s;for(;e-- >de;)i*=i,i%=t;return i}function Ar(s,e){if(s===de)throw new Error("invert: expected non-zero number");if(e<=de)throw new Error("invert: expected positive modulus, got "+e);let t=Te(s,e),i=e,r=de,n=ie;for(;t!==de;){let o=i/t,a=i%t,c=r-n*o;i=t,t=a,r=n,n=c}if(i!==ie)throw new Error("invert: does not exist");return Te(r,e)}function nu(s){let e=(s-ie)/Bt,t,i,r;for(t=s-ie,i=0;t%Bt===de;t/=Bt,i++);for(r=Bt;r<s&&Qa(r,e,s)!==s-ie;r++)if(r>1e3)throw new Error("Cannot find square root: likely non-prime P");if(i===1){let o=(s+ie)/Tr;return function(a,c){let h=a.pow(c,o);if(!a.eql(a.sqr(h),c))throw new Error("Cannot find square root");return h}}let n=(t+ie)/Bt;return function(o,a){if(o.pow(a,e)===o.neg(o.ONE))throw new Error("Cannot find square root");let c=i,h=o.pow(o.mul(o.ONE,r),t),l=o.pow(a,n),p=o.pow(a,t);for(;!o.eql(p,o.ONE);){if(o.eql(p,o.ZERO))return o.ZERO;let u=1;for(let g=o.sqr(p);u<c&&!o.eql(g,o.ONE);u++)g=o.sqr(g);let d=o.pow(h,ie<<BigInt(c-u-1));h=o.sqr(d),l=o.mul(l,d),p=o.mul(p,h),c=u}return l}}function ou(s){if(s%Tr===ru){let e=(s+ie)/Tr;return function(t,i){let r=t.pow(i,e);if(!t.eql(t.sqr(r),i))throw new Error("Cannot find square root");return r}}if(s%pa===la){let e=(s-la)/pa;return function(t,i){let r=t.mul(i,Bt),n=t.pow(r,e),o=t.mul(i,n),a=t.mul(t.mul(o,Bt),n),c=t.mul(o,t.sub(a,t.ONE));if(!t.eql(t.sqr(c),i))throw new Error("Cannot find square root");return c}}return nu(s)}var au=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function cu(s){let e={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},t=au.reduce((i,r)=>(i[r]="function",i),e);return us(s,t)}function hu(s,e,t){if(t<de)throw new Error("invalid exponent, negatives unsupported");if(t===de)return s.ONE;if(t===ie)return e;let i=s.ONE,r=e;for(;t>de;)t&ie&&(i=s.mul(i,r)),r=s.sqr(r),t>>=ie;return i}function lu(s,e){let t=new Array(e.length),i=e.reduce((n,o,a)=>s.is0(o)?n:(t[a]=n,s.mul(n,o)),s.ONE),r=s.inv(i);return e.reduceRight((n,o,a)=>s.is0(o)?n:(t[a]=s.mul(n,t[a]),s.mul(n,o)),r),t}function Xa(s,e){let t=e!==void 0?e:s.toString(2).length,i=Math.ceil(t/8);return{nBitLength:t,nByteLength:i}}function Za(s,e,t=!1,i={}){if(s<=de)throw new Error("invalid field: expected ORDER > 0, got "+s);let{nBitLength:r,nByteLength:n}=Xa(s,e);if(n>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let o,a=Object.freeze({ORDER:s,isLE:t,BITS:r,BYTES:n,MASK:Gr(r),ZERO:de,ONE:ie,create:c=>Te(c,s),isValid:c=>{if(typeof c!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof c);return de<=c&&c<s},is0:c=>c===de,isOdd:c=>(c&ie)===ie,neg:c=>Te(-c,s),eql:(c,h)=>c===h,sqr:c=>Te(c*c,s),add:(c,h)=>Te(c+h,s),sub:(c,h)=>Te(c-h,s),mul:(c,h)=>Te(c*h,s),pow:(c,h)=>hu(a,c,h),div:(c,h)=>Te(c*Ar(h,s),s),sqrN:c=>c*c,addN:(c,h)=>c+h,subN:(c,h)=>c-h,mulN:(c,h)=>c*h,inv:c=>Ar(c,s),sqrt:i.sqrt||(c=>(o||(o=ou(s)),o(a,c))),invertBatch:c=>lu(a,c),cmov:(c,h,l)=>l?h:c,toBytes:c=>t?Si(c,n):ls(c,n),fromBytes:c=>{if(c.length!==n)throw new Error("Field.fromBytes: expected "+n+" bytes, got "+c.length);return t?zs(c):zt(c)}});return Object.freeze(a)}function ec(s){if(typeof s!="bigint")throw new Error("field order must be bigint");let e=s.toString(2).length;return Math.ceil(e/8)}function tc(s){let e=ec(s);return e+Math.ceil(e/2)}function pu(s,e,t=!1){let i=s.length,r=ec(e),n=tc(e);if(i<16||i<n||i>1024)throw new Error("expected "+n+"-1024 bytes of input, got "+i);let o=t?zs(s):zt(s),a=Te(o,e-ie)+ie;return t?Si(a,r):ls(a,r)}var ua=BigInt(0),fi=BigInt(1);function fr(s,e){let t=e.negate();return s?t:e}function sc(s,e){if(!Number.isSafeInteger(s)||s<=0||s>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+s)}function mr(s,e){sc(s,e);let t=Math.ceil(e/s)+1,i=2**(s-1);return{windows:t,windowSize:i}}function uu(s,e){if(!Array.isArray(s))throw new Error("array expected");s.forEach((t,i)=>{if(!(t instanceof e))throw new Error("invalid point at index "+i)})}function du(s,e){if(!Array.isArray(s))throw new Error("array of scalars expected");s.forEach((t,i)=>{if(!e.isValid(t))throw new Error("invalid scalar at index "+i)})}var yr=new WeakMap,ic=new WeakMap;function wr(s){return ic.get(s)||1}function gu(s,e){return{constTimeNegate:fr,hasPrecomputes(t){return wr(t)!==1},unsafeLadder(t,i,r=s.ZERO){let n=t;for(;i>ua;)i&fi&&(r=r.add(n)),n=n.double(),i>>=fi;return r},precomputeWindow(t,i){let{windows:r,windowSize:n}=mr(i,e),o=[],a=t,c=a;for(let h=0;h<r;h++){c=a,o.push(c);for(let l=1;l<n;l++)c=c.add(a),o.push(c);a=c.double()}return o},wNAF(t,i,r){let{windows:n,windowSize:o}=mr(t,e),a=s.ZERO,c=s.BASE,h=BigInt(2**t-1),l=2**t,p=BigInt(t);for(let u=0;u<n;u++){let d=u*o,g=Number(r&h);r>>=p,g>o&&(g-=l,r+=fi);let y=d,f=d+Math.abs(g)-1,w=u%2!==0,m=g<0;g===0?c=c.add(fr(w,i[y])):a=a.add(fr(m,i[f]))}return{p:a,f:c}},wNAFUnsafe(t,i,r,n=s.ZERO){let{windows:o,windowSize:a}=mr(t,e),c=BigInt(2**t-1),h=2**t,l=BigInt(t);for(let p=0;p<o;p++){let u=p*a;if(r===ua)break;let d=Number(r&c);if(r>>=l,d>a&&(d-=h,r+=fi),d===0)continue;let g=i[u+Math.abs(d)-1];d<0&&(g=g.negate()),n=n.add(g)}return n},getPrecomputes(t,i,r){let n=yr.get(i);return n||(n=this.precomputeWindow(i,t),t!==1&&yr.set(i,r(n))),n},wNAFCached(t,i,r){let n=wr(t);return this.wNAF(n,this.getPrecomputes(n,t,r),i)},wNAFCachedUnsafe(t,i,r,n){let o=wr(t);return o===1?this.unsafeLadder(t,i,n):this.wNAFUnsafe(o,this.getPrecomputes(o,t,r),i,n)},setWindowSize(t,i){sc(i,e),ic.set(t,i),yr.delete(t)}}}function fu(s,e,t,i){if(uu(t,s),du(i,e),t.length!==i.length)throw new Error("arrays of points and scalars must have equal length");let r=s.ZERO,n=Ya(BigInt(t.length)),o=n>12?n-3:n>4?n-2:n?2:1,a=(1<<o)-1,c=new Array(a+1).fill(r),h=Math.floor((e.BITS-1)/o)*o,l=r;for(let p=h;p>=0;p-=o){c.fill(r);for(let d=0;d<i.length;d++){let g=i[d],y=Number(g>>BigInt(p)&BigInt(a));c[y]=c[y].add(t[d])}let u=r;for(let d=c.length-1,g=r;d>0;d--)g=g.add(c[d]),u=u.add(g);if(l=l.add(u),p!==0)for(let d=0;d<o;d++)l=l.double()}return l}function rc(s){return cu(s.Fp),us(s,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...Xa(s.n,s.nBitLength),...s,p:s.Fp.ORDER})}BigInt(0),BigInt(1),BigInt(2),BigInt(8);var ss=BigInt(0),br=BigInt(1);function mu(s){return us(s,{a:"bigint"},{montgomeryBits:"isSafeInteger",nByteLength:"isSafeInteger",adjustScalarBytes:"function",domain:"function",powPminus2:"function",Gu:"bigint"}),Object.freeze({...s})}function yu(s){let e=mu(s),{P:t}=e,i=m=>Te(m,t),r=e.montgomeryBits,n=Math.ceil(r/8),o=e.nByteLength,a=e.adjustScalarBytes||(m=>m),c=e.powPminus2||(m=>Qa(m,t-BigInt(2),t));function h(m,b,_){let T=i(m*(b-_));return b=i(b-T),_=i(_+T),[b,_]}let l=(e.a-BigInt(2))/BigInt(4);function p(m,b){vt("u",m,ss,t),vt("scalar",b,ss,t);let _=b,T=m,P=br,O=ss,C=m,v=br,k=ss,q;for(let L=BigInt(r-1);L>=ss;L--){let I=_>>L&br;k^=I,q=h(k,P,C),P=q[0],C=q[1],q=h(k,O,v),O=q[0],v=q[1],k=I;let x=P+O,R=i(x*x),N=P-O,D=i(N*N),S=R-D,j=C+v,$=C-v,M=i($*x),Z=i(j*N),J=M+Z,ne=M-Z;C=i(J*J),v=i(T*i(ne*ne)),P=i(R*D),O=i(S*(R+i(l*S)))}q=h(k,P,C),P=q[0],C=q[1],q=h(k,O,v),O=q[0],v=q[1];let F=c(O);return i(P*F)}function u(m){return Si(i(m),n)}function d(m){let b=Fe("u coordinate",m,n);return o===32&&(b[31]&=127),zs(b)}function g(m){let b=Fe("scalar",m),_=b.length;if(_!==n&&_!==o){let T=""+n+" or "+o;throw new Error("invalid scalar, expected "+T+" bytes, got "+_)}return zs(a(b))}function y(m,b){let _=d(b),T=g(m),P=p(_,T);if(P===ss)throw new Error("invalid private or public key received");return u(P)}let f=u(e.Gu);function w(m){return y(m,f)}return{scalarMult:y,scalarMultBase:w,getSharedSecret:(m,b)=>y(m,b),getPublicKey:m=>w(m),utils:{randomPrivateKey:()=>e.randomBytes(e.nByteLength)},GuBytes:f}}var Cr=BigInt("57896044618658097711785492504343953926634992332820282019728792003956564819949");BigInt(0);var wu=BigInt(1),da=BigInt(2),bu=BigInt(3),vu=BigInt(5);BigInt(8);function Eu(s){let e=BigInt(10),t=BigInt(20),i=BigInt(40),r=BigInt(80),n=Cr,o=s*s%n*s%n,a=Qe(o,da,n)*o%n,c=Qe(a,wu,n)*s%n,h=Qe(c,vu,n)*c%n,l=Qe(h,e,n)*h%n,p=Qe(l,t,n)*l%n,u=Qe(p,i,n)*p%n,d=Qe(u,r,n)*u%n,g=Qe(d,r,n)*u%n,y=Qe(g,e,n)*h%n;return{pow_p_5_8:Qe(y,da,n)*s%n,b2:o}}function Iu(s){return s[0]&=248,s[31]&=127,s[31]|=64,s}var Nr=yu({P:Cr,a:BigInt(486662),montgomeryBits:255,nByteLength:32,Gu:BigInt(9),powPminus2:s=>{let e=Cr,{pow_p_5_8:t,b2:i}=Eu(s);return Te(Qe(t,bu,e)*i,e)},adjustScalarBytes:Iu,randomBytes:ps});function ga(s){s.lowS!==void 0&&as("lowS",s.lowS),s.prehash!==void 0&&as("prehash",s.prehash)}function _u(s){let e=rc(s);us(e,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});let{endo:t,Fp:i,a:r}=e;if(t){if(!i.eql(r,i.ZERO))throw new Error("invalid endomorphism, can only be defined for Koblitz curves that have a=0");if(typeof t!="object"||typeof t.beta!="bigint"||typeof t.splitScalar!="function")throw new Error("invalid endomorphism, expected beta: bigint and splitScalar: function")}return Object.freeze({...e})}var{bytesToNumberBE:Pu,hexToBytes:Su}=iu,qr=class extends Error{constructor(e=""){super(e)}},wt={Err:qr,_tlv:{encode:(s,e)=>{let{Err:t}=wt;if(s<0||s>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");let i=e.length/2,r=is(i);if(r.length/2&128)throw new t("tlv.encode: long form length too big");let n=i>127?is(r.length/2|128):"";return is(s)+n+r+e},decode(s,e){let{Err:t}=wt,i=0;if(s<0||s>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[i++]!==s)throw new t("tlv.decode: wrong tlv");let r=e[i++],n=!!(r&128),o=0;if(!n)o=r;else{let c=r&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");let h=e.subarray(i,i+c);if(h.length!==c)throw new t("tlv.decode: length bytes not complete");if(h[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(let l of h)o=o<<8|l;if(i+=c,o<128)throw new t("tlv.decode(long): not minimal encoding")}let a=e.subarray(i,i+o);if(a.length!==o)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(i+o)}}},_int:{encode(s){let{Err:e}=wt;if(s<bt)throw new e("integer: negative integers are not allowed");let t=is(s);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(s){let{Err:e}=wt;if(s[0]&128)throw new e("invalid signature integer: negative");if(s[0]===0&&!(s[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return Pu(s)}},toSig(s){let{Err:e,_int:t,_tlv:i}=wt,r=typeof s=="string"?Su(s):s;Zs(r);let{v:n,l:o}=i.decode(48,r);if(o.length)throw new e("invalid signature: left bytes after parsing");let{v:a,l:c}=i.decode(2,n),{v:h,l}=i.decode(2,c);if(l.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(h)}},hexFromSig(s){let{_tlv:e,_int:t}=wt,i=e.encode(2,t.encode(s.r)),r=e.encode(2,t.encode(s.s)),n=i+r;return e.encode(48,n)}},bt=BigInt(0),ue=BigInt(1);BigInt(2);var fa=BigInt(3);BigInt(4);function Ou(s){let e=_u(s),{Fp:t}=e,i=Za(e.n,e.nBitLength),r=e.toBytes||((y,f,w)=>{let m=f.toAffine();return Hs(Uint8Array.from([4]),t.toBytes(m.x),t.toBytes(m.y))}),n=e.fromBytes||(y=>{let f=y.subarray(1),w=t.fromBytes(f.subarray(0,t.BYTES)),m=t.fromBytes(f.subarray(t.BYTES,2*t.BYTES));return{x:w,y:m}});function o(y){let{a:f,b:w}=e,m=t.sqr(y),b=t.mul(m,y);return t.add(t.add(b,t.mul(y,f)),w)}if(!t.eql(t.sqr(e.Gy),o(e.Gx)))throw new Error("bad generator point: equation left != right");function a(y){return Oi(y,ue,e.n)}function c(y){let{allowedPrivateKeyLengths:f,nByteLength:w,wrapPrivateKey:m,n:b}=e;if(f&&typeof y!="bigint"){if(Kt(y)&&(y=cs(y)),typeof y!="string"||!f.includes(y.length))throw new Error("invalid private key");y=y.padStart(w*2,"0")}let _;try{_=typeof y=="bigint"?y:zt(Fe("private key",y,w))}catch{throw new Error("invalid private key, expected hex or "+w+" bytes, got "+typeof y)}return m&&(_=Te(_,b)),vt("private key",_,ue,b),_}function h(y){if(!(y instanceof u))throw new Error("ProjectivePoint expected")}let l=xr((y,f)=>{let{px:w,py:m,pz:b}=y;if(t.eql(b,t.ONE))return{x:w,y:m};let _=y.is0();f==null&&(f=_?t.ONE:t.inv(b));let T=t.mul(w,f),P=t.mul(m,f),O=t.mul(b,f);if(_)return{x:t.ZERO,y:t.ZERO};if(!t.eql(O,t.ONE))throw new Error("invZ was invalid");return{x:T,y:P}}),p=xr(y=>{if(y.is0()){if(e.allowInfinityPoint&&!t.is0(y.py))return;throw new Error("bad point: ZERO")}let{x:f,y:w}=y.toAffine();if(!t.isValid(f)||!t.isValid(w))throw new Error("bad point: x or y not FE");let m=t.sqr(w),b=o(f);if(!t.eql(m,b))throw new Error("bad point: equation left != right");if(!y.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});class u{constructor(f,w,m){if(this.px=f,this.py=w,this.pz=m,f==null||!t.isValid(f))throw new Error("x required");if(w==null||!t.isValid(w))throw new Error("y required");if(m==null||!t.isValid(m))throw new Error("z required");Object.freeze(this)}static fromAffine(f){let{x:w,y:m}=f||{};if(!f||!t.isValid(w)||!t.isValid(m))throw new Error("invalid affine point");if(f instanceof u)throw new Error("projective point not allowed");let b=_=>t.eql(_,t.ZERO);return b(w)&&b(m)?u.ZERO:new u(w,m,t.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(f){let w=t.invertBatch(f.map(m=>m.pz));return f.map((m,b)=>m.toAffine(w[b])).map(u.fromAffine)}static fromHex(f){let w=u.fromAffine(n(Fe("pointHex",f)));return w.assertValidity(),w}static fromPrivateKey(f){return u.BASE.multiply(c(f))}static msm(f,w){return fu(u,i,f,w)}_setWindowSize(f){g.setWindowSize(this,f)}assertValidity(){p(this)}hasEvenY(){let{y:f}=this.toAffine();if(t.isOdd)return!t.isOdd(f);throw new Error("Field doesn't support isOdd")}equals(f){h(f);let{px:w,py:m,pz:b}=this,{px:_,py:T,pz:P}=f,O=t.eql(t.mul(w,P),t.mul(_,b)),C=t.eql(t.mul(m,P),t.mul(T,b));return O&&C}negate(){return new u(this.px,t.neg(this.py),this.pz)}double(){let{a:f,b:w}=e,m=t.mul(w,fa),{px:b,py:_,pz:T}=this,P=t.ZERO,O=t.ZERO,C=t.ZERO,v=t.mul(b,b),k=t.mul(_,_),q=t.mul(T,T),F=t.mul(b,_);return F=t.add(F,F),C=t.mul(b,T),C=t.add(C,C),P=t.mul(f,C),O=t.mul(m,q),O=t.add(P,O),P=t.sub(k,O),O=t.add(k,O),O=t.mul(P,O),P=t.mul(F,P),C=t.mul(m,C),q=t.mul(f,q),F=t.sub(v,q),F=t.mul(f,F),F=t.add(F,C),C=t.add(v,v),v=t.add(C,v),v=t.add(v,q),v=t.mul(v,F),O=t.add(O,v),q=t.mul(_,T),q=t.add(q,q),v=t.mul(q,F),P=t.sub(P,v),C=t.mul(q,k),C=t.add(C,C),C=t.add(C,C),new u(P,O,C)}add(f){h(f);let{px:w,py:m,pz:b}=this,{px:_,py:T,pz:P}=f,O=t.ZERO,C=t.ZERO,v=t.ZERO,k=e.a,q=t.mul(e.b,fa),F=t.mul(w,_),L=t.mul(m,T),I=t.mul(b,P),x=t.add(w,m),R=t.add(_,T);x=t.mul(x,R),R=t.add(F,L),x=t.sub(x,R),R=t.add(w,b);let N=t.add(_,P);return R=t.mul(R,N),N=t.add(F,I),R=t.sub(R,N),N=t.add(m,b),O=t.add(T,P),N=t.mul(N,O),O=t.add(L,I),N=t.sub(N,O),v=t.mul(k,R),O=t.mul(q,I),v=t.add(O,v),O=t.sub(L,v),v=t.add(L,v),C=t.mul(O,v),L=t.add(F,F),L=t.add(L,F),I=t.mul(k,I),R=t.mul(q,R),L=t.add(L,I),I=t.sub(F,I),I=t.mul(k,I),R=t.add(R,I),F=t.mul(L,R),C=t.add(C,F),F=t.mul(N,R),O=t.mul(x,O),O=t.sub(O,F),F=t.mul(x,L),v=t.mul(N,v),v=t.add(v,F),new u(O,C,v)}subtract(f){return this.add(f.negate())}is0(){return this.equals(u.ZERO)}wNAF(f){return g.wNAFCached(this,f,u.normalizeZ)}multiplyUnsafe(f){let{endo:w,n:m}=e;vt("scalar",f,bt,m);let b=u.ZERO;if(f===bt)return b;if(this.is0()||f===ue)return this;if(!w||g.hasPrecomputes(this))return g.wNAFCachedUnsafe(this,f,u.normalizeZ);let{k1neg:_,k1:T,k2neg:P,k2:O}=w.splitScalar(f),C=b,v=b,k=this;for(;T>bt||O>bt;)T&ue&&(C=C.add(k)),O&ue&&(v=v.add(k)),k=k.double(),T>>=ue,O>>=ue;return _&&(C=C.negate()),P&&(v=v.negate()),v=new u(t.mul(v.px,w.beta),v.py,v.pz),C.add(v)}multiply(f){let{endo:w,n:m}=e;vt("scalar",f,ue,m);let b,_;if(w){let{k1neg:T,k1:P,k2neg:O,k2:C}=w.splitScalar(f),{p:v,f:k}=this.wNAF(P),{p:q,f:F}=this.wNAF(C);v=g.constTimeNegate(T,v),q=g.constTimeNegate(O,q),q=new u(t.mul(q.px,w.beta),q.py,q.pz),b=v.add(q),_=k.add(F)}else{let{p:T,f:P}=this.wNAF(f);b=T,_=P}return u.normalizeZ([b,_])[0]}multiplyAndAddUnsafe(f,w,m){let b=u.BASE,_=(P,O)=>O===bt||O===ue||!P.equals(b)?P.multiplyUnsafe(O):P.multiply(O),T=_(this,w).add(_(f,m));return T.is0()?void 0:T}toAffine(f){return l(this,f)}isTorsionFree(){let{h:f,isTorsionFree:w}=e;if(f===ue)return!0;if(w)return w(u,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){let{h:f,clearCofactor:w}=e;return f===ue?this:w?w(u,this):this.multiplyUnsafe(e.h)}toRawBytes(f=!0){return as("isCompressed",f),this.assertValidity(),r(u,this,f)}toHex(f=!0){return as("isCompressed",f),cs(this.toRawBytes(f))}}u.BASE=new u(e.Gx,e.Gy,t.ONE),u.ZERO=new u(t.ZERO,t.ONE,t.ZERO);let d=e.nBitLength,g=gu(u,e.endo?Math.ceil(d/2):d);return{CURVE:e,ProjectivePoint:u,normPrivateKeyToScalar:c,weierstrassEquation:o,isWithinCurveOrder:a}}function Ru(s){let e=rc(s);return us(e,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...e})}function xu(s){let e=Ru(s),{Fp:t,n:i}=e,r=t.BYTES+1,n=2*t.BYTES+1;function o(I){return Te(I,i)}function a(I){return Ar(I,i)}let{ProjectivePoint:c,normPrivateKeyToScalar:h,weierstrassEquation:l,isWithinCurveOrder:p}=Ou({...e,toBytes(I,x,R){let N=x.toAffine(),D=t.toBytes(N.x),S=Hs;return as("isCompressed",R),R?S(Uint8Array.from([x.hasEvenY()?2:3]),D):S(Uint8Array.from([4]),D,t.toBytes(N.y))},fromBytes(I){let x=I.length,R=I[0],N=I.subarray(1);if(x===r&&(R===2||R===3)){let D=zt(N);if(!Oi(D,ue,t.ORDER))throw new Error("Point is not on curve");let S=l(D),j;try{j=t.sqrt(S)}catch(M){let Z=M instanceof Error?": "+M.message:"";throw new Error("Point is not on curve"+Z)}let $=(j&ue)===ue;return(R&1)===1!==$&&(j=t.neg(j)),{x:D,y:j}}else if(x===n&&R===4){let D=t.fromBytes(N.subarray(0,t.BYTES)),S=t.fromBytes(N.subarray(t.BYTES,2*t.BYTES));return{x:D,y:S}}else{let D=r,S=n;throw new Error("invalid Point, expected length of "+D+", or uncompressed "+S+", got "+x)}}}),u=I=>cs(ls(I,e.nByteLength));function d(I){let x=i>>ue;return I>x}function g(I){return d(I)?o(-I):I}let y=(I,x,R)=>zt(I.slice(x,R));class f{constructor(x,R,N){this.r=x,this.s=R,this.recovery=N,this.assertValidity()}static fromCompact(x){let R=e.nByteLength;return x=Fe("compactSignature",x,R*2),new f(y(x,0,R),y(x,R,2*R))}static fromDER(x){let{r:R,s:N}=wt.toSig(Fe("DER",x));return new f(R,N)}assertValidity(){vt("r",this.r,ue,i),vt("s",this.s,ue,i)}addRecoveryBit(x){return new f(this.r,this.s,x)}recoverPublicKey(x){let{r:R,s:N,recovery:D}=this,S=P(Fe("msgHash",x));if(D==null||![0,1,2,3].includes(D))throw new Error("recovery id invalid");let j=D===2||D===3?R+e.n:R;if(j>=t.ORDER)throw new Error("recovery id 2 or 3 invalid");let $=D&1?"03":"02",M=c.fromHex($+u(j)),Z=a(j),J=o(-S*Z),ne=o(N*Z),pe=c.BASE.multiplyAndAddUnsafe(M,J,ne);if(!pe)throw new Error("point at infinify");return pe.assertValidity(),pe}hasHighS(){return d(this.s)}normalizeS(){return this.hasHighS()?new f(this.r,o(-this.s),this.recovery):this}toDERRawBytes(){return hs(this.toDERHex())}toDERHex(){return wt.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return hs(this.toCompactHex())}toCompactHex(){return u(this.r)+u(this.s)}}let w={isValidPrivateKey(I){try{return h(I),!0}catch{return!1}},normPrivateKeyToScalar:h,randomPrivateKey:()=>{let I=tc(e.n);return pu(e.randomBytes(I),e.n)},precompute(I=8,x=c.BASE){return x._setWindowSize(I),x.multiply(BigInt(3)),x}};function m(I,x=!0){return c.fromPrivateKey(I).toRawBytes(x)}function b(I){let x=Kt(I),R=typeof I=="string",N=(x||R)&&I.length;return x?N===r||N===n:R?N===2*r||N===2*n:I instanceof c}function _(I,x,R=!0){if(b(I))throw new Error("first arg must be private key");if(!b(x))throw new Error("second arg must be public key");return c.fromHex(x).multiply(h(I)).toRawBytes(R)}let T=e.bits2int||function(I){if(I.length>8192)throw new Error("input is too large");let x=zt(I),R=I.length*8-e.nBitLength;return R>0?x>>BigInt(R):x},P=e.bits2int_modN||function(I){return o(T(I))},O=Gr(e.nBitLength);function C(I){return vt("num < 2^"+e.nBitLength,I,bt,O),ls(I,e.nByteLength)}function v(I,x,R=k){if(["recovered","canonical"].some(ae=>ae in R))throw new Error("sign() legacy options not supported");let{hash:N,randomBytes:D}=e,{lowS:S,prehash:j,extraEntropy:$}=R;S==null&&(S=!0),I=Fe("msgHash",I),ga(R),j&&(I=Fe("prehashed msgHash",N(I)));let M=P(I),Z=h(x),J=[C(Z),C(M)];if($!=null&&$!==!1){let ae=$===!0?D(t.BYTES):$;J.push(Fe("extraEntropy",ae))}let ne=Hs(...J),pe=M;function Ee(ae){let ce=T(ae);if(!p(ce))return;let kt=a(ce),gt=c.BASE.multiply(ce).toAffine(),rt=o(gt.x);if(rt===bt)return;let ft=o(kt*o(pe+rt*Z));if(ft===bt)return;let Xt=(gt.x===rt?0:2)|Number(gt.y&ue),pi=ft;return S&&d(ft)&&(pi=g(ft),Xt^=1),new f(rt,pi,Xt)}return{seed:ne,k2sig:Ee}}let k={lowS:e.lowS,prehash:!1},q={lowS:e.lowS,prehash:!1};function F(I,x,R=k){let{seed:N,k2sig:D}=v(I,x,R),S=e;return Ja(S.hash.outputLen,S.nByteLength,S.hmac)(N,D)}c.BASE._setWindowSize(8);function L(I,x,R,N=q){let D=I;x=Fe("msgHash",x),R=Fe("publicKey",R);let{lowS:S,prehash:j,format:$}=N;if(ga(N),"strict"in N)throw new Error("options.strict was renamed to lowS");if($!==void 0&&$!=="compact"&&$!=="der")throw new Error("format must be compact or der");let M=typeof D=="string"||Kt(D),Z=!M&&!$&&typeof D=="object"&&D!==null&&typeof D.r=="bigint"&&typeof D.s=="bigint";if(!M&&!Z)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");let J,ne;try{if(Z&&(J=new f(D.r,D.s)),M){try{$!=="compact"&&(J=f.fromDER(D))}catch(ft){if(!(ft instanceof wt.Err))throw ft}!J&&$!=="der"&&(J=f.fromCompact(D))}ne=c.fromHex(R)}catch{return!1}if(!J||S&&J.hasHighS())return!1;j&&(x=e.hash(x));let{r:pe,s:Ee}=J,ae=P(x),ce=a(Ee),kt=o(ae*ce),gt=o(pe*ce),rt=c.BASE.multiplyAndAddUnsafe(ne,kt,gt)?.toAffine();return rt?o(rt.x)===pe:!1}return{CURVE:e,getPublicKey:m,getSharedSecret:_,sign:F,verify:L,ProjectivePoint:c,Signature:f,utils:w}}function Tu(s){return{hash:s,hmac:(e,...t)=>Ii(s,e,Ml(...t)),randomBytes:ps}}function Au(s,e){let t=i=>xu({...s,...Tu(i)});return{...t(e),create:t}}var nc=Za(BigInt("0xffffffff00000001000000000000000000000000ffffffffffffffffffffffff")),Cu=nc.create(BigInt("-3")),Nu=BigInt("0x5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63bce3c3e27d2604b"),qu=Au({a:Cu,b:Nu,Fp:nc,n:BigInt("0xffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551"),Gx:BigInt("0x6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296"),Gy:BigInt("0x4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececbb6406837bf51f5"),h:BigInt(1),lowS:!1},Xs),oc="base10",_e="base16",ke="base64pad",St="base64url",ei="utf8",ac=0,et=1,ds=2,Du=0,ma=1,$s=12,Wr=32;function cc(){let s=Nr.utils.randomPrivateKey(),e=Nr.getPublicKey(s);return{privateKey:Ie(s,_e),publicKey:Ie(e,_e)}}function Ri(){let s=ps(Wr);return Ie(s,_e)}function hc(s,e){let t=Nr.getSharedSecret(qe(s,_e),qe(e,_e)),i=Vp(Xs,t,void 0,void 0,Wr);return Ie(i,_e)}function gs(s){let e=Xs(qe(s,_e));return Ie(e,_e)}function ze(s){let e=Xs(qe(s,ei));return Ie(e,_e)}function lc(s){return qe(`${s}`,oc)}function Ct(s){return Number(Ie(s,oc))}function pc(s){return s.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function uc(s){let e=s.replace(/-/g,"+").replace(/_/g,"/"),t=(4-e.length%4)%4;return e+"=".repeat(t)}function dc(s){let e=lc(typeof s.type<"u"?s.type:ac);if(Ct(e)===et&&typeof s.senderPublicKey>"u")throw new Error("Missing sender public key for type 1 envelope");let t=typeof s.senderPublicKey<"u"?qe(s.senderPublicKey,_e):void 0,i=typeof s.iv<"u"?qe(s.iv,_e):ps($s),r=qe(s.symKey,_e),n=Wa(r,i).encrypt(qe(s.message,ei)),o=yc({type:e,sealed:n,iv:i,senderPublicKey:t});return s.encoding===St?pc(o):o}function gc(s){let e=qe(s.symKey,_e),{sealed:t,iv:i}=fs({encoded:s.encoded,encoding:s.encoding}),r=Wa(e,i).decrypt(t);if(r===null)throw new Error("Failed to decrypt");return Ie(r,ei)}function fc(s,e){let t=lc(ds),i=ps($s),r=qe(s,ei),n=yc({type:t,sealed:r,iv:i});return e===St?pc(n):n}function mc(s,e){let{sealed:t}=fs({encoded:s,encoding:e});return Ie(t,ei)}function yc(s){if(Ct(s.type)===ds)return Ie(Zt([s.type,s.sealed]),ke);if(Ct(s.type)===et){if(typeof s.senderPublicKey>"u")throw new Error("Missing sender public key for type 1 envelope");return Ie(Zt([s.type,s.senderPublicKey,s.iv,s.sealed]),ke)}return Ie(Zt([s.type,s.iv,s.sealed]),ke)}function fs(s){let e=(s.encoding||ke)===St?uc(s.encoded):s.encoded,t=qe(e,ke),i=t.slice(Du,ma),r=ma;if(Ct(i)===et){let c=r+Wr,h=c+$s,l=t.slice(r,c),p=t.slice(c,h),u=t.slice(h);return{type:i,sealed:u,iv:p,senderPublicKey:l}}if(Ct(i)===ds){let c=t.slice(r),h=ps($s);return{type:i,sealed:c,iv:h}}let n=r+$s,o=t.slice(r,n),a=t.slice(n);return{type:i,sealed:a,iv:o}}function wc(s,e){let t=fs({encoded:s,encoding:e?.encoding});return Yr({type:Ct(t.type),senderPublicKey:typeof t.senderPublicKey<"u"?Ie(t.senderPublicKey,_e):void 0,receiverPublicKey:e?.receiverPublicKey})}function Yr(s){let e=s?.type||ac;if(e===et){if(typeof s?.senderPublicKey>"u")throw new Error("missing sender public key");if(typeof s?.receiverPublicKey>"u")throw new Error("missing receiver public key")}return{type:e,senderPublicKey:s?.senderPublicKey,receiverPublicKey:s?.receiverPublicKey}}function Jr(s){return s.type===et&&typeof s.senderPublicKey=="string"&&typeof s.receiverPublicKey=="string"}function Qr(s){return s.type===ds}function Fu(s){let e=Buffer.from(s.x,"base64"),t=Buffer.from(s.y,"base64");return Zt([new Uint8Array([4]),e,t])}function bc(s,e){let[t,i,r]=s.split("."),n=Buffer.from(uc(r),"base64");if(n.length!==64)throw new Error("Invalid signature length");let o=n.slice(0,32),a=n.slice(32,64),c=`${t}.${i}`,h=Xs(c),l=Fu(e);if(!qu.verify(Zt([o,a]),h,l))throw new Error("Invalid signature");return Us(s).payload}var Uu="irn";function ti(s){return s?.relay||{protocol:Uu}}function ms(s){let e=Do[s];if(typeof e>"u")throw new Error(`Relay Protocol not supported: ${s}`);return e}function ku(s,e="-"){let t={},i="relay"+e;return Object.keys(s).forEach(r=>{if(r.startsWith(i)){let n=r.replace(i,""),o=s[r];t[n]=o}}),t}function Xr(s){if(!s.includes("wc:")){let h=qa(s);h!=null&&h.includes("wc:")&&(s=h)}s=s.includes("wc://")?s.replace("wc://",""):s,s=s.includes("wc:")?s.replace("wc:",""):s;let e=s.indexOf(":"),t=s.indexOf("?")!==-1?s.indexOf("?"):void 0,i=s.substring(0,e),r=s.substring(e+1,t).split("@"),n=typeof t<"u"?s.substring(t):"",o=new URLSearchParams(n),a={};o.forEach((h,l)=>{a[l]=h});let c=typeof a.methods=="string"?a.methods.split(","):void 0;return{protocol:i,topic:ju(r[0]),version:parseInt(r[1],10),symKey:a.symKey,relay:ku(a),methods:c,expiryTimestamp:a.expiryTimestamp?parseInt(a.expiryTimestamp,10):void 0}}function ju(s){return s.startsWith("//")?s.substring(2):s}function Lu(s,e="-"){let t="relay",i={};return Object.keys(s).forEach(r=>{let n=r,o=t+e+n;s[n]&&(i[o]=s[n])}),i}function Zr(s){let e=new URLSearchParams,t=Lu(s.relay);Object.keys(t).sort().forEach(r=>{e.set(r,t[r])}),e.set("symKey",s.symKey),s.expiryTimestamp&&e.set("expiryTimestamp",s.expiryTimestamp.toString()),s.methods&&e.set("methods",s.methods.join(","));let i=e.toString();return`${s.protocol}:${s.topic}@${s.version}?${i}`}function si(s,e,t){return`${s}?wc_ev=${t}&topic=${e}`}var $u=Object.defineProperty,Mu=Object.defineProperties,Bu=Object.getOwnPropertyDescriptors,ya=Object.getOwnPropertySymbols,Vu=Object.prototype.hasOwnProperty,zu=Object.prototype.propertyIsEnumerable,wa=(s,e,t)=>e in s?$u(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Hu=(s,e)=>{for(var t in e||(e={}))Vu.call(e,t)&&wa(s,t,e[t]);if(ya)for(var t of ya(e))zu.call(e,t)&&wa(s,t,e[t]);return s},Ku=(s,e)=>Mu(s,Bu(e));function ys(s){let e=[];return s.forEach(t=>{let[i,r]=t.split(":");e.push(`${i}:${r}`)}),e}function Gu(s){let e=[];return Object.values(s).forEach(t=>{e.push(...ys(t.accounts))}),e}function Wu(s,e){let t=[];return Object.values(s).forEach(i=>{ys(i.accounts).includes(e)&&t.push(...i.methods)}),t}function Yu(s,e){let t=[];return Object.values(s).forEach(i=>{ys(i.accounts).includes(e)&&t.push(...i.events)}),t}function ii(s){return s.includes(":")}function Wt(s){return ii(s)?s.split(":")[0]:s}function ba(s){var e,t,i;let r={};if(!ct(s))return r;for(let[n,o]of Object.entries(s)){let a=ii(n)?[n]:o.chains,c=o.methods||[],h=o.events||[],l=Wt(n);r[l]=Ku(Hu({},r[l]),{chains:Xe(a,(e=r[l])==null?void 0:e.chains),methods:Xe(c,(t=r[l])==null?void 0:t.methods),events:Xe(h,(i=r[l])==null?void 0:i.events)})}return r}function Ju(s){let e={};return s?.forEach(t=>{var i;let[r,n]=t.split(":");e[r]||(e[r]={accounts:[],chains:[],events:[],methods:[]}),e[r].accounts.push(t),(i=e[r].chains)==null||i.push(`${r}:${n}`)}),e}function en(s,e){e=e.map(i=>i.replace("did:pkh:",""));let t=Ju(e);for(let[i,r]of Object.entries(t))r.methods?r.methods=Xe(r.methods,s):r.methods=s,r.events=["chainChanged","accountsChanged"];return t}function vc(s,e){var t,i,r,n,o,a;let c=ba(s),h=ba(e),l={},p=Object.keys(c).concat(Object.keys(h));for(let u of p)l[u]={chains:Xe((t=c[u])==null?void 0:t.chains,(i=h[u])==null?void 0:i.chains),methods:Xe((r=c[u])==null?void 0:r.methods,(n=h[u])==null?void 0:n.methods),events:Xe((o=c[u])==null?void 0:o.events,(a=h[u])==null?void 0:a.events)};return l}var Qu={INVALID_METHOD:{message:"Invalid method.",code:1001},INVALID_EVENT:{message:"Invalid event.",code:1002},INVALID_UPDATE_REQUEST:{message:"Invalid update request.",code:1003},INVALID_EXTEND_REQUEST:{message:"Invalid extend request.",code:1004},INVALID_SESSION_SETTLE_REQUEST:{message:"Invalid session settle request.",code:1005},UNAUTHORIZED_METHOD:{message:"Unauthorized method.",code:3001},UNAUTHORIZED_EVENT:{message:"Unauthorized event.",code:3002},UNAUTHORIZED_UPDATE_REQUEST:{message:"Unauthorized update request.",code:3003},UNAUTHORIZED_EXTEND_REQUEST:{message:"Unauthorized extend request.",code:3004},USER_REJECTED:{message:"User rejected.",code:5e3},USER_REJECTED_CHAINS:{message:"User rejected chains.",code:5001},USER_REJECTED_METHODS:{message:"User rejected methods.",code:5002},USER_REJECTED_EVENTS:{message:"User rejected events.",code:5003},UNSUPPORTED_CHAINS:{message:"Unsupported chains.",code:5100},UNSUPPORTED_METHODS:{message:"Unsupported methods.",code:5101},UNSUPPORTED_EVENTS:{message:"Unsupported events.",code:5102},UNSUPPORTED_ACCOUNTS:{message:"Unsupported accounts.",code:5103},UNSUPPORTED_NAMESPACE_KEY:{message:"Unsupported namespace key.",code:5104},USER_DISCONNECTED:{message:"User disconnected.",code:6e3},SESSION_SETTLEMENT_FAILED:{message:"Session settlement failed.",code:7e3},WC_METHOD_UNSUPPORTED:{message:"Unsupported wc_ method.",code:10001}},Xu={NOT_INITIALIZED:{message:"Not initialized.",code:1},NO_MATCHING_KEY:{message:"No matching key.",code:2},RESTORE_WILL_OVERRIDE:{message:"Restore will override.",code:3},RESUBSCRIBED:{message:"Resubscribed.",code:4},MISSING_OR_INVALID:{message:"Missing or invalid.",code:5},EXPIRED:{message:"Expired.",code:6},UNKNOWN_TYPE:{message:"Unknown type.",code:7},MISMATCHED_TOPIC:{message:"Mismatched topic.",code:8},NON_CONFORMING_NAMESPACES:{message:"Non conforming namespaces.",code:9}};function A(s,e){let{message:t,code:i}=Xu[s];return{message:e?`${t} ${e}`:t,code:i}}function H(s,e){let{message:t,code:i}=Qu[s];return{message:e?`${t} ${e}`:t,code:i}}function Ce(s,e){return Array.isArray(s)?typeof e<"u"&&s.length?s.every(e):!0:!1}function ct(s){return Object.getPrototypeOf(s)===Object.prototype&&Object.keys(s).length}function he(s){return typeof s>"u"}function se(s,e){return e&&he(s)?!0:typeof s=="string"&&!!s.trim().length}function tn(s,e){return e&&he(s)?!0:typeof s=="number"&&!isNaN(s)}function Ec(s,e){let{requiredNamespaces:t}=e,i=Object.keys(s.namespaces),r=Object.keys(t),n=!0;return Vt(r,i)?(i.forEach(o=>{let{accounts:a,methods:c,events:h}=s.namespaces[o],l=ys(a),p=t[o];(!Vt(_a(o,p),l)||!Vt(p.methods,c)||!Vt(p.events,h))&&(n=!1)}),n):!1}function yi(s){return se(s,!1)&&s.includes(":")?s.split(":").length===2:!1}function Zu(s){if(se(s,!1)&&s.includes(":")){let e=s.split(":");if(e.length===3){let t=e[0]+":"+e[1];return!!e[2]&&yi(t)}}return!1}function Ic(s){function e(t){try{return typeof new URL(t)<"u"}catch{return!1}}try{if(se(s,!1)){if(e(s))return!0;let t=qa(s);return e(t)}}catch{}return!1}function _c(s){var e;return(e=s?.proposer)==null?void 0:e.publicKey}function Pc(s){return s?.topic}function Sc(s,e){let t=null;return se(s?.publicKey,!1)||(t=A("MISSING_OR_INVALID",`${e} controller public key should be a string`)),t}function va(s){let e=!0;return Ce(s)?s.length&&(e=s.every(t=>se(t,!1))):e=!1,e}function ed(s,e,t){let i=null;return Ce(e)&&e.length?e.forEach(r=>{i||yi(r)||(i=H("UNSUPPORTED_CHAINS",`${t}, chain ${r} should be a string and conform to "namespace:chainId" format`))}):yi(s)||(i=H("UNSUPPORTED_CHAINS",`${t}, chains must be defined as "namespace:chainId" e.g. "eip155:1": {...} in the namespace key OR as an array of CAIP-2 chainIds e.g. eip155: { chains: ["eip155:1", "eip155:5"] }`)),i}function td(s,e,t){let i=null;return Object.entries(s).forEach(([r,n])=>{if(i)return;let o=ed(r,_a(r,n),`${e} ${t}`);o&&(i=o)}),i}function sd(s,e){let t=null;return Ce(s)?s.forEach(i=>{t||Zu(i)||(t=H("UNSUPPORTED_ACCOUNTS",`${e}, account ${i} should be a string and conform to "namespace:chainId:address" format`))}):t=H("UNSUPPORTED_ACCOUNTS",`${e}, accounts should be an array of strings conforming to "namespace:chainId:address" format`),t}function id(s,e){let t=null;return Object.values(s).forEach(i=>{if(t)return;let r=sd(i?.accounts,`${e} namespace`);r&&(t=r)}),t}function rd(s,e){let t=null;return va(s?.methods)?va(s?.events)||(t=H("UNSUPPORTED_EVENTS",`${e}, events should be an array of strings or empty array for no events`)):t=H("UNSUPPORTED_METHODS",`${e}, methods should be an array of strings or empty array for no methods`),t}function Oc(s,e){let t=null;return Object.values(s).forEach(i=>{if(t)return;let r=rd(i,`${e}, namespace`);r&&(t=r)}),t}function Rc(s,e,t){let i=null;if(s&&ct(s)){let r=Oc(s,e);r&&(i=r);let n=td(s,e,t);n&&(i=n)}else i=A("MISSING_OR_INVALID",`${e}, ${t} should be an object with data`);return i}function xi(s,e){let t=null;if(s&&ct(s)){let i=Oc(s,e);i&&(t=i);let r=id(s,e);r&&(t=r)}else t=A("MISSING_OR_INVALID",`${e}, namespaces should be an object with data`);return t}function sn(s){return se(s.protocol,!0)}function xc(s,e){let t=!1;return e&&!s?t=!0:s&&Ce(s)&&s.length&&s.forEach(i=>{t=sn(i)}),t}function Tc(s){return typeof s=="number"}function Pe(s){return typeof s<"u"&&typeof s!==null}function Ac(s){return!(!s||typeof s!="object"||!s.code||!tn(s.code,!1)||!s.message||!se(s.message,!1))}function Cc(s){return!(he(s)||!se(s.method,!1))}function Nc(s){return!(he(s)||he(s.result)&&he(s.error)||!tn(s.id,!1)||!se(s.jsonrpc,!1))}function qc(s){return!(he(s)||!se(s.name,!1))}function rn(s,e){return!(!yi(e)||!Gu(s).includes(e))}function Dc(s,e,t){return se(t,!1)?Wu(s,e).includes(t):!1}function Fc(s,e,t){return se(t,!1)?Yu(s,e).includes(t):!1}function nn(s,e,t){let i=null,r=nd(s),n=od(e),o=Object.keys(r),a=Object.keys(n),c=Ea(Object.keys(s)),h=Ea(Object.keys(e)),l=c.filter(p=>!h.includes(p));return l.length&&(i=A("NON_CONFORMING_NAMESPACES",`${t} namespaces keys don't satisfy requiredNamespaces.
      Required: ${l.toString()}
      Received: ${Object.keys(e).toString()}`)),Vt(o,a)||(i=A("NON_CONFORMING_NAMESPACES",`${t} namespaces chains don't satisfy required namespaces.
      Required: ${o.toString()}
      Approved: ${a.toString()}`)),Object.keys(e).forEach(p=>{if(!p.includes(":")||i)return;let u=ys(e[p].accounts);u.includes(p)||(i=A("NON_CONFORMING_NAMESPACES",`${t} namespaces accounts don't satisfy namespace accounts for ${p}
        Required: ${p}
        Approved: ${u.toString()}`))}),o.forEach(p=>{i||(Vt(r[p].methods,n[p].methods)?Vt(r[p].events,n[p].events)||(i=A("NON_CONFORMING_NAMESPACES",`${t} namespaces events don't satisfy namespace events for ${p}`)):i=A("NON_CONFORMING_NAMESPACES",`${t} namespaces methods don't satisfy namespace methods for ${p}`))}),i}function nd(s){let e={};return Object.keys(s).forEach(t=>{var i;t.includes(":")?e[t]=s[t]:(i=s[t].chains)==null||i.forEach(r=>{e[r]={methods:s[t].methods,events:s[t].events}})}),e}function Ea(s){return[...new Set(s.map(e=>e.includes(":")?e.split(":")[0]:e))]}function od(s){let e={};return Object.keys(s).forEach(t=>{t.includes(":")?e[t]=s[t]:ys(s[t].accounts)?.forEach(r=>{e[r]={accounts:s[t].accounts.filter(n=>n.includes(`${r}:`)),methods:s[t].methods,events:s[t].events}})}),e}function Uc(s,e){return tn(s,!1)&&s<=e.max&&s>=e.min}function on(){let s=Gs();return new Promise(e=>{switch(s){case Ae.browser:e(ad());break;case Ae.reactNative:e(cd());break;case Ae.node:e(hd());break;default:e(!0)}})}function ad(){return Gt()&&navigator?.onLine}async function cd(){return It()&&typeof global<"u"&&global!=null&&global.NetInfo?(await(global==null?void 0:global.NetInfo.fetch()))?.isConnected:!0}function hd(){return!0}function kc(s){switch(Gs()){case Ae.browser:ld(s);break;case Ae.reactNative:pd(s);break;case Ae.node:break}}function ld(s){!It()&&Gt()&&(window.addEventListener("online",()=>s(!0)),window.addEventListener("offline",()=>s(!1)))}function pd(s){It()&&typeof global<"u"&&global!=null&&global.NetInfo&&global?.NetInfo.addEventListener(e=>s(e?.isConnected))}function jc(){var s;return Gt()&&(0,Ze.getDocument)()?((s=(0,Ze.getDocument)())==null?void 0:s.visibilityState)==="visible":!0}var vr={},Nt=class{static get(e){return vr[e]}static set(e,t){vr[e]=t}static delete(e){delete vr[e]}};var Ot=Ye(Fs());var Mc=Ye(Fs()),ud=Object.defineProperty,dd=(s,e,t)=>e in s?ud(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Lc=(s,e,t)=>dd(s,typeof e!="symbol"?e+"":e,t),Ti=class extends jt{constructor(e){super(),this.opts=e,Lc(this,"protocol","wc"),Lc(this,"version",2)}};var gd=Object.defineProperty,fd=(s,e,t)=>e in s?gd(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,md=(s,e,t)=>fd(s,typeof e!="symbol"?e+"":e,t),Ai=class extends jt{constructor(e,t){super(),this.core=e,this.logger=t,md(this,"records",new Map)}},Ci=class{constructor(e,t){this.logger=e,this.core=t}},Ni=class extends jt{constructor(e,t){super(),this.relayer=e,this.logger=t}},qi=class extends jt{constructor(e){super()}},Di=class{constructor(e,t,i,r){this.core=e,this.logger=t,this.name=i}};var Fi=class extends jt{constructor(e,t){super(),this.relayer=e,this.logger=t}};var Ui=class extends jt{constructor(e,t){super(),this.core=e,this.logger=t}};var ki=class{constructor(e,t,i){this.core=e,this.logger=t,this.store=i}},ji=class{constructor(e,t){this.projectId=e,this.logger=t}},Li=class{constructor(e,t,i){this.core=e,this.logger=t,this.telemetryEnabled=i}},yd=Object.defineProperty,wd=(s,e,t)=>e in s?yd(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,$c=(s,e,t)=>wd(s,typeof e!="symbol"?e+"":e,t);var $i=class{constructor(e){this.opts=e,$c(this,"protocol","wc"),$c(this,"version",2)}};var Mi=class{constructor(e){this.client=e}};var U=Ye(sr());var uh=Ye(Ro()),dh="wc",gh=2,zi="core",pt=`${dh}@2:${zi}:`,bd={name:zi,logger:"error"},vd={database:":memory:"},Ed="crypto",Bc="client_ed25519_seed",Id=U.ONE_DAY,_d="keychain",Pd="0.3",Sd="messages",Od="0.3",Vc=U.SIX_HOURS,Rd="publisher",Mn="irn",xd="error",fh="wss://relay.walletconnect.org",Td="relayer",le={message:"relayer_message",message_ack:"relayer_message_ack",connect:"relayer_connect",disconnect:"relayer_disconnect",error:"relayer_error",connection_stalled:"relayer_connection_stalled",transport_closed:"relayer_transport_closed",publish:"relayer_publish"},Ad="_subscription",He={payload:"payload",connect:"connect",disconnect:"disconnect",error:"error"},Cd=.1;var pn="2.21.1";var te={link_mode:"link_mode",relay:"relay"},Vi={inbound:"inbound",outbound:"outbound"},Nd="0.3",qd="WALLETCONNECT_CLIENT_ID",zc="WALLETCONNECT_LINK_MODE_APPS",Le={created:"subscription_created",deleted:"subscription_deleted",expired:"subscription_expired",disabled:"subscription_disabled",sync:"subscription_sync",resubscribed:"subscription_resubscribed"};var Dd="subscription",Fd="0.3",vb=U.FIVE_SECONDS*1e3,Ud="pairing",kd="0.3";var ri={wc_pairingDelete:{req:{ttl:U.ONE_DAY,prompt:!1,tag:1e3},res:{ttl:U.ONE_DAY,prompt:!1,tag:1001}},wc_pairingPing:{req:{ttl:U.THIRTY_SECONDS,prompt:!1,tag:1002},res:{ttl:U.THIRTY_SECONDS,prompt:!1,tag:1003}},unregistered_method:{req:{ttl:U.ONE_DAY,prompt:!1,tag:0},res:{ttl:U.ONE_DAY,prompt:!1,tag:0}}},Dt={create:"pairing_create",expire:"pairing_expire",delete:"pairing_delete",ping:"pairing_ping"},tt={created:"history_created",updated:"history_updated",deleted:"history_deleted",sync:"history_sync"},jd="history",Ld="0.3",$d="expirer",$e={created:"expirer_created",deleted:"expirer_deleted",expired:"expirer_expired",sync:"expirer_sync"},Md="0.3";var Bd="verify-api",Vd="https://verify.walletconnect.com",mh="https://verify.walletconnect.org",bs=mh,zd=`${bs}/v3`,Hd=[Vd,mh],Kd="echo",Gd="https://echo.walletconnect.com";var it={pairing_started:"pairing_started",pairing_uri_validation_success:"pairing_uri_validation_success",pairing_uri_not_expired:"pairing_uri_not_expired",store_new_pairing:"store_new_pairing",subscribing_pairing_topic:"subscribing_pairing_topic",subscribe_pairing_topic_success:"subscribe_pairing_topic_success",existing_pairing:"existing_pairing",pairing_not_expired:"pairing_not_expired",emit_inactive_pairing:"emit_inactive_pairing",emit_session_proposal:"emit_session_proposal",subscribing_to_pairing_topic:"subscribing_to_pairing_topic"},lt={no_wss_connection:"no_wss_connection",no_internet_connection:"no_internet_connection",malformed_pairing_uri:"malformed_pairing_uri",active_pairing_already_exists:"active_pairing_already_exists",subscribe_pairing_topic_failure:"subscribe_pairing_topic_failure",pairing_expired:"pairing_expired",proposal_expired:"proposal_expired",proposal_listener_not_found:"proposal_listener_not_found"},Ke={session_approve_started:"session_approve_started",proposal_not_expired:"proposal_not_expired",session_namespaces_validation_success:"session_namespaces_validation_success",create_session_topic:"create_session_topic",subscribing_session_topic:"subscribing_session_topic",subscribe_session_topic_success:"subscribe_session_topic_success",publishing_session_approve:"publishing_session_approve",session_approve_publish_success:"session_approve_publish_success",store_session:"store_session",publishing_session_settle:"publishing_session_settle",session_settle_publish_success:"session_settle_publish_success"},Ft={no_internet_connection:"no_internet_connection",no_wss_connection:"no_wss_connection",proposal_expired:"proposal_expired",subscribe_session_topic_failure:"subscribe_session_topic_failure",session_approve_publish_failure:"session_approve_publish_failure",session_settle_publish_failure:"session_settle_publish_failure",session_approve_namespace_validation_failure:"session_approve_namespace_validation_failure",proposal_not_found:"proposal_not_found"},Ut={authenticated_session_approve_started:"authenticated_session_approve_started",authenticated_session_not_expired:"authenticated_session_not_expired",chains_caip2_compliant:"chains_caip2_compliant",chains_evm_compliant:"chains_evm_compliant",create_authenticated_session_topic:"create_authenticated_session_topic",cacaos_verified:"cacaos_verified",store_authenticated_session:"store_authenticated_session",subscribing_authenticated_session_topic:"subscribing_authenticated_session_topic",subscribe_authenticated_session_topic_success:"subscribe_authenticated_session_topic_success",publishing_authenticated_session_approve:"publishing_authenticated_session_approve",authenticated_session_approve_publish_success:"authenticated_session_approve_publish_success"},vs={no_internet_connection:"no_internet_connection",no_wss_connection:"no_wss_connection",missing_session_authenticate_request:"missing_session_authenticate_request",session_authenticate_request_expired:"session_authenticate_request_expired",chains_caip2_compliant_failure:"chains_caip2_compliant_failure",chains_evm_compliant_failure:"chains_evm_compliant_failure",invalid_cacao:"invalid_cacao",subscribe_authenticated_session_topic_failure:"subscribe_authenticated_session_topic_failure",authenticated_session_approve_publish_failure:"authenticated_session_approve_publish_failure",authenticated_session_pending_request_not_found:"authenticated_session_pending_request_not_found"},Wd=.1,Yd="event-client",Jd=86400,Qd="https://pulse.walletconnect.org/batch";function Xd(s,e){if(s.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),i=0;i<t.length;i++)t[i]=255;for(var r=0;r<s.length;r++){var n=s.charAt(r),o=n.charCodeAt(0);if(t[o]!==255)throw new TypeError(n+" is ambiguous");t[o]=r}var a=s.length,c=s.charAt(0),h=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function p(g){if(g instanceof Uint8Array||(ArrayBuffer.isView(g)?g=new Uint8Array(g.buffer,g.byteOffset,g.byteLength):Array.isArray(g)&&(g=Uint8Array.from(g))),!(g instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(g.length===0)return"";for(var y=0,f=0,w=0,m=g.length;w!==m&&g[w]===0;)w++,y++;for(var b=(m-w)*l+1>>>0,_=new Uint8Array(b);w!==m;){for(var T=g[w],P=0,O=b-1;(T!==0||P<f)&&O!==-1;O--,P++)T+=256*_[O]>>>0,_[O]=T%a>>>0,T=T/a>>>0;if(T!==0)throw new Error("Non-zero carry");f=P,w++}for(var C=b-f;C!==b&&_[C]===0;)C++;for(var v=c.repeat(y);C<b;++C)v+=s.charAt(_[C]);return v}function u(g){if(typeof g!="string")throw new TypeError("Expected String");if(g.length===0)return new Uint8Array;var y=0;if(g[y]!==" "){for(var f=0,w=0;g[y]===c;)f++,y++;for(var m=(g.length-y)*h+1>>>0,b=new Uint8Array(m);g[y];){var _=t[g.charCodeAt(y)];if(_===255)return;for(var T=0,P=m-1;(_!==0||T<w)&&P!==-1;P--,T++)_+=a*b[P]>>>0,b[P]=_%256>>>0,_=_/256>>>0;if(_!==0)throw new Error("Non-zero carry");w=T,y++}if(g[y]!==" "){for(var O=m-w;O!==m&&b[O]===0;)O++;for(var C=new Uint8Array(f+(m-O)),v=f;O!==m;)C[v++]=b[O++];return C}}}function d(g){var y=u(g);if(y)return y;throw new Error(`Non-${e} character`)}return{encode:p,decodeUnsafe:u,decode:d}}var Zd=Xd,eg=Zd,yh=s=>{if(s instanceof Uint8Array&&s.constructor.name==="Uint8Array")return s;if(s instanceof ArrayBuffer)return new Uint8Array(s);if(ArrayBuffer.isView(s))return new Uint8Array(s.buffer,s.byteOffset,s.byteLength);throw new Error("Unknown type, must be binary type")},tg=s=>new TextEncoder().encode(s),sg=s=>new TextDecoder().decode(s),un=class{constructor(e,t,i){this.name=e,this.prefix=t,this.baseEncode=i}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},dn=class{constructor(e,t,i){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=i}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return wh(this,e)}},gn=class{constructor(e){this.decoders=e}or(e){return wh(this,e)}decode(e){let t=e[0],i=this.decoders[t];if(i)return i.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}},wh=(s,e)=>new gn({...s.decoders||{[s.prefix]:s},...e.decoders||{[e.prefix]:e}}),fn=class{constructor(e,t,i,r){this.name=e,this.prefix=t,this.baseEncode=i,this.baseDecode=r,this.encoder=new un(e,t,i),this.decoder=new dn(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}},Hi=({name:s,prefix:e,encode:t,decode:i})=>new fn(s,e,t,i),hi=({prefix:s,name:e,alphabet:t})=>{let{encode:i,decode:r}=eg(t,e);return Hi({prefix:s,name:e,encode:i,decode:n=>yh(r(n))})},ig=(s,e,t,i)=>{let r={};for(let l=0;l<e.length;++l)r[e[l]]=l;let n=s.length;for(;s[n-1]==="=";)--n;let o=new Uint8Array(n*t/8|0),a=0,c=0,h=0;for(let l=0;l<n;++l){let p=r[s[l]];if(p===void 0)throw new SyntaxError(`Non-${i} character`);c=c<<t|p,a+=t,a>=8&&(a-=8,o[h++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},rg=(s,e,t)=>{let i=e[e.length-1]==="=",r=(1<<t)-1,n="",o=0,a=0;for(let c=0;c<s.length;++c)for(a=a<<8|s[c],o+=8;o>t;)o-=t,n+=e[r&a>>o];if(o&&(n+=e[r&a<<t-o]),i)for(;n.length*t&7;)n+="=";return n},ve=({name:s,prefix:e,bitsPerChar:t,alphabet:i})=>Hi({prefix:e,name:s,encode(r){return rg(r,i,t)},decode(r){return ig(r,i,t,s)}}),ng=Hi({prefix:"\0",name:"identity",encode:s=>sg(s),decode:s=>tg(s)}),og=Object.freeze({__proto__:null,identity:ng}),ag=ve({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),cg=Object.freeze({__proto__:null,base2:ag}),hg=ve({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),lg=Object.freeze({__proto__:null,base8:hg}),pg=hi({prefix:"9",name:"base10",alphabet:"0123456789"}),ug=Object.freeze({__proto__:null,base10:pg}),dg=ve({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),gg=ve({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),fg=Object.freeze({__proto__:null,base16:dg,base16upper:gg}),mg=ve({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),yg=ve({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),wg=ve({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),bg=ve({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),vg=ve({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Eg=ve({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Ig=ve({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),_g=ve({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Pg=ve({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),Sg=Object.freeze({__proto__:null,base32:mg,base32upper:yg,base32pad:wg,base32padupper:bg,base32hex:vg,base32hexupper:Eg,base32hexpad:Ig,base32hexpadupper:_g,base32z:Pg}),Og=hi({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Rg=hi({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),xg=Object.freeze({__proto__:null,base36:Og,base36upper:Rg}),Tg=hi({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Ag=hi({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),Cg=Object.freeze({__proto__:null,base58btc:Tg,base58flickr:Ag}),Ng=ve({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),qg=ve({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Dg=ve({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Fg=ve({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),Ug=Object.freeze({__proto__:null,base64:Ng,base64pad:qg,base64url:Dg,base64urlpad:Fg}),bh=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),kg=bh.reduce((s,e,t)=>(s[t]=e,s),[]),jg=bh.reduce((s,e,t)=>(s[e.codePointAt(0)]=t,s),[]);function Lg(s){return s.reduce((e,t)=>(e+=kg[t],e),"")}function $g(s){let e=[];for(let t of s){let i=jg[t.codePointAt(0)];if(i===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(i)}return new Uint8Array(e)}var Mg=Hi({prefix:"\u{1F680}",name:"base256emoji",encode:Lg,decode:$g}),Bg=Object.freeze({__proto__:null,base256emoji:Mg}),Vg=vh,Hc=128,zg=127,Hg=~zg,Kg=Math.pow(2,31);function vh(s,e,t){e=e||[],t=t||0;for(var i=t;s>=Kg;)e[t++]=s&255|Hc,s/=128;for(;s&Hg;)e[t++]=s&255|Hc,s>>>=7;return e[t]=s|0,vh.bytes=t-i+1,e}var Gg=mn,Wg=128,Kc=127;function mn(s,i){var t=0,i=i||0,r=0,n=i,o,a=s.length;do{if(n>=a)throw mn.bytes=0,new RangeError("Could not decode varint");o=s[n++],t+=r<28?(o&Kc)<<r:(o&Kc)*Math.pow(2,r),r+=7}while(o>=Wg);return mn.bytes=n-i,t}var Yg=Math.pow(2,7),Jg=Math.pow(2,14),Qg=Math.pow(2,21),Xg=Math.pow(2,28),Zg=Math.pow(2,35),ef=Math.pow(2,42),tf=Math.pow(2,49),sf=Math.pow(2,56),rf=Math.pow(2,63),nf=function(s){return s<Yg?1:s<Jg?2:s<Qg?3:s<Xg?4:s<Zg?5:s<ef?6:s<tf?7:s<sf?8:s<rf?9:10},of={encode:Vg,decode:Gg,encodingLength:nf},Eh=of,Gc=(s,e,t=0)=>(Eh.encode(s,e,t),e),Wc=s=>Eh.encodingLength(s),yn=(s,e)=>{let t=e.byteLength,i=Wc(s),r=i+Wc(t),n=new Uint8Array(r+t);return Gc(s,n,0),Gc(t,n,i),n.set(e,r),new wn(s,t,e,n)},wn=class{constructor(e,t,i,r){this.code=e,this.size=t,this.digest=i,this.bytes=r}},Ih=({name:s,code:e,encode:t})=>new bn(s,e,t),bn=class{constructor(e,t,i){this.name=e,this.code=t,this.encode=i}digest(e){if(e instanceof Uint8Array){let t=this.encode(e);return t instanceof Uint8Array?yn(this.code,t):t.then(i=>yn(this.code,i))}else throw Error("Unknown type, must be binary type")}},_h=s=>async e=>new Uint8Array(await crypto.subtle.digest(s,e)),af=Ih({name:"sha2-256",code:18,encode:_h("SHA-256")}),cf=Ih({name:"sha2-512",code:19,encode:_h("SHA-512")}),hf=Object.freeze({__proto__:null,sha256:af,sha512:cf}),Ph=0,lf="identity",Sh=yh,pf=s=>yn(Ph,Sh(s)),uf={code:Ph,name:lf,encode:Sh,digest:pf},df=Object.freeze({__proto__:null,identity:uf});new TextEncoder,new TextDecoder;var Yc={...og,...cg,...lg,...ug,...fg,...Sg,...xg,...Cg,...Ug,...Bg};({...hf,...df});function gf(s=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?globalThis.Buffer.allocUnsafe(s):new Uint8Array(s)}function Oh(s,e,t,i){return{name:s,prefix:e,encoder:{name:s,prefix:e,encode:t},decoder:{decode:i}}}var Jc=Oh("utf8","u",s=>"u"+new TextDecoder("utf8").decode(s),s=>new TextEncoder().encode(s.substring(1))),an=Oh("ascii","a",s=>{let e="a";for(let t=0;t<s.length;t++)e+=String.fromCharCode(s[t]);return e},s=>{s=s.substring(1);let e=gf(s.length);for(let t=0;t<s.length;t++)e[t]=s.charCodeAt(t);return e}),ff={utf8:Jc,"utf-8":Jc,hex:Yc.base16,latin1:an,ascii:an,binary:an,...Yc};function mf(s,e="utf8"){let t=ff[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(s,"utf8"):t.decoder.decode(`${t.prefix}${s}`)}var yf=Object.defineProperty,wf=(s,e,t)=>e in s?yf(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ht=(s,e,t)=>wf(s,typeof e!="symbol"?e+"":e,t),vn=class{constructor(e,t){this.core=e,this.logger=t,ht(this,"keychain",new Map),ht(this,"name",_d),ht(this,"version",Pd),ht(this,"initialized",!1),ht(this,"storagePrefix",pt),ht(this,"init",async()=>{if(!this.initialized){let i=await this.getKeyChain();typeof i<"u"&&(this.keychain=i),this.initialized=!0}}),ht(this,"has",i=>(this.isInitialized(),this.keychain.has(i))),ht(this,"set",async(i,r)=>{this.isInitialized(),this.keychain.set(i,r),await this.persist()}),ht(this,"get",i=>{this.isInitialized();let r=this.keychain.get(i);if(typeof r>"u"){let{message:n}=A("NO_MATCHING_KEY",`${this.name}: ${i}`);throw new Error(n)}return r}),ht(this,"del",async i=>{this.isInitialized(),this.keychain.delete(i),await this.persist()}),this.core=e,this.logger=me(t,this.name)}get context(){return Oe(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}async setKeyChain(e){await this.core.storage.setItem(this.storageKey,wi(e))}async getKeyChain(){let e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?bi(e):void 0}async persist(){await this.setKeyChain(this.keychain)}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}},bf=Object.defineProperty,vf=(s,e,t)=>e in s?bf(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,we=(s,e,t)=>vf(s,typeof e!="symbol"?e+"":e,t),En=class{constructor(e,t,i){this.core=e,this.logger=t,we(this,"name",Ed),we(this,"keychain"),we(this,"randomSessionIdentifier",Ri()),we(this,"initialized",!1),we(this,"init",async()=>{this.initialized||(await this.keychain.init(),this.initialized=!0)}),we(this,"hasKeys",r=>(this.isInitialized(),this.keychain.has(r))),we(this,"getClientId",async()=>{this.isInitialized();let r=await this.getClientSeed(),n=ar(r);return No(n.publicKey)}),we(this,"generateKeyPair",()=>{this.isInitialized();let r=cc();return this.setPrivateKey(r.publicKey,r.privateKey)}),we(this,"signJWT",async r=>{this.isInitialized();let n=await this.getClientSeed(),o=ar(n),a=this.randomSessionIdentifier;return await qo(a,r,Id,o)}),we(this,"generateSharedKey",(r,n,o)=>{this.isInitialized();let a=this.getPrivateKey(r),c=hc(a,n);return this.setSymKey(c,o)}),we(this,"setSymKey",async(r,n)=>{this.isInitialized();let o=n||gs(r);return await this.keychain.set(o,r),o}),we(this,"deleteKeyPair",async r=>{this.isInitialized(),await this.keychain.del(r)}),we(this,"deleteSymKey",async r=>{this.isInitialized(),await this.keychain.del(r)}),we(this,"encode",async(r,n,o)=>{this.isInitialized();let a=Yr(o),c=Co(n);if(Qr(a))return fc(c,o?.encoding);if(Jr(a)){let u=a.senderPublicKey,d=a.receiverPublicKey;r=await this.generateSharedKey(u,d)}let h=this.getSymKey(r),{type:l,senderPublicKey:p}=a;return dc({type:l,symKey:h,message:c,senderPublicKey:p,encoding:o?.encoding})}),we(this,"decode",async(r,n,o)=>{this.isInitialized();let a=wc(n,o);if(Qr(a)){let c=mc(n,o?.encoding);return or(c)}if(Jr(a)){let c=a.receiverPublicKey,h=a.senderPublicKey;r=await this.generateSharedKey(c,h)}try{let c=this.getSymKey(r),h=gc({symKey:c,encoded:n,encoding:o?.encoding});return or(h)}catch(c){this.logger.error(`Failed to decode message from topic: '${r}', clientId: '${await this.getClientId()}'`),this.logger.error(c)}}),we(this,"getPayloadType",(r,n=ke)=>{let o=fs({encoded:r,encoding:n});return Ct(o.type)}),we(this,"getPayloadSenderPublicKey",(r,n=ke)=>{let o=fs({encoded:r,encoding:n});return o.senderPublicKey?Ie(o.senderPublicKey,_e):void 0}),this.core=e,this.logger=me(t,this.name),this.keychain=i||new vn(this.core,this.logger)}get context(){return Oe(this.logger)}async setPrivateKey(e,t){return await this.keychain.set(e,t),e}getPrivateKey(e){return this.keychain.get(e)}async getClientSeed(){let e="";try{e=this.keychain.get(Bc)}catch{e=Ri(),await this.keychain.set(Bc,e)}return mf(e,"base16")}getSymKey(e){return this.keychain.get(e)}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}},Ef=Object.defineProperty,If=Object.defineProperties,_f=Object.getOwnPropertyDescriptors,Qc=Object.getOwnPropertySymbols,Pf=Object.prototype.hasOwnProperty,Sf=Object.prototype.propertyIsEnumerable,In=(s,e,t)=>e in s?Ef(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Of=(s,e)=>{for(var t in e||(e={}))Pf.call(e,t)&&In(s,t,e[t]);if(Qc)for(var t of Qc(e))Sf.call(e,t)&&In(s,t,e[t]);return s},Rf=(s,e)=>If(s,_f(e)),je=(s,e,t)=>In(s,typeof e!="symbol"?e+"":e,t),_n=class extends Ci{constructor(e,t){super(e,t),this.logger=e,this.core=t,je(this,"messages",new Map),je(this,"messagesWithoutClientAck",new Map),je(this,"name",Sd),je(this,"version",Od),je(this,"initialized",!1),je(this,"storagePrefix",pt),je(this,"init",async()=>{if(!this.initialized){this.logger.trace("Initialized");try{let i=await this.getRelayerMessages();typeof i<"u"&&(this.messages=i);let r=await this.getRelayerMessagesWithoutClientAck();typeof r<"u"&&(this.messagesWithoutClientAck=r),this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",size:this.messages.size})}catch(i){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(i)}finally{this.initialized=!0}}}),je(this,"set",async(i,r,n)=>{this.isInitialized();let o=ze(r),a=this.messages.get(i);if(typeof a>"u"&&(a={}),typeof a[o]<"u")return o;if(a[o]=r,this.messages.set(i,a),n===Vi.inbound){let c=this.messagesWithoutClientAck.get(i)||{};this.messagesWithoutClientAck.set(i,Rf(Of({},c),{[o]:r}))}return await this.persist(),o}),je(this,"get",i=>{this.isInitialized();let r=this.messages.get(i);return typeof r>"u"&&(r={}),r}),je(this,"getWithoutAck",i=>{this.isInitialized();let r={};for(let n of i){let o=this.messagesWithoutClientAck.get(n)||{};r[n]=Object.values(o)}return r}),je(this,"has",(i,r)=>{this.isInitialized();let n=this.get(i),o=ze(r);return typeof n[o]<"u"}),je(this,"ack",async(i,r)=>{this.isInitialized();let n=this.messagesWithoutClientAck.get(i);if(typeof n>"u")return;let o=ze(r);delete n[o],Object.keys(n).length===0?this.messagesWithoutClientAck.delete(i):this.messagesWithoutClientAck.set(i,n),await this.persist()}),je(this,"del",async i=>{this.isInitialized(),this.messages.delete(i),this.messagesWithoutClientAck.delete(i),await this.persist()}),this.logger=me(e,this.name),this.core=t}get context(){return Oe(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get storageKeyWithoutClientAck(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name+"_withoutClientAck"}async setRelayerMessages(e){await this.core.storage.setItem(this.storageKey,wi(e))}async setRelayerMessagesWithoutClientAck(e){await this.core.storage.setItem(this.storageKeyWithoutClientAck,wi(e))}async getRelayerMessages(){let e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?bi(e):void 0}async getRelayerMessagesWithoutClientAck(){let e=await this.core.storage.getItem(this.storageKeyWithoutClientAck);return typeof e<"u"?bi(e):void 0}async persist(){await this.setRelayerMessages(this.messages),await this.setRelayerMessagesWithoutClientAck(this.messagesWithoutClientAck)}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}},xf=Object.defineProperty,Tf=Object.defineProperties,Af=Object.getOwnPropertyDescriptors,Xc=Object.getOwnPropertySymbols,Cf=Object.prototype.hasOwnProperty,Nf=Object.prototype.propertyIsEnumerable,Pn=(s,e,t)=>e in s?xf(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Bi=(s,e)=>{for(var t in e||(e={}))Cf.call(e,t)&&Pn(s,t,e[t]);if(Xc)for(var t of Xc(e))Nf.call(e,t)&&Pn(s,t,e[t]);return s},cn=(s,e)=>Tf(s,Af(e)),st=(s,e,t)=>Pn(s,typeof e!="symbol"?e+"":e,t),Sn=class extends Ni{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,st(this,"events",new Ot.EventEmitter),st(this,"name",Rd),st(this,"queue",new Map),st(this,"publishTimeout",(0,U.toMiliseconds)(U.ONE_MINUTE)),st(this,"initialPublishTimeout",(0,U.toMiliseconds)(U.ONE_SECOND*15)),st(this,"needsTransportRestart",!1),st(this,"publish",async(i,r,n)=>{var o;this.logger.debug("Publishing Payload"),this.logger.trace({type:"method",method:"publish",params:{topic:i,message:r,opts:n}});let a=n?.ttl||Vc,c=ti(n),h=n?.prompt||!1,l=n?.tag||0,p=n?.id||Rt().toString(),u={topic:i,message:r,opts:{ttl:a,relay:c,prompt:h,tag:l,id:p,attestation:n?.attestation,tvf:n?.tvf}},d=`Failed to publish payload, please try again. id:${p} tag:${l}`;try{let g=new Promise(async y=>{let f=({id:m})=>{u.opts.id===m&&(this.removeRequestFromQueue(m),this.relayer.events.removeListener(le.publish,f),y(u))};this.relayer.events.on(le.publish,f);let w=Pt(new Promise((m,b)=>{this.rpcPublish({topic:i,message:r,ttl:a,prompt:h,tag:l,id:p,attestation:n?.attestation,tvf:n?.tvf}).then(m).catch(_=>{this.logger.warn(_,_?.message),b(_)})}),this.initialPublishTimeout,`Failed initial publish, retrying.... id:${p} tag:${l}`);try{await w,this.events.removeListener(le.publish,f)}catch(m){this.queue.set(p,cn(Bi({},u),{attempt:1})),this.logger.warn(m,m?.message)}});this.logger.trace({type:"method",method:"publish",params:{id:p,topic:i,message:r,opts:n}}),await Pt(g,this.publishTimeout,d)}catch(g){if(this.logger.debug("Failed to Publish Payload"),this.logger.error(g),(o=n?.internal)!=null&&o.throwOnFailedPublish)throw g}finally{this.queue.delete(p)}}),st(this,"on",(i,r)=>{this.events.on(i,r)}),st(this,"once",(i,r)=>{this.events.once(i,r)}),st(this,"off",(i,r)=>{this.events.off(i,r)}),st(this,"removeListener",(i,r)=>{this.events.removeListener(i,r)}),this.relayer=e,this.logger=me(t,this.name),this.registerEventListeners()}get context(){return Oe(this.logger)}async rpcPublish(e){var t,i,r,n;let{topic:o,message:a,ttl:c=Vc,prompt:h,tag:l,id:p,attestation:u,tvf:d}=e,g={method:ms(ti().protocol).publish,params:Bi({topic:o,message:a,ttl:c,prompt:h,tag:l,attestation:u},d),id:p};he((t=g.params)==null?void 0:t.prompt)&&((i=g.params)==null||delete i.prompt),he((r=g.params)==null?void 0:r.tag)&&((n=g.params)==null||delete n.tag),this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"message",direction:"outgoing",request:g});let y=await this.relayer.request(g);return this.relayer.events.emit(le.publish,e),this.logger.debug("Successfully Published Payload"),y}removeRequestFromQueue(e){this.queue.delete(e)}checkQueue(){this.queue.forEach(async(e,t)=>{let i=e.attempt+1;this.queue.set(t,cn(Bi({},e),{attempt:i}));let{topic:r,message:n,opts:o,attestation:a}=e;this.logger.warn({},`Publisher: queue->publishing: ${e.opts.id}, tag: ${e.opts.tag}, attempt: ${i}`),await this.rpcPublish(cn(Bi({},e),{topic:r,message:n,ttl:o.ttl,prompt:o.prompt,tag:o.tag,id:o.id,attestation:a,tvf:o.tvf})),this.logger.warn({},`Publisher: queue->published: ${e.opts.id}`)})}registerEventListeners(){this.relayer.core.heartbeat.on(Lt.pulse,()=>{if(this.needsTransportRestart){this.needsTransportRestart=!1,this.relayer.events.emit(le.connection_stalled);return}this.checkQueue()}),this.relayer.on(le.message_ack,e=>{this.removeRequestFromQueue(e.id.toString())})}},qf=Object.defineProperty,Df=(s,e,t)=>e in s?qf(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ws=(s,e,t)=>Df(s,typeof e!="symbol"?e+"":e,t),On=class{constructor(){ws(this,"map",new Map),ws(this,"set",(e,t)=>{let i=this.get(e);this.exists(e,t)||this.map.set(e,[...i,t])}),ws(this,"get",e=>this.map.get(e)||[]),ws(this,"exists",(e,t)=>this.get(e).includes(t)),ws(this,"delete",(e,t)=>{if(typeof t>"u"){this.map.delete(e);return}if(!this.map.has(e))return;let i=this.get(e);if(!this.exists(e,t))return;let r=i.filter(n=>n!==t);if(!r.length){this.map.delete(e);return}this.map.set(e,r)}),ws(this,"clear",()=>{this.map.clear()})}get topics(){return Array.from(this.map.keys())}},Ff=Object.defineProperty,Uf=Object.defineProperties,kf=Object.getOwnPropertyDescriptors,Zc=Object.getOwnPropertySymbols,jf=Object.prototype.hasOwnProperty,Lf=Object.prototype.propertyIsEnumerable,Rn=(s,e,t)=>e in s?Ff(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ni=(s,e)=>{for(var t in e||(e={}))jf.call(e,t)&&Rn(s,t,e[t]);if(Zc)for(var t of Zc(e))Lf.call(e,t)&&Rn(s,t,e[t]);return s},hn=(s,e)=>Uf(s,kf(e)),Q=(s,e,t)=>Rn(s,typeof e!="symbol"?e+"":e,t),xn=class extends Fi{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,Q(this,"subscriptions",new Map),Q(this,"topicMap",new On),Q(this,"events",new Ot.EventEmitter),Q(this,"name",Dd),Q(this,"version",Fd),Q(this,"pending",new Map),Q(this,"cached",[]),Q(this,"initialized",!1),Q(this,"storagePrefix",pt),Q(this,"subscribeTimeout",(0,U.toMiliseconds)(U.ONE_MINUTE)),Q(this,"initialSubscribeTimeout",(0,U.toMiliseconds)(U.ONE_SECOND*15)),Q(this,"clientId"),Q(this,"batchSubscribeTopicsLimit",500),Q(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),this.registerEventListeners(),await this.restore()),this.initialized=!0}),Q(this,"subscribe",async(i,r)=>{this.isInitialized(),this.logger.debug("Subscribing Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:i,opts:r}});try{let n=ti(r),o={topic:i,relay:n,transportType:r?.transportType};this.pending.set(i,o);let a=await this.rpcSubscribe(i,n,r);return typeof a=="string"&&(this.onSubscribe(a,o),this.logger.debug("Successfully Subscribed Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:i,opts:r}})),a}catch(n){throw this.logger.debug("Failed to Subscribe Topic"),this.logger.error(n),n}}),Q(this,"unsubscribe",async(i,r)=>{this.isInitialized(),typeof r?.id<"u"?await this.unsubscribeById(i,r.id,r):await this.unsubscribeByTopic(i,r)}),Q(this,"isSubscribed",i=>new Promise(r=>{r(this.topicMap.topics.includes(i))})),Q(this,"isKnownTopic",i=>new Promise(r=>{r(this.topicMap.topics.includes(i)||this.pending.has(i)||this.cached.some(n=>n.topic===i))})),Q(this,"on",(i,r)=>{this.events.on(i,r)}),Q(this,"once",(i,r)=>{this.events.once(i,r)}),Q(this,"off",(i,r)=>{this.events.off(i,r)}),Q(this,"removeListener",(i,r)=>{this.events.removeListener(i,r)}),Q(this,"start",async()=>{await this.onConnect()}),Q(this,"stop",async()=>{await this.onDisconnect()}),Q(this,"restart",async()=>{await this.restore(),await this.onRestart()}),Q(this,"checkPending",async()=>{if(this.pending.size===0&&(!this.initialized||!this.relayer.connected))return;let i=[];this.pending.forEach(r=>{i.push(r)}),await this.batchSubscribe(i)}),Q(this,"registerEventListeners",()=>{this.relayer.core.heartbeat.on(Lt.pulse,async()=>{await this.checkPending()}),this.events.on(Le.created,async i=>{let r=Le.created;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,data:i}),await this.persist()}),this.events.on(Le.deleted,async i=>{let r=Le.deleted;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,data:i}),await this.persist()})}),this.relayer=e,this.logger=me(t,this.name),this.clientId=""}get context(){return Oe(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.relayer.core.customStoragePrefix+"//"+this.name}get length(){return this.subscriptions.size}get ids(){return Array.from(this.subscriptions.keys())}get values(){return Array.from(this.subscriptions.values())}get topics(){return this.topicMap.topics}get hasAnyTopics(){return this.topicMap.topics.length>0||this.pending.size>0||this.cached.length>0||this.subscriptions.size>0}hasSubscription(e,t){let i=!1;try{i=this.getSubscription(e).topic===t}catch{}return i}reset(){this.cached=[],this.initialized=!0}onDisable(){this.values.length>0&&(this.cached=this.values),this.subscriptions.clear(),this.topicMap.clear()}async unsubscribeByTopic(e,t){let i=this.topicMap.get(e);await Promise.all(i.map(async r=>await this.unsubscribeById(e,r,t)))}async unsubscribeById(e,t,i){this.logger.debug("Unsubscribing Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:i}});try{let r=ti(i);await this.restartToComplete({topic:e,id:t,relay:r}),await this.rpcUnsubscribe(e,t,r);let n=H("USER_DISCONNECTED",`${this.name}, ${e}`);await this.onUnsubscribe(e,t,n),this.logger.debug("Successfully Unsubscribed Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:i}})}catch(r){throw this.logger.debug("Failed to Unsubscribe Topic"),this.logger.error(r),r}}async rpcSubscribe(e,t,i){var r;(!i||i?.transportType===te.relay)&&await this.restartToComplete({topic:e,id:e,relay:t});let n={method:ms(t.protocol).subscribe,params:{topic:e}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:n});let o=(r=i?.internal)==null?void 0:r.throwOnFailedPublish;try{let a=await this.getSubscriptionId(e);if(i?.transportType===te.link_mode)return setTimeout(()=>{(this.relayer.connected||this.relayer.connecting)&&this.relayer.request(n).catch(l=>this.logger.warn(l))},(0,U.toMiliseconds)(U.ONE_SECOND)),a;let c=new Promise(async l=>{let p=u=>{u.topic===e&&(this.events.removeListener(Le.created,p),l(u.id))};this.events.on(Le.created,p);try{let u=await Pt(new Promise((d,g)=>{this.relayer.request(n).catch(y=>{this.logger.warn(y,y?.message),g(y)}).then(d)}),this.initialSubscribeTimeout,`Subscribing to ${e} failed, please try again`);this.events.removeListener(Le.created,p),l(u)}catch{}}),h=await Pt(c,this.subscribeTimeout,`Subscribing to ${e} failed, please try again`);if(!h&&o)throw new Error(`Subscribing to ${e} failed, please try again`);return h?a:null}catch(a){if(this.logger.debug("Outgoing Relay Subscribe Payload stalled"),this.relayer.events.emit(le.connection_stalled),o)throw a}return null}async rpcBatchSubscribe(e){if(!e.length)return;let t=e[0].relay,i={method:ms(t.protocol).batchSubscribe,params:{topics:e.map(r=>r.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:i});try{await await Pt(new Promise(r=>{this.relayer.request(i).catch(n=>this.logger.warn(n)).then(r)}),this.subscribeTimeout,"rpcBatchSubscribe failed, please try again")}catch{this.relayer.events.emit(le.connection_stalled)}}async rpcBatchFetchMessages(e){if(!e.length)return;let t=e[0].relay,i={method:ms(t.protocol).batchFetchMessages,params:{topics:e.map(n=>n.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:i});let r;try{r=await await Pt(new Promise((n,o)=>{this.relayer.request(i).catch(a=>{this.logger.warn(a),o(a)}).then(n)}),this.subscribeTimeout,"rpcBatchFetchMessages failed, please try again")}catch{this.relayer.events.emit(le.connection_stalled)}return r}rpcUnsubscribe(e,t,i){let r={method:ms(i.protocol).unsubscribe,params:{topic:e,id:t}};return this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:r}),this.relayer.request(r)}onSubscribe(e,t){this.setSubscription(e,hn(ni({},t),{id:e})),this.pending.delete(t.topic)}onBatchSubscribe(e){e.length&&e.forEach(t=>{this.setSubscription(t.id,ni({},t)),this.pending.delete(t.topic)})}async onUnsubscribe(e,t,i){this.events.removeAllListeners(t),this.hasSubscription(t,e)&&this.deleteSubscription(t,i),await this.relayer.messages.del(e)}async setRelayerSubscriptions(e){await this.relayer.core.storage.setItem(this.storageKey,e)}async getRelayerSubscriptions(){return await this.relayer.core.storage.getItem(this.storageKey)}setSubscription(e,t){this.logger.debug("Setting subscription"),this.logger.trace({type:"method",method:"setSubscription",id:e,subscription:t}),this.addSubscription(e,t)}addSubscription(e,t){this.subscriptions.set(e,ni({},t)),this.topicMap.set(t.topic,e),this.events.emit(Le.created,t)}getSubscription(e){this.logger.debug("Getting subscription"),this.logger.trace({type:"method",method:"getSubscription",id:e});let t=this.subscriptions.get(e);if(!t){let{message:i}=A("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(i)}return t}deleteSubscription(e,t){this.logger.debug("Deleting subscription"),this.logger.trace({type:"method",method:"deleteSubscription",id:e,reason:t});let i=this.getSubscription(e);this.subscriptions.delete(e),this.topicMap.delete(i.topic,e),this.events.emit(Le.deleted,hn(ni({},i),{reason:t}))}async persist(){await this.setRelayerSubscriptions(this.values),this.events.emit(Le.sync)}async onRestart(){if(this.cached.length){let e=[...this.cached],t=Math.ceil(this.cached.length/this.batchSubscribeTopicsLimit);for(let i=0;i<t;i++){let r=e.splice(0,this.batchSubscribeTopicsLimit);await this.batchSubscribe(r)}}this.events.emit(Le.resubscribed)}async restore(){try{let e=await this.getRelayerSubscriptions();if(typeof e>"u"||!e.length)return;if(this.subscriptions.size){let{message:t}=A("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),this.logger.error(`${this.name}: ${JSON.stringify(this.values)}`),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored subscriptions for ${this.name}`),this.logger.trace({type:"method",method:"restore",subscriptions:this.values})}catch(e){this.logger.debug(`Failed to Restore subscriptions for ${this.name}`),this.logger.error(e)}}async batchSubscribe(e){e.length&&(await this.rpcBatchSubscribe(e),this.onBatchSubscribe(await Promise.all(e.map(async t=>hn(ni({},t),{id:await this.getSubscriptionId(t.topic)})))))}async batchFetchMessages(e){if(!e.length)return;this.logger.trace(`Fetching batch messages for ${e.length} subscriptions`);let t=await this.rpcBatchFetchMessages(e);t&&t.messages&&(await Da((0,U.toMiliseconds)(U.ONE_SECOND)),await this.relayer.handleBatchMessageEvents(t.messages))}async onConnect(){await this.restart(),this.reset()}onDisconnect(){this.onDisable()}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}async restartToComplete(e){!this.relayer.connected&&!this.relayer.connecting&&(this.cached.push(e),await this.relayer.transportOpen())}async getClientId(){return this.clientId||(this.clientId=await this.relayer.core.crypto.getClientId()),this.clientId}async getSubscriptionId(e){return ze(e+await this.getClientId())}},$f=Object.defineProperty,eh=Object.getOwnPropertySymbols,Mf=Object.prototype.hasOwnProperty,Bf=Object.prototype.propertyIsEnumerable,Tn=(s,e,t)=>e in s?$f(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,th=(s,e)=>{for(var t in e||(e={}))Mf.call(e,t)&&Tn(s,t,e[t]);if(eh)for(var t of eh(e))Bf.call(e,t)&&Tn(s,t,e[t]);return s},W=(s,e,t)=>Tn(s,typeof e!="symbol"?e+"":e,t),An=class extends qi{constructor(e){super(e),W(this,"protocol","wc"),W(this,"version",2),W(this,"core"),W(this,"logger"),W(this,"events",new Ot.EventEmitter),W(this,"provider"),W(this,"messages"),W(this,"subscriber"),W(this,"publisher"),W(this,"name",Td),W(this,"transportExplicitlyClosed",!1),W(this,"initialized",!1),W(this,"connectionAttemptInProgress",!1),W(this,"relayUrl"),W(this,"projectId"),W(this,"packageName"),W(this,"bundleId"),W(this,"hasExperiencedNetworkDisruption",!1),W(this,"pingTimeout"),W(this,"heartBeatTimeout",(0,U.toMiliseconds)(U.THIRTY_SECONDS+U.FIVE_SECONDS)),W(this,"reconnectTimeout"),W(this,"connectPromise"),W(this,"reconnectInProgress",!1),W(this,"requestsInFlight",[]),W(this,"connectTimeout",(0,U.toMiliseconds)(U.ONE_SECOND*15)),W(this,"request",async t=>{var i,r;this.logger.debug("Publishing Request Payload");let n=t.id||Rt().toString();await this.toEstablishConnection();try{this.logger.trace({id:n,method:t.method,topic:(i=t.params)==null?void 0:i.topic},"relayer.request - publishing...");let o=`${n}:${((r=t.params)==null?void 0:r.tag)||""}`;this.requestsInFlight.push(o);let a=await this.provider.request(t);return this.requestsInFlight=this.requestsInFlight.filter(c=>c!==o),a}catch(o){throw this.logger.debug(`Failed to Publish Request: ${n}`),o}}),W(this,"resetPingTimeout",()=>{Ks()&&(clearTimeout(this.pingTimeout),this.pingTimeout=setTimeout(()=>{var t,i,r,n;try{this.logger.debug({},"pingTimeout: Connection stalled, terminating..."),(n=(r=(i=(t=this.provider)==null?void 0:t.connection)==null?void 0:i.socket)==null?void 0:r.terminate)==null||n.call(r)}catch(o){this.logger.warn(o,o?.message)}},this.heartBeatTimeout))}),W(this,"onPayloadHandler",t=>{this.onProviderPayload(t),this.resetPingTimeout()}),W(this,"onConnectHandler",()=>{this.logger.warn({},"Relayer connected \u{1F6DC}"),this.startPingTimeout(),this.events.emit(le.connect)}),W(this,"onDisconnectHandler",()=>{this.logger.warn({},"Relayer disconnected \u{1F6D1}"),this.requestsInFlight=[],this.onProviderDisconnect()}),W(this,"onProviderErrorHandler",t=>{this.logger.fatal(`Fatal socket error: ${t.message}`),this.events.emit(le.error,t),this.logger.fatal("Fatal socket error received, closing transport"),this.transportClose()}),W(this,"registerProviderListeners",()=>{this.provider.on(He.payload,this.onPayloadHandler),this.provider.on(He.connect,this.onConnectHandler),this.provider.on(He.disconnect,this.onDisconnectHandler),this.provider.on(He.error,this.onProviderErrorHandler)}),this.core=e.core,this.logger=typeof e.logger<"u"&&typeof e.logger!="string"?me(e.logger,this.name):(0,es.default)($t({level:e.logger||xd})),this.messages=new _n(this.logger,e.core),this.subscriber=new xn(this,this.logger),this.publisher=new Sn(this,this.logger),this.relayUrl=e?.relayUrl||fh,this.projectId=e.projectId,Pa()?this.packageName=Fr():Sa()&&(this.bundleId=Fr()),this.provider={}}async init(){if(this.logger.trace("Initialized"),this.registerEventListeners(),await Promise.all([this.messages.init(),this.subscriber.init()]),this.initialized=!0,this.subscriber.hasAnyTopics)try{await this.transportOpen()}catch(e){this.logger.warn(e,e?.message)}}get context(){return Oe(this.logger)}get connected(){var e,t,i;return((i=(t=(e=this.provider)==null?void 0:e.connection)==null?void 0:t.socket)==null?void 0:i.readyState)===1||!1}get connecting(){var e,t,i;return((i=(t=(e=this.provider)==null?void 0:e.connection)==null?void 0:t.socket)==null?void 0:i.readyState)===0||this.connectPromise!==void 0||!1}async publish(e,t,i){this.isInitialized(),await this.publisher.publish(e,t,i),await this.recordMessageEvent({topic:e,message:t,publishedAt:Date.now(),transportType:te.relay},Vi.outbound)}async subscribe(e,t){var i,r,n;this.isInitialized(),(!(t!=null&&t.transportType)||t?.transportType==="relay")&&await this.toEstablishConnection();let o=typeof((i=t?.internal)==null?void 0:i.throwOnFailedPublish)>"u"?!0:(r=t?.internal)==null?void 0:r.throwOnFailedPublish,a=((n=this.subscriber.topicMap.get(e))==null?void 0:n[0])||"",c,h=l=>{l.topic===e&&(this.subscriber.off(Le.created,h),c())};return await Promise.all([new Promise(l=>{c=l,this.subscriber.on(Le.created,h)}),new Promise(async(l,p)=>{a=await this.subscriber.subscribe(e,th({internal:{throwOnFailedPublish:o}},t)).catch(u=>{o&&p(u)})||a,l()})]),a}async unsubscribe(e,t){this.isInitialized(),await this.subscriber.unsubscribe(e,t)}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}off(e,t){this.events.off(e,t)}removeListener(e,t){this.events.removeListener(e,t)}async transportDisconnect(){this.provider.disconnect&&(this.hasExperiencedNetworkDisruption||this.connected)?await Pt(this.provider.disconnect(),2e3,"provider.disconnect()").catch(()=>this.onProviderDisconnect()):this.onProviderDisconnect()}async transportClose(){this.transportExplicitlyClosed=!0,await this.transportDisconnect()}async transportOpen(e){if(!this.subscriber.hasAnyTopics){this.logger.warn("Starting WS connection skipped because the client has no topics to work with.");return}if(this.connectPromise?(this.logger.debug({},"Waiting for existing connection attempt to resolve..."),await this.connectPromise,this.logger.debug({},"Existing connection attempt resolved")):(this.connectPromise=new Promise(async(t,i)=>{await this.connect(e).then(t).catch(i).finally(()=>{this.connectPromise=void 0})}),await this.connectPromise),!this.connected)throw new Error(`Couldn't establish socket connection to the relay server: ${this.relayUrl}`)}async restartTransport(e){this.logger.debug({},"Restarting transport..."),!this.connectionAttemptInProgress&&(this.relayUrl=e||this.relayUrl,await this.confirmOnlineStateOrThrow(),await this.transportClose(),await this.transportOpen())}async confirmOnlineStateOrThrow(){if(!await on())throw new Error("No internet connection detected. Please restart your network and try again.")}async handleBatchMessageEvents(e){if(e?.length===0){this.logger.trace("Batch message events is empty. Ignoring...");return}let t=e.sort((i,r)=>i.publishedAt-r.publishedAt);this.logger.debug(`Batch of ${t.length} message events sorted`);for(let i of t)try{await this.onMessageEvent(i)}catch(r){this.logger.warn(r,"Error while processing batch message event: "+r?.message)}this.logger.trace(`Batch of ${t.length} message events processed`)}async onLinkMessageEvent(e,t){let{topic:i}=e;if(!t.sessionExists){let r=re(U.FIVE_MINUTES),n={topic:i,expiry:r,relay:{protocol:"irn"},active:!1};await this.core.pairing.pairings.set(i,n)}this.events.emit(le.message,e),await this.recordMessageEvent(e,Vi.inbound)}async connect(e){await this.confirmOnlineStateOrThrow(),e&&e!==this.relayUrl&&(this.relayUrl=e,await this.transportDisconnect()),this.connectionAttemptInProgress=!0,this.transportExplicitlyClosed=!1;let t=1;for(;t<6;){try{if(this.transportExplicitlyClosed)break;this.logger.debug({},`Connecting to ${this.relayUrl}, attempt: ${t}...`),await this.createProvider(),await new Promise(async(i,r)=>{let n=()=>{r(new Error("Connection interrupted while trying to subscribe"))};this.provider.once(He.disconnect,n),await Pt(new Promise((o,a)=>{this.provider.connect().then(o).catch(a)}),this.connectTimeout,`Socket stalled when trying to connect to ${this.relayUrl}`).catch(o=>{r(o)}).finally(()=>{this.provider.off(He.disconnect,n),clearTimeout(this.reconnectTimeout)}),await new Promise(async(o,a)=>{let c=()=>{a(new Error("Connection interrupted while trying to subscribe"))};this.provider.once(He.disconnect,c),await this.subscriber.start().then(o).catch(a).finally(()=>{this.provider.off(He.disconnect,c)})}),this.hasExperiencedNetworkDisruption=!1,i()})}catch(i){await this.subscriber.stop();let r=i;this.logger.warn({},r.message),this.hasExperiencedNetworkDisruption=!0}finally{this.connectionAttemptInProgress=!1}if(this.connected){this.logger.debug({},`Connected to ${this.relayUrl} successfully on attempt: ${t}`);break}await new Promise(i=>setTimeout(i,(0,U.toMiliseconds)(t*1))),t++}}startPingTimeout(){var e,t,i,r,n;if(Ks())try{(t=(e=this.provider)==null?void 0:e.connection)!=null&&t.socket&&((n=(r=(i=this.provider)==null?void 0:i.connection)==null?void 0:r.socket)==null||n.on("ping",()=>{this.resetPingTimeout()})),this.resetPingTimeout()}catch(o){this.logger.warn(o,o?.message)}}async createProvider(){this.provider.connection&&this.unregisterProviderListeners();let e=await this.core.crypto.signJWT(this.relayUrl);this.provider=new xe(new jo(Ra({sdkVersion:pn,protocol:this.protocol,version:this.version,relayUrl:this.relayUrl,projectId:this.projectId,auth:e,useOnCloseEvent:!0,bundleId:this.bundleId,packageName:this.packageName}))),this.registerProviderListeners()}async recordMessageEvent(e,t){let{topic:i,message:r}=e;await this.messages.set(i,r,t)}async shouldIgnoreMessageEvent(e){let{topic:t,message:i}=e;if(!i||i.length===0)return this.logger.warn(`Ignoring invalid/empty message: ${i}`),!0;if(!await this.subscriber.isKnownTopic(t))return this.logger.warn(`Ignoring message for unknown topic ${t}`),!0;let r=this.messages.has(t,i);return r&&this.logger.warn(`Ignoring duplicate message: ${i}`),r}async onProviderPayload(e){if(this.logger.debug("Incoming Relay Payload"),this.logger.trace({type:"payload",direction:"incoming",payload:e}),ks(e)){if(!e.method.endsWith(Ad))return;let t=e.params,{topic:i,message:r,publishedAt:n,attestation:o}=t.data,a={topic:i,message:r,publishedAt:n,transportType:te.relay,attestation:o};this.logger.debug("Emitting Relayer Payload"),this.logger.trace(th({type:"event",event:t.id},a)),this.events.emit(t.id,a),await this.acknowledgePayload(e),await this.onMessageEvent(a)}else js(e)&&this.events.emit(le.message_ack,e)}async onMessageEvent(e){await this.shouldIgnoreMessageEvent(e)||(await this.recordMessageEvent(e,Vi.inbound),this.events.emit(le.message,e))}async acknowledgePayload(e){let t=Mt(e.id,!0);await this.provider.connection.send(t)}unregisterProviderListeners(){this.provider.off(He.payload,this.onPayloadHandler),this.provider.off(He.connect,this.onConnectHandler),this.provider.off(He.disconnect,this.onDisconnectHandler),this.provider.off(He.error,this.onProviderErrorHandler),clearTimeout(this.pingTimeout)}async registerEventListeners(){let e=await on();kc(async t=>{e!==t&&(e=t,t?await this.transportOpen().catch(i=>this.logger.error(i,i?.message)):(this.hasExperiencedNetworkDisruption=!0,await this.transportDisconnect(),this.transportExplicitlyClosed=!1))}),this.core.heartbeat.on(Lt.pulse,async()=>{if(!this.transportExplicitlyClosed&&!this.connected&&jc())try{await this.confirmOnlineStateOrThrow(),await this.transportOpen()}catch(t){this.logger.warn(t,t?.message)}})}async onProviderDisconnect(){clearTimeout(this.pingTimeout),this.events.emit(le.disconnect),this.connectionAttemptInProgress=!1,!this.reconnectInProgress&&(this.reconnectInProgress=!0,await this.subscriber.stop(),this.subscriber.hasAnyTopics&&(this.transportExplicitlyClosed||(this.reconnectTimeout=setTimeout(async()=>{await this.transportOpen().catch(e=>this.logger.error(e,e?.message)),this.reconnectTimeout=void 0,this.reconnectInProgress=!1},(0,U.toMiliseconds)(Cd)))))}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}async toEstablishConnection(){if(await this.confirmOnlineStateOrThrow(),!this.connected){if(this.connectPromise){await this.connectPromise;return}await this.connect()}}};function Vf(){}function sh(s){if(!s||typeof s!="object")return!1;let e=Object.getPrototypeOf(s);return e===null||e===Object.prototype||Object.getPrototypeOf(e)===null?Object.prototype.toString.call(s)==="[object Object]":!1}function ih(s){return Object.getOwnPropertySymbols(s).filter(e=>Object.prototype.propertyIsEnumerable.call(s,e))}function rh(s){return s==null?s===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(s)}var zf="[object RegExp]",Hf="[object String]",Kf="[object Number]",Gf="[object Boolean]",nh="[object Arguments]",Wf="[object Symbol]",Yf="[object Date]",Jf="[object Map]",Qf="[object Set]",Xf="[object Array]",Zf="[object Function]",em="[object ArrayBuffer]",ln="[object Object]",tm="[object Error]",sm="[object DataView]",im="[object Uint8Array]",rm="[object Uint8ClampedArray]",nm="[object Uint16Array]",om="[object Uint32Array]",am="[object BigUint64Array]",cm="[object Int8Array]",hm="[object Int16Array]",lm="[object Int32Array]",pm="[object BigInt64Array]",um="[object Float32Array]",dm="[object Float64Array]";function gm(s,e){return s===e||Number.isNaN(s)&&Number.isNaN(e)}function fm(s,e,t){return ai(s,e,void 0,void 0,void 0,void 0,t)}function ai(s,e,t,i,r,n,o){let a=o(s,e,t,i,r,n);if(a!==void 0)return a;if(typeof s==typeof e)switch(typeof s){case"bigint":case"string":case"boolean":case"symbol":case"undefined":return s===e;case"number":return s===e||Object.is(s,e);case"function":return s===e;case"object":return ci(s,e,n,o)}return ci(s,e,n,o)}function ci(s,e,t,i){if(Object.is(s,e))return!0;let r=rh(s),n=rh(e);if(r===nh&&(r=ln),n===nh&&(n=ln),r!==n)return!1;switch(r){case Hf:return s.toString()===e.toString();case Kf:{let c=s.valueOf(),h=e.valueOf();return gm(c,h)}case Gf:case Yf:case Wf:return Object.is(s.valueOf(),e.valueOf());case zf:return s.source===e.source&&s.flags===e.flags;case Zf:return s===e}t=t??new Map;let o=t.get(s),a=t.get(e);if(o!=null&&a!=null)return o===e;t.set(s,e),t.set(e,s);try{switch(r){case Jf:{if(s.size!==e.size)return!1;for(let[c,h]of s.entries())if(!e.has(c)||!ai(h,e.get(c),c,s,e,t,i))return!1;return!0}case Qf:{if(s.size!==e.size)return!1;let c=Array.from(s.values()),h=Array.from(e.values());for(let l=0;l<c.length;l++){let p=c[l],u=h.findIndex(d=>ai(p,d,void 0,s,e,t,i));if(u===-1)return!1;h.splice(u,1)}return!0}case Xf:case im:case rm:case nm:case om:case am:case cm:case hm:case lm:case pm:case um:case dm:{if(typeof Buffer<"u"&&Buffer.isBuffer(s)!==Buffer.isBuffer(e)||s.length!==e.length)return!1;for(let c=0;c<s.length;c++)if(!ai(s[c],e[c],c,s,e,t,i))return!1;return!0}case em:return s.byteLength!==e.byteLength?!1:ci(new Uint8Array(s),new Uint8Array(e),t,i);case sm:return s.byteLength!==e.byteLength||s.byteOffset!==e.byteOffset?!1:ci(new Uint8Array(s),new Uint8Array(e),t,i);case tm:return s.name===e.name&&s.message===e.message;case ln:{if(!(ci(s.constructor,e.constructor,t,i)||sh(s)&&sh(e)))return!1;let c=[...Object.keys(s),...ih(s)],h=[...Object.keys(e),...ih(e)];if(c.length!==h.length)return!1;for(let l=0;l<c.length;l++){let p=c[l],u=s[p];if(!Object.hasOwn(e,p))return!1;let d=e[p];if(!ai(u,d,p,s,e,t,i))return!1}return!0}default:return!1}}finally{t.delete(s),t.delete(e)}}function mm(s,e){return fm(s,e,Vf)}var ym=Object.defineProperty,oh=Object.getOwnPropertySymbols,wm=Object.prototype.hasOwnProperty,bm=Object.prototype.propertyIsEnumerable,Cn=(s,e,t)=>e in s?ym(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ah=(s,e)=>{for(var t in e||(e={}))wm.call(e,t)&&Cn(s,t,e[t]);if(oh)for(var t of oh(e))bm.call(e,t)&&Cn(s,t,e[t]);return s},Ne=(s,e,t)=>Cn(s,typeof e!="symbol"?e+"":e,t),ut=class extends Di{constructor(e,t,i,r=pt,n=void 0){super(e,t,i,r),this.core=e,this.logger=t,this.name=i,Ne(this,"map",new Map),Ne(this,"version",Nd),Ne(this,"cached",[]),Ne(this,"initialized",!1),Ne(this,"getKey"),Ne(this,"storagePrefix",pt),Ne(this,"recentlyDeleted",[]),Ne(this,"recentlyDeletedLimit",200),Ne(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(o=>{this.getKey&&o!==null&&!he(o)?this.map.set(this.getKey(o),o):_c(o)?this.map.set(o.id,o):Pc(o)&&this.map.set(o.topic,o)}),this.cached=[],this.initialized=!0)}),Ne(this,"set",async(o,a)=>{this.isInitialized(),this.map.has(o)?await this.update(o,a):(this.logger.debug("Setting value"),this.logger.trace({type:"method",method:"set",key:o,value:a}),this.map.set(o,a),await this.persist())}),Ne(this,"get",o=>(this.isInitialized(),this.logger.debug("Getting value"),this.logger.trace({type:"method",method:"get",key:o}),this.getData(o))),Ne(this,"getAll",o=>(this.isInitialized(),o?this.values.filter(a=>Object.keys(o).every(c=>mm(a[c],o[c]))):this.values)),Ne(this,"update",async(o,a)=>{this.isInitialized(),this.logger.debug("Updating value"),this.logger.trace({type:"method",method:"update",key:o,update:a});let c=ah(ah({},this.getData(o)),a);this.map.set(o,c),await this.persist()}),Ne(this,"delete",async(o,a)=>{this.isInitialized(),this.map.has(o)&&(this.logger.debug("Deleting value"),this.logger.trace({type:"method",method:"delete",key:o,reason:a}),this.map.delete(o),this.addToRecentlyDeleted(o),await this.persist())}),this.logger=me(t,this.name),this.storagePrefix=r,this.getKey=n}get context(){return Oe(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.map.size}get keys(){return Array.from(this.map.keys())}get values(){return Array.from(this.map.values())}addToRecentlyDeleted(e){this.recentlyDeleted.push(e),this.recentlyDeleted.length>=this.recentlyDeletedLimit&&this.recentlyDeleted.splice(0,this.recentlyDeletedLimit/2)}async setDataStore(e){await this.core.storage.setItem(this.storageKey,e)}async getDataStore(){return await this.core.storage.getItem(this.storageKey)}getData(e){let t=this.map.get(e);if(!t){if(this.recentlyDeleted.includes(e)){let{message:r}=A("MISSING_OR_INVALID",`Record was recently deleted - ${this.name}: ${e}`);throw this.logger.error(r),new Error(r)}let{message:i}=A("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.error(i),new Error(i)}return t}async persist(){await this.setDataStore(this.values)}async restore(){try{let e=await this.getDataStore();if(typeof e>"u"||!e.length)return;if(this.map.size){let{message:t}=A("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored value for ${this.name}`),this.logger.trace({type:"method",method:"restore",value:this.values})}catch(e){this.logger.debug(`Failed to Restore value for ${this.name}`),this.logger.error(e)}}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}},vm=Object.defineProperty,Em=(s,e,t)=>e in s?vm(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,V=(s,e,t)=>Em(s,typeof e!="symbol"?e+"":e,t),Nn=class{constructor(e,t){this.core=e,this.logger=t,V(this,"name",Ud),V(this,"version",kd),V(this,"events",new Ot.default),V(this,"pairings"),V(this,"initialized",!1),V(this,"storagePrefix",pt),V(this,"ignoredPayloadTypes",[et]),V(this,"registeredMethods",[]),V(this,"init",async()=>{this.initialized||(await this.pairings.init(),await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.initialized=!0,this.logger.trace("Initialized"))}),V(this,"register",({methods:i})=>{this.isInitialized(),this.registeredMethods=[...new Set([...this.registeredMethods,...i])]}),V(this,"create",async i=>{this.isInitialized();let r=Ri(),n=await this.core.crypto.setSymKey(r),o=re(U.FIVE_MINUTES),a={protocol:Mn},c={topic:n,expiry:o,relay:a,active:!1,methods:i?.methods},h=Zr({protocol:this.core.protocol,version:this.core.version,topic:n,symKey:r,relay:a,expiryTimestamp:o,methods:i?.methods});return this.events.emit(Dt.create,c),this.core.expirer.set(n,o),await this.pairings.set(n,c),await this.core.relayer.subscribe(n,{transportType:i?.transportType}),{topic:n,uri:h}}),V(this,"pair",async i=>{this.isInitialized();let r=this.core.eventClient.createEvent({properties:{topic:i?.uri,trace:[it.pairing_started]}});this.isValidPair(i,r);let{topic:n,symKey:o,relay:a,expiryTimestamp:c,methods:h}=Xr(i.uri);r.props.properties.topic=n,r.addTrace(it.pairing_uri_validation_success),r.addTrace(it.pairing_uri_not_expired);let l;if(this.pairings.keys.includes(n)){if(l=this.pairings.get(n),r.addTrace(it.existing_pairing),l.active)throw r.setError(lt.active_pairing_already_exists),new Error(`Pairing already exists: ${n}. Please try again with a new connection URI.`);r.addTrace(it.pairing_not_expired)}let p=c||re(U.FIVE_MINUTES),u={topic:n,relay:a,expiry:p,active:!1,methods:h};this.core.expirer.set(n,p),await this.pairings.set(n,u),r.addTrace(it.store_new_pairing),i.activatePairing&&await this.activate({topic:n}),this.events.emit(Dt.create,u),r.addTrace(it.emit_inactive_pairing),this.core.crypto.keychain.has(n)||await this.core.crypto.setSymKey(o,n),r.addTrace(it.subscribing_pairing_topic);try{await this.core.relayer.confirmOnlineStateOrThrow()}catch{r.setError(lt.no_internet_connection)}try{await this.core.relayer.subscribe(n,{relay:a})}catch(d){throw r.setError(lt.subscribe_pairing_topic_failure),d}return r.addTrace(it.subscribe_pairing_topic_success),u}),V(this,"activate",async({topic:i})=>{this.isInitialized();let r=re(U.FIVE_MINUTES);this.core.expirer.set(i,r),await this.pairings.update(i,{active:!0,expiry:r})}),V(this,"ping",async i=>{this.isInitialized(),await this.isValidPing(i),this.logger.warn("ping() is deprecated and will be removed in the next major release.");let{topic:r}=i;if(this.pairings.keys.includes(r)){let n=await this.sendRequest(r,"wc_pairingPing",{}),{done:o,resolve:a,reject:c}=_t();this.events.once(G("pairing_ping",n),({error:h})=>{h?c(h):a()}),await o()}}),V(this,"updateExpiry",async({topic:i,expiry:r})=>{this.isInitialized(),await this.pairings.update(i,{expiry:r})}),V(this,"updateMetadata",async({topic:i,metadata:r})=>{this.isInitialized(),await this.pairings.update(i,{peerMetadata:r})}),V(this,"getPairings",()=>(this.isInitialized(),this.pairings.values)),V(this,"disconnect",async i=>{this.isInitialized(),await this.isValidDisconnect(i);let{topic:r}=i;this.pairings.keys.includes(r)&&(await this.sendRequest(r,"wc_pairingDelete",H("USER_DISCONNECTED")),await this.deletePairing(r))}),V(this,"formatUriFromPairing",i=>{this.isInitialized();let{topic:r,relay:n,expiry:o,methods:a}=i,c=this.core.crypto.keychain.get(r);return Zr({protocol:this.core.protocol,version:this.core.version,topic:r,symKey:c,relay:n,expiryTimestamp:o,methods:a})}),V(this,"sendRequest",async(i,r,n)=>{let o=nt(r,n),a=await this.core.crypto.encode(i,o),c=ri[r].req;return this.core.history.set(i,o),this.core.relayer.publish(i,a,c),o.id}),V(this,"sendResult",async(i,r,n)=>{let o=Mt(i,n),a=await this.core.crypto.encode(r,o),c=(await this.core.history.get(r,i)).request.method,h=ri[c].res;await this.core.relayer.publish(r,a,h),await this.core.history.resolve(o)}),V(this,"sendError",async(i,r,n)=>{let o=ui(i,n),a=await this.core.crypto.encode(r,o),c=(await this.core.history.get(r,i)).request.method,h=ri[c]?ri[c].res:ri.unregistered_method.res;await this.core.relayer.publish(r,a,h),await this.core.history.resolve(o)}),V(this,"deletePairing",async(i,r)=>{await this.core.relayer.unsubscribe(i),await Promise.all([this.pairings.delete(i,H("USER_DISCONNECTED")),this.core.crypto.deleteSymKey(i),r?Promise.resolve():this.core.expirer.del(i)])}),V(this,"cleanup",async()=>{let i=this.pairings.getAll().filter(r=>at(r.expiry));await Promise.all(i.map(r=>this.deletePairing(r.topic)))}),V(this,"onRelayEventRequest",async i=>{let{topic:r,payload:n}=i;switch(n.method){case"wc_pairingPing":return await this.onPairingPingRequest(r,n);case"wc_pairingDelete":return await this.onPairingDeleteRequest(r,n);default:return await this.onUnknownRpcMethodRequest(r,n)}}),V(this,"onRelayEventResponse",async i=>{let{topic:r,payload:n}=i,o=(await this.core.history.get(r,n.id)).request.method;switch(o){case"wc_pairingPing":return this.onPairingPingResponse(r,n);default:return this.onUnknownRpcMethodResponse(o)}}),V(this,"onPairingPingRequest",async(i,r)=>{let{id:n}=r;try{this.isValidPing({topic:i}),await this.sendResult(n,i,!0),this.events.emit(Dt.ping,{id:n,topic:i})}catch(o){await this.sendError(n,i,o),this.logger.error(o)}}),V(this,"onPairingPingResponse",(i,r)=>{let{id:n}=r;setTimeout(()=>{Je(r)?this.events.emit(G("pairing_ping",n),{}):Ve(r)&&this.events.emit(G("pairing_ping",n),{error:r.error})},500)}),V(this,"onPairingDeleteRequest",async(i,r)=>{let{id:n}=r;try{this.isValidDisconnect({topic:i}),await this.deletePairing(i),this.events.emit(Dt.delete,{id:n,topic:i})}catch(o){await this.sendError(n,i,o),this.logger.error(o)}}),V(this,"onUnknownRpcMethodRequest",async(i,r)=>{let{id:n,method:o}=r;try{if(this.registeredMethods.includes(o))return;let a=H("WC_METHOD_UNSUPPORTED",o);await this.sendError(n,i,a),this.logger.error(a)}catch(a){await this.sendError(n,i,a),this.logger.error(a)}}),V(this,"onUnknownRpcMethodResponse",i=>{this.registeredMethods.includes(i)||this.logger.error(H("WC_METHOD_UNSUPPORTED",i))}),V(this,"isValidPair",(i,r)=>{var n;if(!Pe(i)){let{message:a}=A("MISSING_OR_INVALID",`pair() params: ${i}`);throw r.setError(lt.malformed_pairing_uri),new Error(a)}if(!Ic(i.uri)){let{message:a}=A("MISSING_OR_INVALID",`pair() uri: ${i.uri}`);throw r.setError(lt.malformed_pairing_uri),new Error(a)}let o=Xr(i?.uri);if(!((n=o?.relay)!=null&&n.protocol)){let{message:a}=A("MISSING_OR_INVALID","pair() uri#relay-protocol");throw r.setError(lt.malformed_pairing_uri),new Error(a)}if(!(o!=null&&o.symKey)){let{message:a}=A("MISSING_OR_INVALID","pair() uri#symKey");throw r.setError(lt.malformed_pairing_uri),new Error(a)}if(o!=null&&o.expiryTimestamp&&(0,U.toMiliseconds)(o?.expiryTimestamp)<Date.now()){r.setError(lt.pairing_expired);let{message:a}=A("EXPIRED","pair() URI has expired. Please try again with a new connection URI.");throw new Error(a)}}),V(this,"isValidPing",async i=>{if(!Pe(i)){let{message:n}=A("MISSING_OR_INVALID",`ping() params: ${i}`);throw new Error(n)}let{topic:r}=i;await this.isValidPairingTopic(r)}),V(this,"isValidDisconnect",async i=>{if(!Pe(i)){let{message:n}=A("MISSING_OR_INVALID",`disconnect() params: ${i}`);throw new Error(n)}let{topic:r}=i;await this.isValidPairingTopic(r)}),V(this,"isValidPairingTopic",async i=>{if(!se(i,!1)){let{message:r}=A("MISSING_OR_INVALID",`pairing topic should be a string: ${i}`);throw new Error(r)}if(!this.pairings.keys.includes(i)){let{message:r}=A("NO_MATCHING_KEY",`pairing topic doesn't exist: ${i}`);throw new Error(r)}if(at(this.pairings.get(i).expiry)){await this.deletePairing(i);let{message:r}=A("EXPIRED",`pairing topic: ${i}`);throw new Error(r)}}),this.core=e,this.logger=me(t,this.name),this.pairings=new ut(this.core,this.logger,this.name,this.storagePrefix)}get context(){return Oe(this.logger)}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}registerRelayerEvents(){this.core.relayer.on(le.message,async e=>{let{topic:t,message:i,transportType:r}=e;if(this.pairings.keys.includes(t)&&r!==te.link_mode&&!this.ignoredPayloadTypes.includes(this.core.crypto.getPayloadType(i)))try{let n=await this.core.crypto.decode(t,i);ks(n)?(this.core.history.set(t,n),await this.onRelayEventRequest({topic:t,payload:n})):js(n)&&(await this.core.history.resolve(n),await this.onRelayEventResponse({topic:t,payload:n}),this.core.history.delete(t,n.id)),await this.core.relayer.messages.ack(t,i)}catch(n){this.logger.error(n)}})}registerExpirerEvents(){this.core.expirer.on($e.expired,async e=>{let{topic:t}=vi(e.target);t&&this.pairings.keys.includes(t)&&(await this.deletePairing(t,!0),this.events.emit(Dt.expire,{topic:t}))})}},Im=Object.defineProperty,_m=(s,e,t)=>e in s?Im(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,be=(s,e,t)=>_m(s,typeof e!="symbol"?e+"":e,t),qn=class extends Ai{constructor(e,t){super(e,t),this.core=e,this.logger=t,be(this,"records",new Map),be(this,"events",new Ot.EventEmitter),be(this,"name",jd),be(this,"version",Ld),be(this,"cached",[]),be(this,"initialized",!1),be(this,"storagePrefix",pt),be(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(i=>this.records.set(i.id,i)),this.cached=[],this.registerEventListeners(),this.initialized=!0)}),be(this,"set",(i,r,n)=>{if(this.isInitialized(),this.logger.debug("Setting JSON-RPC request history record"),this.logger.trace({type:"method",method:"set",topic:i,request:r,chainId:n}),this.records.has(r.id))return;let o={id:r.id,topic:i,request:{method:r.method,params:r.params||null},chainId:n,expiry:re(U.THIRTY_DAYS)};this.records.set(o.id,o),this.persist(),this.events.emit(tt.created,o)}),be(this,"resolve",async i=>{if(this.isInitialized(),this.logger.debug("Updating JSON-RPC response history record"),this.logger.trace({type:"method",method:"update",response:i}),!this.records.has(i.id))return;let r=await this.getRecord(i.id);typeof r.response>"u"&&(r.response=Ve(i)?{error:i.error}:{result:i.result},this.records.set(r.id,r),this.persist(),this.events.emit(tt.updated,r))}),be(this,"get",async(i,r)=>(this.isInitialized(),this.logger.debug("Getting record"),this.logger.trace({type:"method",method:"get",topic:i,id:r}),await this.getRecord(r))),be(this,"delete",(i,r)=>{this.isInitialized(),this.logger.debug("Deleting record"),this.logger.trace({type:"method",method:"delete",id:r}),this.values.forEach(n=>{if(n.topic===i){if(typeof r<"u"&&n.id!==r)return;this.records.delete(n.id),this.events.emit(tt.deleted,n)}}),this.persist()}),be(this,"exists",async(i,r)=>(this.isInitialized(),this.records.has(r)?(await this.getRecord(r)).topic===i:!1)),be(this,"on",(i,r)=>{this.events.on(i,r)}),be(this,"once",(i,r)=>{this.events.once(i,r)}),be(this,"off",(i,r)=>{this.events.off(i,r)}),be(this,"removeListener",(i,r)=>{this.events.removeListener(i,r)}),this.logger=me(t,this.name)}get context(){return Oe(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get size(){return this.records.size}get keys(){return Array.from(this.records.keys())}get values(){return Array.from(this.records.values())}get pending(){let e=[];return this.values.forEach(t=>{if(typeof t.response<"u")return;let i={topic:t.topic,request:nt(t.request.method,t.request.params,t.id),chainId:t.chainId};return e.push(i)}),e}async setJsonRpcRecords(e){await this.core.storage.setItem(this.storageKey,e)}async getJsonRpcRecords(){return await this.core.storage.getItem(this.storageKey)}getRecord(e){this.isInitialized();let t=this.records.get(e);if(!t){let{message:i}=A("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(i)}return t}async persist(){await this.setJsonRpcRecords(this.values),this.events.emit(tt.sync)}async restore(){try{let e=await this.getJsonRpcRecords();if(typeof e>"u"||!e.length)return;if(this.records.size){let{message:t}=A("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",records:this.values})}catch(e){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(e)}}registerEventListeners(){this.events.on(tt.created,e=>{let t=tt.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.events.on(tt.updated,e=>{let t=tt.updated;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.events.on(tt.deleted,e=>{let t=tt.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.core.heartbeat.on(Lt.pulse,()=>{this.cleanup()})}cleanup(){try{this.isInitialized();let e=!1;this.records.forEach(t=>{(0,U.toMiliseconds)(t.expiry||0)-Date.now()<=0&&(this.logger.info(`Deleting expired history log: ${t.id}`),this.records.delete(t.id),this.events.emit(tt.deleted,t,!1),e=!0)}),e&&this.persist()}catch(e){this.logger.warn(e)}}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}},Pm=Object.defineProperty,Sm=(s,e,t)=>e in s?Pm(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Se=(s,e,t)=>Sm(s,typeof e!="symbol"?e+"":e,t),Dn=class extends Ui{constructor(e,t){super(e,t),this.core=e,this.logger=t,Se(this,"expirations",new Map),Se(this,"events",new Ot.EventEmitter),Se(this,"name",$d),Se(this,"version",Md),Se(this,"cached",[]),Se(this,"initialized",!1),Se(this,"storagePrefix",pt),Se(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(i=>this.expirations.set(i.target,i)),this.cached=[],this.registerEventListeners(),this.initialized=!0)}),Se(this,"has",i=>{try{let r=this.formatTarget(i);return typeof this.getExpiration(r)<"u"}catch{return!1}}),Se(this,"set",(i,r)=>{this.isInitialized();let n=this.formatTarget(i),o={target:n,expiry:r};this.expirations.set(n,o),this.checkExpiry(n,o),this.events.emit($e.created,{target:n,expiration:o})}),Se(this,"get",i=>{this.isInitialized();let r=this.formatTarget(i);return this.getExpiration(r)}),Se(this,"del",i=>{if(this.isInitialized(),this.has(i)){let r=this.formatTarget(i),n=this.getExpiration(r);this.expirations.delete(r),this.events.emit($e.deleted,{target:r,expiration:n})}}),Se(this,"on",(i,r)=>{this.events.on(i,r)}),Se(this,"once",(i,r)=>{this.events.once(i,r)}),Se(this,"off",(i,r)=>{this.events.off(i,r)}),Se(this,"removeListener",(i,r)=>{this.events.removeListener(i,r)}),this.logger=me(t,this.name)}get context(){return Oe(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.expirations.size}get keys(){return Array.from(this.expirations.keys())}get values(){return Array.from(this.expirations.values())}formatTarget(e){if(typeof e=="string")return Ta(e);if(typeof e=="number")return Aa(e);let{message:t}=A("UNKNOWN_TYPE",`Target type: ${typeof e}`);throw new Error(t)}async setExpirations(e){await this.core.storage.setItem(this.storageKey,e)}async getExpirations(){return await this.core.storage.getItem(this.storageKey)}async persist(){await this.setExpirations(this.values),this.events.emit($e.sync)}async restore(){try{let e=await this.getExpirations();if(typeof e>"u"||!e.length)return;if(this.expirations.size){let{message:t}=A("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored expirations for ${this.name}`),this.logger.trace({type:"method",method:"restore",expirations:this.values})}catch(e){this.logger.debug(`Failed to Restore expirations for ${this.name}`),this.logger.error(e)}}getExpiration(e){let t=this.expirations.get(e);if(!t){let{message:i}=A("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.warn(i),new Error(i)}return t}checkExpiry(e,t){let{expiry:i}=t;(0,U.toMiliseconds)(i)-Date.now()<=0&&this.expire(e,t)}expire(e,t){this.expirations.delete(e),this.events.emit($e.expired,{target:e,expiration:t})}checkExpirations(){this.core.relayer.connected&&this.expirations.forEach((e,t)=>this.checkExpiry(t,e))}registerEventListeners(){this.core.heartbeat.on(Lt.pulse,()=>this.checkExpirations()),this.events.on($e.created,e=>{let t=$e.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on($e.expired,e=>{let t=$e.expired;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on($e.deleted,e=>{let t=$e.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()})}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}},Om=Object.defineProperty,Rm=(s,e,t)=>e in s?Om(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,oe=(s,e,t)=>Rm(s,typeof e!="symbol"?e+"":e,t),Fn=class extends ki{constructor(e,t,i){super(e,t,i),this.core=e,this.logger=t,this.store=i,oe(this,"name",Bd),oe(this,"abortController"),oe(this,"isDevEnv"),oe(this,"verifyUrlV3",zd),oe(this,"storagePrefix",pt),oe(this,"version",gh),oe(this,"publicKey"),oe(this,"fetchPromise"),oe(this,"init",async()=>{var r;this.isDevEnv||(this.publicKey=await this.store.getItem(this.storeKey),this.publicKey&&(0,U.toMiliseconds)((r=this.publicKey)==null?void 0:r.expiresAt)<Date.now()&&(this.logger.debug("verify v2 public key expired"),await this.removePublicKey()))}),oe(this,"register",async r=>{if(!Gt()||this.isDevEnv)return;let n=window.location.origin,{id:o,decryptedId:a}=r,c=`${this.verifyUrlV3}/attestation?projectId=${this.core.projectId}&origin=${n}&id=${o}&decryptedId=${a}`;try{let h=(0,uh.getDocument)(),l=this.startAbortTimer(U.ONE_SECOND*5),p=await new Promise((u,d)=>{let g=()=>{window.removeEventListener("message",f),h.body.removeChild(y),d("attestation aborted")};this.abortController.signal.addEventListener("abort",g);let y=h.createElement("iframe");y.src=c,y.style.display="none",y.addEventListener("error",g,{signal:this.abortController.signal});let f=w=>{if(w.data&&typeof w.data=="string")try{let m=JSON.parse(w.data);if(m.type==="verify_attestation"){if(Us(m.attestation).payload.id!==o)return;clearInterval(l),h.body.removeChild(y),this.abortController.signal.removeEventListener("abort",g),window.removeEventListener("message",f),u(m.attestation===null?"":m.attestation)}}catch(m){this.logger.warn(m)}};h.body.appendChild(y),window.addEventListener("message",f,{signal:this.abortController.signal})});return this.logger.debug("jwt attestation",p),p}catch(h){this.logger.warn(h)}return""}),oe(this,"resolve",async r=>{if(this.isDevEnv)return"";let{attestationId:n,hash:o,encryptedId:a}=r;if(n===""){this.logger.debug("resolve: attestationId is empty, skipping");return}if(n){if(Us(n).payload.id!==a)return;let h=await this.isValidJwtAttestation(n);if(h){if(!h.isVerified){this.logger.warn("resolve: jwt attestation: origin url not verified");return}return h}}if(!o)return;let c=this.getVerifyUrl(r?.verifyUrl);return this.fetchAttestation(o,c)}),oe(this,"fetchAttestation",async(r,n)=>{this.logger.debug(`resolving attestation: ${r} from url: ${n}`);let o=this.startAbortTimer(U.ONE_SECOND*5),a=await fetch(`${n}/attestation/${r}?v2Supported=true`,{signal:this.abortController.signal});return clearTimeout(o),a.status===200?await a.json():void 0}),oe(this,"getVerifyUrl",r=>{let n=r||bs;return Hd.includes(n)||(this.logger.info(`verify url: ${n}, not included in trusted list, assigning default: ${bs}`),n=bs),n}),oe(this,"fetchPublicKey",async()=>{try{this.logger.debug(`fetching public key from: ${this.verifyUrlV3}`);let r=this.startAbortTimer(U.FIVE_SECONDS),n=await fetch(`${this.verifyUrlV3}/public-key`,{signal:this.abortController.signal});return clearTimeout(r),await n.json()}catch(r){this.logger.warn(r)}}),oe(this,"persistPublicKey",async r=>{this.logger.debug("persisting public key to local storage",r),await this.store.setItem(this.storeKey,r),this.publicKey=r}),oe(this,"removePublicKey",async()=>{this.logger.debug("removing verify v2 public key from storage"),await this.store.removeItem(this.storeKey),this.publicKey=void 0}),oe(this,"isValidJwtAttestation",async r=>{let n=await this.getPublicKey();try{if(n)return this.validateAttestation(r,n)}catch(a){this.logger.error(a),this.logger.warn("error validating attestation")}let o=await this.fetchAndPersistPublicKey();try{if(o)return this.validateAttestation(r,o)}catch(a){this.logger.error(a),this.logger.warn("error validating attestation")}}),oe(this,"getPublicKey",async()=>this.publicKey?this.publicKey:await this.fetchAndPersistPublicKey()),oe(this,"fetchAndPersistPublicKey",async()=>{if(this.fetchPromise)return await this.fetchPromise,this.publicKey;this.fetchPromise=new Promise(async n=>{let o=await this.fetchPublicKey();o&&(await this.persistPublicKey(o),n(o))});let r=await this.fetchPromise;return this.fetchPromise=void 0,r}),oe(this,"validateAttestation",(r,n)=>{let o=bc(r,n.publicKey),a={hasExpired:(0,U.toMiliseconds)(o.exp)<Date.now(),payload:o};if(a.hasExpired)throw this.logger.warn("resolve: jwt attestation expired"),new Error("JWT attestation expired");return{origin:a.payload.origin,isScam:a.payload.isScam,isVerified:a.payload.isVerified}}),this.logger=me(t,this.name),this.abortController=new AbortController,this.isDevEnv=Ws(),this.init()}get storeKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//verify:public:key"}get context(){return Oe(this.logger)}startAbortTimer(e){return this.abortController=new AbortController,setTimeout(()=>this.abortController.abort(),(0,U.toMiliseconds)(e))}},xm=Object.defineProperty,Tm=(s,e,t)=>e in s?xm(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ch=(s,e,t)=>Tm(s,typeof e!="symbol"?e+"":e,t),Un=class extends ji{constructor(e,t){super(e,t),this.projectId=e,this.logger=t,ch(this,"context",Kd),ch(this,"registerDeviceToken",async i=>{let{clientId:r,token:n,notificationType:o,enableEncrypted:a=!1}=i,c=`${Gd}/${this.projectId}/clients`;await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:r,type:o,token:n,always_raw:a})})}),this.logger=me(t,this.context)}},Am=Object.defineProperty,hh=Object.getOwnPropertySymbols,Cm=Object.prototype.hasOwnProperty,Nm=Object.prototype.propertyIsEnumerable,kn=(s,e,t)=>e in s?Am(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,oi=(s,e)=>{for(var t in e||(e={}))Cm.call(e,t)&&kn(s,t,e[t]);if(hh)for(var t of hh(e))Nm.call(e,t)&&kn(s,t,e[t]);return s},ge=(s,e,t)=>kn(s,typeof e!="symbol"?e+"":e,t),jn=class extends Li{constructor(e,t,i=!0){super(e,t,i),this.core=e,this.logger=t,ge(this,"context",Yd),ge(this,"storagePrefix",pt),ge(this,"storageVersion",Wd),ge(this,"events",new Map),ge(this,"shouldPersist",!1),ge(this,"init",async()=>{if(!Ws())try{let r={eventId:Lr(),timestamp:Date.now(),domain:this.getAppDomain(),props:{event:"INIT",type:"",properties:{client_id:await this.core.crypto.getClientId(),user_agent:kr(this.core.relayer.protocol,this.core.relayer.version,pn)}}};await this.sendEvent([r])}catch(r){this.logger.warn(r)}}),ge(this,"createEvent",r=>{let{event:n="ERROR",type:o="",properties:{topic:a,trace:c}}=r,h=Lr(),l=this.core.projectId||"",p=Date.now(),u=oi({eventId:h,timestamp:p,props:{event:n,type:o,properties:{topic:a,trace:c}},bundleId:l,domain:this.getAppDomain()},this.setMethods(h));return this.telemetryEnabled&&(this.events.set(h,u),this.shouldPersist=!0),u}),ge(this,"getEvent",r=>{let{eventId:n,topic:o}=r;if(n)return this.events.get(n);let a=Array.from(this.events.values()).find(c=>c.props.properties.topic===o);if(a)return oi(oi({},a),this.setMethods(a.eventId))}),ge(this,"deleteEvent",r=>{let{eventId:n}=r;this.events.delete(n),this.shouldPersist=!0}),ge(this,"setEventListeners",()=>{this.core.heartbeat.on(Lt.pulse,async()=>{this.shouldPersist&&await this.persist(),this.events.forEach(r=>{(0,U.fromMiliseconds)(Date.now())-(0,U.fromMiliseconds)(r.timestamp)>Jd&&(this.events.delete(r.eventId),this.shouldPersist=!0)})})}),ge(this,"setMethods",r=>({addTrace:n=>this.addTrace(r,n),setError:n=>this.setError(r,n)})),ge(this,"addTrace",(r,n)=>{let o=this.events.get(r);o&&(o.props.properties.trace.push(n),this.events.set(r,o),this.shouldPersist=!0)}),ge(this,"setError",(r,n)=>{let o=this.events.get(r);o&&(o.props.type=n,o.timestamp=Date.now(),this.events.set(r,o),this.shouldPersist=!0)}),ge(this,"persist",async()=>{await this.core.storage.setItem(this.storageKey,Array.from(this.events.values())),this.shouldPersist=!1}),ge(this,"restore",async()=>{try{let r=await this.core.storage.getItem(this.storageKey)||[];if(!r.length)return;r.forEach(n=>{this.events.set(n.eventId,oi(oi({},n),this.setMethods(n.eventId)))})}catch(r){this.logger.warn(r)}}),ge(this,"submit",async()=>{if(!this.telemetryEnabled||this.events.size===0)return;let r=[];for(let[n,o]of this.events)o.props.type&&r.push(o);if(r.length!==0)try{if((await this.sendEvent(r)).ok)for(let n of r)this.events.delete(n.eventId),this.shouldPersist=!0}catch(n){this.logger.warn(n)}}),ge(this,"sendEvent",async r=>{let n=this.getAppDomain()?"":"&sp=desktop";return await fetch(`${Qd}?projectId=${this.core.projectId}&st=events_sdk&sv=js-${pn}${n}`,{method:"POST",body:JSON.stringify(r)})}),ge(this,"getAppDomain",()=>Ur().url),this.logger=me(t,this.context),this.telemetryEnabled=i,i?this.restore().then(async()=>{await this.submit(),this.setEventListeners()}):this.persist()}get storageKey(){return this.storagePrefix+this.storageVersion+this.core.customStoragePrefix+"//"+this.context}},qm=Object.defineProperty,lh=Object.getOwnPropertySymbols,Dm=Object.prototype.hasOwnProperty,Fm=Object.prototype.propertyIsEnumerable,Ln=(s,e,t)=>e in s?qm(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ph=(s,e)=>{for(var t in e||(e={}))Dm.call(e,t)&&Ln(s,t,e[t]);if(lh)for(var t of lh(e))Fm.call(e,t)&&Ln(s,t,e[t]);return s},ee=(s,e,t)=>Ln(s,typeof e!="symbol"?e+"":e,t),$n=class s extends Ti{constructor(e){var t;super(e),ee(this,"protocol",dh),ee(this,"version",gh),ee(this,"name",zi),ee(this,"relayUrl"),ee(this,"projectId"),ee(this,"customStoragePrefix"),ee(this,"events",new Ot.EventEmitter),ee(this,"logger"),ee(this,"heartbeat"),ee(this,"relayer"),ee(this,"crypto"),ee(this,"storage"),ee(this,"history"),ee(this,"expirer"),ee(this,"pairing"),ee(this,"verify"),ee(this,"echoClient"),ee(this,"linkModeSupportedApps"),ee(this,"eventClient"),ee(this,"initialized",!1),ee(this,"logChunkController"),ee(this,"on",(a,c)=>this.events.on(a,c)),ee(this,"once",(a,c)=>this.events.once(a,c)),ee(this,"off",(a,c)=>this.events.off(a,c)),ee(this,"removeListener",(a,c)=>this.events.removeListener(a,c)),ee(this,"dispatchEnvelope",({topic:a,message:c,sessionExists:h})=>{if(!a||!c)return;let l={topic:a,message:c,publishedAt:Date.now(),transportType:te.link_mode};this.relayer.onLinkMessageEvent(l,{sessionExists:h})});let i=this.getGlobalCore(e?.customStoragePrefix);if(i)try{return this.customStoragePrefix=i.customStoragePrefix,this.logger=i.logger,this.heartbeat=i.heartbeat,this.crypto=i.crypto,this.history=i.history,this.expirer=i.expirer,this.storage=i.storage,this.relayer=i.relayer,this.pairing=i.pairing,this.verify=i.verify,this.echoClient=i.echoClient,this.linkModeSupportedApps=i.linkModeSupportedApps,this.eventClient=i.eventClient,this.initialized=i.initialized,this.logChunkController=i.logChunkController,i}catch(a){console.warn("Failed to copy global core",a)}this.projectId=e?.projectId,this.relayUrl=e?.relayUrl||fh,this.customStoragePrefix=e!=null&&e.customStoragePrefix?`:${e.customStoragePrefix}`:"";let r=$t({level:typeof e?.logger=="string"&&e.logger?e.logger:bd.logger,name:zi}),{logger:n,chunkLoggerController:o}=ko({opts:r,maxSizeInBytes:e?.maxLogBlobSizeInBytes,loggerOverride:e?.logger});this.logChunkController=o,(t=this.logChunkController)!=null&&t.downloadLogsBlobInBrowser&&(window.downloadLogsBlobInBrowser=async()=>{var a,c;(a=this.logChunkController)!=null&&a.downloadLogsBlobInBrowser&&((c=this.logChunkController)==null||c.downloadLogsBlobInBrowser({clientId:await this.crypto.getClientId()}))}),this.logger=me(n,this.name),this.heartbeat=new Fo,this.crypto=new En(this,this.logger,e?.keychain),this.history=new qn(this,this.logger),this.expirer=new Dn(this,this.logger),this.storage=e!=null&&e.storage?e.storage:new Uo(ph(ph({},vd),e?.storageOptions)),this.relayer=new An({core:this,logger:this.logger,relayUrl:this.relayUrl,projectId:this.projectId}),this.pairing=new Nn(this,this.logger),this.verify=new Fn(this,this.logger,this.storage),this.echoClient=new Un(this.projectId||"",this.logger),this.linkModeSupportedApps=[],this.eventClient=new jn(this,this.logger,e?.telemetryEnabled),this.setGlobalCore(this)}static async init(e){let t=new s(e);await t.initialize();let i=await t.crypto.getClientId();return await t.storage.setItem(qd,i),t}get context(){return Oe(this.logger)}async start(){this.initialized||await this.initialize()}async getLogsBlob(){var e;return(e=this.logChunkController)==null?void 0:e.logsToBlob({clientId:await this.crypto.getClientId()})}async addLinkModeSupportedApp(e){this.linkModeSupportedApps.includes(e)||(this.linkModeSupportedApps.push(e),await this.storage.setItem(zc,this.linkModeSupportedApps))}async initialize(){this.logger.trace("Initialized");try{await this.crypto.init(),await this.history.init(),await this.expirer.init(),await this.relayer.init(),await this.heartbeat.init(),await this.pairing.init(),this.linkModeSupportedApps=await this.storage.getItem(zc)||[],this.initialized=!0,this.logger.info("Core Initialization Success")}catch(e){throw this.logger.warn(`Core Initialization Failure at epoch ${Date.now()}`,e),this.logger.error(e.message),e}}getGlobalCore(e=""){try{if(this.isGlobalCoreDisabled())return;let t=`_walletConnectCore_${e}`,i=`${t}_count`;return globalThis[i]=(globalThis[i]||0)+1,globalThis[i]>1&&console.warn(`WalletConnect Core is already initialized. This is probably a mistake and can lead to unexpected behavior. Init() was called ${globalThis[i]} times.`),globalThis[t]}catch(t){console.warn("Failed to get global WalletConnect core",t);return}}setGlobalCore(e){var t;try{if(this.isGlobalCoreDisabled())return;let i=`_walletConnectCore_${((t=e.opts)==null?void 0:t.customStoragePrefix)||""}`;globalThis[i]=e}catch(i){console.warn("Failed to set global WalletConnect core",i)}}isGlobalCoreDisabled(){try{return typeof process<"u"&&process.env.DISABLE_GLOBAL_CORE==="true"}catch{return!0}}},Rh=$n;var B=Ye(sr());var Wi=Ye(Fs());var Nh="wc",qh=2,Dh="client",eo=`${Nh}@${qh}:${Dh}:`,Bn={name:Dh,logger:"error",controller:!1,relayUrl:"wss://relay.walletconnect.org"};var xh="WALLETCONNECT_DEEPLINK_CHOICE";var Um="proposal";var Th="Proposal expired",km="session",Es=B.SEVEN_DAYS,jm="engine",fe={wc_sessionPropose:{req:{ttl:B.FIVE_MINUTES,prompt:!0,tag:1100},res:{ttl:B.FIVE_MINUTES,prompt:!1,tag:1101},reject:{ttl:B.FIVE_MINUTES,prompt:!1,tag:1120},autoReject:{ttl:B.FIVE_MINUTES,prompt:!1,tag:1121}},wc_sessionSettle:{req:{ttl:B.FIVE_MINUTES,prompt:!1,tag:1102},res:{ttl:B.FIVE_MINUTES,prompt:!1,tag:1103}},wc_sessionUpdate:{req:{ttl:B.ONE_DAY,prompt:!1,tag:1104},res:{ttl:B.ONE_DAY,prompt:!1,tag:1105}},wc_sessionExtend:{req:{ttl:B.ONE_DAY,prompt:!1,tag:1106},res:{ttl:B.ONE_DAY,prompt:!1,tag:1107}},wc_sessionRequest:{req:{ttl:B.FIVE_MINUTES,prompt:!0,tag:1108},res:{ttl:B.FIVE_MINUTES,prompt:!1,tag:1109}},wc_sessionEvent:{req:{ttl:B.FIVE_MINUTES,prompt:!0,tag:1110},res:{ttl:B.FIVE_MINUTES,prompt:!1,tag:1111}},wc_sessionDelete:{req:{ttl:B.ONE_DAY,prompt:!1,tag:1112},res:{ttl:B.ONE_DAY,prompt:!1,tag:1113}},wc_sessionPing:{req:{ttl:B.ONE_DAY,prompt:!1,tag:1114},res:{ttl:B.ONE_DAY,prompt:!1,tag:1115}},wc_sessionAuthenticate:{req:{ttl:B.ONE_HOUR,prompt:!0,tag:1116},res:{ttl:B.ONE_HOUR,prompt:!1,tag:1117},reject:{ttl:B.FIVE_MINUTES,prompt:!1,tag:1118},autoReject:{ttl:B.FIVE_MINUTES,prompt:!1,tag:1119}}},Vn={min:B.FIVE_MINUTES,max:B.SEVEN_DAYS},dt={idle:"IDLE",active:"ACTIVE"},Ah={eth_sendTransaction:{key:""},eth_sendRawTransaction:{key:""},wallet_sendCalls:{key:""},solana_signTransaction:{key:"signature"},solana_signAllTransactions:{key:"transactions"},solana_signAndSendTransaction:{key:"signature"}},Lm="request",$m=["wc_sessionPropose","wc_sessionRequest","wc_authRequest","wc_sessionAuthenticate"],Mm="wc";var Bm="auth",Vm="authKeys",zm="pairingTopics",Hm="requests",Yi=`${Mm}@${1.5}:${Bm}:`,Ki=`${Yi}:PUB_KEY`,Km=Object.defineProperty,Gm=Object.defineProperties,Wm=Object.getOwnPropertyDescriptors,Ch=Object.getOwnPropertySymbols,Ym=Object.prototype.hasOwnProperty,Jm=Object.prototype.propertyIsEnumerable,Hn=(s,e,t)=>e in s?Km(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,X=(s,e)=>{for(var t in e||(e={}))Ym.call(e,t)&&Hn(s,t,e[t]);if(Ch)for(var t of Ch(e))Jm.call(e,t)&&Hn(s,t,e[t]);return s},Re=(s,e)=>Gm(s,Wm(e)),E=(s,e,t)=>Hn(s,typeof e!="symbol"?e+"":e,t),Kn=class extends Mi{constructor(e){super(e),E(this,"name",jm),E(this,"events",new Wi.default),E(this,"initialized",!1),E(this,"requestQueue",{state:dt.idle,queue:[]}),E(this,"sessionRequestQueue",{state:dt.idle,queue:[]}),E(this,"requestQueueDelay",B.ONE_SECOND),E(this,"expectedPairingMethodMap",new Map),E(this,"recentlyDeletedMap",new Map),E(this,"recentlyDeletedLimit",200),E(this,"relayMessageCache",[]),E(this,"pendingSessions",new Map),E(this,"init",async()=>{this.initialized||(await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.registerPairingEvents(),await this.registerLinkModeListeners(),this.client.core.pairing.register({methods:Object.keys(fe)}),this.initialized=!0,setTimeout(async()=>{await this.processPendingMessageEvents(),this.sessionRequestQueue.queue=this.getPendingSessionRequests(),this.processSessionRequestQueue()},(0,B.toMiliseconds)(this.requestQueueDelay)))}),E(this,"connect",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();let i=Re(X({},t),{requiredNamespaces:t.requiredNamespaces||{},optionalNamespaces:t.optionalNamespaces||{}});await this.isValidConnect(i),i.optionalNamespaces=vc(i.requiredNamespaces,i.optionalNamespaces),i.requiredNamespaces={};let{pairingTopic:r,requiredNamespaces:n,optionalNamespaces:o,sessionProperties:a,scopedProperties:c,relays:h}=i,l=r,p,u=!1;try{if(l){let P=this.client.core.pairing.pairings.get(l);this.client.logger.warn("connect() with existing pairing topic is deprecated and will be removed in the next major release."),u=P.active}}catch(P){throw this.client.logger.error(`connect() -> pairing.get(${l}) failed`),P}if(!l||!u){let{topic:P,uri:O}=await this.client.core.pairing.create();l=P,p=O}if(!l){let{message:P}=A("NO_MATCHING_KEY",`connect() pairing topic: ${l}`);throw new Error(P)}let d=await this.client.core.crypto.generateKeyPair(),g=fe.wc_sessionPropose.req.ttl||B.FIVE_MINUTES,y=re(g),f=Re(X(X({requiredNamespaces:n,optionalNamespaces:o,relays:h??[{protocol:Mn}],proposer:{publicKey:d,metadata:this.client.metadata},expiryTimestamp:y,pairingTopic:l},a&&{sessionProperties:a}),c&&{scopedProperties:c}),{id:mt()}),w=G("session_connect",f.id),{reject:m,resolve:b,done:_}=_t(g,Th),T=({id:P})=>{P===f.id&&(this.client.events.off("proposal_expire",T),this.pendingSessions.delete(f.id),this.events.emit(w,{error:{message:Th,code:0}}))};return this.client.events.on("proposal_expire",T),this.events.once(w,({error:P,session:O})=>{this.client.events.off("proposal_expire",T),P?m(P):O&&b(O)}),await this.sendRequest({topic:l,method:"wc_sessionPropose",params:f,throwOnFailedPublish:!0,clientRpcId:f.id}),await this.setProposal(f.id,f),{uri:p,approval:_}}),E(this,"pair",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{return await this.client.core.pairing.pair(t)}catch(i){throw this.client.logger.error("pair() failed"),i}}),E(this,"approve",async t=>{var i,r,n;let o=this.client.core.eventClient.createEvent({properties:{topic:(i=t?.id)==null?void 0:i.toString(),trace:[Ke.session_approve_started]}});try{this.isInitialized(),await this.confirmOnlineStateOrThrow()}catch(v){throw o.setError(Ft.no_internet_connection),v}try{await this.isValidProposalId(t?.id)}catch(v){throw this.client.logger.error(`approve() -> proposal.get(${t?.id}) failed`),o.setError(Ft.proposal_not_found),v}try{await this.isValidApprove(t)}catch(v){throw this.client.logger.error("approve() -> isValidApprove() failed"),o.setError(Ft.session_approve_namespace_validation_failure),v}let{id:a,relayProtocol:c,namespaces:h,sessionProperties:l,scopedProperties:p,sessionConfig:u}=t,d=this.client.proposal.get(a);this.client.core.eventClient.deleteEvent({eventId:o.eventId});let{pairingTopic:g,proposer:y,requiredNamespaces:f,optionalNamespaces:w}=d,m=(r=this.client.core.eventClient)==null?void 0:r.getEvent({topic:g});m||(m=(n=this.client.core.eventClient)==null?void 0:n.createEvent({type:Ke.session_approve_started,properties:{topic:g,trace:[Ke.session_approve_started,Ke.session_namespaces_validation_success]}}));let b=await this.client.core.crypto.generateKeyPair(),_=y.publicKey,T=await this.client.core.crypto.generateSharedKey(b,_),P=X(X(X({relay:{protocol:c??"irn"},namespaces:h,controller:{publicKey:b,metadata:this.client.metadata},expiry:re(Es)},l&&{sessionProperties:l}),p&&{scopedProperties:p}),u&&{sessionConfig:u}),O=te.relay;m.addTrace(Ke.subscribing_session_topic);try{await this.client.core.relayer.subscribe(T,{transportType:O})}catch(v){throw m.setError(Ft.subscribe_session_topic_failure),v}m.addTrace(Ke.subscribe_session_topic_success);let C=Re(X({},P),{topic:T,requiredNamespaces:f,optionalNamespaces:w,pairingTopic:g,acknowledged:!1,self:P.controller,peer:{publicKey:y.publicKey,metadata:y.metadata},controller:b,transportType:te.relay});await this.client.session.set(T,C),m.addTrace(Ke.store_session);try{m.addTrace(Ke.publishing_session_settle),await this.sendRequest({topic:T,method:"wc_sessionSettle",params:P,throwOnFailedPublish:!0}).catch(v=>{throw m?.setError(Ft.session_settle_publish_failure),v}),m.addTrace(Ke.session_settle_publish_success),m.addTrace(Ke.publishing_session_approve),await this.sendResult({id:a,topic:g,result:{relay:{protocol:c??"irn"},responderPublicKey:b},throwOnFailedPublish:!0}).catch(v=>{throw m?.setError(Ft.session_approve_publish_failure),v}),m.addTrace(Ke.session_approve_publish_success)}catch(v){throw this.client.logger.error(v),this.client.session.delete(T,H("USER_DISCONNECTED")),await this.client.core.relayer.unsubscribe(T),v}return this.client.core.eventClient.deleteEvent({eventId:m.eventId}),await this.client.core.pairing.updateMetadata({topic:g,metadata:y.metadata}),await this.client.proposal.delete(a,H("USER_DISCONNECTED")),await this.client.core.pairing.activate({topic:g}),await this.setExpiry(T,re(Es)),{topic:T,acknowledged:()=>Promise.resolve(this.client.session.get(T))}}),E(this,"reject",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidReject(t)}catch(o){throw this.client.logger.error("reject() -> isValidReject() failed"),o}let{id:i,reason:r}=t,n;try{n=this.client.proposal.get(i).pairingTopic}catch(o){throw this.client.logger.error(`reject() -> proposal.get(${i}) failed`),o}n&&(await this.sendError({id:i,topic:n,error:r,rpcOpts:fe.wc_sessionPropose.reject}),await this.client.proposal.delete(i,H("USER_DISCONNECTED")))}),E(this,"update",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidUpdate(t)}catch(p){throw this.client.logger.error("update() -> isValidUpdate() failed"),p}let{topic:i,namespaces:r}=t,{done:n,resolve:o,reject:a}=_t(),c=mt(),h=Rt().toString(),l=this.client.session.get(i).namespaces;return this.events.once(G("session_update",c),({error:p})=>{p?a(p):o()}),await this.client.session.update(i,{namespaces:r}),await this.sendRequest({topic:i,method:"wc_sessionUpdate",params:{namespaces:r},throwOnFailedPublish:!0,clientRpcId:c,relayRpcId:h}).catch(p=>{this.client.logger.error(p),this.client.session.update(i,{namespaces:l}),a(p)}),{acknowledged:n}}),E(this,"extend",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidExtend(t)}catch(c){throw this.client.logger.error("extend() -> isValidExtend() failed"),c}let{topic:i}=t,r=mt(),{done:n,resolve:o,reject:a}=_t();return this.events.once(G("session_extend",r),({error:c})=>{c?a(c):o()}),await this.setExpiry(i,re(Es)),this.sendRequest({topic:i,method:"wc_sessionExtend",params:{},clientRpcId:r,throwOnFailedPublish:!0}).catch(c=>{a(c)}),{acknowledged:n}}),E(this,"request",async t=>{this.isInitialized();try{await this.isValidRequest(t)}catch(w){throw this.client.logger.error("request() -> isValidRequest() failed"),w}let{chainId:i,request:r,topic:n,expiry:o=fe.wc_sessionRequest.req.ttl}=t,a=this.client.session.get(n);a?.transportType===te.relay&&await this.confirmOnlineStateOrThrow();let c=mt(),h=Rt().toString(),{done:l,resolve:p,reject:u}=_t(o,"Request expired. Please try again.");this.events.once(G("session_request",c),({error:w,result:m})=>{w?u(w):p(m)});let d="wc_sessionRequest",g=this.getAppLinkIfEnabled(a.peer.metadata,a.transportType);if(g)return await this.sendRequest({clientRpcId:c,relayRpcId:h,topic:n,method:d,params:{request:Re(X({},r),{expiryTimestamp:re(o)}),chainId:i},expiry:o,throwOnFailedPublish:!0,appLink:g}).catch(w=>u(w)),this.client.events.emit("session_request_sent",{topic:n,request:r,chainId:i,id:c}),await l();let y={request:Re(X({},r),{expiryTimestamp:re(o)}),chainId:i},f=this.shouldSetTVF(d,y);return await Promise.all([new Promise(async w=>{await this.sendRequest(X({clientRpcId:c,relayRpcId:h,topic:n,method:d,params:y,expiry:o,throwOnFailedPublish:!0},f&&{tvf:this.getTVFParams(c,y)})).catch(m=>u(m)),this.client.events.emit("session_request_sent",{topic:n,request:r,chainId:i,id:c}),w()}),new Promise(async w=>{var m;if(!((m=a.sessionConfig)!=null&&m.disableDeepLink)){let b=await Na(this.client.core.storage,xh);await Ca({id:c,topic:n,wcDeepLink:b})}w()}),l()]).then(w=>w[2])}),E(this,"respond",async t=>{this.isInitialized(),await this.isValidRespond(t);let{topic:i,response:r}=t,{id:n}=r,o=this.client.session.get(i);o.transportType===te.relay&&await this.confirmOnlineStateOrThrow();let a=this.getAppLinkIfEnabled(o.peer.metadata,o.transportType);Je(r)?await this.sendResult({id:n,topic:i,result:r.result,throwOnFailedPublish:!0,appLink:a}):Ve(r)&&await this.sendError({id:n,topic:i,error:r.error,appLink:a}),this.cleanupAfterResponse(t)}),E(this,"ping",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidPing(t)}catch(r){throw this.client.logger.error("ping() -> isValidPing() failed"),r}let{topic:i}=t;if(this.client.session.keys.includes(i)){let r=mt(),n=Rt().toString(),{done:o,resolve:a,reject:c}=_t();this.events.once(G("session_ping",r),({error:h})=>{h?c(h):a()}),await Promise.all([this.sendRequest({topic:i,method:"wc_sessionPing",params:{},throwOnFailedPublish:!0,clientRpcId:r,relayRpcId:n}),o()])}else this.client.core.pairing.pairings.keys.includes(i)&&(this.client.logger.warn("ping() on pairing topic is deprecated and will be removed in the next major release."),await this.client.core.pairing.ping({topic:i}))}),E(this,"emit",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow(),await this.isValidEmit(t);let{topic:i,event:r,chainId:n}=t,o=Rt().toString(),a=mt();await this.sendRequest({topic:i,method:"wc_sessionEvent",params:{event:r,chainId:n},throwOnFailedPublish:!0,relayRpcId:o,clientRpcId:a})}),E(this,"disconnect",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow(),await this.isValidDisconnect(t);let{topic:i}=t;if(this.client.session.keys.includes(i))await this.sendRequest({topic:i,method:"wc_sessionDelete",params:H("USER_DISCONNECTED"),throwOnFailedPublish:!0}),await this.deleteSession({topic:i,emitEvent:!1});else if(this.client.core.pairing.pairings.keys.includes(i))await this.client.core.pairing.disconnect({topic:i});else{let{message:r}=A("MISMATCHED_TOPIC",`Session or pairing topic not found: ${i}`);throw new Error(r)}}),E(this,"find",t=>(this.isInitialized(),this.client.session.getAll().filter(i=>Ec(i,t)))),E(this,"getPendingSessionRequests",()=>this.client.pendingRequest.getAll()),E(this,"authenticate",async(t,i)=>{var r;this.isInitialized(),this.isValidAuthenticate(t);let n=i&&this.client.core.linkModeSupportedApps.includes(i)&&((r=this.client.metadata.redirect)==null?void 0:r.linkMode),o=n?te.link_mode:te.relay;o===te.relay&&await this.confirmOnlineStateOrThrow();let{chains:a,statement:c="",uri:h,domain:l,nonce:p,type:u,exp:d,nbf:g,methods:y=[],expiry:f}=t,w=[...t.resources||[]],{topic:m,uri:b}=await this.client.core.pairing.create({methods:["wc_sessionAuthenticate"],transportType:o});this.client.logger.info({message:"Generated new pairing",pairing:{topic:m,uri:b}});let _=await this.client.core.crypto.generateKeyPair(),T=gs(_);if(await Promise.all([this.client.auth.authKeys.set(Ki,{responseTopic:T,publicKey:_}),this.client.auth.pairingTopics.set(T,{topic:T,pairingTopic:m})]),await this.client.core.relayer.subscribe(T,{transportType:o}),this.client.logger.info(`sending request to new pairing topic: ${m}`),y.length>0){let{namespace:S}=qt(a[0]),j=Va(S,"request",y);Qs(w)&&(j=za(j,w.pop())),w.push(j)}let P=f&&f>fe.wc_sessionAuthenticate.req.ttl?f:fe.wc_sessionAuthenticate.req.ttl,O={authPayload:{type:u??"caip122",chains:a,statement:c,aud:h,domain:l,version:"1",nonce:p,iat:new Date().toISOString(),exp:d,nbf:g,resources:w},requester:{publicKey:_,metadata:this.client.metadata},expiryTimestamp:re(P)},C={eip155:{chains:a,methods:[...new Set(["personal_sign",...y])],events:["chainChanged","accountsChanged"]}},v={requiredNamespaces:{},optionalNamespaces:C,relays:[{protocol:"irn"}],pairingTopic:m,proposer:{publicKey:_,metadata:this.client.metadata},expiryTimestamp:re(fe.wc_sessionPropose.req.ttl),id:mt()},{done:k,resolve:q,reject:F}=_t(P,"Request expired"),L=mt(),I=G("session_connect",v.id),x=G("session_request",L),R=async({error:S,session:j})=>{this.events.off(x,N),S?F(S):j&&q({session:j})},N=async S=>{var j,$,M;if(await this.deletePendingAuthRequest(L,{message:"fulfilled",code:0}),S.error){let ce=H("WC_METHOD_UNSUPPORTED","wc_sessionAuthenticate");return S.error.code===ce.code?void 0:(this.events.off(I,R),F(S.error.message))}await this.deleteProposal(v.id),this.events.off(I,R);let{cacaos:Z,responder:J}=S.result,ne=[],pe=[];for(let ce of Z){await Br({cacao:ce,projectId:this.client.core.projectId})||(this.client.logger.error(ce,"Signature verification failed"),F(H("SESSION_SETTLEMENT_FAILED","Signature verification failed")));let{p:kt}=ce,gt=Qs(kt.resources),rt=[Ei(kt.iss)],ft=Js(kt.iss);if(gt){let Xt=zr(gt),pi=Hr(gt);ne.push(...Xt),rt.push(...pi)}for(let Xt of rt)pe.push(`${Xt}:${ft}`)}let Ee=await this.client.core.crypto.generateSharedKey(_,J.publicKey),ae;ne.length>0&&(ae={topic:Ee,acknowledged:!0,self:{publicKey:_,metadata:this.client.metadata},peer:J,controller:J.publicKey,expiry:re(Es),requiredNamespaces:{},optionalNamespaces:{},relay:{protocol:"irn"},pairingTopic:m,namespaces:en([...new Set(ne)],[...new Set(pe)]),transportType:o},await this.client.core.relayer.subscribe(Ee,{transportType:o}),await this.client.session.set(Ee,ae),m&&await this.client.core.pairing.updateMetadata({topic:m,metadata:J.metadata}),ae=this.client.session.get(Ee)),(j=this.client.metadata.redirect)!=null&&j.linkMode&&($=J.metadata.redirect)!=null&&$.linkMode&&(M=J.metadata.redirect)!=null&&M.universal&&i&&(this.client.core.addLinkModeSupportedApp(J.metadata.redirect.universal),this.client.session.update(Ee,{transportType:te.link_mode})),q({auths:Z,session:ae})};this.events.once(I,R),this.events.once(x,N);let D;try{if(n){let S=nt("wc_sessionAuthenticate",O,L);this.client.core.history.set(m,S);let j=await this.client.core.crypto.encode("",S,{type:ds,encoding:St});D=si(i,m,j)}else await Promise.all([this.sendRequest({topic:m,method:"wc_sessionAuthenticate",params:O,expiry:t.expiry,throwOnFailedPublish:!0,clientRpcId:L}),this.sendRequest({topic:m,method:"wc_sessionPropose",params:v,expiry:fe.wc_sessionPropose.req.ttl,throwOnFailedPublish:!0,clientRpcId:v.id})])}catch(S){throw this.events.off(I,R),this.events.off(x,N),S}return await this.setProposal(v.id,v),await this.setAuthRequest(L,{request:Re(X({},O),{verifyContext:{}}),pairingTopic:m,transportType:o}),{uri:D??b,response:k}}),E(this,"approveSessionAuthenticate",async t=>{let{id:i,auths:r}=t,n=this.client.core.eventClient.createEvent({properties:{topic:i.toString(),trace:[Ut.authenticated_session_approve_started]}});try{this.isInitialized()}catch(f){throw n.setError(vs.no_internet_connection),f}let o=this.getPendingAuthRequest(i);if(!o)throw n.setError(vs.authenticated_session_pending_request_not_found),new Error(`Could not find pending auth request with id ${i}`);let a=o.transportType||te.relay;a===te.relay&&await this.confirmOnlineStateOrThrow();let c=o.requester.publicKey,h=await this.client.core.crypto.generateKeyPair(),l=gs(c),p={type:et,receiverPublicKey:c,senderPublicKey:h},u=[],d=[];for(let f of r){if(!await Br({cacao:f,projectId:this.client.core.projectId})){n.setError(vs.invalid_cacao);let T=H("SESSION_SETTLEMENT_FAILED","Signature verification failed");throw await this.sendError({id:i,topic:l,error:T,encodeOpts:p}),new Error(T.message)}n.addTrace(Ut.cacaos_verified);let{p:w}=f,m=Qs(w.resources),b=[Ei(w.iss)],_=Js(w.iss);if(m){let T=zr(m),P=Hr(m);u.push(...T),b.push(...P)}for(let T of b)d.push(`${T}:${_}`)}let g=await this.client.core.crypto.generateSharedKey(h,c);n.addTrace(Ut.create_authenticated_session_topic);let y;if(u?.length>0){y={topic:g,acknowledged:!0,self:{publicKey:h,metadata:this.client.metadata},peer:{publicKey:c,metadata:o.requester.metadata},controller:c,expiry:re(Es),authentication:r,requiredNamespaces:{},optionalNamespaces:{},relay:{protocol:"irn"},pairingTopic:o.pairingTopic,namespaces:en([...new Set(u)],[...new Set(d)]),transportType:a},n.addTrace(Ut.subscribing_authenticated_session_topic);try{await this.client.core.relayer.subscribe(g,{transportType:a})}catch(f){throw n.setError(vs.subscribe_authenticated_session_topic_failure),f}n.addTrace(Ut.subscribe_authenticated_session_topic_success),await this.client.session.set(g,y),n.addTrace(Ut.store_authenticated_session),await this.client.core.pairing.updateMetadata({topic:o.pairingTopic,metadata:o.requester.metadata})}n.addTrace(Ut.publishing_authenticated_session_approve);try{await this.sendResult({topic:l,id:i,result:{cacaos:r,responder:{publicKey:h,metadata:this.client.metadata}},encodeOpts:p,throwOnFailedPublish:!0,appLink:this.getAppLinkIfEnabled(o.requester.metadata,a)})}catch(f){throw n.setError(vs.authenticated_session_approve_publish_failure),f}return await this.client.auth.requests.delete(i,{message:"fulfilled",code:0}),await this.client.core.pairing.activate({topic:o.pairingTopic}),this.client.core.eventClient.deleteEvent({eventId:n.eventId}),{session:y}}),E(this,"rejectSessionAuthenticate",async t=>{this.isInitialized();let{id:i,reason:r}=t,n=this.getPendingAuthRequest(i);if(!n)throw new Error(`Could not find pending auth request with id ${i}`);n.transportType===te.relay&&await this.confirmOnlineStateOrThrow();let o=n.requester.publicKey,a=await this.client.core.crypto.generateKeyPair(),c=gs(o),h={type:et,receiverPublicKey:o,senderPublicKey:a};await this.sendError({id:i,topic:c,error:r,encodeOpts:h,rpcOpts:fe.wc_sessionAuthenticate.reject,appLink:this.getAppLinkIfEnabled(n.requester.metadata,n.transportType)}),await this.client.auth.requests.delete(i,{message:"rejected",code:0}),await this.client.proposal.delete(i,H("USER_DISCONNECTED"))}),E(this,"formatAuthMessage",t=>{this.isInitialized();let{request:i,iss:r}=t;return Vr(i,r)}),E(this,"processRelayMessageCache",()=>{setTimeout(async()=>{if(this.relayMessageCache.length!==0)for(;this.relayMessageCache.length>0;)try{let t=this.relayMessageCache.shift();t&&await this.onRelayMessage(t)}catch(t){this.client.logger.error(t)}},50)}),E(this,"cleanupDuplicatePairings",async t=>{if(t.pairingTopic)try{let i=this.client.core.pairing.pairings.get(t.pairingTopic),r=this.client.core.pairing.pairings.getAll().filter(n=>{var o,a;return((o=n.peerMetadata)==null?void 0:o.url)&&((a=n.peerMetadata)==null?void 0:a.url)===t.peer.metadata.url&&n.topic&&n.topic!==i.topic});if(r.length===0)return;this.client.logger.info(`Cleaning up ${r.length} duplicate pairing(s)`),await Promise.all(r.map(n=>this.client.core.pairing.disconnect({topic:n.topic}))),this.client.logger.info("Duplicate pairings clean up finished")}catch(i){this.client.logger.error(i)}}),E(this,"deleteSession",async t=>{var i;let{topic:r,expirerHasDeleted:n=!1,emitEvent:o=!0,id:a=0}=t,{self:c}=this.client.session.get(r);await this.client.core.relayer.unsubscribe(r),await this.client.session.delete(r,H("USER_DISCONNECTED")),this.addToRecentlyDeleted(r,"session"),this.client.core.crypto.keychain.has(c.publicKey)&&await this.client.core.crypto.deleteKeyPair(c.publicKey),this.client.core.crypto.keychain.has(r)&&await this.client.core.crypto.deleteSymKey(r),n||this.client.core.expirer.del(r),this.client.core.storage.removeItem(xh).catch(h=>this.client.logger.warn(h)),this.getPendingSessionRequests().forEach(h=>{h.topic===r&&this.deletePendingSessionRequest(h.id,H("USER_DISCONNECTED"))}),r===((i=this.sessionRequestQueue.queue[0])==null?void 0:i.topic)&&(this.sessionRequestQueue.state=dt.idle),o&&this.client.events.emit("session_delete",{id:a,topic:r})}),E(this,"deleteProposal",async(t,i)=>{if(i)try{let r=this.client.proposal.get(t);this.client.core.eventClient.getEvent({topic:r.pairingTopic})?.setError(Ft.proposal_expired)}catch{}await Promise.all([this.client.proposal.delete(t,H("USER_DISCONNECTED")),i?Promise.resolve():this.client.core.expirer.del(t)]),this.addToRecentlyDeleted(t,"proposal")}),E(this,"deletePendingSessionRequest",async(t,i,r=!1)=>{await Promise.all([this.client.pendingRequest.delete(t,i),r?Promise.resolve():this.client.core.expirer.del(t)]),this.addToRecentlyDeleted(t,"request"),this.sessionRequestQueue.queue=this.sessionRequestQueue.queue.filter(n=>n.id!==t),r&&(this.sessionRequestQueue.state=dt.idle,this.client.events.emit("session_request_expire",{id:t}))}),E(this,"deletePendingAuthRequest",async(t,i,r=!1)=>{await Promise.all([this.client.auth.requests.delete(t,i),r?Promise.resolve():this.client.core.expirer.del(t)])}),E(this,"setExpiry",async(t,i)=>{this.client.session.keys.includes(t)&&(this.client.core.expirer.set(t,i),await this.client.session.update(t,{expiry:i}))}),E(this,"setProposal",async(t,i)=>{this.client.core.expirer.set(t,re(fe.wc_sessionPropose.req.ttl)),await this.client.proposal.set(t,i)}),E(this,"setAuthRequest",async(t,i)=>{let{request:r,pairingTopic:n,transportType:o=te.relay}=i;this.client.core.expirer.set(t,r.expiryTimestamp),await this.client.auth.requests.set(t,{authPayload:r.authPayload,requester:r.requester,expiryTimestamp:r.expiryTimestamp,id:t,pairingTopic:n,verifyContext:r.verifyContext,transportType:o})}),E(this,"setPendingSessionRequest",async t=>{let{id:i,topic:r,params:n,verifyContext:o}=t,a=n.request.expiryTimestamp||re(fe.wc_sessionRequest.req.ttl);this.client.core.expirer.set(i,a),await this.client.pendingRequest.set(i,{id:i,topic:r,params:n,verifyContext:o})}),E(this,"sendRequest",async t=>{let{topic:i,method:r,params:n,expiry:o,relayRpcId:a,clientRpcId:c,throwOnFailedPublish:h,appLink:l,tvf:p}=t,u=nt(r,n,c),d,g=!!l;try{let w=g?St:ke;d=await this.client.core.crypto.encode(i,u,{encoding:w})}catch(w){throw await this.cleanup(),this.client.logger.error(`sendRequest() -> core.crypto.encode() for topic ${i} failed`),w}let y;if($m.includes(r)){let w=ze(JSON.stringify(u)),m=ze(d);y=await this.client.core.verify.register({id:m,decryptedId:w})}let f=fe[r].req;if(f.attestation=y,o&&(f.ttl=o),a&&(f.id=a),this.client.core.history.set(i,u),g){let w=si(l,i,d);await global.Linking.openURL(w,this.client.name)}else{let w=fe[r].req;o&&(w.ttl=o),a&&(w.id=a),w.tvf=Re(X({},p),{correlationId:u.id}),h?(w.internal=Re(X({},w.internal),{throwOnFailedPublish:!0}),await this.client.core.relayer.publish(i,d,w)):this.client.core.relayer.publish(i,d,w).catch(m=>this.client.logger.error(m))}return u.id}),E(this,"sendResult",async t=>{let{id:i,topic:r,result:n,throwOnFailedPublish:o,encodeOpts:a,appLink:c}=t,h=Mt(i,n),l,p=c&&typeof(global==null?void 0:global.Linking)<"u";try{let g=p?St:ke;l=await this.client.core.crypto.encode(r,h,Re(X({},a||{}),{encoding:g}))}catch(g){throw await this.cleanup(),this.client.logger.error(`sendResult() -> core.crypto.encode() for topic ${r} failed`),g}let u,d;try{u=await this.client.core.history.get(r,i);let g=u.request;try{this.shouldSetTVF(g.method,g.params)&&(d=this.getTVFParams(i,g.params,n))}catch(y){this.client.logger.warn("sendResult() -> getTVFParams() failed",y)}}catch(g){throw this.client.logger.error(`sendResult() -> history.get(${r}, ${i}) failed`),g}if(p){let g=si(c,r,l);await global.Linking.openURL(g,this.client.name)}else{let g=u.request.method,y=fe[g].res;y.tvf=Re(X({},d),{correlationId:i}),o?(y.internal=Re(X({},y.internal),{throwOnFailedPublish:!0}),await this.client.core.relayer.publish(r,l,y)):this.client.core.relayer.publish(r,l,y).catch(f=>this.client.logger.error(f))}await this.client.core.history.resolve(h)}),E(this,"sendError",async t=>{let{id:i,topic:r,error:n,encodeOpts:o,rpcOpts:a,appLink:c}=t,h=ui(i,n),l,p=c&&typeof(global==null?void 0:global.Linking)<"u";try{let d=p?St:ke;l=await this.client.core.crypto.encode(r,h,Re(X({},o||{}),{encoding:d}))}catch(d){throw await this.cleanup(),this.client.logger.error(`sendError() -> core.crypto.encode() for topic ${r} failed`),d}let u;try{u=await this.client.core.history.get(r,i)}catch(d){throw this.client.logger.error(`sendError() -> history.get(${r}, ${i}) failed`),d}if(p){let d=si(c,r,l);await global.Linking.openURL(d,this.client.name)}else{let d=u.request.method,g=a||fe[d].res;this.client.core.relayer.publish(r,l,g)}await this.client.core.history.resolve(h)}),E(this,"cleanup",async()=>{let t=[],i=[];this.client.session.getAll().forEach(r=>{let n=!1;at(r.expiry)&&(n=!0),this.client.core.crypto.keychain.has(r.topic)||(n=!0),n&&t.push(r.topic)}),this.client.proposal.getAll().forEach(r=>{at(r.expiryTimestamp)&&i.push(r.id)}),await Promise.all([...t.map(r=>this.deleteSession({topic:r})),...i.map(r=>this.deleteProposal(r))])}),E(this,"onProviderMessageEvent",async t=>{!this.initialized||this.relayMessageCache.length>0?this.relayMessageCache.push(t):await this.onRelayMessage(t)}),E(this,"onRelayEventRequest",async t=>{this.requestQueue.queue.push(t),await this.processRequestsQueue()}),E(this,"processRequestsQueue",async()=>{if(this.requestQueue.state===dt.active){this.client.logger.info("Request queue already active, skipping...");return}for(this.client.logger.info(`Request queue starting with ${this.requestQueue.queue.length} requests`);this.requestQueue.queue.length>0;){this.requestQueue.state=dt.active;let t=this.requestQueue.queue.shift();if(t)try{await this.processRequest(t)}catch(i){this.client.logger.warn(i)}}this.requestQueue.state=dt.idle}),E(this,"processRequest",async t=>{let{topic:i,payload:r,attestation:n,transportType:o,encryptedId:a}=t,c=r.method;if(!this.shouldIgnorePairingRequest({topic:i,requestMethod:c}))switch(c){case"wc_sessionPropose":return await this.onSessionProposeRequest({topic:i,payload:r,attestation:n,encryptedId:a});case"wc_sessionSettle":return await this.onSessionSettleRequest(i,r);case"wc_sessionUpdate":return await this.onSessionUpdateRequest(i,r);case"wc_sessionExtend":return await this.onSessionExtendRequest(i,r);case"wc_sessionPing":return await this.onSessionPingRequest(i,r);case"wc_sessionDelete":return await this.onSessionDeleteRequest(i,r);case"wc_sessionRequest":return await this.onSessionRequest({topic:i,payload:r,attestation:n,encryptedId:a,transportType:o});case"wc_sessionEvent":return await this.onSessionEventRequest(i,r);case"wc_sessionAuthenticate":return await this.onSessionAuthenticateRequest({topic:i,payload:r,attestation:n,encryptedId:a,transportType:o});default:return this.client.logger.info(`Unsupported request method ${c}`)}}),E(this,"onRelayEventResponse",async t=>{let{topic:i,payload:r,transportType:n}=t,o=(await this.client.core.history.get(i,r.id)).request.method;switch(o){case"wc_sessionPropose":return this.onSessionProposeResponse(i,r,n);case"wc_sessionSettle":return this.onSessionSettleResponse(i,r);case"wc_sessionUpdate":return this.onSessionUpdateResponse(i,r);case"wc_sessionExtend":return this.onSessionExtendResponse(i,r);case"wc_sessionPing":return this.onSessionPingResponse(i,r);case"wc_sessionRequest":return this.onSessionRequestResponse(i,r);case"wc_sessionAuthenticate":return this.onSessionAuthenticateResponse(i,r);default:return this.client.logger.info(`Unsupported response method ${o}`)}}),E(this,"onRelayEventUnknownPayload",t=>{let{topic:i}=t,{message:r}=A("MISSING_OR_INVALID",`Decoded payload on topic ${i} is not identifiable as a JSON-RPC request or a response.`);throw new Error(r)}),E(this,"shouldIgnorePairingRequest",t=>{let{topic:i,requestMethod:r}=t,n=this.expectedPairingMethodMap.get(i);return!n||n.includes(r)?!1:!!(n.includes("wc_sessionAuthenticate")&&this.client.events.listenerCount("session_authenticate")>0)}),E(this,"onSessionProposeRequest",async t=>{let{topic:i,payload:r,attestation:n,encryptedId:o}=t,{params:a,id:c}=r;try{let h=this.client.core.eventClient.getEvent({topic:i});this.client.events.listenerCount("session_proposal")===0&&(console.warn("No listener for session_proposal event"),h?.setError(lt.proposal_listener_not_found)),this.isValidConnect(X({},r.params));let l=a.expiryTimestamp||re(fe.wc_sessionPropose.req.ttl),p=X({id:c,pairingTopic:i,expiryTimestamp:l},a);await this.setProposal(c,p);let u=await this.getVerifyContext({attestationId:n,hash:ze(JSON.stringify(r)),encryptedId:o,metadata:p.proposer.metadata});h?.addTrace(it.emit_session_proposal),this.client.events.emit("session_proposal",{id:c,params:p,verifyContext:u})}catch(h){await this.sendError({id:c,topic:i,error:h,rpcOpts:fe.wc_sessionPropose.autoReject}),this.client.logger.error(h)}}),E(this,"onSessionProposeResponse",async(t,i,r)=>{let{id:n}=i;if(Je(i)){let{result:o}=i;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",result:o});let a=this.client.proposal.get(n);this.client.logger.trace({type:"method",method:"onSessionProposeResponse",proposal:a});let c=a.proposer.publicKey;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",selfPublicKey:c});let h=o.responderPublicKey;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",peerPublicKey:h});let l=await this.client.core.crypto.generateSharedKey(c,h);this.pendingSessions.set(n,{sessionTopic:l,pairingTopic:t,proposalId:n,publicKey:c});let p=await this.client.core.relayer.subscribe(l,{transportType:r});this.client.logger.trace({type:"method",method:"onSessionProposeResponse",subscriptionId:p}),await this.client.core.pairing.activate({topic:t})}else if(Ve(i)){await this.client.proposal.delete(n,H("USER_DISCONNECTED"));let o=G("session_connect",n);if(this.events.listenerCount(o)===0)throw new Error(`emitting ${o} without any listeners, 954`);this.events.emit(o,{error:i.error})}}),E(this,"onSessionSettleRequest",async(t,i)=>{let{id:r,params:n}=i;try{this.isValidSessionSettleRequest(n);let{relay:o,controller:a,expiry:c,namespaces:h,sessionProperties:l,scopedProperties:p,sessionConfig:u}=i.params,d=[...this.pendingSessions.values()].find(f=>f.sessionTopic===t);if(!d)return this.client.logger.error(`Pending session not found for topic ${t}`);let g=this.client.proposal.get(d.proposalId),y=Re(X(X(X({topic:t,relay:o,expiry:c,namespaces:h,acknowledged:!0,pairingTopic:d.pairingTopic,requiredNamespaces:g.requiredNamespaces,optionalNamespaces:g.optionalNamespaces,controller:a.publicKey,self:{publicKey:d.publicKey,metadata:this.client.metadata},peer:{publicKey:a.publicKey,metadata:a.metadata}},l&&{sessionProperties:l}),p&&{scopedProperties:p}),u&&{sessionConfig:u}),{transportType:te.relay});await this.client.session.set(y.topic,y),await this.setExpiry(y.topic,y.expiry),await this.client.core.pairing.updateMetadata({topic:d.pairingTopic,metadata:y.peer.metadata}),this.client.events.emit("session_connect",{session:y}),this.events.emit(G("session_connect",d.proposalId),{session:y}),this.pendingSessions.delete(d.proposalId),this.deleteProposal(d.proposalId,!1),this.cleanupDuplicatePairings(y),await this.sendResult({id:i.id,topic:t,result:!0,throwOnFailedPublish:!0})}catch(o){await this.sendError({id:r,topic:t,error:o}),this.client.logger.error(o)}}),E(this,"onSessionSettleResponse",async(t,i)=>{let{id:r}=i;Je(i)?(await this.client.session.update(t,{acknowledged:!0}),this.events.emit(G("session_approve",r),{})):Ve(i)&&(await this.client.session.delete(t,H("USER_DISCONNECTED")),this.events.emit(G("session_approve",r),{error:i.error}))}),E(this,"onSessionUpdateRequest",async(t,i)=>{let{params:r,id:n}=i;try{let o=`${t}_session_update`,a=Nt.get(o);if(a&&this.isRequestOutOfSync(a,n)){this.client.logger.warn(`Discarding out of sync request - ${n}`),this.sendError({id:n,topic:t,error:H("INVALID_UPDATE_REQUEST")});return}this.isValidUpdate(X({topic:t},r));try{Nt.set(o,n),await this.client.session.update(t,{namespaces:r.namespaces}),await this.sendResult({id:n,topic:t,result:!0,throwOnFailedPublish:!0})}catch(c){throw Nt.delete(o),c}this.client.events.emit("session_update",{id:n,topic:t,params:r})}catch(o){await this.sendError({id:n,topic:t,error:o}),this.client.logger.error(o)}}),E(this,"isRequestOutOfSync",(t,i)=>i.toString().slice(0,-3)<t.toString().slice(0,-3)),E(this,"onSessionUpdateResponse",(t,i)=>{let{id:r}=i,n=G("session_update",r);if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners`);Je(i)?this.events.emit(G("session_update",r),{}):Ve(i)&&this.events.emit(G("session_update",r),{error:i.error})}),E(this,"onSessionExtendRequest",async(t,i)=>{let{id:r}=i;try{this.isValidExtend({topic:t}),await this.setExpiry(t,re(Es)),await this.sendResult({id:r,topic:t,result:!0,throwOnFailedPublish:!0}),this.client.events.emit("session_extend",{id:r,topic:t})}catch(n){await this.sendError({id:r,topic:t,error:n}),this.client.logger.error(n)}}),E(this,"onSessionExtendResponse",(t,i)=>{let{id:r}=i,n=G("session_extend",r);if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners`);Je(i)?this.events.emit(G("session_extend",r),{}):Ve(i)&&this.events.emit(G("session_extend",r),{error:i.error})}),E(this,"onSessionPingRequest",async(t,i)=>{let{id:r}=i;try{this.isValidPing({topic:t}),await this.sendResult({id:r,topic:t,result:!0,throwOnFailedPublish:!0}),this.client.events.emit("session_ping",{id:r,topic:t})}catch(n){await this.sendError({id:r,topic:t,error:n}),this.client.logger.error(n)}}),E(this,"onSessionPingResponse",(t,i)=>{let{id:r}=i,n=G("session_ping",r);setTimeout(()=>{if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners 2176`);Je(i)?this.events.emit(G("session_ping",r),{}):Ve(i)&&this.events.emit(G("session_ping",r),{error:i.error})},500)}),E(this,"onSessionDeleteRequest",async(t,i)=>{let{id:r}=i;try{this.isValidDisconnect({topic:t,reason:i.params}),Promise.all([new Promise(n=>{this.client.core.relayer.once(le.publish,async()=>{n(await this.deleteSession({topic:t,id:r}))})}),this.sendResult({id:r,topic:t,result:!0,throwOnFailedPublish:!0}),this.cleanupPendingSentRequestsForTopic({topic:t,error:H("USER_DISCONNECTED")})]).catch(n=>this.client.logger.error(n))}catch(n){this.client.logger.error(n)}}),E(this,"onSessionRequest",async t=>{var i,r,n;let{topic:o,payload:a,attestation:c,encryptedId:h,transportType:l}=t,{id:p,params:u}=a;try{await this.isValidRequest(X({topic:o},u));let d=this.client.session.get(o),g=await this.getVerifyContext({attestationId:c,hash:ze(JSON.stringify(nt("wc_sessionRequest",u,p))),encryptedId:h,metadata:d.peer.metadata,transportType:l}),y={id:p,topic:o,params:u,verifyContext:g};await this.setPendingSessionRequest(y),l===te.link_mode&&(i=d.peer.metadata.redirect)!=null&&i.universal&&this.client.core.addLinkModeSupportedApp((r=d.peer.metadata.redirect)==null?void 0:r.universal),(n=this.client.signConfig)!=null&&n.disableRequestQueue?this.emitSessionRequest(y):(this.addSessionRequestToSessionRequestQueue(y),this.processSessionRequestQueue())}catch(d){await this.sendError({id:p,topic:o,error:d}),this.client.logger.error(d)}}),E(this,"onSessionRequestResponse",(t,i)=>{let{id:r}=i,n=G("session_request",r);if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners`);Je(i)?this.events.emit(G("session_request",r),{result:i.result}):Ve(i)&&this.events.emit(G("session_request",r),{error:i.error})}),E(this,"onSessionEventRequest",async(t,i)=>{let{id:r,params:n}=i;try{let o=`${t}_session_event_${n.event.name}`,a=Nt.get(o);if(a&&this.isRequestOutOfSync(a,r)){this.client.logger.info(`Discarding out of sync request - ${r}`);return}this.isValidEmit(X({topic:t},n)),this.client.events.emit("session_event",{id:r,topic:t,params:n}),Nt.set(o,r)}catch(o){await this.sendError({id:r,topic:t,error:o}),this.client.logger.error(o)}}),E(this,"onSessionAuthenticateResponse",(t,i)=>{let{id:r}=i;this.client.logger.trace({type:"method",method:"onSessionAuthenticateResponse",topic:t,payload:i}),Je(i)?this.events.emit(G("session_request",r),{result:i.result}):Ve(i)&&this.events.emit(G("session_request",r),{error:i.error})}),E(this,"onSessionAuthenticateRequest",async t=>{var i;let{topic:r,payload:n,attestation:o,encryptedId:a,transportType:c}=t;try{let{requester:h,authPayload:l,expiryTimestamp:p}=n.params,u=await this.getVerifyContext({attestationId:o,hash:ze(JSON.stringify(n)),encryptedId:a,metadata:h.metadata,transportType:c}),d={requester:h,pairingTopic:r,id:n.id,authPayload:l,verifyContext:u,expiryTimestamp:p};await this.setAuthRequest(n.id,{request:d,pairingTopic:r,transportType:c}),c===te.link_mode&&(i=h.metadata.redirect)!=null&&i.universal&&this.client.core.addLinkModeSupportedApp(h.metadata.redirect.universal),this.client.events.emit("session_authenticate",{topic:r,params:n.params,id:n.id,verifyContext:u})}catch(h){this.client.logger.error(h);let l=n.params.requester.publicKey,p=await this.client.core.crypto.generateKeyPair(),u=this.getAppLinkIfEnabled(n.params.requester.metadata,c),d={type:et,receiverPublicKey:l,senderPublicKey:p};await this.sendError({id:n.id,topic:r,error:h,encodeOpts:d,rpcOpts:fe.wc_sessionAuthenticate.autoReject,appLink:u})}}),E(this,"addSessionRequestToSessionRequestQueue",t=>{this.sessionRequestQueue.queue.push(t)}),E(this,"cleanupAfterResponse",t=>{this.deletePendingSessionRequest(t.response.id,{message:"fulfilled",code:0}),setTimeout(()=>{this.sessionRequestQueue.state=dt.idle,this.processSessionRequestQueue()},(0,B.toMiliseconds)(this.requestQueueDelay))}),E(this,"cleanupPendingSentRequestsForTopic",({topic:t,error:i})=>{let r=this.client.core.history.pending;r.length>0&&r.filter(n=>n.topic===t&&n.request.method==="wc_sessionRequest").forEach(n=>{let o=n.request.id,a=G("session_request",o);if(this.events.listenerCount(a)===0)throw new Error(`emitting ${a} without any listeners`);this.events.emit(G("session_request",n.request.id),{error:i})})}),E(this,"processSessionRequestQueue",()=>{if(this.sessionRequestQueue.state===dt.active){this.client.logger.info("session request queue is already active.");return}let t=this.sessionRequestQueue.queue[0];if(!t){this.client.logger.info("session request queue is empty.");return}try{this.sessionRequestQueue.state=dt.active,this.emitSessionRequest(t)}catch(i){this.client.logger.error(i)}}),E(this,"emitSessionRequest",t=>{this.client.events.emit("session_request",t)}),E(this,"onPairingCreated",t=>{if(t.methods&&this.expectedPairingMethodMap.set(t.topic,t.methods),t.active)return;let i=this.client.proposal.getAll().find(r=>r.pairingTopic===t.topic);i&&this.onSessionProposeRequest({topic:t.topic,payload:nt("wc_sessionPropose",Re(X({},i),{requiredNamespaces:i.requiredNamespaces,optionalNamespaces:i.optionalNamespaces,relays:i.relays,proposer:i.proposer,sessionProperties:i.sessionProperties,scopedProperties:i.scopedProperties}),i.id)})}),E(this,"isValidConnect",async t=>{if(!Pe(t)){let{message:h}=A("MISSING_OR_INVALID",`connect() params: ${JSON.stringify(t)}`);throw new Error(h)}let{pairingTopic:i,requiredNamespaces:r,optionalNamespaces:n,sessionProperties:o,scopedProperties:a,relays:c}=t;if(he(i)||await this.isValidPairingTopic(i),!xc(c,!0)){let{message:h}=A("MISSING_OR_INVALID",`connect() relays: ${c}`);throw new Error(h)}if(!he(r)&&ct(r)!==0){let h="requiredNamespaces are deprecated and are automatically assigned to optionalNamespaces";["fatal","error","silent"].includes(this.client.logger.level)?console.warn(h):this.client.logger.warn(h),this.validateNamespaces(r,"requiredNamespaces")}if(!he(n)&&ct(n)!==0&&this.validateNamespaces(n,"optionalNamespaces"),he(o)||this.validateSessionProps(o,"sessionProperties"),!he(a)){this.validateSessionProps(a,"scopedProperties");let h=Object.keys(r||{}).concat(Object.keys(n||{}));if(!Object.keys(a).every(l=>h.includes(l)))throw new Error(`Scoped properties must be a subset of required/optional namespaces, received: ${JSON.stringify(a)}, required/optional namespaces: ${JSON.stringify(h)}`)}}),E(this,"validateNamespaces",(t,i)=>{let r=Rc(t,"connect()",i);if(r)throw new Error(r.message)}),E(this,"isValidApprove",async t=>{if(!Pe(t))throw new Error(A("MISSING_OR_INVALID",`approve() params: ${t}`).message);let{id:i,namespaces:r,relayProtocol:n,sessionProperties:o,scopedProperties:a}=t;this.checkRecentlyDeleted(i),await this.isValidProposalId(i);let c=this.client.proposal.get(i),h=xi(r,"approve()");if(h)throw new Error(h.message);let l=nn(c.requiredNamespaces,r,"approve()");if(l)throw new Error(l.message);if(!se(n,!0)){let{message:p}=A("MISSING_OR_INVALID",`approve() relayProtocol: ${n}`);throw new Error(p)}if(he(o)||this.validateSessionProps(o,"sessionProperties"),!he(a)){this.validateSessionProps(a,"scopedProperties");let p=new Set(Object.keys(r));if(!Object.keys(a).every(u=>p.has(u)))throw new Error(`Scoped properties must be a subset of approved namespaces, received: ${JSON.stringify(a)}, approved namespaces: ${Array.from(p).join(", ")}`)}}),E(this,"isValidReject",async t=>{if(!Pe(t)){let{message:n}=A("MISSING_OR_INVALID",`reject() params: ${t}`);throw new Error(n)}let{id:i,reason:r}=t;if(this.checkRecentlyDeleted(i),await this.isValidProposalId(i),!Ac(r)){let{message:n}=A("MISSING_OR_INVALID",`reject() reason: ${JSON.stringify(r)}`);throw new Error(n)}}),E(this,"isValidSessionSettleRequest",t=>{if(!Pe(t)){let{message:h}=A("MISSING_OR_INVALID",`onSessionSettleRequest() params: ${t}`);throw new Error(h)}let{relay:i,controller:r,namespaces:n,expiry:o}=t;if(!sn(i)){let{message:h}=A("MISSING_OR_INVALID","onSessionSettleRequest() relay protocol should be a string");throw new Error(h)}let a=Sc(r,"onSessionSettleRequest()");if(a)throw new Error(a.message);let c=xi(n,"onSessionSettleRequest()");if(c)throw new Error(c.message);if(at(o)){let{message:h}=A("EXPIRED","onSessionSettleRequest()");throw new Error(h)}}),E(this,"isValidUpdate",async t=>{if(!Pe(t)){let{message:c}=A("MISSING_OR_INVALID",`update() params: ${t}`);throw new Error(c)}let{topic:i,namespaces:r}=t;this.checkRecentlyDeleted(i),await this.isValidSessionTopic(i);let n=this.client.session.get(i),o=xi(r,"update()");if(o)throw new Error(o.message);let a=nn(n.requiredNamespaces,r,"update()");if(a)throw new Error(a.message)}),E(this,"isValidExtend",async t=>{if(!Pe(t)){let{message:r}=A("MISSING_OR_INVALID",`extend() params: ${t}`);throw new Error(r)}let{topic:i}=t;this.checkRecentlyDeleted(i),await this.isValidSessionTopic(i)}),E(this,"isValidRequest",async t=>{if(!Pe(t)){let{message:c}=A("MISSING_OR_INVALID",`request() params: ${t}`);throw new Error(c)}let{topic:i,request:r,chainId:n,expiry:o}=t;this.checkRecentlyDeleted(i),await this.isValidSessionTopic(i);let{namespaces:a}=this.client.session.get(i);if(!rn(a,n)){let{message:c}=A("MISSING_OR_INVALID",`request() chainId: ${n}`);throw new Error(c)}if(!Cc(r)){let{message:c}=A("MISSING_OR_INVALID",`request() ${JSON.stringify(r)}`);throw new Error(c)}if(!Dc(a,n,r.method)){let{message:c}=A("MISSING_OR_INVALID",`request() method: ${r.method}`);throw new Error(c)}if(o&&!Uc(o,Vn)){let{message:c}=A("MISSING_OR_INVALID",`request() expiry: ${o}. Expiry must be a number (in seconds) between ${Vn.min} and ${Vn.max}`);throw new Error(c)}}),E(this,"isValidRespond",async t=>{var i;if(!Pe(t)){let{message:o}=A("MISSING_OR_INVALID",`respond() params: ${t}`);throw new Error(o)}let{topic:r,response:n}=t;try{await this.isValidSessionTopic(r)}catch(o){throw(i=t?.response)!=null&&i.id&&this.cleanupAfterResponse(t),o}if(!Nc(n)){let{message:o}=A("MISSING_OR_INVALID",`respond() response: ${JSON.stringify(n)}`);throw new Error(o)}}),E(this,"isValidPing",async t=>{if(!Pe(t)){let{message:r}=A("MISSING_OR_INVALID",`ping() params: ${t}`);throw new Error(r)}let{topic:i}=t;await this.isValidSessionOrPairingTopic(i)}),E(this,"isValidEmit",async t=>{if(!Pe(t)){let{message:a}=A("MISSING_OR_INVALID",`emit() params: ${t}`);throw new Error(a)}let{topic:i,event:r,chainId:n}=t;await this.isValidSessionTopic(i);let{namespaces:o}=this.client.session.get(i);if(!rn(o,n)){let{message:a}=A("MISSING_OR_INVALID",`emit() chainId: ${n}`);throw new Error(a)}if(!qc(r)){let{message:a}=A("MISSING_OR_INVALID",`emit() event: ${JSON.stringify(r)}`);throw new Error(a)}if(!Fc(o,n,r.name)){let{message:a}=A("MISSING_OR_INVALID",`emit() event: ${JSON.stringify(r)}`);throw new Error(a)}}),E(this,"isValidDisconnect",async t=>{if(!Pe(t)){let{message:r}=A("MISSING_OR_INVALID",`disconnect() params: ${t}`);throw new Error(r)}let{topic:i}=t;await this.isValidSessionOrPairingTopic(i)}),E(this,"isValidAuthenticate",t=>{let{chains:i,uri:r,domain:n,nonce:o}=t;if(!Array.isArray(i)||i.length===0)throw new Error("chains is required and must be a non-empty array");if(!se(r,!1))throw new Error("uri is required parameter");if(!se(n,!1))throw new Error("domain is required parameter");if(!se(o,!1))throw new Error("nonce is required parameter");if([...new Set(i.map(c=>qt(c).namespace))].length>1)throw new Error("Multi-namespace requests are not supported. Please request single namespace only.");let{namespace:a}=qt(i[0]);if(a!=="eip155")throw new Error("Only eip155 namespace is supported for authenticated sessions. Please use .connect() for non-eip155 chains.")}),E(this,"getVerifyContext",async t=>{let{attestationId:i,hash:r,encryptedId:n,metadata:o,transportType:a}=t,c={verified:{verifyUrl:o.verifyUrl||bs,validation:"UNKNOWN",origin:o.url||""}};try{if(a===te.link_mode){let l=this.getAppLinkIfEnabled(o,a);return c.verified.validation=l&&new URL(l).origin===new URL(o.url).origin?"VALID":"INVALID",c}let h=await this.client.core.verify.resolve({attestationId:i,hash:r,encryptedId:n,verifyUrl:o.verifyUrl});h&&(c.verified.origin=h.origin,c.verified.isScam=h.isScam,c.verified.validation=h.origin===new URL(o.url).origin?"VALID":"INVALID")}catch(h){this.client.logger.warn(h)}return this.client.logger.debug(`Verify context: ${JSON.stringify(c)}`),c}),E(this,"validateSessionProps",(t,i)=>{Object.values(t).forEach((r,n)=>{if(r==null){let{message:o}=A("MISSING_OR_INVALID",`${i} must contain an existing value for each key. Received: ${r} for key ${Object.keys(t)[n]}`);throw new Error(o)}})}),E(this,"getPendingAuthRequest",t=>{let i=this.client.auth.requests.get(t);return typeof i=="object"?i:void 0}),E(this,"addToRecentlyDeleted",(t,i)=>{if(this.recentlyDeletedMap.set(t,i),this.recentlyDeletedMap.size>=this.recentlyDeletedLimit){let r=0,n=this.recentlyDeletedLimit/2;for(let o of this.recentlyDeletedMap.keys()){if(r++>=n)break;this.recentlyDeletedMap.delete(o)}}}),E(this,"checkRecentlyDeleted",t=>{let i=this.recentlyDeletedMap.get(t);if(i){let{message:r}=A("MISSING_OR_INVALID",`Record was recently deleted - ${i}: ${t}`);throw new Error(r)}}),E(this,"isLinkModeEnabled",(t,i)=>{var r,n,o,a,c,h,l,p,u;return!t||i!==te.link_mode?!1:((n=(r=this.client.metadata)==null?void 0:r.redirect)==null?void 0:n.linkMode)===!0&&((a=(o=this.client.metadata)==null?void 0:o.redirect)==null?void 0:a.universal)!==void 0&&((h=(c=this.client.metadata)==null?void 0:c.redirect)==null?void 0:h.universal)!==""&&((l=t?.redirect)==null?void 0:l.universal)!==void 0&&((p=t?.redirect)==null?void 0:p.universal)!==""&&((u=t?.redirect)==null?void 0:u.linkMode)===!0&&this.client.core.linkModeSupportedApps.includes(t.redirect.universal)&&typeof(global==null?void 0:global.Linking)<"u"}),E(this,"getAppLinkIfEnabled",(t,i)=>{var r;return this.isLinkModeEnabled(t,i)?(r=t?.redirect)==null?void 0:r.universal:void 0}),E(this,"handleLinkModeMessage",({url:t})=>{if(!t||!t.includes("wc_ev")||!t.includes("topic"))return;let i=jr(t,"topic")||"",r=decodeURIComponent(jr(t,"wc_ev")||""),n=this.client.session.keys.includes(i);n&&this.client.session.update(i,{transportType:te.link_mode}),this.client.core.dispatchEnvelope({topic:i,message:r,sessionExists:n})}),E(this,"registerLinkModeListeners",async()=>{var t;if(Ws()||It()&&(t=this.client.metadata.redirect)!=null&&t.linkMode){let i=global==null?void 0:global.Linking;if(typeof i<"u"){i.addEventListener("url",this.handleLinkModeMessage,this.client.name);let r=await i.getInitialURL();r&&setTimeout(()=>{this.handleLinkModeMessage({url:r})},50)}}}),E(this,"shouldSetTVF",(t,i)=>{if(!i||t!=="wc_sessionRequest")return!1;let{request:r}=i;return Object.keys(Ah).includes(r.method)}),E(this,"getTVFParams",(t,i,r)=>{var n,o;try{let a=i.request.method,c=this.extractTxHashesFromResult(a,r);return Re(X({correlationId:t,rpcMethods:[a],chainId:i.chainId},this.isValidContractData(i.request.params)&&{contractAddresses:[(o=(n=i.request.params)==null?void 0:n[0])==null?void 0:o.to]}),{txHashes:c})}catch(a){this.client.logger.warn("Error getting TVF params",a)}return{}}),E(this,"isValidContractData",t=>{var i;if(!t)return!1;try{let r=t?.data||((i=t?.[0])==null?void 0:i.data);if(!r.startsWith("0x"))return!1;let n=r.slice(2);return/^[0-9a-fA-F]*$/.test(n)?n.length%2===0:!1}catch{}return!1}),E(this,"extractTxHashesFromResult",(t,i)=>{try{let r=Ah[t];if(typeof i=="string")return[i];let n=i[r.key];if(Ce(n))return t==="solana_signAllTransactions"?n.map(o=>Ma(o)):n;if(typeof n=="string")return[n]}catch(r){this.client.logger.warn("Error extracting tx hashes from result",r)}return[]})}async processPendingMessageEvents(){try{let e=this.client.session.keys,t=this.client.core.relayer.messages.getWithoutAck(e);for(let[i,r]of Object.entries(t))for(let n of r)try{await this.onProviderMessageEvent({topic:i,message:n,publishedAt:Date.now()})}catch{this.client.logger.warn(`Error processing pending message event for topic: ${i}, message: ${n}`)}}catch(e){this.client.logger.warn("processPendingMessageEvents failed",e)}}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}async confirmOnlineStateOrThrow(){await this.client.core.relayer.confirmOnlineStateOrThrow()}registerRelayerEvents(){this.client.core.relayer.on(le.message,e=>{this.onProviderMessageEvent(e)})}async onRelayMessage(e){let{topic:t,message:i,attestation:r,transportType:n}=e,{publicKey:o}=this.client.auth.authKeys.keys.includes(Ki)?this.client.auth.authKeys.get(Ki):{responseTopic:void 0,publicKey:void 0};try{let a=await this.client.core.crypto.decode(t,i,{receiverPublicKey:o,encoding:n===te.link_mode?St:ke});ks(a)?(this.client.core.history.set(t,a),await this.onRelayEventRequest({topic:t,payload:a,attestation:r,transportType:n,encryptedId:ze(i)})):js(a)?(await this.client.core.history.resolve(a),await this.onRelayEventResponse({topic:t,payload:a,transportType:n}),this.client.core.history.delete(t,a.id)):await this.onRelayEventUnknownPayload({topic:t,payload:a,transportType:n}),await this.client.core.relayer.messages.ack(t,i)}catch(a){this.client.logger.error(a)}}registerExpirerEvents(){this.client.core.expirer.on($e.expired,async e=>{let{topic:t,id:i}=vi(e.target);if(i&&this.client.pendingRequest.keys.includes(i))return await this.deletePendingSessionRequest(i,A("EXPIRED"),!0);if(i&&this.client.auth.requests.keys.includes(i))return await this.deletePendingAuthRequest(i,A("EXPIRED"),!0);t?this.client.session.keys.includes(t)&&(await this.deleteSession({topic:t,expirerHasDeleted:!0}),this.client.events.emit("session_expire",{topic:t})):i&&(await this.deleteProposal(i,!0),this.client.events.emit("proposal_expire",{id:i}))})}registerPairingEvents(){this.client.core.pairing.events.on(Dt.create,e=>this.onPairingCreated(e)),this.client.core.pairing.events.on(Dt.delete,e=>{this.addToRecentlyDeleted(e.topic,"pairing")})}isValidPairingTopic(e){if(!se(e,!1)){let{message:t}=A("MISSING_OR_INVALID",`pairing topic should be a string: ${e}`);throw new Error(t)}if(!this.client.core.pairing.pairings.keys.includes(e)){let{message:t}=A("NO_MATCHING_KEY",`pairing topic doesn't exist: ${e}`);throw new Error(t)}if(at(this.client.core.pairing.pairings.get(e).expiry)){let{message:t}=A("EXPIRED",`pairing topic: ${e}`);throw new Error(t)}}async isValidSessionTopic(e){if(!se(e,!1)){let{message:t}=A("MISSING_OR_INVALID",`session topic should be a string: ${e}`);throw new Error(t)}if(this.checkRecentlyDeleted(e),!this.client.session.keys.includes(e)){let{message:t}=A("NO_MATCHING_KEY",`session topic doesn't exist: ${e}`);throw new Error(t)}if(at(this.client.session.get(e).expiry)){await this.deleteSession({topic:e});let{message:t}=A("EXPIRED",`session topic: ${e}`);throw new Error(t)}if(!this.client.core.crypto.keychain.has(e)){let{message:t}=A("MISSING_OR_INVALID",`session topic does not exist in keychain: ${e}`);throw await this.deleteSession({topic:e}),new Error(t)}}async isValidSessionOrPairingTopic(e){if(this.checkRecentlyDeleted(e),this.client.session.keys.includes(e))await this.isValidSessionTopic(e);else if(this.client.core.pairing.pairings.keys.includes(e))this.isValidPairingTopic(e);else if(se(e,!1)){let{message:t}=A("NO_MATCHING_KEY",`session or pairing topic doesn't exist: ${e}`);throw new Error(t)}else{let{message:t}=A("MISSING_OR_INVALID",`session or pairing topic should be a string: ${e}`);throw new Error(t)}}async isValidProposalId(e){if(!Tc(e)){let{message:t}=A("MISSING_OR_INVALID",`proposal id should be a number: ${e}`);throw new Error(t)}if(!this.client.proposal.keys.includes(e)){let{message:t}=A("NO_MATCHING_KEY",`proposal id doesn't exist: ${e}`);throw new Error(t)}if(at(this.client.proposal.get(e).expiryTimestamp)){await this.deleteProposal(e);let{message:t}=A("EXPIRED",`proposal id: ${e}`);throw new Error(t)}}},Gn=class extends ut{constructor(e,t){super(e,t,Um,eo),this.core=e,this.logger=t}},Wn=class extends ut{constructor(e,t){super(e,t,km,eo),this.core=e,this.logger=t}},Yn=class extends ut{constructor(e,t){super(e,t,Lm,eo,i=>i.id),this.core=e,this.logger=t}},Jn=class extends ut{constructor(e,t){super(e,t,Vm,Yi,()=>Ki),this.core=e,this.logger=t}},Qn=class extends ut{constructor(e,t){super(e,t,zm,Yi),this.core=e,this.logger=t}},Xn=class extends ut{constructor(e,t){super(e,t,Hm,Yi,i=>i.id),this.core=e,this.logger=t}},Qm=Object.defineProperty,Xm=(s,e,t)=>e in s?Qm(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,zn=(s,e,t)=>Xm(s,typeof e!="symbol"?e+"":e,t),Zn=class{constructor(e,t){this.core=e,this.logger=t,zn(this,"authKeys"),zn(this,"pairingTopics"),zn(this,"requests"),this.authKeys=new Jn(this.core,this.logger),this.pairingTopics=new Qn(this.core,this.logger),this.requests=new Xn(this.core,this.logger)}async init(){await this.authKeys.init(),await this.pairingTopics.init(),await this.requests.init()}},Zm=Object.defineProperty,ey=(s,e,t)=>e in s?Zm(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,z=(s,e,t)=>ey(s,typeof e!="symbol"?e+"":e,t),Gi=class s extends $i{constructor(e){super(e),z(this,"protocol",Nh),z(this,"version",qh),z(this,"name",Bn.name),z(this,"metadata"),z(this,"core"),z(this,"logger"),z(this,"events",new Wi.EventEmitter),z(this,"engine"),z(this,"session"),z(this,"proposal"),z(this,"pendingRequest"),z(this,"auth"),z(this,"signConfig"),z(this,"on",(i,r)=>this.events.on(i,r)),z(this,"once",(i,r)=>this.events.once(i,r)),z(this,"off",(i,r)=>this.events.off(i,r)),z(this,"removeListener",(i,r)=>this.events.removeListener(i,r)),z(this,"removeAllListeners",i=>this.events.removeAllListeners(i)),z(this,"connect",async i=>{try{return await this.engine.connect(i)}catch(r){throw this.logger.error(r.message),r}}),z(this,"pair",async i=>{try{return await this.engine.pair(i)}catch(r){throw this.logger.error(r.message),r}}),z(this,"approve",async i=>{try{return await this.engine.approve(i)}catch(r){throw this.logger.error(r.message),r}}),z(this,"reject",async i=>{try{return await this.engine.reject(i)}catch(r){throw this.logger.error(r.message),r}}),z(this,"update",async i=>{try{return await this.engine.update(i)}catch(r){throw this.logger.error(r.message),r}}),z(this,"extend",async i=>{try{return await this.engine.extend(i)}catch(r){throw this.logger.error(r.message),r}}),z(this,"request",async i=>{try{return await this.engine.request(i)}catch(r){throw this.logger.error(r.message),r}}),z(this,"respond",async i=>{try{return await this.engine.respond(i)}catch(r){throw this.logger.error(r.message),r}}),z(this,"ping",async i=>{try{return await this.engine.ping(i)}catch(r){throw this.logger.error(r.message),r}}),z(this,"emit",async i=>{try{return await this.engine.emit(i)}catch(r){throw this.logger.error(r.message),r}}),z(this,"disconnect",async i=>{try{return await this.engine.disconnect(i)}catch(r){throw this.logger.error(r.message),r}}),z(this,"find",i=>{try{return this.engine.find(i)}catch(r){throw this.logger.error(r.message),r}}),z(this,"getPendingSessionRequests",()=>{try{return this.engine.getPendingSessionRequests()}catch(i){throw this.logger.error(i.message),i}}),z(this,"authenticate",async(i,r)=>{try{return await this.engine.authenticate(i,r)}catch(n){throw this.logger.error(n.message),n}}),z(this,"formatAuthMessage",i=>{try{return this.engine.formatAuthMessage(i)}catch(r){throw this.logger.error(r.message),r}}),z(this,"approveSessionAuthenticate",async i=>{try{return await this.engine.approveSessionAuthenticate(i)}catch(r){throw this.logger.error(r.message),r}}),z(this,"rejectSessionAuthenticate",async i=>{try{return await this.engine.rejectSessionAuthenticate(i)}catch(r){throw this.logger.error(r.message),r}}),this.name=e?.name||Bn.name,this.metadata=Oa(e?.metadata),this.signConfig=e?.signConfig;let t=typeof e?.logger<"u"&&typeof e?.logger!="string"?e.logger:(0,es.default)($t({level:e?.logger||Bn.logger}));this.core=e?.core||new Rh(e),this.logger=me(t,this.name),this.session=new Wn(this.core,this.logger),this.proposal=new Gn(this.core,this.logger),this.pendingRequest=new Yn(this.core,this.logger),this.engine=new Kn(this),this.auth=new Zn(this.core,this.logger)}static async init(e){let t=new s(e);return await t.initialize(),t}get context(){return Oe(this.logger)}get pairing(){return this.core.pairing.pairings}async initialize(){this.logger.trace("Initialized");try{await this.core.start(),await this.session.init(),await this.proposal.init(),await this.pendingRequest.init(),await this.auth.init(),await this.engine.init(),this.logger.info("SignClient Initialization Success"),setTimeout(()=>{this.engine.processRelayMessageCache()},(0,B.toMiliseconds)(B.ONE_SECOND))}catch(e){throw this.logger.info("SignClient Initialization Failure"),this.logger.error(e.message),e}}};var Wh=Ye(Fs()),Fh="error",ty="wss://relay.walletconnect.org",sy="wc",iy="universal_provider",Ji=`${sy}@2:${iy}:`,Yh="https://rpc.walletconnect.org/v1/",qs="generic",ry=`${Yh}bundler`,We={DEFAULT_CHAIN_CHANGED:"default_chain_changed"};function ny(){}function vo(s){return s==null||typeof s!="object"&&typeof s!="function"}function Eo(s){return ArrayBuffer.isView(s)&&!(s instanceof DataView)}function oy(s){if(vo(s))return s;if(Array.isArray(s)||Eo(s)||s instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&s instanceof SharedArrayBuffer)return s.slice(0);let e=Object.getPrototypeOf(s),t=e.constructor;if(s instanceof Date||s instanceof Map||s instanceof Set)return new t(s);if(s instanceof RegExp){let i=new t(s);return i.lastIndex=s.lastIndex,i}if(s instanceof DataView)return new t(s.buffer.slice(0));if(s instanceof Error){let i=new t(s.message);return i.stack=s.stack,i.name=s.name,i.cause=s.cause,i}if(typeof File<"u"&&s instanceof File)return new t([s],s.name,{type:s.type,lastModified:s.lastModified});if(typeof s=="object"){let i=Object.create(e);return Object.assign(i,s)}return s}function Uh(s){return typeof s=="object"&&s!==null}function Jh(s){return Object.getOwnPropertySymbols(s).filter(e=>Object.prototype.propertyIsEnumerable.call(s,e))}function Qh(s){return s==null?s===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(s)}var ay="[object RegExp]",Xh="[object String]",Zh="[object Number]",el="[object Boolean]",tl="[object Arguments]",cy="[object Symbol]",hy="[object Date]",ly="[object Map]",py="[object Set]",uy="[object Array]",dy="[object ArrayBuffer]",gy="[object Object]",fy="[object DataView]",my="[object Uint8Array]",yy="[object Uint8ClampedArray]",wy="[object Uint16Array]",by="[object Uint32Array]",vy="[object Int8Array]",Ey="[object Int16Array]",Iy="[object Int32Array]",_y="[object Float32Array]",Py="[object Float64Array]";function Sy(s,e){return Ds(s,void 0,s,new Map,e)}function Ds(s,e,t,i=new Map,r=void 0){let n=r?.(s,e,t,i);if(n!=null)return n;if(vo(s))return s;if(i.has(s))return i.get(s);if(Array.isArray(s)){let o=new Array(s.length);i.set(s,o);for(let a=0;a<s.length;a++)o[a]=Ds(s[a],a,t,i,r);return Object.hasOwn(s,"index")&&(o.index=s.index),Object.hasOwn(s,"input")&&(o.input=s.input),o}if(s instanceof Date)return new Date(s.getTime());if(s instanceof RegExp){let o=new RegExp(s.source,s.flags);return o.lastIndex=s.lastIndex,o}if(s instanceof Map){let o=new Map;i.set(s,o);for(let[a,c]of s)o.set(a,Ds(c,a,t,i,r));return o}if(s instanceof Set){let o=new Set;i.set(s,o);for(let a of s)o.add(Ds(a,void 0,t,i,r));return o}if(typeof Buffer<"u"&&Buffer.isBuffer(s))return s.subarray();if(Eo(s)){let o=new(Object.getPrototypeOf(s)).constructor(s.length);i.set(s,o);for(let a=0;a<s.length;a++)o[a]=Ds(s[a],a,t,i,r);return o}if(s instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&s instanceof SharedArrayBuffer)return s.slice(0);if(s instanceof DataView){let o=new DataView(s.buffer.slice(0),s.byteOffset,s.byteLength);return i.set(s,o),Yt(o,s,t,i,r),o}if(typeof File<"u"&&s instanceof File){let o=new File([s],s.name,{type:s.type});return i.set(s,o),Yt(o,s,t,i,r),o}if(s instanceof Blob){let o=new Blob([s],{type:s.type});return i.set(s,o),Yt(o,s,t,i,r),o}if(s instanceof Error){let o=new s.constructor;return i.set(s,o),o.message=s.message,o.name=s.name,o.stack=s.stack,o.cause=s.cause,Yt(o,s,t,i,r),o}if(typeof s=="object"&&Oy(s)){let o=Object.create(Object.getPrototypeOf(s));return i.set(s,o),Yt(o,s,t,i,r),o}return s}function Yt(s,e,t=s,i,r){let n=[...Object.keys(e),...Jh(e)];for(let o=0;o<n.length;o++){let a=n[o],c=Object.getOwnPropertyDescriptor(s,a);(c==null||c.writable)&&(s[a]=Ds(e[a],a,t,i,r))}}function Oy(s){switch(Qh(s)){case tl:case uy:case dy:case fy:case el:case hy:case _y:case Py:case vy:case Ey:case Iy:case ly:case Zh:case gy:case ay:case py:case Xh:case cy:case my:case yy:case wy:case by:return!0;default:return!1}}function Ry(s,e){return Sy(s,(t,i,r,n)=>{let o=e?.(t,i,r,n);if(o!=null)return o;if(typeof s=="object")switch(Object.prototype.toString.call(s)){case Zh:case Xh:case el:{let a=new s.constructor(s?.valueOf());return Yt(a,s),a}case tl:{let a={};return Yt(a,s),a.length=s.length,a[Symbol.iterator]=s[Symbol.iterator],a}default:return}})}function kh(s){return Ry(s)}function jh(s){return s!==null&&typeof s=="object"&&Qh(s)==="[object Arguments]"}function xy(s){return Eo(s)}function Ty(s){if(typeof s!="object"||s==null)return!1;if(Object.getPrototypeOf(s)===null)return!0;if(Object.prototype.toString.call(s)!=="[object Object]"){let t=s[Symbol.toStringTag];return t==null||!Object.getOwnPropertyDescriptor(s,Symbol.toStringTag)?.writable?!1:s.toString()===`[object ${t}]`}let e=s;for(;Object.getPrototypeOf(e)!==null;)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(s)===e}function Ay(s,...e){let t=e.slice(0,-1),i=e[e.length-1],r=s;for(let n=0;n<t.length;n++){let o=t[n];r=ro(r,o,i,new Map)}return r}function ro(s,e,t,i){if(vo(s)&&(s=Object(s)),e==null||typeof e!="object")return s;if(i.has(e))return oy(i.get(e));if(i.set(e,s),Array.isArray(e)){e=e.slice();for(let n=0;n<e.length;n++)e[n]=e[n]??void 0}let r=[...Object.keys(e),...Jh(e)];for(let n=0;n<r.length;n++){let o=r[n],a=e[o],c=s[o];if(jh(a)&&(a={...a}),jh(c)&&(c={...c}),typeof Buffer<"u"&&Buffer.isBuffer(a)&&(a=kh(a)),Array.isArray(a))if(typeof c=="object"&&c!=null){let l=[],p=Reflect.ownKeys(c);for(let u=0;u<p.length;u++){let d=p[u];l[d]=c[d]}c=l}else c=[];let h=t(c,a,o,s,e,i);h!=null?s[o]=h:Array.isArray(a)||Uh(c)&&Uh(a)?s[o]=ro(c,a,t,i):c==null&&Ty(a)?s[o]=ro({},a,t,i):c==null&&xy(a)?s[o]=kh(a):(c===void 0||a!==void 0)&&(s[o]=a)}return s}function Cy(s,...e){return Ay(s,...e,ny)}var Ny=Object.defineProperty,qy=Object.defineProperties,Dy=Object.getOwnPropertyDescriptors,Lh=Object.getOwnPropertySymbols,Fy=Object.prototype.hasOwnProperty,Uy=Object.prototype.propertyIsEnumerable,$h=(s,e,t)=>e in s?Ny(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Qi=(s,e)=>{for(var t in e||(e={}))Fy.call(e,t)&&$h(s,t,e[t]);if(Lh)for(var t of Lh(e))Uy.call(e,t)&&$h(s,t,e[t]);return s},ky=(s,e)=>qy(s,Dy(e));function Me(s,e,t){var i;let r=qt(s);return((i=e.rpcMap)==null?void 0:i[r.reference])||`${Yh}?chainId=${r.namespace}:${r.reference}&projectId=${t}`}function Jt(s){return s.includes(":")?s.split(":")[1]:s}function sl(s){return s.map(e=>`${e.split(":")[0]}:${e.split(":")[1]}`)}function jy(s,e){let t=Object.keys(e.namespaces).filter(r=>r.includes(s));if(!t.length)return[];let i=[];return t.forEach(r=>{let n=e.namespaces[r].accounts;i.push(...n)}),i}function Xi(s={},e={}){let t=Mh(s),i=Mh(e);return Cy(t,i)}function Mh(s){var e,t,i,r,n;let o={};if(!ct(s))return o;for(let[a,c]of Object.entries(s)){let h=ii(a)?[a]:c.chains,l=c.methods||[],p=c.events||[],u=c.rpcMap||{},d=Wt(a);o[d]=ky(Qi(Qi({},o[d]),c),{chains:Xe(h,(e=o[d])==null?void 0:e.chains),methods:Xe(l,(t=o[d])==null?void 0:t.methods),events:Xe(p,(i=o[d])==null?void 0:i.events)}),(ct(u)||ct(((r=o[d])==null?void 0:r.rpcMap)||{}))&&(o[d].rpcMap=Qi(Qi({},u),(n=o[d])==null?void 0:n.rpcMap))}return o}function Bh(s){return s.includes(":")?s.split(":")[2]:s}function Vh(s){let e={};for(let[t,i]of Object.entries(s)){let r=i.methods||[],n=i.events||[],o=i.accounts||[],a=ii(t)?[t]:i.chains?i.chains:sl(i.accounts);e[t]={chains:a,methods:r,events:n,accounts:o}}return e}function to(s){return typeof s=="number"?s:s.includes("0x")?parseInt(s,16):(s=s.includes(":")?s.split(":")[1]:s,isNaN(Number(s))?s:Number(s))}var il={},Y=s=>il[s],so=(s,e)=>{il[s]=e},Ly=Object.defineProperty,$y=(s,e,t)=>e in s?Ly(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Is=(s,e,t)=>$y(s,typeof e!="symbol"?e+"":e,t),no=class{constructor(e){Is(this,"name","polkadot"),Is(this,"client"),Is(this,"httpProviders"),Is(this,"events"),Is(this,"namespace"),Is(this,"chainId"),this.namespace=e.namespace,this.events=Y("events"),this.client=Y("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(We.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}getAccounts(){let e=this.namespace.accounts;return e?e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2])||[]:[]}createHttpProviders(){let e={};return this.namespace.chains.forEach(t=>{var i;let r=Jt(t);e[r]=this.createHttpProvider(r,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getHttpProvider(){let e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){let i=t||Me(e,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new xe(new De(i,Y("disableProviderPing")))}},My=Object.defineProperty,By=Object.defineProperties,Vy=Object.getOwnPropertyDescriptors,zh=Object.getOwnPropertySymbols,zy=Object.prototype.hasOwnProperty,Hy=Object.prototype.propertyIsEnumerable,oo=(s,e,t)=>e in s?My(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Hh=(s,e)=>{for(var t in e||(e={}))zy.call(e,t)&&oo(s,t,e[t]);if(zh)for(var t of zh(e))Hy.call(e,t)&&oo(s,t,e[t]);return s},Kh=(s,e)=>By(s,Vy(e)),_s=(s,e,t)=>oo(s,typeof e!="symbol"?e+"":e,t),ao=class{constructor(e){_s(this,"name","eip155"),_s(this,"client"),_s(this,"chainId"),_s(this,"namespace"),_s(this,"httpProviders"),_s(this,"events"),this.namespace=e.namespace,this.events=Y("events"),this.client=Y("client"),this.httpProviders=this.createHttpProviders(),this.chainId=parseInt(this.getDefaultChain())}async request(e){switch(e.request.method){case"eth_requestAccounts":return this.getAccounts();case"eth_accounts":return this.getAccounts();case"wallet_switchEthereumChain":return await this.handleSwitchChain(e);case"eth_chainId":return parseInt(this.getDefaultChain());case"wallet_getCapabilities":return await this.getCapabilities(e);case"wallet_getCallsStatus":return await this.getCallStatus(e)}return this.namespace.methods.includes(e.request.method)?await this.client.request(e):this.getHttpProvider().request(e.request)}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(parseInt(e),t),this.chainId=parseInt(e),this.events.emit(We.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId.toString();if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}createHttpProvider(e,t){let i=t||Me(`${this.name}:${e}`,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new xe(new De(i,Y("disableProviderPing")))}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProviders(){let e={};return this.namespace.chains.forEach(t=>{var i;let r=parseInt(Jt(t));e[r]=this.createHttpProvider(r,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getAccounts(){let e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}getHttpProvider(){let e=this.chainId,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}async handleSwitchChain(e){var t,i;let r=e.request.params?(t=e.request.params[0])==null?void 0:t.chainId:"0x0";r=r.startsWith("0x")?r:`0x${r}`;let n=parseInt(r,16);if(this.isChainApproved(n))this.setDefaultChain(`${n}`);else if(this.namespace.methods.includes("wallet_switchEthereumChain"))await this.client.request({topic:e.topic,request:{method:e.request.method,params:[{chainId:r}]},chainId:(i=this.namespace.chains)==null?void 0:i[0]}),this.setDefaultChain(`${n}`);else throw new Error(`Failed to switch to chain 'eip155:${n}'. The chain is not approved or the wallet does not support 'wallet_switchEthereumChain' method.`);return null}isChainApproved(e){return this.namespace.chains.includes(`${this.name}:${e}`)}async getCapabilities(e){var t,i,r,n,o;let a=(i=(t=e.request)==null?void 0:t.params)==null?void 0:i[0],c=((n=(r=e.request)==null?void 0:r.params)==null?void 0:n[1])||[],h=`${a}${c.join(",")}`;if(!a)throw new Error("Missing address parameter in `wallet_getCapabilities` request");let l=this.client.session.get(e.topic),p=((o=l?.sessionProperties)==null?void 0:o.capabilities)||{};if(p!=null&&p[h])return p?.[h];let u=await this.client.request(e);try{await this.client.session.update(e.topic,{sessionProperties:Kh(Hh({},l.sessionProperties||{}),{capabilities:Kh(Hh({},p||{}),{[h]:u})})})}catch(d){console.warn("Failed to update session with capabilities",d)}return u}async getCallStatus(e){var t,i;let r=this.client.session.get(e.topic),n=(t=r.sessionProperties)==null?void 0:t.bundler_name;if(n){let a=this.getBundlerUrl(e.chainId,n);try{return await this.getUserOperationReceipt(a,e)}catch(c){console.warn("Failed to fetch call status from bundler",c,a)}}let o=(i=r.sessionProperties)==null?void 0:i.bundler_url;if(o)try{return await this.getUserOperationReceipt(o,e)}catch(a){console.warn("Failed to fetch call status from custom bundler",a,o)}if(this.namespace.methods.includes(e.request.method))return await this.client.request(e);throw new Error("Fetching call status not approved by the wallet.")}async getUserOperationReceipt(e,t){var i;let r=new URL(e),n=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(nt("eth_getUserOperationReceipt",[(i=t.request.params)==null?void 0:i[0]]))});if(!n.ok)throw new Error(`Failed to fetch user operation receipt - ${n.status}`);return await n.json()}getBundlerUrl(e,t){return`${ry}?projectId=${this.client.core.projectId}&chainId=${e}&bundler=${t}`}},Ky=Object.defineProperty,Gy=(s,e,t)=>e in s?Ky(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ps=(s,e,t)=>Gy(s,typeof e!="symbol"?e+"":e,t),co=class{constructor(e){Ps(this,"name","solana"),Ps(this,"client"),Ps(this,"httpProviders"),Ps(this,"events"),Ps(this,"namespace"),Ps(this,"chainId"),this.namespace=e.namespace,this.events=Y("events"),this.client=Y("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(We.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}getAccounts(){let e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){let e={};return this.namespace.chains.forEach(t=>{var i;let r=Jt(t);e[r]=this.createHttpProvider(r,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getHttpProvider(){let e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){let i=t||Me(e,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new xe(new De(i,Y("disableProviderPing")))}},Wy=Object.defineProperty,Yy=(s,e,t)=>e in s?Wy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ss=(s,e,t)=>Yy(s,typeof e!="symbol"?e+"":e,t),ho=class{constructor(e){Ss(this,"name","cosmos"),Ss(this,"client"),Ss(this,"httpProviders"),Ss(this,"events"),Ss(this,"namespace"),Ss(this,"chainId"),this.namespace=e.namespace,this.events=Y("events"),this.client=Y("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(We.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getAccounts(){let e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){let e={};return this.namespace.chains.forEach(t=>{var i;let r=Jt(t);e[r]=this.createHttpProvider(r,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getHttpProvider(){let e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){let i=t||Me(e,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new xe(new De(i,Y("disableProviderPing")))}},Jy=Object.defineProperty,Qy=(s,e,t)=>e in s?Jy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Os=(s,e,t)=>Qy(s,typeof e!="symbol"?e+"":e,t),lo=class{constructor(e){Os(this,"name","algorand"),Os(this,"client"),Os(this,"httpProviders"),Os(this,"events"),Os(this,"namespace"),Os(this,"chainId"),this.namespace=e.namespace,this.events=Y("events"),this.client=Y("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){if(!this.httpProviders[e]){let i=t||Me(`${this.name}:${e}`,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);this.setHttpProvider(e,i)}this.chainId=e,this.events.emit(We.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}getAccounts(){let e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){let e={};return this.namespace.chains.forEach(t=>{var i;e[t]=this.createHttpProvider(t,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getHttpProvider(){let e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){let i=t||Me(e,this.namespace,this.client.core.projectId);return typeof i>"u"?void 0:new xe(new De(i,Y("disableProviderPing")))}},Xy=Object.defineProperty,Zy=(s,e,t)=>e in s?Xy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Rs=(s,e,t)=>Zy(s,typeof e!="symbol"?e+"":e,t),po=class{constructor(e){Rs(this,"name","cip34"),Rs(this,"client"),Rs(this,"httpProviders"),Rs(this,"events"),Rs(this,"namespace"),Rs(this,"chainId"),this.namespace=e.namespace,this.events=Y("events"),this.client=Y("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(We.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getAccounts(){let e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){let e={};return this.namespace.chains.forEach(t=>{let i=this.getCardanoRPCUrl(t),r=Jt(t);e[r]=this.createHttpProvider(r,i)}),e}getHttpProvider(){let e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}getCardanoRPCUrl(e){let t=this.namespace.rpcMap;if(t)return t[e]}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){let i=t||this.getCardanoRPCUrl(e);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new xe(new De(i,Y("disableProviderPing")))}},ew=Object.defineProperty,tw=(s,e,t)=>e in s?ew(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,xs=(s,e,t)=>tw(s,typeof e!="symbol"?e+"":e,t),uo=class{constructor(e){xs(this,"name","elrond"),xs(this,"client"),xs(this,"httpProviders"),xs(this,"events"),xs(this,"namespace"),xs(this,"chainId"),this.namespace=e.namespace,this.events=Y("events"),this.client=Y("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(We.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}getAccounts(){let e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){let e={};return this.namespace.chains.forEach(t=>{var i;let r=Jt(t);e[r]=this.createHttpProvider(r,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getHttpProvider(){let e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){let i=t||Me(e,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new xe(new De(i,Y("disableProviderPing")))}},sw=Object.defineProperty,iw=(s,e,t)=>e in s?sw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ts=(s,e,t)=>iw(s,typeof e!="symbol"?e+"":e,t),go=class{constructor(e){Ts(this,"name","multiversx"),Ts(this,"client"),Ts(this,"httpProviders"),Ts(this,"events"),Ts(this,"namespace"),Ts(this,"chainId"),this.namespace=e.namespace,this.events=Y("events"),this.client=Y("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(We.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}getAccounts(){let e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){let e={};return this.namespace.chains.forEach(t=>{var i;let r=Jt(t);e[r]=this.createHttpProvider(r,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getHttpProvider(){let e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){let i=t||Me(e,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new xe(new De(i,Y("disableProviderPing")))}},rw=Object.defineProperty,nw=(s,e,t)=>e in s?rw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,As=(s,e,t)=>nw(s,typeof e!="symbol"?e+"":e,t),fo=class{constructor(e){As(this,"name","near"),As(this,"client"),As(this,"httpProviders"),As(this,"events"),As(this,"namespace"),As(this,"chainId"),this.namespace=e.namespace,this.events=Y("events"),this.client=Y("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){if(this.chainId=e,!this.httpProviders[e]){let i=t||Me(`${this.name}:${e}`,this.namespace);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);this.setHttpProvider(e,i)}this.events.emit(We.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getAccounts(){let e=this.namespace.accounts;return e?e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2])||[]:[]}createHttpProviders(){let e={};return this.namespace.chains.forEach(t=>{var i;e[t]=this.createHttpProvider(t,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getHttpProvider(){let e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){let i=t||Me(e,this.namespace);return typeof i>"u"?void 0:new xe(new De(i,Y("disableProviderPing")))}},ow=Object.defineProperty,aw=(s,e,t)=>e in s?ow(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Cs=(s,e,t)=>aw(s,typeof e!="symbol"?e+"":e,t),mo=class{constructor(e){Cs(this,"name","tezos"),Cs(this,"client"),Cs(this,"httpProviders"),Cs(this,"events"),Cs(this,"namespace"),Cs(this,"chainId"),this.namespace=e.namespace,this.events=Y("events"),this.client=Y("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){if(this.chainId=e,!this.httpProviders[e]){let i=t||Me(`${this.name}:${e}`,this.namespace);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);this.setHttpProvider(e,i)}this.events.emit(We.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getAccounts(){let e=this.namespace.accounts;return e?e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2])||[]:[]}createHttpProviders(){let e={};return this.namespace.chains.forEach(t=>{e[t]=this.createHttpProvider(t)}),e}getHttpProvider(){let e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){let i=t||Me(e,this.namespace);return typeof i>"u"?void 0:new xe(new De(i))}},cw=Object.defineProperty,hw=(s,e,t)=>e in s?cw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ns=(s,e,t)=>hw(s,typeof e!="symbol"?e+"":e,t),yo=class{constructor(e){Ns(this,"name",qs),Ns(this,"client"),Ns(this,"httpProviders"),Ns(this,"events"),Ns(this,"namespace"),Ns(this,"chainId"),this.namespace=e.namespace,this.events=Y("events"),this.client=Y("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace.chains=[...new Set((this.namespace.chains||[]).concat(e.chains||[]))],this.namespace.accounts=[...new Set((this.namespace.accounts||[]).concat(e.accounts||[]))],this.namespace.methods=[...new Set((this.namespace.methods||[]).concat(e.methods||[]))],this.namespace.events=[...new Set((this.namespace.events||[]).concat(e.events||[]))],this.httpProviders=this.createHttpProviders()}requestAccounts(){return this.getAccounts()}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider(e.chainId).request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(We.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}getAccounts(){let e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){var e,t;let i={};return(t=(e=this.namespace)==null?void 0:e.accounts)==null||t.forEach(r=>{let n=qt(r);i[`${n.namespace}:${n.reference}`]=this.createHttpProvider(r)}),i}getHttpProvider(e){let t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){let i=t||Me(e,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new xe(new De(i,Y("disableProviderPing")))}},lw=Object.defineProperty,pw=Object.defineProperties,uw=Object.getOwnPropertyDescriptors,Gh=Object.getOwnPropertySymbols,dw=Object.prototype.hasOwnProperty,gw=Object.prototype.propertyIsEnumerable,wo=(s,e,t)=>e in s?lw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Zi=(s,e)=>{for(var t in e||(e={}))dw.call(e,t)&&wo(s,t,e[t]);if(Gh)for(var t of Gh(e))gw.call(e,t)&&wo(s,t,e[t]);return s},io=(s,e)=>pw(s,uw(e)),Ge=(s,e,t)=>wo(s,typeof e!="symbol"?e+"":e,t),bo=class s{constructor(e){Ge(this,"client"),Ge(this,"namespaces"),Ge(this,"optionalNamespaces"),Ge(this,"sessionProperties"),Ge(this,"scopedProperties"),Ge(this,"events",new Wh.default),Ge(this,"rpcProviders",{}),Ge(this,"session"),Ge(this,"providerOpts"),Ge(this,"logger"),Ge(this,"uri"),Ge(this,"disableProviderPing",!1),this.providerOpts=e,this.logger=typeof e?.logger<"u"&&typeof e?.logger!="string"?e.logger:(0,es.default)($t({level:e?.logger||Fh})),this.disableProviderPing=e?.disableProviderPing||!1}static async init(e){let t=new s(e);return await t.initialize(),t}async request(e,t,i){let[r,n]=this.validateChain(t);if(!this.session)throw new Error("Please call connect() before request()");return await this.getProvider(r).request({request:Zi({},e),chainId:`${r}:${n}`,topic:this.session.topic,expiry:i})}sendAsync(e,t,i,r){let n=new Date().getTime();this.request(e,i,r).then(o=>t(null,Mt(n,o))).catch(o=>t(o,void 0))}async enable(){if(!this.client)throw new Error("Sign Client not initialized");return this.session||await this.connect({namespaces:this.namespaces,optionalNamespaces:this.optionalNamespaces,sessionProperties:this.sessionProperties,scopedProperties:this.scopedProperties}),await this.requestAccounts()}async disconnect(){var e;if(!this.session)throw new Error("Please call connect() before enable()");await this.client.disconnect({topic:(e=this.session)==null?void 0:e.topic,reason:H("USER_DISCONNECTED")}),await this.cleanup()}async connect(e){if(!this.client)throw new Error("Sign Client not initialized");if(this.setNamespaces(e),await this.cleanupPendingPairings(),!e.skipPairing)return await this.pair(e.pairingTopic)}async authenticate(e,t){if(!this.client)throw new Error("Sign Client not initialized");this.setNamespaces(e),await this.cleanupPendingPairings();let{uri:i,response:r}=await this.client.authenticate(e,t);i&&(this.uri=i,this.events.emit("display_uri",i));let n=await r();if(this.session=n.session,this.session){let o=Vh(this.session.namespaces);this.namespaces=Xi(this.namespaces,o),await this.persist("namespaces",this.namespaces),this.onConnect()}return n}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}removeListener(e,t){this.events.removeListener(e,t)}off(e,t){this.events.off(e,t)}get isWalletConnect(){return!0}async pair(e){let{uri:t,approval:i}=await this.client.connect({pairingTopic:e,requiredNamespaces:this.namespaces,optionalNamespaces:this.optionalNamespaces,sessionProperties:this.sessionProperties,scopedProperties:this.scopedProperties});t&&(this.uri=t,this.events.emit("display_uri",t));let r=await i();this.session=r;let n=Vh(r.namespaces);return this.namespaces=Xi(this.namespaces,n),await this.persist("namespaces",this.namespaces),await this.persist("optionalNamespaces",this.optionalNamespaces),this.onConnect(),this.session}setDefaultChain(e,t){try{if(!this.session)return;let[i,r]=this.validateChain(e),n=this.getProvider(i);n.name===qs?n.setDefaultChain(`${i}:${r}`,t):n.setDefaultChain(r,t)}catch(i){if(!/Please call connect/.test(i.message))throw i}}async cleanupPendingPairings(e={}){this.logger.info("Cleaning up inactive pairings...");let t=this.client.pairing.getAll();if(Ce(t)){for(let i of t)e.deletePairings?this.client.core.expirer.set(i.topic,0):await this.client.core.relayer.subscriber.unsubscribe(i.topic);this.logger.info(`Inactive pairings cleared: ${t.length}`)}}abortPairingAttempt(){this.logger.warn("abortPairingAttempt is deprecated. This is now a no-op.")}async checkStorage(){this.namespaces=await this.getFromStore("namespaces")||{},this.optionalNamespaces=await this.getFromStore("optionalNamespaces")||{},this.session&&this.createProviders()}async initialize(){this.logger.trace("Initialized"),await this.createClient(),await this.checkStorage(),this.registerEventListeners()}async createClient(){var e,t;if(this.client=this.providerOpts.client||await Gi.init({core:this.providerOpts.core,logger:this.providerOpts.logger||Fh,relayUrl:this.providerOpts.relayUrl||ty,projectId:this.providerOpts.projectId,metadata:this.providerOpts.metadata,storageOptions:this.providerOpts.storageOptions,storage:this.providerOpts.storage,name:this.providerOpts.name,customStoragePrefix:this.providerOpts.customStoragePrefix,telemetryEnabled:this.providerOpts.telemetryEnabled}),this.providerOpts.session)try{this.session=this.client.session.get(this.providerOpts.session.topic)}catch(i){throw this.logger.error("Failed to get session",i),new Error(`The provided session: ${(t=(e=this.providerOpts)==null?void 0:e.session)==null?void 0:t.topic} doesn't exist in the Sign client`)}else{let i=this.client.session.getAll();this.session=i[0]}this.logger.trace("SignClient Initialized")}createProviders(){if(!this.client)throw new Error("Sign Client not initialized");if(!this.session)throw new Error("Session not initialized. Please call connect() before enable()");let e=[...new Set(Object.keys(this.session.namespaces).map(t=>Wt(t)))];so("client",this.client),so("events",this.events),so("disableProviderPing",this.disableProviderPing),e.forEach(t=>{if(!this.session)return;let i=jy(t,this.session),r=sl(i),n=Xi(this.namespaces,this.optionalNamespaces),o=io(Zi({},n[t]),{accounts:i,chains:r});switch(t){case"eip155":this.rpcProviders[t]=new ao({namespace:o});break;case"algorand":this.rpcProviders[t]=new lo({namespace:o});break;case"solana":this.rpcProviders[t]=new co({namespace:o});break;case"cosmos":this.rpcProviders[t]=new ho({namespace:o});break;case"polkadot":this.rpcProviders[t]=new no({namespace:o});break;case"cip34":this.rpcProviders[t]=new po({namespace:o});break;case"elrond":this.rpcProviders[t]=new uo({namespace:o});break;case"multiversx":this.rpcProviders[t]=new go({namespace:o});break;case"near":this.rpcProviders[t]=new fo({namespace:o});break;case"tezos":this.rpcProviders[t]=new mo({namespace:o});break;default:this.rpcProviders[qs]?this.rpcProviders[qs].updateNamespace(o):this.rpcProviders[qs]=new yo({namespace:o})}})}registerEventListeners(){if(typeof this.client>"u")throw new Error("Sign Client is not initialized");this.client.on("session_ping",e=>{var t;let{topic:i}=e;i===((t=this.session)==null?void 0:t.topic)&&this.events.emit("session_ping",e)}),this.client.on("session_event",e=>{var t;let{params:i,topic:r}=e;if(r!==((t=this.session)==null?void 0:t.topic))return;let{event:n}=i;if(n.name==="accountsChanged"){let o=n.data;o&&Ce(o)&&this.events.emit("accountsChanged",o.map(Bh))}else if(n.name==="chainChanged"){let o=i.chainId,a=i.event.data,c=Wt(o),h=to(o)!==to(a)?`${c}:${to(a)}`:o;this.onChainChanged(h)}else this.events.emit(n.name,n.data);this.events.emit("session_event",e)}),this.client.on("session_update",({topic:e,params:t})=>{var i,r;if(e!==((i=this.session)==null?void 0:i.topic))return;let{namespaces:n}=t,o=(r=this.client)==null?void 0:r.session.get(e);this.session=io(Zi({},o),{namespaces:n}),this.onSessionUpdate(),this.events.emit("session_update",{topic:e,params:t})}),this.client.on("session_delete",async e=>{var t;e.topic===((t=this.session)==null?void 0:t.topic)&&(await this.cleanup(),this.events.emit("session_delete",e),this.events.emit("disconnect",io(Zi({},H("USER_DISCONNECTED")),{data:e.topic})))}),this.on(We.DEFAULT_CHAIN_CHANGED,e=>{this.onChainChanged(e,!0)})}getProvider(e){return this.rpcProviders[e]||this.rpcProviders[qs]}onSessionUpdate(){Object.keys(this.rpcProviders).forEach(e=>{var t;this.getProvider(e).updateNamespace((t=this.session)==null?void 0:t.namespaces[e])})}setNamespaces(e){let{namespaces:t={},optionalNamespaces:i={},sessionProperties:r,scopedProperties:n}=e;this.optionalNamespaces=Xi(t,i),this.sessionProperties=r,this.scopedProperties=n}validateChain(e){let[t,i]=e?.split(":")||["",""];if(!this.namespaces||!Object.keys(this.namespaces).length)return[t,i];if(t&&!Object.keys(this.namespaces||{}).map(o=>Wt(o)).includes(t))throw new Error(`Namespace '${t}' is not configured. Please call connect() first with namespace config.`);if(t&&i)return[t,i];let r=Wt(Object.keys(this.namespaces)[0]),n=this.rpcProviders[r].getDefaultChain();return[r,n]}async requestAccounts(){let[e]=this.validateChain();return await this.getProvider(e).requestAccounts()}async onChainChanged(e,t=!1){if(!this.namespaces)return;let[i,r]=this.validateChain(e);if(!r)return;this.updateNamespaceChain(i,r),this.events.emit("chainChanged",r);let n=this.getProvider(i).getDefaultChain();t||this.getProvider(i).setDefaultChain(r),this.emitAccountsChangedOnChainChange({namespace:i,previousChainId:n,newChainId:e}),await this.persist("namespaces",this.namespaces)}emitAccountsChangedOnChainChange({namespace:e,previousChainId:t,newChainId:i}){var r,n;try{if(t===i)return;let o=(n=(r=this.session)==null?void 0:r.namespaces[e])==null?void 0:n.accounts;if(!o)return;let a=o.filter(c=>c.includes(`${i}:`)).map(Bh);if(!Ce(a))return;this.events.emit("accountsChanged",a)}catch(o){this.logger.warn("Failed to emit accountsChanged on chain change",o)}}updateNamespaceChain(e,t){if(!this.namespaces)return;let i=this.namespaces[e]?e:`${e}:${t}`,r={chains:[],methods:[],events:[],defaultChain:t};this.namespaces[i]?this.namespaces[i]&&(this.namespaces[i].defaultChain=t):this.namespaces[i]=r}onConnect(){this.createProviders(),this.events.emit("connect",{session:this.session})}async cleanup(){this.namespaces=void 0,this.optionalNamespaces=void 0,this.sessionProperties=void 0,await this.deleteFromStore("namespaces"),await this.deleteFromStore("optionalNamespaces"),await this.deleteFromStore("sessionProperties"),this.session=void 0,await this.cleanupPendingPairings({deletePairings:!0}),await this.cleanupStorage()}async persist(e,t){var i;let r=((i=this.session)==null?void 0:i.topic)||"";await this.client.core.storage.setItem(`${Ji}/${e}${r}`,t)}async getFromStore(e){var t;let i=((t=this.session)==null?void 0:t.topic)||"";return await this.client.core.storage.getItem(`${Ji}/${e}${i}`)}async deleteFromStore(e){var t;let i=((t=this.session)==null?void 0:t.topic)||"";await this.client.core.storage.removeItem(`${Ji}/${e}${i}`)}async cleanupStorage(){var e;try{if(((e=this.client)==null?void 0:e.session.length)>0)return;let t=await this.client.core.storage.getKeys();for(let i of t)i.startsWith(Ji)&&await this.client.core.storage.removeItem(i)}catch(t){this.logger.warn("Failed to cleanup storage",t)}}},rl=bo;var fw="wc",mw="ethereum_provider",yw=`${fw}@2:${mw}:`,ww="https://rpc.walletconnect.org/v1/",Io=["eth_sendTransaction","personal_sign"],bw=["eth_accounts","eth_requestAccounts","eth_sendRawTransaction","eth_sign","eth_signTransaction","eth_signTypedData","eth_signTypedData_v3","eth_signTypedData_v4","eth_sendTransaction","personal_sign","wallet_switchEthereumChain","wallet_addEthereumChain","wallet_getPermissions","wallet_requestPermissions","wallet_registerOnboarding","wallet_watchAsset","wallet_scanQRCode","wallet_sendCalls","wallet_getCapabilities","wallet_getCallsStatus","wallet_showCallsStatus"],_o=["chainChanged","accountsChanged"],vw=["chainChanged","accountsChanged","message","disconnect","connect"],Ew=async()=>{let{createAppKit:s}=await import("./pretix-eth-5-core-X4U3HJFH.js");return s},Iw=Object.defineProperty,_w=Object.defineProperties,Pw=Object.getOwnPropertyDescriptors,nl=Object.getOwnPropertySymbols,Sw=Object.prototype.hasOwnProperty,Ow=Object.prototype.propertyIsEnumerable,Po=(s,e,t)=>e in s?Iw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Qt=(s,e)=>{for(var t in e||(e={}))Sw.call(e,t)&&Po(s,t,e[t]);if(nl)for(var t of nl(e))Ow.call(e,t)&&Po(s,t,e[t]);return s},li=(s,e)=>_w(s,Pw(e)),Be=(s,e,t)=>Po(s,typeof e!="symbol"?e+"":e,t);function tr(s){return Number(s[0].split(":")[1])}function er(s){return`0x${s.toString(16)}`}function Rw(s){let{chains:e,optionalChains:t,methods:i,optionalMethods:r,events:n,optionalEvents:o,rpcMap:a}=s;if(!Ce(e))throw new Error("Invalid chains");let c={chains:e,methods:i||Io,events:n||_o,rpcMap:Qt({},e.length?{[tr(e)]:a[tr(e)]}:{})},h=n?.filter(d=>!_o.includes(d)),l=i?.filter(d=>!Io.includes(d));if(!t&&!o&&!r&&!(h!=null&&h.length)&&!(l!=null&&l.length))return{required:e.length?c:void 0};let p=h?.length&&l?.length||!t,u={chains:[...new Set(p?c.chains.concat(t||[]):t)],methods:[...new Set(c.methods.concat(r!=null&&r.length?r:bw))],events:[...new Set(c.events.concat(o!=null&&o.length?o:vw))],rpcMap:a};return{required:e.length?c:void 0,optional:t.length?u:void 0}}var So=class s{constructor(){Be(this,"events",new cl.EventEmitter),Be(this,"namespace","eip155"),Be(this,"accounts",[]),Be(this,"signer"),Be(this,"chainId",1),Be(this,"modal"),Be(this,"rpc"),Be(this,"STORAGE_KEY",yw),Be(this,"on",(e,t)=>(this.events.on(e,t),this)),Be(this,"once",(e,t)=>(this.events.once(e,t),this)),Be(this,"removeListener",(e,t)=>(this.events.removeListener(e,t),this)),Be(this,"off",(e,t)=>(this.events.off(e,t),this)),Be(this,"parseAccount",e=>this.isCompatibleChainId(e)?this.parseAccountId(e).address:e),this.signer={},this.rpc={}}static async init(e){let t=new s;return await t.initialize(e),t}async request(e,t){return await this.signer.request(e,this.formatChainId(this.chainId),t)}sendAsync(e,t,i){this.signer.sendAsync(e,t,this.formatChainId(this.chainId),i)}get connected(){return this.signer.client?this.signer.client.core.relayer.connected:!1}get connecting(){return this.signer.client?this.signer.client.core.relayer.connecting:!1}async enable(){return this.session||await this.connect(),await this.request({method:"eth_requestAccounts"})}async connect(e){var t;if(!this.signer.client)throw new Error("Provider not initialized. Call init() first");this.loadConnectOpts(e);let{required:i,optional:r}=Rw(this.rpc);try{let n=await new Promise(async(a,c)=>{var h,l;this.rpc.showQrModal&&((h=this.modal)==null||h.open(),(l=this.modal)==null||l.subscribeState(u=>{!u.open&&!this.signer.session&&(this.signer.abortPairingAttempt(),c(new Error("Connection request reset. Please try again.")))}));let p=e!=null&&e.scopedProperties?{[this.namespace]:e.scopedProperties}:void 0;await this.signer.connect(li(Qt({namespaces:Qt({},i&&{[this.namespace]:i})},r&&{optionalNamespaces:{[this.namespace]:r}}),{pairingTopic:e?.pairingTopic,scopedProperties:p})).then(u=>{a(u)}).catch(u=>{var d;(d=this.modal)==null||d.showErrorMessage("Unable to connect"),c(new Error(u.message))})});if(!n)return;let o=Dr(n.namespaces,[this.namespace]);this.setChainIds(this.rpc.chains.length?this.rpc.chains:o),this.setAccounts(o),this.events.emit("connect",{chainId:er(this.chainId)})}catch(n){throw this.signer.logger.error(n),n}finally{(t=this.modal)==null||t.close()}}async authenticate(e,t){var i;if(!this.signer.client)throw new Error("Provider not initialized. Call init() first");this.loadConnectOpts({chains:e?.chains});try{let r=await new Promise(async(o,a)=>{var c,h;this.rpc.showQrModal&&((c=this.modal)==null||c.open(),(h=this.modal)==null||h.subscribeState(l=>{!l.open&&!this.signer.session&&(this.signer.abortPairingAttempt(),a(new Error("Connection request reset. Please try again.")))})),await this.signer.authenticate(li(Qt({},e),{chains:this.rpc.chains}),t).then(l=>{o(l)}).catch(l=>{var p;(p=this.modal)==null||p.showErrorMessage("Unable to connect"),a(new Error(l.message))})}),n=r.session;if(n){let o=Dr(n.namespaces,[this.namespace]);this.setChainIds(this.rpc.chains.length?this.rpc.chains:o),this.setAccounts(o),this.events.emit("connect",{chainId:er(this.chainId)})}return r}catch(r){throw this.signer.logger.error(r),r}finally{(i=this.modal)==null||i.close()}}async disconnect(){this.session&&await this.signer.disconnect(),this.reset()}get isWalletConnect(){return!0}get session(){return this.signer.session}registerEventListeners(){this.signer.on("session_event",e=>{let{params:t}=e,{event:i}=t;i.name==="accountsChanged"?(this.accounts=this.parseAccounts(i.data),this.events.emit("accountsChanged",this.accounts)):i.name==="chainChanged"?this.setChainId(this.formatChainId(i.data)):this.events.emit(i.name,i.data),this.events.emit("session_event",e)}),this.signer.on("accountsChanged",e=>{this.accounts=this.parseAccounts(e),this.events.emit("accountsChanged",this.accounts)}),this.signer.on("chainChanged",e=>{let t=parseInt(e);this.chainId=t,this.events.emit("chainChanged",er(this.chainId)),this.persist()}),this.signer.on("session_update",e=>{this.events.emit("session_update",e)}),this.signer.on("session_delete",e=>{this.reset(),this.events.emit("session_delete",e),this.events.emit("disconnect",li(Qt({},H("USER_DISCONNECTED")),{data:e.topic,name:"USER_DISCONNECTED"}))}),this.signer.on("display_uri",e=>{this.events.emit("display_uri",e)})}switchEthereumChain(e){this.request({method:"wallet_switchEthereumChain",params:[{chainId:e.toString(16)}]})}isCompatibleChainId(e){return typeof e=="string"?e.startsWith(`${this.namespace}:`):!1}formatChainId(e){return`${this.namespace}:${e}`}parseChainId(e){return Number(e.split(":")[1])}setChainIds(e){let t=e.filter(i=>this.isCompatibleChainId(i)).map(i=>this.parseChainId(i));t.length&&(this.chainId=t[0],this.events.emit("chainChanged",er(this.chainId)),this.persist())}setChainId(e){if(this.isCompatibleChainId(e)){let t=this.parseChainId(e);this.chainId=t,this.switchEthereumChain(t)}}parseAccountId(e){let[t,i,r]=e.split(":");return{chainId:`${t}:${i}`,address:r}}setAccounts(e){this.accounts=e.filter(t=>this.parseChainId(this.parseAccountId(t).chainId)===this.chainId).map(t=>this.parseAccountId(t).address),this.events.emit("accountsChanged",this.accounts)}getRpcConfig(e){var t,i;let r=(t=e?.chains)!=null?t:[],n=(i=e?.optionalChains)!=null?i:[],o=r.concat(n);if(!o.length)throw new Error("No chains specified in either `chains` or `optionalChains`");let a=r.length?e?.methods||Io:[],c=r.length?e?.events||_o:[],h=e?.optionalMethods||[],l=e?.optionalEvents||[],p=e?.rpcMap||this.buildRpcMap(o,e.projectId),u=e?.qrModalOptions||void 0;return{chains:r?.map(d=>this.formatChainId(d)),optionalChains:n.map(d=>this.formatChainId(d)),methods:a,events:c,optionalMethods:h,optionalEvents:l,rpcMap:p,showQrModal:!!(e!=null&&e.showQrModal),qrModalOptions:u,projectId:e.projectId,metadata:e.metadata}}buildRpcMap(e,t){let i={};return e.forEach(r=>{i[r]=this.getRpcUrl(r,t)}),i}async initialize(e){if(this.rpc=this.getRpcConfig(e),this.chainId=this.rpc.chains.length?tr(this.rpc.chains):tr(this.rpc.optionalChains),this.signer=await rl.init({projectId:this.rpc.projectId,metadata:this.rpc.metadata,disableProviderPing:e.disableProviderPing,relayUrl:e.relayUrl,storage:e.storage,storageOptions:e.storageOptions,customStoragePrefix:e.customStoragePrefix,telemetryEnabled:e.telemetryEnabled,logger:e.logger}),this.registerEventListeners(),await this.loadPersistedSession(),this.rpc.showQrModal){let t;try{let i=await Ew(),{convertWCMToAppKitOptions:r}=await Promise.resolve().then(function(){return kw}),n=r(li(Qt({},this.rpc.qrModalOptions),{chains:[...new Set([...this.rpc.chains,...this.rpc.optionalChains])],metadata:this.rpc.metadata,projectId:this.rpc.projectId}));if(!n.networks.length)throw new Error("No networks found for WalletConnect\xB7");t=i(li(Qt({},n),{universalProvider:this.signer,manualWCControl:!0}))}catch(i){throw console.warn(i),new Error("To use QR modal, please install @reown/appkit package")}if(t)try{this.modal=t}catch(i){throw this.signer.logger.error(i),new Error("Could not generate WalletConnectModal Instance")}}}loadConnectOpts(e){if(!e)return;let{chains:t,optionalChains:i,rpcMap:r}=e;t&&Ce(t)&&(this.rpc.chains=t.map(n=>this.formatChainId(n)),t.forEach(n=>{this.rpc.rpcMap[n]=r?.[n]||this.getRpcUrl(n)})),i&&Ce(i)&&(this.rpc.optionalChains=[],this.rpc.optionalChains=i?.map(n=>this.formatChainId(n)),i.forEach(n=>{this.rpc.rpcMap[n]=r?.[n]||this.getRpcUrl(n)}))}getRpcUrl(e,t){var i;return((i=this.rpc.rpcMap)==null?void 0:i[e])||`${ww}?chainId=eip155:${e}&projectId=${t||this.rpc.projectId}`}async loadPersistedSession(){if(this.session)try{let e=await this.signer.client.core.storage.getItem(`${this.STORAGE_KEY}/chainId`),t=this.session.namespaces[`${this.namespace}:${e}`]?this.session.namespaces[`${this.namespace}:${e}`]:this.session.namespaces[this.namespace];this.setChainIds(e?[this.formatChainId(e)]:t?.accounts),this.setAccounts(t?.accounts)}catch(e){this.signer.logger.error("Failed to load persisted session, clearing state..."),this.signer.logger.error(e),await this.disconnect().catch(t=>this.signer.logger.warn(t))}}reset(){this.chainId=1,this.accounts=[]}persist(){this.session&&this.signer.client.core.storage.setItem(`${this.STORAGE_KEY}/chainId`,this.chainId)}parseAccounts(e){return typeof e=="string"||e instanceof String?[this.parseAccount(e)]:e.map(t=>this.parseAccount(t))}},kb=So,xw=Object.defineProperty,Tw=Object.defineProperties,Aw=Object.getOwnPropertyDescriptors,ol=Object.getOwnPropertySymbols,Cw=Object.prototype.hasOwnProperty,Nw=Object.prototype.propertyIsEnumerable,al=(s,e,t)=>e in s?xw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,hl=(s,e)=>{for(var t in e||(e={}))Cw.call(e,t)&&al(s,t,e[t]);if(ol)for(var t of ol(e))Nw.call(e,t)&&al(s,t,e[t]);return s},qw=(s,e)=>Tw(s,Aw(e));function Dw(s){if(s)return{"--w3m-font-family":s["--wcm-font-family"],"--w3m-accent":s["--wcm-accent-color"],"--w3m-color-mix":s["--wcm-background-color"],"--w3m-z-index":s["--wcm-z-index"]?Number(s["--wcm-z-index"]):void 0,"--w3m-qr-color":s["--wcm-accent-color"],"--w3m-font-size-master":s["--wcm-text-medium-regular-size"],"--w3m-border-radius-master":s["--wcm-container-border-radius"],"--w3m-color-mix-strength":0}}var Fw=s=>{let[e,t]=s.split(":");return ll({id:t,caipNetworkId:s,chainNamespace:e,name:"",nativeCurrency:{name:"",symbol:"",decimals:8},rpcUrls:{default:{http:["https://rpc.walletconnect.org/v1"]}}})};function Uw(s){var e,t,i,r,n,o,a;let c=(e=s.chains)==null?void 0:e.map(Fw).filter(Boolean);if(c.length===0)throw new Error("At least one chain must be specified");let h=c.find(p=>{var u;return p.id===((u=s.defaultChain)==null?void 0:u.id)}),l={projectId:s.projectId,networks:c,themeMode:s.themeMode,themeVariables:Dw(s.themeVariables),chainImages:s.chainImages,connectorImages:s.walletImages,defaultNetwork:h,metadata:qw(hl({},s.metadata),{name:((t=s.metadata)==null?void 0:t.name)||"WalletConnect",description:((i=s.metadata)==null?void 0:i.description)||"Connect to WalletConnect-compatible wallets",url:((r=s.metadata)==null?void 0:r.url)||"https://walletconnect.org",icons:((n=s.metadata)==null?void 0:n.icons)||["https://walletconnect.org/walletconnect-logo.png"]}),showWallets:!0,featuredWalletIds:s.explorerRecommendedWalletIds==="NONE"?[]:Array.isArray(s.explorerRecommendedWalletIds)?s.explorerRecommendedWalletIds:[],excludeWalletIds:s.explorerExcludedWalletIds==="ALL"?[]:Array.isArray(s.explorerExcludedWalletIds)?s.explorerExcludedWalletIds:[],enableEIP6963:!1,enableInjected:!1,enableCoinbase:!0,enableWalletConnect:!0,features:{email:!1,socials:!1}};if((o=s.mobileWallets)!=null&&o.length||(a=s.desktopWallets)!=null&&a.length){let p=[...(s.mobileWallets||[]).map(g=>({id:g.id,name:g.name,links:g.links})),...(s.desktopWallets||[]).map(g=>({id:g.id,name:g.name,links:{native:g.links.native,universal:g.links.universal}}))],u=[...l.featuredWalletIds||[],...l.excludeWalletIds||[]],d=p.filter(g=>!u.includes(g.id));d.length&&(l.customWallets=d)}return l}function ll(s){return hl({formatters:void 0,fees:void 0,serializers:void 0},s)}var kw=Object.freeze({__proto__:null,convertWCMToAppKitOptions:Uw,defineChain:ll});export{kb as EthereumProvider,vw as OPTIONAL_EVENTS,bw as OPTIONAL_METHODS,_o as REQUIRED_EVENTS,Io as REQUIRED_METHODS,So as default};
/*! Bundled license information:

@walletconnect/utils/dist/index.es.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)
*/
