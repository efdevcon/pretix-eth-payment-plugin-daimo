import{a as Bt,b as ni,c as ba,d as ss,e as Ea,f as ws,g as ae,h as Ia}from"./pretix-eth-5-chunk-CWRWVZQN.js";import{A as ys,B as ma,D as Fi,E as Li,I as Ca,J as _a,a as ee,b as ua,c as Nt,h as Ce,i as Ue,j as Me,k as L,m as ga,n as $t,o as ms,p as Di,q as ri,r as gt,s as oe,t as Lr,u as Ve,v as qr,w as fa,x as C,y as jr,z as H}from"./pretix-eth-5-chunk-V7RLZCVE.js";import{a as kr,b as ra,c as Kh,d as oa,e as ti,f as Dr,g as aa,h as gs,i as $e,j as Te,k as ca,l as Zt,m as Qt,n as la,o as ha,p as da}from"./pretix-eth-5-chunk-U6NSFY34.js";import{a as Ur,b as na,c as fs,d as es,e as ke,f as Ie,g as pa,i as At,j as jt,k as ut,l as ts,m as Ui,p as si,q as ii,r as it,s as Xe,t as Fr,u as Fe,v as Be}from"./pretix-eth-5-chunk-MCYRL7OX.js";import"./pretix-eth-5-chunk-TH6XAEVV.js";import{a as $r,b as Br,c as ya,d as Mr,e as wa,f as va}from"./pretix-eth-5-chunk-A4FVHTRP.js";import"./pretix-eth-5-chunk-OWY5K5LW.js";import{a as ia}from"./pretix-eth-5-chunk-OKFWZUDU.js";import"./pretix-eth-5-chunk-5HE44PJF.js";import"./pretix-eth-5-chunk-AHVGFHZN.js";import"./pretix-eth-5-chunk-G6JA5WON.js";import"./pretix-eth-5-chunk-RYOKWQSX.js";import{D as xr}from"./pretix-eth-5-chunk-ZCL5HT24.js";import"./pretix-eth-5-chunk-ERWRNXFQ.js";import"./pretix-eth-5-chunk-UYVEV2Z2.js";import"./pretix-eth-5-chunk-E4YN6HJG.js";import{a as ki}from"./pretix-eth-5-chunk-64QJEAS7.js";import{f as dt}from"./pretix-eth-5-chunk-BIK4PATU.js";var Lt=dt(ki());var Na=dt(ki()),Wh=Object.defineProperty,Gh=(s,e,t)=>e in s?Wh(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Pa=(s,e,t)=>Gh(s,typeof e!="symbol"?e+"":e,t),qi=class extends Zt{constructor(e){super(),this.opts=e,Pa(this,"protocol","wc"),Pa(this,"version",2)}};var Yh=Object.defineProperty,Jh=(s,e,t)=>e in s?Yh(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Xh=(s,e,t)=>Jh(s,typeof e!="symbol"?e+"":e,t),ji=class extends Zt{constructor(e,t){super(),this.core=e,this.logger=t,Xh(this,"records",new Map)}},$i=class{constructor(e,t){this.logger=e,this.core=t}},Bi=class extends Zt{constructor(e,t){super(),this.relayer=e,this.logger=t}},Mi=class extends Zt{constructor(e){super()}},Vi=class{constructor(e,t,i,r){this.core=e,this.logger=t,this.name=i}};var Hi=class extends Zt{constructor(e,t){super(),this.relayer=e,this.logger=t}};var zi=class extends Zt{constructor(e,t){super(),this.core=e,this.logger=t}};var Ki=class{constructor(e,t,i){this.core=e,this.logger=t,this.store=i}},Wi=class{constructor(e,t){this.projectId=e,this.logger=t}},Gi=class{constructor(e,t,i){this.core=e,this.logger=t,this.telemetryEnabled=i}},Zh=Object.defineProperty,Qh=(s,e,t)=>e in s?Zh(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Aa=(s,e,t)=>Qh(s,typeof e!="symbol"?e+"":e,t);var Yi=class{constructor(e){this.opts=e,Aa(this,"protocol","wc"),Aa(this,"version",2)}};var Ji=class{constructor(e){this.client=e}};var q=dt(kr());var xt=dt(kr()),ot=dt(ra()),hc=dt(Kh());function Sa(s){let e=wa(`0x${s.substring(4)}`).substring(26);return va(`0x${e}`)}async function Oa({hash:s,signature:e}){let t=$r(s)?s:Mr(s),{secp256k1:i}=await import("./pretix-eth-5-secp256k1-SN7RLBBU.js");return`0x${(()=>{if(typeof e=="object"&&"r"in e&&"s"in e){let{r:l,s:h,v:p,yParity:d}=e,g=Number(d??p),f=Ta(g);return new i.Signature(Br(l),Br(h)).addRecoveryBit(f)}let o=$r(e)?e:Mr(e),a=ya(`0x${o.slice(130)}`),c=Ta(a);return i.Signature.fromCompact(o.substring(2,130)).addRecoveryBit(c)})().recoverPublicKey(t.substring(2)).toHex(!1)}`}function Ta(s){if(s===0||s===1)return s;if(s===27)return 0;if(s===28)return 1;throw new Error("Invalid yParityOrV value")}async function Vr({hash:s,signature:e}){return Sa(await Oa({hash:s,signature:e}))}function ep(s){if(s.length>=255)throw new TypeError("Alphabet too long");let e=new Uint8Array(256);for(let l=0;l<e.length;l++)e[l]=255;for(let l=0;l<s.length;l++){let h=s.charAt(l),p=h.charCodeAt(0);if(e[p]!==255)throw new TypeError(h+" is ambiguous");e[p]=l}let t=s.length,i=s.charAt(0),r=Math.log(t)/Math.log(256),n=Math.log(256)/Math.log(t);function o(l){if(l instanceof Uint8Array||(ArrayBuffer.isView(l)?l=new Uint8Array(l.buffer,l.byteOffset,l.byteLength):Array.isArray(l)&&(l=Uint8Array.from(l))),!(l instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(l.length===0)return"";let h=0,p=0,d=0,g=l.length;for(;d!==g&&l[d]===0;)d++,h++;let f=(g-d)*n+1>>>0,m=new Uint8Array(f);for(;d!==g;){let y=l[d],v=0;for(let _=f-1;(y!==0||v<p)&&_!==-1;_--,v++)y+=256*m[_]>>>0,m[_]=y%t>>>0,y=y/t>>>0;if(y!==0)throw new Error("Non-zero carry");p=v,d++}let u=f-p;for(;u!==f&&m[u]===0;)u++;let w=i.repeat(h);for(;u<f;++u)w+=s.charAt(m[u]);return w}function a(l){if(typeof l!="string")throw new TypeError("Expected String");if(l.length===0)return new Uint8Array;let h=0,p=0,d=0;for(;l[h]===i;)p++,h++;let g=(l.length-h)*r+1>>>0,f=new Uint8Array(g);for(;h<l.length;){let y=l.charCodeAt(h);if(y>255)return;let v=e[y];if(v===255)return;let _=0;for(let O=g-1;(v!==0||_<d)&&O!==-1;O--,_++)v+=t*f[O]>>>0,f[O]=v%256>>>0,v=v/256>>>0;if(v!==0)throw new Error("Non-zero carry");d=_,h++}let m=g-d;for(;m!==g&&f[m]===0;)m++;let u=new Uint8Array(p+(g-m)),w=p;for(;m!==g;)u[w++]=f[m++];return u}function c(l){let h=a(l);if(h)return h;throw new Error("Non-base"+t+" character")}return{encode:o,decodeUnsafe:a,decode:c}}var Ra=ep;var tp="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz",Xi=Ra(tp);var sp=":";function Wt(s){let[e,t]=s.split(sp);return{namespace:e,reference:t}}function pc(s,e){return s.includes(":")?[s]:e.chains||[]}var ip=Object.defineProperty,rp=Object.defineProperties,np=Object.getOwnPropertyDescriptors,xa=Object.getOwnPropertySymbols,op=Object.prototype.hasOwnProperty,ap=Object.prototype.propertyIsEnumerable,ka=(s,e,t)=>e in s?ip(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ua=(s,e)=>{for(var t in e||(e={}))op.call(e,t)&&ka(s,t,e[t]);if(xa)for(var t of xa(e))ap.call(e,t)&&ka(s,t,e[t]);return s},cp=(s,e)=>rp(s,np(e)),lp="ReactNative",qe={reactNative:"react-native",node:"node",browser:"browser",unknown:"unknown"};var hp="js";function ui(){return typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"}function kt(){return!(0,ot.getDocument)()&&!!(0,ot.getNavigator)()&&navigator.product===lp}function dc(){return kt()&&typeof global<"u"&&typeof(global==null?void 0:global.Platform)<"u"&&(global==null?void 0:global.Platform.OS)==="android"}function uc(){return kt()&&typeof global<"u"&&typeof(global==null?void 0:global.Platform)<"u"&&(global==null?void 0:global.Platform.OS)==="ios"}function cs(){return!ui()&&!!(0,ot.getNavigator)()&&!!(0,ot.getDocument)()}function gi(){return kt()?qe.reactNative:ui()?qe.node:cs()?qe.browser:qe.unknown}function fn(){var s;try{return kt()&&typeof global<"u"&&typeof(global==null?void 0:global.Application)<"u"?(s=global.Application)==null?void 0:s.applicationId:void 0}catch{return}}function pp(s,e){let t=new URLSearchParams(s);for(let i of Object.keys(e).sort())if(e.hasOwnProperty(i)){let r=e[i];r!==void 0&&t.set(i,r)}return t.toString()}function gc(s){var e,t;let i=mn();try{return s!=null&&s.url&&i.url&&new URL(s.url).host!==new URL(i.url).host&&(console.warn(`The configured WalletConnect 'metadata.url':${s.url} differs from the actual page url:${i.url}. This is probably unintended and can lead to issues.`),s.url=i.url),(e=s?.icons)!=null&&e.length&&s.icons.length>0&&(s.icons=s.icons.filter(r=>r!=="")),cp(Ua(Ua({},i),s),{url:s?.url||i.url,name:s?.name||i.name,description:s?.description||i.description,icons:(t=s?.icons)!=null&&t.length&&s.icons.length>0?s.icons:i.icons})}catch(r){return console.warn("Error populating app metadata",r),s||i}}function mn(){return(0,hc.getWindowMetadata)()||{name:"",description:"",url:"",icons:[""]}}function dp(){if(gi()===qe.reactNative&&typeof global<"u"&&typeof(global==null?void 0:global.Platform)<"u"){let{OS:t,Version:i}=global.Platform;return[t,i].join("-")}let s=ia();if(s===null)return"unknown";let e=s.os?s.os.replace(" ","").toLowerCase():"unknown";return s.type==="browser"?[e,s.name,s.version].join("-"):[e,s.version].join("-")}function up(){var s;let e=gi();return e===qe.browser?[e,((s=(0,ot.getLocation)())==null?void 0:s.host)||"unknown"].join(":"):e}function yn(s,e,t){let i=dp(),r=up();return[[s,e].join("-"),[hp,t].join("-"),i,r].join("/")}function fc({protocol:s,version:e,relayUrl:t,sdkVersion:i,auth:r,projectId:n,useOnCloseEvent:o,bundleId:a,packageName:c}){let l=t.split("?"),h=yn(s,e,i),p={auth:r,ua:h,projectId:n,useOnCloseEvent:o||void 0,packageName:c||void 0,bundleId:a||void 0},d=pp(l[1]||"",p);return l[0]+"?"+d}function rs(s,e){return s.filter(t=>e.includes(t)).length===s.length}function ir(s){return Object.fromEntries(s.entries())}function rr(s){return new Map(Object.entries(s))}function Ut(s=xt.FIVE_MINUTES,e){let t=(0,xt.toMiliseconds)(s||xt.FIVE_MINUTES),i,r,n,o;return{resolve:a=>{n&&i&&(clearTimeout(n),i(a),o=Promise.resolve(a))},reject:a=>{n&&r&&(clearTimeout(n),r(a))},done:()=>new Promise((a,c)=>{if(o)return a(o);n=setTimeout(()=>{let l=new Error(e);o=Promise.reject(l),c(l)},t),i=a,r=c})}}function Dt(s,e,t){return new Promise(async(i,r)=>{let n=setTimeout(()=>r(new Error(t)),e);try{let o=await s;i(o)}catch(o){r(o)}clearTimeout(n)})}function mc(s,e){if(typeof e=="string"&&e.startsWith(`${s}:`))return e;if(s.toLowerCase()==="topic"){if(typeof e!="string")throw new Error('Value must be "string" for expirer target type: topic');return`topic:${e}`}else if(s.toLowerCase()==="id"){if(typeof e!="number")throw new Error('Value must be "number" for expirer target type: id');return`id:${e}`}throw new Error(`Unknown expirer target type: ${s}`)}function yc(s){return mc("topic",s)}function wc(s){return mc("id",s)}function nr(s){let[e,t]=s.split(":"),i={id:void 0,topic:void 0};if(e==="topic"&&typeof t=="string")i.topic=t;else if(e==="id"&&Number.isInteger(Number(t)))i.id=Number(t);else throw new Error(`Invalid target, expected id:number or topic:string, got ${e}:${t}`);return i}function he(s,e){return(0,xt.fromMiliseconds)((e||Date.now())+(0,xt.toMiliseconds)(s))}function mt(s){return Date.now()>=(0,xt.toMiliseconds)(s)}function Y(s,e){return`${s}${e?`:${e}`:""}`}function nt(s=[],e=[]){return[...new Set([...s,...e])]}async function vc({id:s,topic:e,wcDeepLink:t}){var i;try{if(!t)return;let r=typeof t=="string"?JSON.parse(t):t,n=r?.href;if(typeof n!="string")return;let o=gp(n,s,e),a=gi();if(a===qe.browser){if(!((i=(0,ot.getDocument)())!=null&&i.hasFocus())){console.warn("Document does not have focus, skipping deeplink.");return}fp(o)}else a===qe.reactNative&&typeof(global==null?void 0:global.Linking)<"u"&&await global.Linking.openURL(o)}catch(r){console.error(r)}}function gp(s,e,t){let i=`requestId=${e}&sessionTopic=${t}`;s.endsWith("/")&&(s=s.slice(0,-1));let r=`${s}`;if(s.startsWith("https://t.me")){let n=s.includes("?")?"&startapp=":"?startapp=";r=`${r}${n}${wp(i,!0)}`}else r=`${r}/wc?${i}`;return r}function fp(s){let e="_self";yp()?e="_top":(mp()||s.startsWith("https://")||s.startsWith("http://"))&&(e="_blank"),window.open(s,e,"noreferrer noopener")}async function bc(s,e){let t="";try{if(cs()&&(t=localStorage.getItem(e),t))return t;t=await s.getItem(e)}catch(i){console.error(i)}return t}function wn(s,e){if(!s.includes(e))return null;let t=s.split(/([&,?,=])/),i=t.indexOf(e);return t[i+2]}function vn(){return typeof crypto<"u"&&crypto!=null&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/gu,s=>{let e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)})}function fi(){return typeof process<"u"&&process.env.IS_VITEST==="true"}function mp(){return typeof window<"u"&&(!!window.TelegramWebviewProxy||!!window.Telegram||!!window.TelegramWebviewProxyProto)}function yp(){try{return window.self!==window.top}catch{return!1}}function wp(s,e=!1){let t=Buffer.from(s).toString("base64");return e?t.replace(/[=]/g,""):t}function Ec(s){return Buffer.from(s,"base64").toString("utf-8")}function Ic(s){return new Promise(e=>setTimeout(e,s))}function ci(s){if(!Number.isSafeInteger(s)||s<0)throw new Error("positive integer expected, got "+s)}function vp(s){return s instanceof Uint8Array||ArrayBuffer.isView(s)&&s.constructor.name==="Uint8Array"}function mi(s,...e){if(!vp(s))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(s.length))throw new Error("Uint8Array expected of length "+e+", got length="+s.length)}function bn(s){if(typeof s!="function"||typeof s.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");ci(s.outputLen),ci(s.blockLen)}function Is(s,e=!0){if(s.destroyed)throw new Error("Hash instance has been destroyed");if(e&&s.finished)throw new Error("Hash#digest() has already been called")}function Cc(s,e){mi(s);let t=e.outputLen;if(s.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}var Zi=BigInt(2**32-1),Da=BigInt(32);function bp(s,e=!1){return e?{h:Number(s&Zi),l:Number(s>>Da&Zi)}:{h:Number(s>>Da&Zi)|0,l:Number(s&Zi)|0}}function Ep(s,e=!1){let t=new Uint32Array(s.length),i=new Uint32Array(s.length);for(let r=0;r<s.length;r++){let{h:n,l:o}=bp(s[r],e);[t[r],i[r]]=[n,o]}return[t,i]}var Ip=(s,e,t)=>s<<t|e>>>32-t,Cp=(s,e,t)=>e<<t|s>>>32-t,_p=(s,e,t)=>e<<t-32|s>>>64-t,Pp=(s,e,t)=>s<<t-32|e>>>64-t,vs=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;function Ap(s){return new Uint32Array(s.buffer,s.byteOffset,Math.floor(s.byteLength/4))}function Hr(s){return new DataView(s.buffer,s.byteOffset,s.byteLength)}function ft(s,e){return s<<32-e|s>>>e}var Fa=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function Np(s){return s<<24&4278190080|s<<8&16711680|s>>>8&65280|s>>>24&255}function La(s){for(let e=0;e<s.length;e++)s[e]=Np(s[e])}function Sp(s){if(typeof s!="string")throw new Error("utf8ToBytes expected string, got "+typeof s);return new Uint8Array(new TextEncoder().encode(s))}function Cs(s){return typeof s=="string"&&(s=Sp(s)),mi(s),s}function Tp(...s){let e=0;for(let i=0;i<s.length;i++){let r=s[i];mi(r),e+=r.length}let t=new Uint8Array(e);for(let i=0,r=0;i<s.length;i++){let n=s[i];t.set(n,r),r+=n.length}return t}var li=class{clone(){return this._cloneInto()}};function _c(s){let e=i=>s().update(Cs(i)).digest(),t=s();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>s(),e}function Ts(s=32){if(vs&&typeof vs.getRandomValues=="function")return vs.getRandomValues(new Uint8Array(s));if(vs&&typeof vs.randomBytes=="function")return vs.randomBytes(s);throw new Error("crypto.getRandomValues must be defined")}var Pc=[],Ac=[],Nc=[],Op=BigInt(0),oi=BigInt(1),Rp=BigInt(2),xp=BigInt(7),kp=BigInt(256),Up=BigInt(113);for(let s=0,e=oi,t=1,i=0;s<24;s++){[t,i]=[i,(2*t+3*i)%5],Pc.push(2*(5*i+t)),Ac.push((s+1)*(s+2)/2%64);let r=Op;for(let n=0;n<7;n++)e=(e<<oi^(e>>xp)*Up)%kp,e&Rp&&(r^=oi<<(oi<<BigInt(n))-oi);Nc.push(r)}var[Dp,Fp]=Ep(Nc,!0),qa=(s,e,t)=>t>32?_p(s,e,t):Ip(s,e,t),ja=(s,e,t)=>t>32?Pp(s,e,t):Cp(s,e,t);function Lp(s,e=24){let t=new Uint32Array(10);for(let i=24-e;i<24;i++){for(let o=0;o<10;o++)t[o]=s[o]^s[o+10]^s[o+20]^s[o+30]^s[o+40];for(let o=0;o<10;o+=2){let a=(o+8)%10,c=(o+2)%10,l=t[c],h=t[c+1],p=qa(l,h,1)^t[a],d=ja(l,h,1)^t[a+1];for(let g=0;g<50;g+=10)s[o+g]^=p,s[o+g+1]^=d}let r=s[2],n=s[3];for(let o=0;o<24;o++){let a=Ac[o],c=qa(r,n,a),l=ja(r,n,a),h=Pc[o];r=s[h],n=s[h+1],s[h]=c,s[h+1]=l}for(let o=0;o<50;o+=10){for(let a=0;a<10;a++)t[a]=s[o+a];for(let a=0;a<10;a++)s[o+a]^=~t[(a+2)%10]&t[(a+4)%10]}s[0]^=Dp[i],s[1]^=Fp[i]}t.fill(0)}var tn=class s extends li{constructor(e,t,i,r=!1,n=24){if(super(),this.blockLen=e,this.suffix=t,this.outputLen=i,this.enableXOF=r,this.rounds=n,this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,ci(i),0>=this.blockLen||this.blockLen>=200)throw new Error("Sha3 supports only keccak-f1600 function");this.state=new Uint8Array(200),this.state32=Ap(this.state)}keccak(){Fa||La(this.state32),Lp(this.state32,this.rounds),Fa||La(this.state32),this.posOut=0,this.pos=0}update(e){Is(this);let{blockLen:t,state:i}=this;e=Cs(e);let r=e.length;for(let n=0;n<r;){let o=Math.min(t-this.pos,r-n);for(let a=0;a<o;a++)i[this.pos++]^=e[n++];this.pos===t&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;let{state:e,suffix:t,pos:i,blockLen:r}=this;e[i]^=t,t&128&&i===r-1&&this.keccak(),e[r-1]^=128,this.keccak()}writeInto(e){Is(this,!1),mi(e),this.finish();let t=this.state,{blockLen:i}=this;for(let r=0,n=e.length;r<n;){this.posOut>=i&&this.keccak();let o=Math.min(i-this.posOut,n-r);e.set(t.subarray(this.posOut,this.posOut+o),r),this.posOut+=o,r+=o}return e}xofInto(e){if(!this.enableXOF)throw new Error("XOF is not possible for this instance");return this.writeInto(e)}xof(e){return ci(e),this.xofInto(new Uint8Array(e))}digestInto(e){if(Cc(e,this),this.finished)throw new Error("digest() was already called");return this.writeInto(e),this.destroy(),e}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,this.state.fill(0)}_cloneInto(e){let{blockLen:t,suffix:i,outputLen:r,rounds:n,enableXOF:o}=this;return e||(e=new s(t,i,r,o,n)),e.state32.set(this.state32),e.pos=this.pos,e.posOut=this.posOut,e.finished=this.finished,e.rounds=n,e.suffix=i,e.outputLen=r,e.enableXOF=o,e.destroyed=this.destroyed,e}},qp=(s,e,t)=>_c(()=>new tn(e,s,t)),jp=qp(1,136,256/8),$p="https://rpc.walletconnect.org/v1";function Sc(s){let e=`Ethereum Signed Message:
${s.length}`,t=new TextEncoder().encode(e+s);return"0x"+Buffer.from(jp(t)).toString("hex")}async function Bp(s,e,t,i,r,n){switch(t.t){case"eip191":return await Mp(s,e,t.s);case"eip1271":return await Vp(s,e,t.s,i,r,n);default:throw new Error(`verifySignature failed: Attempted to verify CacaoSignature with unknown type: ${t.t}`)}}async function Mp(s,e,t){return(await Vr({hash:Sc(e),signature:t})).toLowerCase()===s.toLowerCase()}async function Vp(s,e,t,i,r,n){let o=Wt(i);if(!o.namespace||!o.reference)throw new Error(`isValidEip1271Signature failed: chainId must be in CAIP-2 format, received: ${i}`);try{let a="0x1626ba7e",c="0000000000000000000000000000000000000000000000000000000000000040",l="0000000000000000000000000000000000000000000000000000000000000041",h=t.substring(2),p=Sc(e).substring(2),d=a+p+c+l+h,g=await fetch(`${n||$p}/?chainId=${i}&projectId=${r}`,{method:"POST",body:JSON.stringify({id:Hp(),jsonrpc:"2.0",method:"eth_call",params:[{to:s,data:d},"latest"]})}),{result:f}=await g.json();return f?f.slice(0,a.length).toLowerCase()===a.toLowerCase():!1}catch(a){return console.error("isValidEip1271Signature: ",a),!1}}function Hp(){return Date.now()+Math.floor(Math.random()*1e3)}function Tc(s){let e=atob(s),t=new Uint8Array(e.length);for(let o=0;o<e.length;o++)t[o]=e.charCodeAt(o);let i=t[0];if(i===0)throw new Error("No signatures found");let r=1+i*64;if(t.length<r)throw new Error("Transaction data too short for claimed signature count");if(t.length<100)throw new Error("Transaction too short");let n=Buffer.from(s,"base64").slice(1,65);return Xi.encode(n)}var zp=Object.defineProperty,Kp=Object.defineProperties,Wp=Object.getOwnPropertyDescriptors,$a=Object.getOwnPropertySymbols,Gp=Object.prototype.hasOwnProperty,Yp=Object.prototype.propertyIsEnumerable,Ba=(s,e,t)=>e in s?zp(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Jp=(s,e)=>{for(var t in e||(e={}))Gp.call(e,t)&&Ba(s,t,e[t]);if($a)for(var t of $a(e))Yp.call(e,t)&&Ba(s,t,e[t]);return s},Xp=(s,e)=>Kp(s,Wp(e)),Zp="did:pkh:",En=s=>s?.split(":"),Qp=s=>{let e=s&&En(s);if(e)return s.includes(Zp)?e[3]:e[1]},or=s=>{let e=s&&En(s);if(e)return e[2]+":"+e[3]},yi=s=>{let e=s&&En(s);if(e)return e.pop()};async function In(s){let{cacao:e,projectId:t}=s,{s:i,p:r}=e,n=Cn(r,r.iss),o=yi(r.iss);return await Bp(o,n,i,or(r.iss),t)}var Cn=(s,e)=>{let t=`${s.domain} wants you to sign in with your Ethereum account:`,i=yi(e);if(!s.aud&&!s.uri)throw new Error("Either `aud` or `uri` is required to construct the message");let r=s.statement||void 0,n=`URI: ${s.aud||s.uri}`,o=`Version: ${s.version}`,a=`Chain ID: ${Qp(e)}`,c=`Nonce: ${s.nonce}`,l=`Issued At: ${s.iat}`,h=s.exp?`Expiration Time: ${s.exp}`:void 0,p=s.nbf?`Not Before: ${s.nbf}`:void 0,d=s.requestId?`Request ID: ${s.requestId}`:void 0,g=s.resources?`Resources:${s.resources.map(m=>`
- ${m}`).join("")}`:void 0,f=wi(s.resources);if(f){let m=hi(f);r=od(r,m)}return[t,i,"",r,"",n,o,a,c,l,h,p,d,g].filter(m=>m!=null).join(`
`)};function ed(s){return Buffer.from(JSON.stringify(s)).toString("base64")}function td(s){return JSON.parse(Buffer.from(s,"base64").toString("utf-8"))}function os(s){if(!s)throw new Error("No recap provided, value is undefined");if(!s.att)throw new Error("No `att` property found");let e=Object.keys(s.att);if(!(e!=null&&e.length))throw new Error("No resources found in `att` property");e.forEach(t=>{let i=s.att[t];if(Array.isArray(i))throw new Error(`Resource must be an object: ${t}`);if(typeof i!="object")throw new Error(`Resource must be an object: ${t}`);if(!Object.keys(i).length)throw new Error(`Resource object is empty: ${t}`);Object.keys(i).forEach(r=>{let n=i[r];if(!Array.isArray(n))throw new Error(`Ability limits ${r} must be an array of objects, found: ${n}`);if(!n.length)throw new Error(`Value of ${r} is empty array, must be an array with objects`);n.forEach(o=>{if(typeof o!="object")throw new Error(`Ability limits (${r}) must be an array of objects, found: ${o}`)})})})}function sd(s,e,t,i={}){return t?.sort((r,n)=>r.localeCompare(n)),{att:{[s]:id(e,t,i)}}}function id(s,e,t={}){e=e?.sort((r,n)=>r.localeCompare(n));let i=e.map(r=>({[`${s}/${r}`]:[t]}));return Object.assign({},...i)}function Oc(s){return os(s),`urn:recap:${ed(s).replace(/=/g,"")}`}function hi(s){let e=td(s.replace("urn:recap:",""));return os(e),e}function Rc(s,e,t){let i=sd(s,e,t);return Oc(i)}function rd(s){return s&&s.includes("urn:recap:")}function xc(s,e){let t=hi(s),i=hi(e),r=nd(t,i);return Oc(r)}function nd(s,e){os(s),os(e);let t=Object.keys(s.att).concat(Object.keys(e.att)).sort((r,n)=>r.localeCompare(n)),i={att:{}};return t.forEach(r=>{var n,o;Object.keys(((n=s.att)==null?void 0:n[r])||{}).concat(Object.keys(((o=e.att)==null?void 0:o[r])||{})).sort((a,c)=>a.localeCompare(c)).forEach(a=>{var c,l;i.att[r]=Xp(Jp({},i.att[r]),{[a]:((c=s.att[r])==null?void 0:c[a])||((l=e.att[r])==null?void 0:l[a])})})}),i}function od(s="",e){os(e);let t="I further authorize the stated URI to perform the following actions on my behalf: ";if(s.includes(t))return s;let i=[],r=0;Object.keys(e.att).forEach(a=>{let c=Object.keys(e.att[a]).map(p=>({ability:p.split("/")[0],action:p.split("/")[1]}));c.sort((p,d)=>p.action.localeCompare(d.action));let l={};c.forEach(p=>{l[p.ability]||(l[p.ability]=[]),l[p.ability].push(p.action)});let h=Object.keys(l).map(p=>(r++,`(${r}) '${p}': '${l[p].join("', '")}' for '${a}'.`));i.push(h.join(", ").replace(".,","."))});let n=i.join(" "),o=`${t}${n}`;return`${s?s+" ":""}${o}`}function _n(s){var e;let t=hi(s);os(t);let i=(e=t.att)==null?void 0:e.eip155;return i?Object.keys(i).map(r=>r.split("/")[1]):[]}function Pn(s){let e=hi(s);os(e);let t=[];return Object.values(e.att).forEach(i=>{Object.values(i).forEach(r=>{var n;(n=r?.[0])!=null&&n.chains&&t.push(r[0].chains)})}),[...new Set(t.flat())]}function wi(s){if(!s)return;let e=s?.[s.length-1];return rd(e)?e:void 0}function zr(s){if(!Number.isSafeInteger(s)||s<0)throw new Error("positive integer expected, got "+s)}function kc(s){return s instanceof Uint8Array||ArrayBuffer.isView(s)&&s.constructor.name==="Uint8Array"}function ze(s,...e){if(!kc(s))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(s.length))throw new Error("Uint8Array expected of length "+e+", got length="+s.length)}function Ma(s,e=!0){if(s.destroyed)throw new Error("Hash instance has been destroyed");if(e&&s.finished)throw new Error("Hash#digest() has already been called")}function ad(s,e){ze(s);let t=e.outputLen;if(s.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function Va(s){if(typeof s!="boolean")throw new Error(`boolean expected, not ${s}`)}var Ht=s=>new Uint32Array(s.buffer,s.byteOffset,Math.floor(s.byteLength/4)),cd=s=>new DataView(s.buffer,s.byteOffset,s.byteLength),ld=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!ld)throw new Error("Non little-endian hardware is not supported");function hd(s){if(typeof s!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(s))}function sn(s){if(typeof s=="string")s=hd(s);else if(kc(s))s=rn(s);else throw new Error("Uint8Array expected, got "+typeof s);return s}function pd(s,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(s,e)}function dd(s,e){if(s.length!==e.length)return!1;let t=0;for(let i=0;i<s.length;i++)t|=s[i]^e[i];return t===0}var ud=(s,e)=>{function t(i,...r){if(ze(i),s.nonceLength!==void 0){let l=r[0];if(!l)throw new Error("nonce / iv required");s.varSizeNonce?ze(l):ze(l,s.nonceLength)}let n=s.tagLength;n&&r[1]!==void 0&&ze(r[1]);let o=e(i,...r),a=(l,h)=>{if(h!==void 0){if(l!==2)throw new Error("cipher output not supported");ze(h)}},c=!1;return{encrypt(l,h){if(c)throw new Error("cannot encrypt() twice with same key + nonce");return c=!0,ze(l),a(o.encrypt.length,h),o.encrypt(l,h)},decrypt(l,h){if(ze(l),n&&l.length<n)throw new Error("invalid ciphertext length: smaller than tagLength="+n);return a(o.decrypt.length,h),o.decrypt(l,h)}}}return Object.assign(t,s),t};function Ha(s,e,t=!0){if(e===void 0)return new Uint8Array(s);if(e.length!==s)throw new Error("invalid output length, expected "+s+", got: "+e.length);if(t&&!gd(e))throw new Error("invalid output, must be aligned");return e}function za(s,e,t,i){if(typeof s.setBigUint64=="function")return s.setBigUint64(e,t,i);let r=BigInt(32),n=BigInt(4294967295),o=Number(t>>r&n),a=Number(t&n),c=i?4:0,l=i?0:4;s.setUint32(e+c,o,i),s.setUint32(e+l,a,i)}function gd(s){return s.byteOffset%4===0}function rn(s){return Uint8Array.from(s)}function _s(...s){for(let e=0;e<s.length;e++)s[e].fill(0)}var Uc=s=>Uint8Array.from(s.split("").map(e=>e.charCodeAt(0))),fd=Uc("expand 16-byte k"),md=Uc("expand 32-byte k"),yd=Ht(fd),wd=Ht(md);function G(s,e){return s<<e|s>>>32-e}function nn(s){return s.byteOffset%4===0}var Qi=64,vd=16,Dc=2**32-1,Ka=new Uint32Array;function bd(s,e,t,i,r,n,o,a){let c=r.length,l=new Uint8Array(Qi),h=Ht(l),p=nn(r)&&nn(n),d=p?Ht(r):Ka,g=p?Ht(n):Ka;for(let f=0;f<c;o++){if(s(e,t,i,h,o,a),o>=Dc)throw new Error("arx: counter overflow");let m=Math.min(Qi,c-f);if(p&&m===Qi){let u=f/4;if(f%4!==0)throw new Error("arx: invalid block position");for(let w=0,y;w<vd;w++)y=u+w,g[y]=d[y]^h[w];f+=Qi;continue}for(let u=0,w;u<m;u++)w=f+u,n[w]=r[w]^l[u];f+=m}}function Ed(s,e){let{allowShortKeys:t,extendNonceFn:i,counterLength:r,counterRight:n,rounds:o}=pd({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof s!="function")throw new Error("core must be a function");return zr(r),zr(o),Va(n),Va(t),(a,c,l,h,p=0)=>{ze(a),ze(c),ze(l);let d=l.length;if(h===void 0&&(h=new Uint8Array(d)),ze(h),zr(p),p<0||p>=Dc)throw new Error("arx: counter overflow");if(h.length<d)throw new Error(`arx: output (${h.length}) is shorter than data (${d})`);let g=[],f=a.length,m,u;if(f===32)g.push(m=rn(a)),u=wd;else if(f===16&&t)m=new Uint8Array(32),m.set(a),m.set(a,16),u=yd,g.push(m);else throw new Error(`arx: invalid 32-byte key, got length=${f}`);nn(c)||g.push(c=rn(c));let w=Ht(m);if(i){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");i(u,w,Ht(c.subarray(0,16)),w),c=c.subarray(16)}let y=16-r;if(y!==c.length)throw new Error(`arx: nonce must be ${y} or 16 bytes`);if(y!==12){let _=new Uint8Array(12);_.set(c,n?0:12-c.length),c=_,g.push(c)}let v=Ht(c);return bd(s,u,w,v,l,h,p,o),_s(...g),h}}var _e=(s,e)=>s[e++]&255|(s[e++]&255)<<8,on=class{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=sn(e),ze(e,32);let t=_e(e,0),i=_e(e,2),r=_e(e,4),n=_e(e,6),o=_e(e,8),a=_e(e,10),c=_e(e,12),l=_e(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|i<<3)&8191,this.r[2]=(i>>>10|r<<6)&7939,this.r[3]=(r>>>7|n<<9)&8191,this.r[4]=(n>>>4|o<<12)&255,this.r[5]=o>>>1&8190,this.r[6]=(o>>>14|a<<2)&8191,this.r[7]=(a>>>11|c<<5)&8065,this.r[8]=(c>>>8|l<<8)&8191,this.r[9]=l>>>5&127;for(let h=0;h<8;h++)this.pad[h]=_e(e,16+2*h)}process(e,t,i=!1){let r=i?0:2048,{h:n,r:o}=this,a=o[0],c=o[1],l=o[2],h=o[3],p=o[4],d=o[5],g=o[6],f=o[7],m=o[8],u=o[9],w=_e(e,t+0),y=_e(e,t+2),v=_e(e,t+4),_=_e(e,t+6),O=_e(e,t+8),P=_e(e,t+10),N=_e(e,t+12),x=_e(e,t+14),b=n[0]+(w&8191),j=n[1]+((w>>>13|y<<3)&8191),U=n[2]+((y>>>10|v<<6)&8191),F=n[3]+((v>>>7|_<<9)&8191),B=n[4]+((_>>>4|O<<12)&8191),I=n[5]+(O>>>1&8191),T=n[6]+((O>>>14|P<<2)&8191),S=n[7]+((P>>>11|N<<5)&8191),k=n[8]+((N>>>8|x<<8)&8191),D=n[9]+(x>>>5|r),A=0,$=A+b*a+j*(5*u)+U*(5*m)+F*(5*f)+B*(5*g);A=$>>>13,$&=8191,$+=I*(5*d)+T*(5*p)+S*(5*h)+k*(5*l)+D*(5*c),A+=$>>>13,$&=8191;let M=A+b*c+j*a+U*(5*u)+F*(5*m)+B*(5*f);A=M>>>13,M&=8191,M+=I*(5*g)+T*(5*d)+S*(5*p)+k*(5*h)+D*(5*l),A+=M>>>13,M&=8191;let V=A+b*l+j*c+U*a+F*(5*u)+B*(5*m);A=V>>>13,V&=8191,V+=I*(5*f)+T*(5*g)+S*(5*d)+k*(5*p)+D*(5*h),A+=V>>>13,V&=8191;let ie=A+b*h+j*l+U*c+F*a+B*(5*u);A=ie>>>13,ie&=8191,ie+=I*(5*m)+T*(5*f)+S*(5*g)+k*(5*d)+D*(5*p),A+=ie>>>13,ie&=8191;let Q=A+b*p+j*h+U*l+F*c+B*a;A=Q>>>13,Q&=8191,Q+=I*(5*u)+T*(5*m)+S*(5*f)+k*(5*g)+D*(5*d),A+=Q>>>13,Q&=8191;let pe=A+b*d+j*p+U*h+F*l+B*c;A=pe>>>13,pe&=8191,pe+=I*a+T*(5*u)+S*(5*m)+k*(5*f)+D*(5*g),A+=pe>>>13,pe&=8191;let ye=A+b*g+j*d+U*p+F*h+B*l;A=ye>>>13,ye&=8191,ye+=I*c+T*a+S*(5*u)+k*(5*m)+D*(5*f),A+=ye>>>13,ye&=8191;let Se=A+b*f+j*g+U*d+F*p+B*h;A=Se>>>13,Se&=8191,Se+=I*l+T*c+S*a+k*(5*u)+D*(5*m),A+=Se>>>13,Se&=8191;let ue=A+b*m+j*f+U*g+F*d+B*p;A=ue>>>13,ue&=8191,ue+=I*h+T*l+S*c+k*a+D*(5*u),A+=ue>>>13,ue&=8191;let ge=A+b*u+j*m+U*f+F*g+B*d;A=ge>>>13,ge&=8191,ge+=I*p+T*h+S*l+k*c+D*a,A+=ge>>>13,ge&=8191,A=(A<<2)+A|0,A=A+$|0,$=A&8191,A=A>>>13,M+=A,n[0]=$,n[1]=M,n[2]=V,n[3]=ie,n[4]=Q,n[5]=pe,n[6]=ye,n[7]=Se,n[8]=ue,n[9]=ge}finalize(){let{h:e,pad:t}=this,i=new Uint16Array(10),r=e[1]>>>13;e[1]&=8191;for(let a=2;a<10;a++)e[a]+=r,r=e[a]>>>13,e[a]&=8191;e[0]+=r*5,r=e[0]>>>13,e[0]&=8191,e[1]+=r,r=e[1]>>>13,e[1]&=8191,e[2]+=r,i[0]=e[0]+5,r=i[0]>>>13,i[0]&=8191;for(let a=1;a<10;a++)i[a]=e[a]+r,r=i[a]>>>13,i[a]&=8191;i[9]-=8192;let n=(r^1)-1;for(let a=0;a<10;a++)i[a]&=n;n=~n;for(let a=0;a<10;a++)e[a]=e[a]&n|i[a];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let o=e[0]+t[0];e[0]=o&65535;for(let a=1;a<8;a++)o=(e[a]+t[a]|0)+(o>>>16)|0,e[a]=o&65535;_s(i)}update(e){Ma(this);let{buffer:t,blockLen:i}=this;e=sn(e);let r=e.length;for(let n=0;n<r;){let o=Math.min(i-this.pos,r-n);if(o===i){for(;i<=r-n;n+=i)this.process(e,n);continue}t.set(e.subarray(n,n+o),this.pos),this.pos+=o,n+=o,this.pos===i&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){_s(this.h,this.r,this.buffer,this.pad)}digestInto(e){Ma(this),ad(e,this),this.finished=!0;let{buffer:t,h:i}=this,{pos:r}=this;if(r){for(t[r++]=1;r<16;r++)t[r]=0;this.process(t,0,!0)}this.finalize();let n=0;for(let o=0;o<8;o++)e[n++]=i[o]>>>0,e[n++]=i[o]>>>8;return e}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let i=e.slice(0,t);return this.destroy(),i}};function Id(s){let e=(i,r)=>s(r).update(sn(i)).digest(),t=s(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=i=>s(i),e}var Cd=Id(s=>new on(s));function _d(s,e,t,i,r,n=20){let o=s[0],a=s[1],c=s[2],l=s[3],h=e[0],p=e[1],d=e[2],g=e[3],f=e[4],m=e[5],u=e[6],w=e[7],y=r,v=t[0],_=t[1],O=t[2],P=o,N=a,x=c,b=l,j=h,U=p,F=d,B=g,I=f,T=m,S=u,k=w,D=y,A=v,$=_,M=O;for(let ie=0;ie<n;ie+=2)P=P+j|0,D=G(D^P,16),I=I+D|0,j=G(j^I,12),P=P+j|0,D=G(D^P,8),I=I+D|0,j=G(j^I,7),N=N+U|0,A=G(A^N,16),T=T+A|0,U=G(U^T,12),N=N+U|0,A=G(A^N,8),T=T+A|0,U=G(U^T,7),x=x+F|0,$=G($^x,16),S=S+$|0,F=G(F^S,12),x=x+F|0,$=G($^x,8),S=S+$|0,F=G(F^S,7),b=b+B|0,M=G(M^b,16),k=k+M|0,B=G(B^k,12),b=b+B|0,M=G(M^b,8),k=k+M|0,B=G(B^k,7),P=P+U|0,M=G(M^P,16),S=S+M|0,U=G(U^S,12),P=P+U|0,M=G(M^P,8),S=S+M|0,U=G(U^S,7),N=N+F|0,D=G(D^N,16),k=k+D|0,F=G(F^k,12),N=N+F|0,D=G(D^N,8),k=k+D|0,F=G(F^k,7),x=x+B|0,A=G(A^x,16),I=I+A|0,B=G(B^I,12),x=x+B|0,A=G(A^x,8),I=I+A|0,B=G(B^I,7),b=b+j|0,$=G($^b,16),T=T+$|0,j=G(j^T,12),b=b+j|0,$=G($^b,8),T=T+$|0,j=G(j^T,7);let V=0;i[V++]=o+P|0,i[V++]=a+N|0,i[V++]=c+x|0,i[V++]=l+b|0,i[V++]=h+j|0,i[V++]=p+U|0,i[V++]=d+F|0,i[V++]=g+B|0,i[V++]=f+I|0,i[V++]=m+T|0,i[V++]=u+S|0,i[V++]=w+k|0,i[V++]=y+D|0,i[V++]=v+A|0,i[V++]=_+$|0,i[V++]=O+M|0}var Pd=Ed(_d,{counterRight:!1,counterLength:4,allowShortKeys:!1}),Ad=new Uint8Array(16),Wa=(s,e)=>{s.update(e);let t=e.length%16;t&&s.update(Ad.subarray(t))},Nd=new Uint8Array(32);function Ga(s,e,t,i,r){let n=s(e,t,Nd),o=Cd.create(n);r&&Wa(o,r),Wa(o,i);let a=new Uint8Array(16),c=cd(a);za(c,0,BigInt(r?r.length:0),!0),za(c,8,BigInt(i.length),!0),o.update(a);let l=o.digest();return _s(n,a),l}var Sd=s=>(e,t,i)=>({encrypt(r,n){let o=r.length;n=Ha(o+16,n,!1),n.set(r);let a=n.subarray(0,-16);s(e,t,a,a,1);let c=Ga(s,e,t,a,i);return n.set(c,o),_s(c),n},decrypt(r,n){n=Ha(r.length-16,n,!1);let o=r.subarray(0,-16),a=r.subarray(-16),c=Ga(s,e,t,o,i);if(!dd(a,c))throw new Error("invalid tag");return n.set(r.subarray(0,-16)),s(e,t,n,n,1),_s(c),n}}),Fc=ud({blockSize:64,nonceLength:12,tagLength:16},Sd(Pd)),tr=class extends li{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,bn(e);let i=Cs(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;let r=this.blockLen,n=new Uint8Array(r);n.set(i.length>r?e.create().update(i).digest():i);for(let o=0;o<n.length;o++)n[o]^=54;this.iHash.update(n),this.oHash=e.create();for(let o=0;o<n.length;o++)n[o]^=106;this.oHash.update(n),n.fill(0)}update(e){return Is(this),this.iHash.update(e),this}digestInto(e){Is(this),mi(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){let e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));let{oHash:t,iHash:i,finished:r,destroyed:n,blockLen:o,outputLen:a}=this;return e=e,e.finished=r,e.destroyed=n,e.blockLen=o,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=i._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}},ar=(s,e,t)=>new tr(s,e).update(t).digest();ar.create=(s,e)=>new tr(s,e);function Td(s,e,t){return bn(s),t===void 0&&(t=new Uint8Array(s.outputLen)),ar(s,Cs(t),Cs(e))}var Kr=new Uint8Array([0]),Ya=new Uint8Array;function Od(s,e,t,i=32){if(bn(s),ci(i),i>255*s.outputLen)throw new Error("Length should be <= 255*HashLen");let r=Math.ceil(i/s.outputLen);t===void 0&&(t=Ya);let n=new Uint8Array(r*s.outputLen),o=ar.create(s,e),a=o._cloneInto(),c=new Uint8Array(o.outputLen);for(let l=0;l<r;l++)Kr[0]=l+1,a.update(l===0?Ya:c).update(t).update(Kr).digestInto(c),n.set(c,s.outputLen*l),o._cloneInto(a);return o.destroy(),a.destroy(),c.fill(0),Kr.fill(0),n.slice(0,i)}var Rd=(s,e,t,i,r)=>Od(s,Td(s,e,t),i,r);function xd(s,e,t,i){if(typeof s.setBigUint64=="function")return s.setBigUint64(e,t,i);let r=BigInt(32),n=BigInt(4294967295),o=Number(t>>r&n),a=Number(t&n),c=i?4:0,l=i?0:4;s.setUint32(e+c,o,i),s.setUint32(e+l,a,i)}function kd(s,e,t){return s&e^~s&t}function Ud(s,e,t){return s&e^s&t^e&t}var an=class extends li{constructor(e,t,i,r){super(),this.blockLen=e,this.outputLen=t,this.padOffset=i,this.isLE=r,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=Hr(this.buffer)}update(e){Is(this);let{view:t,buffer:i,blockLen:r}=this;e=Cs(e);let n=e.length;for(let o=0;o<n;){let a=Math.min(r-this.pos,n-o);if(a===r){let c=Hr(e);for(;r<=n-o;o+=r)this.process(c,o);continue}i.set(e.subarray(o,o+a),this.pos),this.pos+=a,o+=a,this.pos===r&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Is(this),Cc(e,this),this.finished=!0;let{buffer:t,view:i,blockLen:r,isLE:n}=this,{pos:o}=this;t[o++]=128,this.buffer.subarray(o).fill(0),this.padOffset>r-o&&(this.process(i,0),o=0);for(let p=o;p<r;p++)t[p]=0;xd(i,r-8,BigInt(this.length*8),n),this.process(i,0);let a=Hr(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let l=c/4,h=this.get();if(l>h.length)throw new Error("_sha2: outputLen bigger than state");for(let p=0;p<l;p++)a.setUint32(4*p,h[p],n)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let i=e.slice(0,t);return this.destroy(),i}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:i,length:r,finished:n,destroyed:o,pos:a}=this;return e.length=r,e.pos=a,e.finished=n,e.destroyed=o,r%t&&e.buffer.set(i),e}},Dd=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Mt=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Vt=new Uint32Array(64),cn=class extends an{constructor(){super(64,32,8,!1),this.A=Mt[0]|0,this.B=Mt[1]|0,this.C=Mt[2]|0,this.D=Mt[3]|0,this.E=Mt[4]|0,this.F=Mt[5]|0,this.G=Mt[6]|0,this.H=Mt[7]|0}get(){let{A:e,B:t,C:i,D:r,E:n,F:o,G:a,H:c}=this;return[e,t,i,r,n,o,a,c]}set(e,t,i,r,n,o,a,c){this.A=e|0,this.B=t|0,this.C=i|0,this.D=r|0,this.E=n|0,this.F=o|0,this.G=a|0,this.H=c|0}process(e,t){for(let p=0;p<16;p++,t+=4)Vt[p]=e.getUint32(t,!1);for(let p=16;p<64;p++){let d=Vt[p-15],g=Vt[p-2],f=ft(d,7)^ft(d,18)^d>>>3,m=ft(g,17)^ft(g,19)^g>>>10;Vt[p]=m+Vt[p-7]+f+Vt[p-16]|0}let{A:i,B:r,C:n,D:o,E:a,F:c,G:l,H:h}=this;for(let p=0;p<64;p++){let d=ft(a,6)^ft(a,11)^ft(a,25),g=h+d+kd(a,c,l)+Dd[p]+Vt[p]|0,f=(ft(i,2)^ft(i,13)^ft(i,22))+Ud(i,r,n)|0;h=l,l=c,c=a,a=o+g|0,o=n,n=r,r=i,i=g+f|0}i=i+this.A|0,r=r+this.B|0,n=n+this.C|0,o=o+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,h=h+this.H|0,this.set(i,r,n,o,a,c,l,h)}roundClean(){Vt.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}},vi=_c(()=>new cn);var cr=BigInt(0),lr=BigInt(1),Fd=BigInt(2);function as(s){return s instanceof Uint8Array||ArrayBuffer.isView(s)&&s.constructor.name==="Uint8Array"}function bi(s){if(!as(s))throw new Error("Uint8Array expected")}function Ps(s,e){if(typeof e!="boolean")throw new Error(s+" boolean expected, got "+e)}var Ld=Array.from({length:256},(s,e)=>e.toString(16).padStart(2,"0"));function As(s){bi(s);let e="";for(let t=0;t<s.length;t++)e+=Ld[s[t]];return e}function Es(s){let e=s.toString(16);return e.length&1?"0"+e:e}function An(s){if(typeof s!="string")throw new Error("hex string expected, got "+typeof s);return s===""?cr:BigInt("0x"+s)}var St={_0:48,_9:57,A:65,F:70,a:97,f:102};function Ja(s){if(s>=St._0&&s<=St._9)return s-St._0;if(s>=St.A&&s<=St.F)return s-(St.A-10);if(s>=St.a&&s<=St.f)return s-(St.a-10)}function Ns(s){if(typeof s!="string")throw new Error("hex string expected, got "+typeof s);let e=s.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);let i=new Uint8Array(t);for(let r=0,n=0;r<t;r++,n+=2){let o=Ja(s.charCodeAt(n)),a=Ja(s.charCodeAt(n+1));if(o===void 0||a===void 0){let c=s[n]+s[n+1];throw new Error('hex string expected, got non-hex character "'+c+'" at index '+n)}i[r]=o*16+a}return i}function ns(s){return An(As(s))}function pi(s){return bi(s),An(As(Uint8Array.from(s).reverse()))}function Ss(s,e){return Ns(s.toString(16).padStart(e*2,"0"))}function hr(s,e){return Ss(s,e).reverse()}function qd(s){return Ns(Es(s))}function He(s,e,t){let i;if(typeof e=="string")try{i=Ns(e)}catch(n){throw new Error(s+" must be hex string or Uint8Array, cause: "+n)}else if(as(e))i=Uint8Array.from(e);else throw new Error(s+" must be hex string or Uint8Array");let r=i.length;if(typeof t=="number"&&r!==t)throw new Error(s+" of length "+t+" expected, got "+r);return i}function di(...s){let e=0;for(let i=0;i<s.length;i++){let r=s[i];bi(r),e+=r.length}let t=new Uint8Array(e);for(let i=0,r=0;i<s.length;i++){let n=s[i];t.set(n,r),r+=n.length}return t}function jd(s,e){if(s.length!==e.length)return!1;let t=0;for(let i=0;i<s.length;i++)t|=s[i]^e[i];return t===0}function $d(s){if(typeof s!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(s))}var Wr=s=>typeof s=="bigint"&&cr<=s;function pr(s,e,t){return Wr(s)&&Wr(e)&&Wr(t)&&e<=s&&s<t}function Rt(s,e,t,i){if(!pr(e,t,i))throw new Error("expected valid "+s+": "+t+" <= n < "+i+", got "+e)}function Lc(s){let e;for(e=0;s>cr;s>>=lr,e+=1);return e}function Bd(s,e){return s>>BigInt(e)&lr}function Md(s,e,t){return s|(t?lr:cr)<<BigInt(e)}var Nn=s=>(Fd<<BigInt(s-1))-lr,Gr=s=>new Uint8Array(s),Xa=s=>Uint8Array.from(s);function qc(s,e,t){if(typeof s!="number"||s<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");let i=Gr(s),r=Gr(s),n=0,o=()=>{i.fill(1),r.fill(0),n=0},a=(...h)=>t(r,i,...h),c=(h=Gr())=>{r=a(Xa([0]),h),i=a(),h.length!==0&&(r=a(Xa([1]),h),i=a())},l=()=>{if(n++>=1e3)throw new Error("drbg: tried 1000 values");let h=0,p=[];for(;h<e;){i=a();let d=i.slice();p.push(d),h+=i.length}return di(...p)};return(h,p)=>{o(),c(h);let d;for(;!(d=p(l()));)c();return o(),d}}var Vd={bigint:s=>typeof s=="bigint",function:s=>typeof s=="function",boolean:s=>typeof s=="boolean",string:s=>typeof s=="string",stringOrUint8Array:s=>typeof s=="string"||as(s),isSafeInteger:s=>Number.isSafeInteger(s),array:s=>Array.isArray(s),field:(s,e)=>e.Fp.isValid(s),hash:s=>typeof s=="function"&&Number.isSafeInteger(s.outputLen)};function Os(s,e,t={}){let i=(r,n,o)=>{let a=Vd[n];if(typeof a!="function")throw new Error("invalid validator function");let c=s[r];if(!(o&&c===void 0)&&!a(c,s))throw new Error("param "+String(r)+" is invalid. Expected "+n+", got "+c)};for(let[r,n]of Object.entries(e))i(r,n,!1);for(let[r,n]of Object.entries(t))i(r,n,!0);return s}var Hd=()=>{throw new Error("not implemented")};function ln(s){let e=new WeakMap;return(t,...i)=>{let r=e.get(t);if(r!==void 0)return r;let n=s(t,...i);return e.set(t,n),n}}var zd=Object.freeze({__proto__:null,isBytes:as,abytes:bi,abool:Ps,bytesToHex:As,numberToHexUnpadded:Es,hexToNumber:An,hexToBytes:Ns,bytesToNumberBE:ns,bytesToNumberLE:pi,numberToBytesBE:Ss,numberToBytesLE:hr,numberToVarBytesBE:qd,ensureBytes:He,concatBytes:di,equalBytes:jd,utf8ToBytes:$d,inRange:pr,aInRange:Rt,bitLen:Lc,bitGet:Bd,bitSet:Md,bitMask:Nn,createHmacDrbg:qc,validateObject:Os,notImplemented:Hd,memoized:ln}),ve=BigInt(0),le=BigInt(1),is=BigInt(2),Kd=BigInt(3),hn=BigInt(4),Za=BigInt(5),Qa=BigInt(8);function Le(s,e){let t=s%e;return t>=ve?t:e+t}function jc(s,e,t){if(e<ve)throw new Error("invalid exponent, negatives unsupported");if(t<=ve)throw new Error("invalid modulus");if(t===le)return ve;let i=le;for(;e>ve;)e&le&&(i=i*s%t),s=s*s%t,e>>=le;return i}function rt(s,e,t){let i=s;for(;e-- >ve;)i*=i,i%=t;return i}function pn(s,e){if(s===ve)throw new Error("invert: expected non-zero number");if(e<=ve)throw new Error("invert: expected positive modulus, got "+e);let t=Le(s,e),i=e,r=ve,n=le;for(;t!==ve;){let o=i/t,a=i%t,c=r-n*o;i=t,t=a,r=n,n=c}if(i!==le)throw new Error("invert: does not exist");return Le(r,e)}function Wd(s){let e=(s-le)/is,t,i,r;for(t=s-le,i=0;t%is===ve;t/=is,i++);for(r=is;r<s&&jc(r,e,s)!==s-le;r++)if(r>1e3)throw new Error("Cannot find square root: likely non-prime P");if(i===1){let o=(s+le)/hn;return function(a,c){let l=a.pow(c,o);if(!a.eql(a.sqr(l),c))throw new Error("Cannot find square root");return l}}let n=(t+le)/is;return function(o,a){if(o.pow(a,e)===o.neg(o.ONE))throw new Error("Cannot find square root");let c=i,l=o.pow(o.mul(o.ONE,r),t),h=o.pow(a,n),p=o.pow(a,t);for(;!o.eql(p,o.ONE);){if(o.eql(p,o.ZERO))return o.ZERO;let d=1;for(let f=o.sqr(p);d<c&&!o.eql(f,o.ONE);d++)f=o.sqr(f);let g=o.pow(l,le<<BigInt(c-d-1));l=o.sqr(g),h=o.mul(h,g),p=o.mul(p,l),c=d}return h}}function Gd(s){if(s%hn===Kd){let e=(s+le)/hn;return function(t,i){let r=t.pow(i,e);if(!t.eql(t.sqr(r),i))throw new Error("Cannot find square root");return r}}if(s%Qa===Za){let e=(s-Za)/Qa;return function(t,i){let r=t.mul(i,is),n=t.pow(r,e),o=t.mul(i,n),a=t.mul(t.mul(o,is),n),c=t.mul(o,t.sub(a,t.ONE));if(!t.eql(t.sqr(c),i))throw new Error("Cannot find square root");return c}}return Wd(s)}var Yd=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Jd(s){let e={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},t=Yd.reduce((i,r)=>(i[r]="function",i),e);return Os(s,t)}function Xd(s,e,t){if(t<ve)throw new Error("invalid exponent, negatives unsupported");if(t===ve)return s.ONE;if(t===le)return e;let i=s.ONE,r=e;for(;t>ve;)t&le&&(i=s.mul(i,r)),r=s.sqr(r),t>>=le;return i}function Zd(s,e){let t=new Array(e.length),i=e.reduce((n,o,a)=>s.is0(o)?n:(t[a]=n,s.mul(n,o)),s.ONE),r=s.inv(i);return e.reduceRight((n,o,a)=>s.is0(o)?n:(t[a]=s.mul(n,t[a]),s.mul(n,o)),r),t}function $c(s,e){let t=e!==void 0?e:s.toString(2).length,i=Math.ceil(t/8);return{nBitLength:t,nByteLength:i}}function Bc(s,e,t=!1,i={}){if(s<=ve)throw new Error("invalid field: expected ORDER > 0, got "+s);let{nBitLength:r,nByteLength:n}=$c(s,e);if(n>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let o,a=Object.freeze({ORDER:s,isLE:t,BITS:r,BYTES:n,MASK:Nn(r),ZERO:ve,ONE:le,create:c=>Le(c,s),isValid:c=>{if(typeof c!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof c);return ve<=c&&c<s},is0:c=>c===ve,isOdd:c=>(c&le)===le,neg:c=>Le(-c,s),eql:(c,l)=>c===l,sqr:c=>Le(c*c,s),add:(c,l)=>Le(c+l,s),sub:(c,l)=>Le(c-l,s),mul:(c,l)=>Le(c*l,s),pow:(c,l)=>Xd(a,c,l),div:(c,l)=>Le(c*pn(l,s),s),sqrN:c=>c*c,addN:(c,l)=>c+l,subN:(c,l)=>c-l,mulN:(c,l)=>c*l,inv:c=>pn(c,s),sqrt:i.sqrt||(c=>(o||(o=Gd(s)),o(a,c))),invertBatch:c=>Zd(a,c),cmov:(c,l,h)=>h?l:c,toBytes:c=>t?hr(c,n):Ss(c,n),fromBytes:c=>{if(c.length!==n)throw new Error("Field.fromBytes: expected "+n+" bytes, got "+c.length);return t?pi(c):ns(c)}});return Object.freeze(a)}function Mc(s){if(typeof s!="bigint")throw new Error("field order must be bigint");let e=s.toString(2).length;return Math.ceil(e/8)}function Vc(s){let e=Mc(s);return e+Math.ceil(e/2)}function Qd(s,e,t=!1){let i=s.length,r=Mc(e),n=Vc(e);if(i<16||i<n||i>1024)throw new Error("expected "+n+"-1024 bytes of input, got "+i);let o=t?pi(s):ns(s),a=Le(o,e-le)+le;return t?hr(a,r):Ss(a,r)}var ec=BigInt(0),er=BigInt(1);function Yr(s,e){let t=e.negate();return s?t:e}function Hc(s,e){if(!Number.isSafeInteger(s)||s<=0||s>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+s)}function Jr(s,e){Hc(s,e);let t=Math.ceil(e/s)+1,i=2**(s-1);return{windows:t,windowSize:i}}function eu(s,e){if(!Array.isArray(s))throw new Error("array expected");s.forEach((t,i)=>{if(!(t instanceof e))throw new Error("invalid point at index "+i)})}function tu(s,e){if(!Array.isArray(s))throw new Error("array of scalars expected");s.forEach((t,i)=>{if(!e.isValid(t))throw new Error("invalid scalar at index "+i)})}var Xr=new WeakMap,zc=new WeakMap;function Zr(s){return zc.get(s)||1}function su(s,e){return{constTimeNegate:Yr,hasPrecomputes(t){return Zr(t)!==1},unsafeLadder(t,i,r=s.ZERO){let n=t;for(;i>ec;)i&er&&(r=r.add(n)),n=n.double(),i>>=er;return r},precomputeWindow(t,i){let{windows:r,windowSize:n}=Jr(i,e),o=[],a=t,c=a;for(let l=0;l<r;l++){c=a,o.push(c);for(let h=1;h<n;h++)c=c.add(a),o.push(c);a=c.double()}return o},wNAF(t,i,r){let{windows:n,windowSize:o}=Jr(t,e),a=s.ZERO,c=s.BASE,l=BigInt(2**t-1),h=2**t,p=BigInt(t);for(let d=0;d<n;d++){let g=d*o,f=Number(r&l);r>>=p,f>o&&(f-=h,r+=er);let m=g,u=g+Math.abs(f)-1,w=d%2!==0,y=f<0;f===0?c=c.add(Yr(w,i[m])):a=a.add(Yr(y,i[u]))}return{p:a,f:c}},wNAFUnsafe(t,i,r,n=s.ZERO){let{windows:o,windowSize:a}=Jr(t,e),c=BigInt(2**t-1),l=2**t,h=BigInt(t);for(let p=0;p<o;p++){let d=p*a;if(r===ec)break;let g=Number(r&c);if(r>>=h,g>a&&(g-=l,r+=er),g===0)continue;let f=i[d+Math.abs(g)-1];g<0&&(f=f.negate()),n=n.add(f)}return n},getPrecomputes(t,i,r){let n=Xr.get(i);return n||(n=this.precomputeWindow(i,t),t!==1&&Xr.set(i,r(n))),n},wNAFCached(t,i,r){let n=Zr(t);return this.wNAF(n,this.getPrecomputes(n,t,r),i)},wNAFCachedUnsafe(t,i,r,n){let o=Zr(t);return o===1?this.unsafeLadder(t,i,n):this.wNAFUnsafe(o,this.getPrecomputes(o,t,r),i,n)},setWindowSize(t,i){Hc(i,e),zc.set(t,i),Xr.delete(t)}}}function iu(s,e,t,i){if(eu(t,s),tu(i,e),t.length!==i.length)throw new Error("arrays of points and scalars must have equal length");let r=s.ZERO,n=Lc(BigInt(t.length)),o=n>12?n-3:n>4?n-2:n?2:1,a=(1<<o)-1,c=new Array(a+1).fill(r),l=Math.floor((e.BITS-1)/o)*o,h=r;for(let p=l;p>=0;p-=o){c.fill(r);for(let g=0;g<i.length;g++){let f=i[g],m=Number(f>>BigInt(p)&BigInt(a));c[m]=c[m].add(t[g])}let d=r;for(let g=c.length-1,f=r;g>0;g--)f=f.add(c[g]),d=d.add(f);if(h=h.add(d),p!==0)for(let g=0;g<o;g++)h=h.double()}return h}function Kc(s){return Jd(s.Fp),Os(s,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...$c(s.n,s.nBitLength),...s,p:s.Fp.ORDER})}BigInt(0),BigInt(1),BigInt(2),BigInt(8);var bs=BigInt(0),Qr=BigInt(1);function ru(s){return Os(s,{a:"bigint"},{montgomeryBits:"isSafeInteger",nByteLength:"isSafeInteger",adjustScalarBytes:"function",domain:"function",powPminus2:"function",Gu:"bigint"}),Object.freeze({...s})}function nu(s){let e=ru(s),{P:t}=e,i=y=>Le(y,t),r=e.montgomeryBits,n=Math.ceil(r/8),o=e.nByteLength,a=e.adjustScalarBytes||(y=>y),c=e.powPminus2||(y=>jc(y,t-BigInt(2),t));function l(y,v,_){let O=i(y*(v-_));return v=i(v-O),_=i(_+O),[v,_]}let h=(e.a-BigInt(2))/BigInt(4);function p(y,v){Rt("u",y,bs,t),Rt("scalar",v,bs,t);let _=v,O=y,P=Qr,N=bs,x=y,b=Qr,j=bs,U;for(let B=BigInt(r-1);B>=bs;B--){let I=_>>B&Qr;j^=I,U=l(j,P,x),P=U[0],x=U[1],U=l(j,N,b),N=U[0],b=U[1],j=I;let T=P+N,S=i(T*T),k=P-N,D=i(k*k),A=S-D,$=x+b,M=x-b,V=i(M*T),ie=i($*k),Q=V+ie,pe=V-ie;x=i(Q*Q),b=i(O*i(pe*pe)),P=i(S*D),N=i(A*(S+i(h*A)))}U=l(j,P,x),P=U[0],x=U[1],U=l(j,N,b),N=U[0],b=U[1];let F=c(N);return i(P*F)}function d(y){return hr(i(y),n)}function g(y){let v=He("u coordinate",y,n);return o===32&&(v[31]&=127),pi(v)}function f(y){let v=He("scalar",y),_=v.length;if(_!==n&&_!==o){let O=""+n+" or "+o;throw new Error("invalid scalar, expected "+O+" bytes, got "+_)}return pi(a(v))}function m(y,v){let _=g(v),O=f(y),P=p(_,O);if(P===bs)throw new Error("invalid private or public key received");return d(P)}let u=d(e.Gu);function w(y){return m(y,u)}return{scalarMult:m,scalarMultBase:w,getSharedSecret:(y,v)=>m(y,v),getPublicKey:y=>w(y),utils:{randomPrivateKey:()=>e.randomBytes(e.nByteLength)},GuBytes:u}}var dn=BigInt("57896044618658097711785492504343953926634992332820282019728792003956564819949");BigInt(0);var ou=BigInt(1),tc=BigInt(2),au=BigInt(3),cu=BigInt(5);BigInt(8);function lu(s){let e=BigInt(10),t=BigInt(20),i=BigInt(40),r=BigInt(80),n=dn,o=s*s%n*s%n,a=rt(o,tc,n)*o%n,c=rt(a,ou,n)*s%n,l=rt(c,cu,n)*c%n,h=rt(l,e,n)*l%n,p=rt(h,t,n)*h%n,d=rt(p,i,n)*p%n,g=rt(d,r,n)*d%n,f=rt(g,r,n)*d%n,m=rt(f,e,n)*l%n;return{pow_p_5_8:rt(m,tc,n)*s%n,b2:o}}function hu(s){return s[0]&=248,s[31]&=127,s[31]|=64,s}var un=nu({P:dn,a:BigInt(486662),montgomeryBits:255,nByteLength:32,Gu:BigInt(9),powPminus2:s=>{let e=dn,{pow_p_5_8:t,b2:i}=lu(s);return Le(rt(t,au,e)*i,e)},adjustScalarBytes:hu,randomBytes:Ts});function sc(s){s.lowS!==void 0&&Ps("lowS",s.lowS),s.prehash!==void 0&&Ps("prehash",s.prehash)}function pu(s){let e=Kc(s);Os(e,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});let{endo:t,Fp:i,a:r}=e;if(t){if(!i.eql(r,i.ZERO))throw new Error("invalid endomorphism, can only be defined for Koblitz curves that have a=0");if(typeof t!="object"||typeof t.beta!="bigint"||typeof t.splitScalar!="function")throw new Error("invalid endomorphism, expected beta: bigint and splitScalar: function")}return Object.freeze({...e})}var{bytesToNumberBE:du,hexToBytes:uu}=zd,gn=class extends Error{constructor(e=""){super(e)}},Tt={Err:gn,_tlv:{encode:(s,e)=>{let{Err:t}=Tt;if(s<0||s>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");let i=e.length/2,r=Es(i);if(r.length/2&128)throw new t("tlv.encode: long form length too big");let n=i>127?Es(r.length/2|128):"";return Es(s)+n+r+e},decode(s,e){let{Err:t}=Tt,i=0;if(s<0||s>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[i++]!==s)throw new t("tlv.decode: wrong tlv");let r=e[i++],n=!!(r&128),o=0;if(!n)o=r;else{let c=r&127;if(!c)throw new t("tlv.decode(long): indefinite length not supported");if(c>4)throw new t("tlv.decode(long): byte length is too big");let l=e.subarray(i,i+c);if(l.length!==c)throw new t("tlv.decode: length bytes not complete");if(l[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(let h of l)o=o<<8|h;if(i+=c,o<128)throw new t("tlv.decode(long): not minimal encoding")}let a=e.subarray(i,i+o);if(a.length!==o)throw new t("tlv.decode: wrong value length");return{v:a,l:e.subarray(i+o)}}},_int:{encode(s){let{Err:e}=Tt;if(s<Ot)throw new e("integer: negative integers are not allowed");let t=Es(s);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(s){let{Err:e}=Tt;if(s[0]&128)throw new e("invalid signature integer: negative");if(s[0]===0&&!(s[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return du(s)}},toSig(s){let{Err:e,_int:t,_tlv:i}=Tt,r=typeof s=="string"?uu(s):s;bi(r);let{v:n,l:o}=i.decode(48,r);if(o.length)throw new e("invalid signature: left bytes after parsing");let{v:a,l:c}=i.decode(2,n),{v:l,l:h}=i.decode(2,c);if(h.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(a),s:t.decode(l)}},hexFromSig(s){let{_tlv:e,_int:t}=Tt,i=e.encode(2,t.encode(s.r)),r=e.encode(2,t.encode(s.s)),n=i+r;return e.encode(48,n)}},Ot=BigInt(0),we=BigInt(1);BigInt(2);var ic=BigInt(3);BigInt(4);function gu(s){let e=pu(s),{Fp:t}=e,i=Bc(e.n,e.nBitLength),r=e.toBytes||((m,u,w)=>{let y=u.toAffine();return di(Uint8Array.from([4]),t.toBytes(y.x),t.toBytes(y.y))}),n=e.fromBytes||(m=>{let u=m.subarray(1),w=t.fromBytes(u.subarray(0,t.BYTES)),y=t.fromBytes(u.subarray(t.BYTES,2*t.BYTES));return{x:w,y}});function o(m){let{a:u,b:w}=e,y=t.sqr(m),v=t.mul(y,m);return t.add(t.add(v,t.mul(m,u)),w)}if(!t.eql(t.sqr(e.Gy),o(e.Gx)))throw new Error("bad generator point: equation left != right");function a(m){return pr(m,we,e.n)}function c(m){let{allowedPrivateKeyLengths:u,nByteLength:w,wrapPrivateKey:y,n:v}=e;if(u&&typeof m!="bigint"){if(as(m)&&(m=As(m)),typeof m!="string"||!u.includes(m.length))throw new Error("invalid private key");m=m.padStart(w*2,"0")}let _;try{_=typeof m=="bigint"?m:ns(He("private key",m,w))}catch{throw new Error("invalid private key, expected hex or "+w+" bytes, got "+typeof m)}return y&&(_=Le(_,v)),Rt("private key",_,we,v),_}function l(m){if(!(m instanceof d))throw new Error("ProjectivePoint expected")}let h=ln((m,u)=>{let{px:w,py:y,pz:v}=m;if(t.eql(v,t.ONE))return{x:w,y};let _=m.is0();u==null&&(u=_?t.ONE:t.inv(v));let O=t.mul(w,u),P=t.mul(y,u),N=t.mul(v,u);if(_)return{x:t.ZERO,y:t.ZERO};if(!t.eql(N,t.ONE))throw new Error("invZ was invalid");return{x:O,y:P}}),p=ln(m=>{if(m.is0()){if(e.allowInfinityPoint&&!t.is0(m.py))return;throw new Error("bad point: ZERO")}let{x:u,y:w}=m.toAffine();if(!t.isValid(u)||!t.isValid(w))throw new Error("bad point: x or y not FE");let y=t.sqr(w),v=o(u);if(!t.eql(y,v))throw new Error("bad point: equation left != right");if(!m.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});class d{constructor(u,w,y){if(this.px=u,this.py=w,this.pz=y,u==null||!t.isValid(u))throw new Error("x required");if(w==null||!t.isValid(w))throw new Error("y required");if(y==null||!t.isValid(y))throw new Error("z required");Object.freeze(this)}static fromAffine(u){let{x:w,y}=u||{};if(!u||!t.isValid(w)||!t.isValid(y))throw new Error("invalid affine point");if(u instanceof d)throw new Error("projective point not allowed");let v=_=>t.eql(_,t.ZERO);return v(w)&&v(y)?d.ZERO:new d(w,y,t.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(u){let w=t.invertBatch(u.map(y=>y.pz));return u.map((y,v)=>y.toAffine(w[v])).map(d.fromAffine)}static fromHex(u){let w=d.fromAffine(n(He("pointHex",u)));return w.assertValidity(),w}static fromPrivateKey(u){return d.BASE.multiply(c(u))}static msm(u,w){return iu(d,i,u,w)}_setWindowSize(u){f.setWindowSize(this,u)}assertValidity(){p(this)}hasEvenY(){let{y:u}=this.toAffine();if(t.isOdd)return!t.isOdd(u);throw new Error("Field doesn't support isOdd")}equals(u){l(u);let{px:w,py:y,pz:v}=this,{px:_,py:O,pz:P}=u,N=t.eql(t.mul(w,P),t.mul(_,v)),x=t.eql(t.mul(y,P),t.mul(O,v));return N&&x}negate(){return new d(this.px,t.neg(this.py),this.pz)}double(){let{a:u,b:w}=e,y=t.mul(w,ic),{px:v,py:_,pz:O}=this,P=t.ZERO,N=t.ZERO,x=t.ZERO,b=t.mul(v,v),j=t.mul(_,_),U=t.mul(O,O),F=t.mul(v,_);return F=t.add(F,F),x=t.mul(v,O),x=t.add(x,x),P=t.mul(u,x),N=t.mul(y,U),N=t.add(P,N),P=t.sub(j,N),N=t.add(j,N),N=t.mul(P,N),P=t.mul(F,P),x=t.mul(y,x),U=t.mul(u,U),F=t.sub(b,U),F=t.mul(u,F),F=t.add(F,x),x=t.add(b,b),b=t.add(x,b),b=t.add(b,U),b=t.mul(b,F),N=t.add(N,b),U=t.mul(_,O),U=t.add(U,U),b=t.mul(U,F),P=t.sub(P,b),x=t.mul(U,j),x=t.add(x,x),x=t.add(x,x),new d(P,N,x)}add(u){l(u);let{px:w,py:y,pz:v}=this,{px:_,py:O,pz:P}=u,N=t.ZERO,x=t.ZERO,b=t.ZERO,j=e.a,U=t.mul(e.b,ic),F=t.mul(w,_),B=t.mul(y,O),I=t.mul(v,P),T=t.add(w,y),S=t.add(_,O);T=t.mul(T,S),S=t.add(F,B),T=t.sub(T,S),S=t.add(w,v);let k=t.add(_,P);return S=t.mul(S,k),k=t.add(F,I),S=t.sub(S,k),k=t.add(y,v),N=t.add(O,P),k=t.mul(k,N),N=t.add(B,I),k=t.sub(k,N),b=t.mul(j,S),N=t.mul(U,I),b=t.add(N,b),N=t.sub(B,b),b=t.add(B,b),x=t.mul(N,b),B=t.add(F,F),B=t.add(B,F),I=t.mul(j,I),S=t.mul(U,S),B=t.add(B,I),I=t.sub(F,I),I=t.mul(j,I),S=t.add(S,I),F=t.mul(B,S),x=t.add(x,F),F=t.mul(k,S),N=t.mul(T,N),N=t.sub(N,F),F=t.mul(T,B),b=t.mul(k,b),b=t.add(b,F),new d(N,x,b)}subtract(u){return this.add(u.negate())}is0(){return this.equals(d.ZERO)}wNAF(u){return f.wNAFCached(this,u,d.normalizeZ)}multiplyUnsafe(u){let{endo:w,n:y}=e;Rt("scalar",u,Ot,y);let v=d.ZERO;if(u===Ot)return v;if(this.is0()||u===we)return this;if(!w||f.hasPrecomputes(this))return f.wNAFCachedUnsafe(this,u,d.normalizeZ);let{k1neg:_,k1:O,k2neg:P,k2:N}=w.splitScalar(u),x=v,b=v,j=this;for(;O>Ot||N>Ot;)O&we&&(x=x.add(j)),N&we&&(b=b.add(j)),j=j.double(),O>>=we,N>>=we;return _&&(x=x.negate()),P&&(b=b.negate()),b=new d(t.mul(b.px,w.beta),b.py,b.pz),x.add(b)}multiply(u){let{endo:w,n:y}=e;Rt("scalar",u,we,y);let v,_;if(w){let{k1neg:O,k1:P,k2neg:N,k2:x}=w.splitScalar(u),{p:b,f:j}=this.wNAF(P),{p:U,f:F}=this.wNAF(x);b=f.constTimeNegate(O,b),U=f.constTimeNegate(N,U),U=new d(t.mul(U.px,w.beta),U.py,U.pz),v=b.add(U),_=j.add(F)}else{let{p:O,f:P}=this.wNAF(u);v=O,_=P}return d.normalizeZ([v,_])[0]}multiplyAndAddUnsafe(u,w,y){let v=d.BASE,_=(P,N)=>N===Ot||N===we||!P.equals(v)?P.multiplyUnsafe(N):P.multiply(N),O=_(this,w).add(_(u,y));return O.is0()?void 0:O}toAffine(u){return h(this,u)}isTorsionFree(){let{h:u,isTorsionFree:w}=e;if(u===we)return!0;if(w)return w(d,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){let{h:u,clearCofactor:w}=e;return u===we?this:w?w(d,this):this.multiplyUnsafe(e.h)}toRawBytes(u=!0){return Ps("isCompressed",u),this.assertValidity(),r(d,this,u)}toHex(u=!0){return Ps("isCompressed",u),As(this.toRawBytes(u))}}d.BASE=new d(e.Gx,e.Gy,t.ONE),d.ZERO=new d(t.ZERO,t.ONE,t.ZERO);let g=e.nBitLength,f=su(d,e.endo?Math.ceil(g/2):g);return{CURVE:e,ProjectivePoint:d,normPrivateKeyToScalar:c,weierstrassEquation:o,isWithinCurveOrder:a}}function fu(s){let e=Kc(s);return Os(e,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...e})}function mu(s){let e=fu(s),{Fp:t,n:i}=e,r=t.BYTES+1,n=2*t.BYTES+1;function o(I){return Le(I,i)}function a(I){return pn(I,i)}let{ProjectivePoint:c,normPrivateKeyToScalar:l,weierstrassEquation:h,isWithinCurveOrder:p}=gu({...e,toBytes(I,T,S){let k=T.toAffine(),D=t.toBytes(k.x),A=di;return Ps("isCompressed",S),S?A(Uint8Array.from([T.hasEvenY()?2:3]),D):A(Uint8Array.from([4]),D,t.toBytes(k.y))},fromBytes(I){let T=I.length,S=I[0],k=I.subarray(1);if(T===r&&(S===2||S===3)){let D=ns(k);if(!pr(D,we,t.ORDER))throw new Error("Point is not on curve");let A=h(D),$;try{$=t.sqrt(A)}catch(V){let ie=V instanceof Error?": "+V.message:"";throw new Error("Point is not on curve"+ie)}let M=($&we)===we;return(S&1)===1!==M&&($=t.neg($)),{x:D,y:$}}else if(T===n&&S===4){let D=t.fromBytes(k.subarray(0,t.BYTES)),A=t.fromBytes(k.subarray(t.BYTES,2*t.BYTES));return{x:D,y:A}}else{let D=r,A=n;throw new Error("invalid Point, expected length of "+D+", or uncompressed "+A+", got "+T)}}}),d=I=>As(Ss(I,e.nByteLength));function g(I){let T=i>>we;return I>T}function f(I){return g(I)?o(-I):I}let m=(I,T,S)=>ns(I.slice(T,S));class u{constructor(T,S,k){this.r=T,this.s=S,this.recovery=k,this.assertValidity()}static fromCompact(T){let S=e.nByteLength;return T=He("compactSignature",T,S*2),new u(m(T,0,S),m(T,S,2*S))}static fromDER(T){let{r:S,s:k}=Tt.toSig(He("DER",T));return new u(S,k)}assertValidity(){Rt("r",this.r,we,i),Rt("s",this.s,we,i)}addRecoveryBit(T){return new u(this.r,this.s,T)}recoverPublicKey(T){let{r:S,s:k,recovery:D}=this,A=P(He("msgHash",T));if(D==null||![0,1,2,3].includes(D))throw new Error("recovery id invalid");let $=D===2||D===3?S+e.n:S;if($>=t.ORDER)throw new Error("recovery id 2 or 3 invalid");let M=D&1?"03":"02",V=c.fromHex(M+d($)),ie=a($),Q=o(-A*ie),pe=o(k*ie),ye=c.BASE.multiplyAndAddUnsafe(V,Q,pe);if(!ye)throw new Error("point at infinify");return ye.assertValidity(),ye}hasHighS(){return g(this.s)}normalizeS(){return this.hasHighS()?new u(this.r,o(-this.s),this.recovery):this}toDERRawBytes(){return Ns(this.toDERHex())}toDERHex(){return Tt.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return Ns(this.toCompactHex())}toCompactHex(){return d(this.r)+d(this.s)}}let w={isValidPrivateKey(I){try{return l(I),!0}catch{return!1}},normPrivateKeyToScalar:l,randomPrivateKey:()=>{let I=Vc(e.n);return Qd(e.randomBytes(I),e.n)},precompute(I=8,T=c.BASE){return T._setWindowSize(I),T.multiply(BigInt(3)),T}};function y(I,T=!0){return c.fromPrivateKey(I).toRawBytes(T)}function v(I){let T=as(I),S=typeof I=="string",k=(T||S)&&I.length;return T?k===r||k===n:S?k===2*r||k===2*n:I instanceof c}function _(I,T,S=!0){if(v(I))throw new Error("first arg must be private key");if(!v(T))throw new Error("second arg must be public key");return c.fromHex(T).multiply(l(I)).toRawBytes(S)}let O=e.bits2int||function(I){if(I.length>8192)throw new Error("input is too large");let T=ns(I),S=I.length*8-e.nBitLength;return S>0?T>>BigInt(S):T},P=e.bits2int_modN||function(I){return o(O(I))},N=Nn(e.nBitLength);function x(I){return Rt("num < 2^"+e.nBitLength,I,Ot,N),Ss(I,e.nByteLength)}function b(I,T,S=j){if(["recovered","canonical"].some(ue=>ue in S))throw new Error("sign() legacy options not supported");let{hash:k,randomBytes:D}=e,{lowS:A,prehash:$,extraEntropy:M}=S;A==null&&(A=!0),I=He("msgHash",I),sc(S),$&&(I=He("prehashed msgHash",k(I)));let V=P(I),ie=l(T),Q=[x(ie),x(V)];if(M!=null&&M!==!1){let ue=M===!0?D(t.BYTES):M;Q.push(He("extraEntropy",ue))}let pe=di(...Q),ye=V;function Se(ue){let ge=O(ue);if(!p(ge))return;let Xt=a(ge),_t=c.BASE.multiply(ge).toAffine(),pt=o(_t.x);if(pt===Ot)return;let Pt=o(Xt*o(ye+pt*ie));if(Pt===Ot)return;let us=(_t.x===pt?0:2)|Number(_t.y&we),xi=Pt;return A&&g(Pt)&&(xi=f(Pt),us^=1),new u(pt,xi,us)}return{seed:pe,k2sig:Se}}let j={lowS:e.lowS,prehash:!1},U={lowS:e.lowS,prehash:!1};function F(I,T,S=j){let{seed:k,k2sig:D}=b(I,T,S),A=e;return qc(A.hash.outputLen,A.nByteLength,A.hmac)(k,D)}c.BASE._setWindowSize(8);function B(I,T,S,k=U){let D=I;T=He("msgHash",T),S=He("publicKey",S);let{lowS:A,prehash:$,format:M}=k;if(sc(k),"strict"in k)throw new Error("options.strict was renamed to lowS");if(M!==void 0&&M!=="compact"&&M!=="der")throw new Error("format must be compact or der");let V=typeof D=="string"||as(D),ie=!V&&!M&&typeof D=="object"&&D!==null&&typeof D.r=="bigint"&&typeof D.s=="bigint";if(!V&&!ie)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");let Q,pe;try{if(ie&&(Q=new u(D.r,D.s)),V){try{M!=="compact"&&(Q=u.fromDER(D))}catch(Pt){if(!(Pt instanceof Tt.Err))throw Pt}!Q&&M!=="der"&&(Q=u.fromCompact(D))}pe=c.fromHex(S)}catch{return!1}if(!Q||A&&Q.hasHighS())return!1;$&&(T=e.hash(T));let{r:ye,s:Se}=Q,ue=P(T),ge=a(Se),Xt=o(ue*ge),_t=o(ye*ge),pt=c.BASE.multiplyAndAddUnsafe(pe,Xt,_t)?.toAffine();return pt?o(pt.x)===ye:!1}return{CURVE:e,getPublicKey:y,getSharedSecret:_,sign:F,verify:B,ProjectivePoint:c,Signature:u,utils:w}}function yu(s){return{hash:s,hmac:(e,...t)=>ar(s,e,Tp(...t)),randomBytes:Ts}}function wu(s,e){let t=i=>mu({...s,...yu(i)});return{...t(e),create:t}}var Wc=Bc(BigInt("0xffffffff00000001000000000000000000000000ffffffffffffffffffffffff")),vu=Wc.create(BigInt("-3")),bu=BigInt("0x5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63bce3c3e27d2604b"),Eu=wu({a:vu,b:bu,Fp:Wc,n:BigInt("0xffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551"),Gx:BigInt("0x6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296"),Gy:BigInt("0x4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececbb6406837bf51f5"),h:BigInt(1),lowS:!1},vi),Gc="base10",Oe="base16",Ke="base64pad",Ft="base64url",Ei="utf8",Yc=0,at=1,Rs=2,Iu=0,rc=1,ai=12,Sn=32;function Jc(){let s=un.utils.randomPrivateKey(),e=un.getPublicKey(s);return{privateKey:Te(s,Oe),publicKey:Te(e,Oe)}}function dr(){let s=Ts(Sn);return Te(s,Oe)}function Xc(s,e){let t=un.getSharedSecret($e(s,Oe),$e(e,Oe)),i=Rd(vi,t,void 0,void 0,Sn);return Te(i,Oe)}function xs(s){let e=vi($e(s,Oe));return Te(e,Oe)}function Ze(s){let e=vi($e(s,Ei));return Te(e,Oe)}function Zc(s){return $e(`${s}`,Gc)}function zt(s){return Number(Te(s,Gc))}function Qc(s){return s.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function el(s){let e=s.replace(/-/g,"+").replace(/_/g,"/"),t=(4-e.length%4)%4;return e+"=".repeat(t)}function tl(s){let e=Zc(typeof s.type<"u"?s.type:Yc);if(zt(e)===at&&typeof s.senderPublicKey>"u")throw new Error("Missing sender public key for type 1 envelope");let t=typeof s.senderPublicKey<"u"?$e(s.senderPublicKey,Oe):void 0,i=typeof s.iv<"u"?$e(s.iv,Oe):Ts(ai),r=$e(s.symKey,Oe),n=Fc(r,i).encrypt($e(s.message,Ei)),o=nl({type:e,sealed:n,iv:i,senderPublicKey:t});return s.encoding===Ft?Qc(o):o}function sl(s){let e=$e(s.symKey,Oe),{sealed:t,iv:i}=ks({encoded:s.encoded,encoding:s.encoding}),r=Fc(e,i).decrypt(t);if(r===null)throw new Error("Failed to decrypt");return Te(r,Ei)}function il(s,e){let t=Zc(Rs),i=Ts(ai),r=$e(s,Ei),n=nl({type:t,sealed:r,iv:i});return e===Ft?Qc(n):n}function rl(s,e){let{sealed:t}=ks({encoded:s,encoding:e});return Te(t,Ei)}function nl(s){if(zt(s.type)===Rs)return Te(gs([s.type,s.sealed]),Ke);if(zt(s.type)===at){if(typeof s.senderPublicKey>"u")throw new Error("Missing sender public key for type 1 envelope");return Te(gs([s.type,s.senderPublicKey,s.iv,s.sealed]),Ke)}return Te(gs([s.type,s.iv,s.sealed]),Ke)}function ks(s){let e=(s.encoding||Ke)===Ft?el(s.encoded):s.encoded,t=$e(e,Ke),i=t.slice(Iu,rc),r=rc;if(zt(i)===at){let c=r+Sn,l=c+ai,h=t.slice(r,c),p=t.slice(c,l),d=t.slice(l);return{type:i,sealed:d,iv:p,senderPublicKey:h}}if(zt(i)===Rs){let c=t.slice(r),l=Ts(ai);return{type:i,sealed:c,iv:l}}let n=r+ai,o=t.slice(r,n),a=t.slice(n);return{type:i,sealed:a,iv:o}}function ol(s,e){let t=ks({encoded:s,encoding:e?.encoding});return Tn({type:zt(t.type),senderPublicKey:typeof t.senderPublicKey<"u"?Te(t.senderPublicKey,Oe):void 0,receiverPublicKey:e?.receiverPublicKey})}function Tn(s){let e=s?.type||Yc;if(e===at){if(typeof s?.senderPublicKey>"u")throw new Error("missing sender public key");if(typeof s?.receiverPublicKey>"u")throw new Error("missing receiver public key")}return{type:e,senderPublicKey:s?.senderPublicKey,receiverPublicKey:s?.receiverPublicKey}}function On(s){return s.type===at&&typeof s.senderPublicKey=="string"&&typeof s.receiverPublicKey=="string"}function Rn(s){return s.type===Rs}function Cu(s){let e=Buffer.from(s.x,"base64"),t=Buffer.from(s.y,"base64");return gs([new Uint8Array([4]),e,t])}function al(s,e){let[t,i,r]=s.split("."),n=Buffer.from(el(r),"base64");if(n.length!==64)throw new Error("Invalid signature length");let o=n.slice(0,32),a=n.slice(32,64),c=`${t}.${i}`,l=vi(c),h=Cu(e);if(!Eu.verify(gs([o,a]),l,h))throw new Error("Invalid signature");return ti(s).payload}var _u="irn";function Ii(s){return s?.relay||{protocol:_u}}function Us(s){let e=ca[s];if(typeof e>"u")throw new Error(`Relay Protocol not supported: ${s}`);return e}function Pu(s,e="-"){let t={},i="relay"+e;return Object.keys(s).forEach(r=>{if(r.startsWith(i)){let n=r.replace(i,""),o=s[r];t[n]=o}}),t}function xn(s){if(!s.includes("wc:")){let l=Ec(s);l!=null&&l.includes("wc:")&&(s=l)}s=s.includes("wc://")?s.replace("wc://",""):s,s=s.includes("wc:")?s.replace("wc:",""):s;let e=s.indexOf(":"),t=s.indexOf("?")!==-1?s.indexOf("?"):void 0,i=s.substring(0,e),r=s.substring(e+1,t).split("@"),n=typeof t<"u"?s.substring(t):"",o=new URLSearchParams(n),a={};o.forEach((l,h)=>{a[h]=l});let c=typeof a.methods=="string"?a.methods.split(","):void 0;return{protocol:i,topic:Au(r[0]),version:parseInt(r[1],10),symKey:a.symKey,relay:Pu(a),methods:c,expiryTimestamp:a.expiryTimestamp?parseInt(a.expiryTimestamp,10):void 0}}function Au(s){return s.startsWith("//")?s.substring(2):s}function Nu(s,e="-"){let t="relay",i={};return Object.keys(s).forEach(r=>{let n=r,o=t+e+n;s[n]&&(i[o]=s[n])}),i}function kn(s){let e=new URLSearchParams,t=Nu(s.relay);Object.keys(t).sort().forEach(r=>{e.set(r,t[r])}),e.set("symKey",s.symKey),s.expiryTimestamp&&e.set("expiryTimestamp",s.expiryTimestamp.toString()),s.methods&&e.set("methods",s.methods.join(","));let i=e.toString();return`${s.protocol}:${s.topic}@${s.version}?${i}`}function Ci(s,e,t){return`${s}?wc_ev=${t}&topic=${e}`}var Su=Object.defineProperty,Tu=Object.defineProperties,Ou=Object.getOwnPropertyDescriptors,nc=Object.getOwnPropertySymbols,Ru=Object.prototype.hasOwnProperty,xu=Object.prototype.propertyIsEnumerable,oc=(s,e,t)=>e in s?Su(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ku=(s,e)=>{for(var t in e||(e={}))Ru.call(e,t)&&oc(s,t,e[t]);if(nc)for(var t of nc(e))xu.call(e,t)&&oc(s,t,e[t]);return s},Uu=(s,e)=>Tu(s,Ou(e));function Ds(s){let e=[];return s.forEach(t=>{let[i,r]=t.split(":");e.push(`${i}:${r}`)}),e}function Du(s){let e=[];return Object.values(s).forEach(t=>{e.push(...Ds(t.accounts))}),e}function Fu(s,e){let t=[];return Object.values(s).forEach(i=>{Ds(i.accounts).includes(e)&&t.push(...i.methods)}),t}function Lu(s,e){let t=[];return Object.values(s).forEach(i=>{Ds(i.accounts).includes(e)&&t.push(...i.events)}),t}function _i(s){return s.includes(":")}function ls(s){return _i(s)?s.split(":")[0]:s}function ac(s){var e,t,i;let r={};if(!wt(s))return r;for(let[n,o]of Object.entries(s)){let a=_i(n)?[n]:o.chains,c=o.methods||[],l=o.events||[],h=ls(n);r[h]=Uu(ku({},r[h]),{chains:nt(a,(e=r[h])==null?void 0:e.chains),methods:nt(c,(t=r[h])==null?void 0:t.methods),events:nt(l,(i=r[h])==null?void 0:i.events)})}return r}function qu(s){let e={};return s?.forEach(t=>{var i;let[r,n]=t.split(":");e[r]||(e[r]={accounts:[],chains:[],events:[],methods:[]}),e[r].accounts.push(t),(i=e[r].chains)==null||i.push(`${r}:${n}`)}),e}function Un(s,e){e=e.map(i=>i.replace("did:pkh:",""));let t=qu(e);for(let[i,r]of Object.entries(t))r.methods?r.methods=nt(r.methods,s):r.methods=s,r.events=["chainChanged","accountsChanged"];return t}function cl(s,e){var t,i,r,n,o,a;let c=ac(s),l=ac(e),h={},p=Object.keys(c).concat(Object.keys(l));for(let d of p)h[d]={chains:nt((t=c[d])==null?void 0:t.chains,(i=l[d])==null?void 0:i.chains),methods:nt((r=c[d])==null?void 0:r.methods,(n=l[d])==null?void 0:n.methods),events:nt((o=c[d])==null?void 0:o.events,(a=l[d])==null?void 0:a.events)};return h}var ju={INVALID_METHOD:{message:"Invalid method.",code:1001},INVALID_EVENT:{message:"Invalid event.",code:1002},INVALID_UPDATE_REQUEST:{message:"Invalid update request.",code:1003},INVALID_EXTEND_REQUEST:{message:"Invalid extend request.",code:1004},INVALID_SESSION_SETTLE_REQUEST:{message:"Invalid session settle request.",code:1005},UNAUTHORIZED_METHOD:{message:"Unauthorized method.",code:3001},UNAUTHORIZED_EVENT:{message:"Unauthorized event.",code:3002},UNAUTHORIZED_UPDATE_REQUEST:{message:"Unauthorized update request.",code:3003},UNAUTHORIZED_EXTEND_REQUEST:{message:"Unauthorized extend request.",code:3004},USER_REJECTED:{message:"User rejected.",code:5e3},USER_REJECTED_CHAINS:{message:"User rejected chains.",code:5001},USER_REJECTED_METHODS:{message:"User rejected methods.",code:5002},USER_REJECTED_EVENTS:{message:"User rejected events.",code:5003},UNSUPPORTED_CHAINS:{message:"Unsupported chains.",code:5100},UNSUPPORTED_METHODS:{message:"Unsupported methods.",code:5101},UNSUPPORTED_EVENTS:{message:"Unsupported events.",code:5102},UNSUPPORTED_ACCOUNTS:{message:"Unsupported accounts.",code:5103},UNSUPPORTED_NAMESPACE_KEY:{message:"Unsupported namespace key.",code:5104},USER_DISCONNECTED:{message:"User disconnected.",code:6e3},SESSION_SETTLEMENT_FAILED:{message:"Session settlement failed.",code:7e3},WC_METHOD_UNSUPPORTED:{message:"Unsupported wc_ method.",code:10001}},$u={NOT_INITIALIZED:{message:"Not initialized.",code:1},NO_MATCHING_KEY:{message:"No matching key.",code:2},RESTORE_WILL_OVERRIDE:{message:"Restore will override.",code:3},RESUBSCRIBED:{message:"Resubscribed.",code:4},MISSING_OR_INVALID:{message:"Missing or invalid.",code:5},EXPIRED:{message:"Expired.",code:6},UNKNOWN_TYPE:{message:"Unknown type.",code:7},MISMATCHED_TOPIC:{message:"Mismatched topic.",code:8},NON_CONFORMING_NAMESPACES:{message:"Non conforming namespaces.",code:9}};function R(s,e){let{message:t,code:i}=$u[s];return{message:e?`${t} ${e}`:t,code:i}}function Z(s,e){let{message:t,code:i}=ju[s];return{message:e?`${t} ${e}`:t,code:i}}function yt(s,e){return Array.isArray(s)?typeof e<"u"&&s.length?s.every(e):!0:!1}function wt(s){return Object.getPrototypeOf(s)===Object.prototype&&Object.keys(s).length}function fe(s){return typeof s>"u"}function ce(s,e){return e&&fe(s)?!0:typeof s=="string"&&!!s.trim().length}function Dn(s,e){return e&&fe(s)?!0:typeof s=="number"&&!isNaN(s)}function ll(s,e){let{requiredNamespaces:t}=e,i=Object.keys(s.namespaces),r=Object.keys(t),n=!0;return rs(r,i)?(i.forEach(o=>{let{accounts:a,methods:c,events:l}=s.namespaces[o],h=Ds(a),p=t[o];(!rs(pc(o,p),h)||!rs(p.methods,c)||!rs(p.events,l))&&(n=!1)}),n):!1}function sr(s){return ce(s,!1)&&s.includes(":")?s.split(":").length===2:!1}function Bu(s){if(ce(s,!1)&&s.includes(":")){let e=s.split(":");if(e.length===3){let t=e[0]+":"+e[1];return!!e[2]&&sr(t)}}return!1}function hl(s){function e(t){try{return typeof new URL(t)<"u"}catch{return!1}}try{if(ce(s,!1)){if(e(s))return!0;let t=Ec(s);return e(t)}}catch{}return!1}function pl(s){var e;return(e=s?.proposer)==null?void 0:e.publicKey}function dl(s){return s?.topic}function ul(s,e){let t=null;return ce(s?.publicKey,!1)||(t=R("MISSING_OR_INVALID",`${e} controller public key should be a string`)),t}function cc(s){let e=!0;return yt(s)?s.length&&(e=s.every(t=>ce(t,!1))):e=!1,e}function Mu(s,e,t){let i=null;return yt(e)&&e.length?e.forEach(r=>{i||sr(r)||(i=Z("UNSUPPORTED_CHAINS",`${t}, chain ${r} should be a string and conform to "namespace:chainId" format`))}):sr(s)||(i=Z("UNSUPPORTED_CHAINS",`${t}, chains must be defined as "namespace:chainId" e.g. "eip155:1": {...} in the namespace key OR as an array of CAIP-2 chainIds e.g. eip155: { chains: ["eip155:1", "eip155:5"] }`)),i}function Vu(s,e,t){let i=null;return Object.entries(s).forEach(([r,n])=>{if(i)return;let o=Mu(r,pc(r,n),`${e} ${t}`);o&&(i=o)}),i}function Hu(s,e){let t=null;return yt(s)?s.forEach(i=>{t||Bu(i)||(t=Z("UNSUPPORTED_ACCOUNTS",`${e}, account ${i} should be a string and conform to "namespace:chainId:address" format`))}):t=Z("UNSUPPORTED_ACCOUNTS",`${e}, accounts should be an array of strings conforming to "namespace:chainId:address" format`),t}function zu(s,e){let t=null;return Object.values(s).forEach(i=>{if(t)return;let r=Hu(i?.accounts,`${e} namespace`);r&&(t=r)}),t}function Ku(s,e){let t=null;return cc(s?.methods)?cc(s?.events)||(t=Z("UNSUPPORTED_EVENTS",`${e}, events should be an array of strings or empty array for no events`)):t=Z("UNSUPPORTED_METHODS",`${e}, methods should be an array of strings or empty array for no methods`),t}function gl(s,e){let t=null;return Object.values(s).forEach(i=>{if(t)return;let r=Ku(i,`${e}, namespace`);r&&(t=r)}),t}function fl(s,e,t){let i=null;if(s&&wt(s)){let r=gl(s,e);r&&(i=r);let n=Vu(s,e,t);n&&(i=n)}else i=R("MISSING_OR_INVALID",`${e}, ${t} should be an object with data`);return i}function ur(s,e){let t=null;if(s&&wt(s)){let i=gl(s,e);i&&(t=i);let r=zu(s,e);r&&(t=r)}else t=R("MISSING_OR_INVALID",`${e}, namespaces should be an object with data`);return t}function Fn(s){return ce(s.protocol,!0)}function ml(s,e){let t=!1;return e&&!s?t=!0:s&&yt(s)&&s.length&&s.forEach(i=>{t=Fn(i)}),t}function yl(s){return typeof s=="number"}function Re(s){return typeof s<"u"&&typeof s!==null}function wl(s){return!(!s||typeof s!="object"||!s.code||!Dn(s.code,!1)||!s.message||!ce(s.message,!1))}function vl(s){return!(fe(s)||!ce(s.method,!1))}function bl(s){return!(fe(s)||fe(s.result)&&fe(s.error)||!Dn(s.id,!1)||!ce(s.jsonrpc,!1))}function El(s){return!(fe(s)||!ce(s.name,!1))}function Ln(s,e){return!(!sr(e)||!Du(s).includes(e))}function Il(s,e,t){return ce(t,!1)?Fu(s,e).includes(t):!1}function Cl(s,e,t){return ce(t,!1)?Lu(s,e).includes(t):!1}function qn(s,e,t){let i=null,r=Wu(s),n=Gu(e),o=Object.keys(r),a=Object.keys(n),c=lc(Object.keys(s)),l=lc(Object.keys(e)),h=c.filter(p=>!l.includes(p));return h.length&&(i=R("NON_CONFORMING_NAMESPACES",`${t} namespaces keys don't satisfy requiredNamespaces.
      Required: ${h.toString()}
      Received: ${Object.keys(e).toString()}`)),rs(o,a)||(i=R("NON_CONFORMING_NAMESPACES",`${t} namespaces chains don't satisfy required namespaces.
      Required: ${o.toString()}
      Approved: ${a.toString()}`)),Object.keys(e).forEach(p=>{if(!p.includes(":")||i)return;let d=Ds(e[p].accounts);d.includes(p)||(i=R("NON_CONFORMING_NAMESPACES",`${t} namespaces accounts don't satisfy namespace accounts for ${p}
        Required: ${p}
        Approved: ${d.toString()}`))}),o.forEach(p=>{i||(rs(r[p].methods,n[p].methods)?rs(r[p].events,n[p].events)||(i=R("NON_CONFORMING_NAMESPACES",`${t} namespaces events don't satisfy namespace events for ${p}`)):i=R("NON_CONFORMING_NAMESPACES",`${t} namespaces methods don't satisfy namespace methods for ${p}`))}),i}function Wu(s){let e={};return Object.keys(s).forEach(t=>{var i;t.includes(":")?e[t]=s[t]:(i=s[t].chains)==null||i.forEach(r=>{e[r]={methods:s[t].methods,events:s[t].events}})}),e}function lc(s){return[...new Set(s.map(e=>e.includes(":")?e.split(":")[0]:e))]}function Gu(s){let e={};return Object.keys(s).forEach(t=>{t.includes(":")?e[t]=s[t]:Ds(s[t].accounts)?.forEach(r=>{e[r]={accounts:s[t].accounts.filter(n=>n.includes(`${r}:`)),methods:s[t].methods,events:s[t].events}})}),e}function _l(s,e){return Dn(s,!1)&&s<=e.max&&s>=e.min}function jn(){let s=gi();return new Promise(e=>{switch(s){case qe.browser:e(Yu());break;case qe.reactNative:e(Ju());break;case qe.node:e(Xu());break;default:e(!0)}})}function Yu(){return cs()&&navigator?.onLine}async function Ju(){return kt()&&typeof global<"u"&&global!=null&&global.NetInfo?(await(global==null?void 0:global.NetInfo.fetch()))?.isConnected:!0}function Xu(){return!0}function Pl(s){switch(gi()){case qe.browser:Zu(s);break;case qe.reactNative:Qu(s);break;case qe.node:break}}function Zu(s){!kt()&&cs()&&(window.addEventListener("online",()=>s(!0)),window.addEventListener("offline",()=>s(!1)))}function Qu(s){kt()&&typeof global<"u"&&global!=null&&global.NetInfo&&global?.NetInfo.addEventListener(e=>s(e?.isConnected))}function Al(){var s;return cs()&&(0,ot.getDocument)()?((s=(0,ot.getDocument)())==null?void 0:s.visibilityState)==="visible":!0}var en={},Kt=class{static get(e){return en[e]}static set(e,t){en[e]=t}static delete(e){delete en[e]}};var Xl=dt(ra()),Zl="wc",Ql=2,mr="core",Et=`${Zl}@2:${mr}:`,eg={name:mr,logger:"error"},tg={database:":memory:"},sg="crypto",Nl="client_ed25519_seed",ig=q.ONE_DAY,rg="keychain",ng="0.3",og="messages",ag="0.3",Sl=q.SIX_HOURS,cg="publisher",Eo="irn",lg="error",eh="wss://relay.walletconnect.org",hg="relayer",me={message:"relayer_message",message_ack:"relayer_message_ack",connect:"relayer_connect",disconnect:"relayer_disconnect",error:"relayer_error",connection_stalled:"relayer_connection_stalled",transport_closed:"relayer_transport_closed",publish:"relayer_publish"},pg="_subscription",Qe={payload:"payload",connect:"connect",disconnect:"disconnect",error:"error"},dg=.1;var Hn="2.21.0";var ne={link_mode:"link_mode",relay:"relay"},fr={inbound:"inbound",outbound:"outbound"},ug="0.3",gg="WALLETCONNECT_CLIENT_ID",Tl="WALLETCONNECT_LINK_MODE_APPS",Ge={created:"subscription_created",deleted:"subscription_deleted",expired:"subscription_expired",disabled:"subscription_disabled",sync:"subscription_sync",resubscribed:"subscription_resubscribed"};var fg="subscription",mg="0.3",Dv=q.FIVE_SECONDS*1e3,yg="pairing",wg="0.3";var Pi={wc_pairingDelete:{req:{ttl:q.ONE_DAY,prompt:!1,tag:1e3},res:{ttl:q.ONE_DAY,prompt:!1,tag:1001}},wc_pairingPing:{req:{ttl:q.THIRTY_SECONDS,prompt:!1,tag:1002},res:{ttl:q.THIRTY_SECONDS,prompt:!1,tag:1003}},unregistered_method:{req:{ttl:q.ONE_DAY,prompt:!1,tag:0},res:{ttl:q.ONE_DAY,prompt:!1,tag:0}}},Gt={create:"pairing_create",expire:"pairing_expire",delete:"pairing_delete",ping:"pairing_ping"},ct={created:"history_created",updated:"history_updated",deleted:"history_deleted",sync:"history_sync"},vg="history",bg="0.3",Eg="expirer",Ye={created:"expirer_created",deleted:"expirer_deleted",expired:"expirer_expired",sync:"expirer_sync"},Ig="0.3";var Cg="verify-api",_g="https://verify.walletconnect.com",th="https://verify.walletconnect.org",Ls=th,Pg=`${Ls}/v3`,Ag=[_g,th],Ng="echo",Sg="https://echo.walletconnect.com";var ht={pairing_started:"pairing_started",pairing_uri_validation_success:"pairing_uri_validation_success",pairing_uri_not_expired:"pairing_uri_not_expired",store_new_pairing:"store_new_pairing",subscribing_pairing_topic:"subscribing_pairing_topic",subscribe_pairing_topic_success:"subscribe_pairing_topic_success",existing_pairing:"existing_pairing",pairing_not_expired:"pairing_not_expired",emit_inactive_pairing:"emit_inactive_pairing",emit_session_proposal:"emit_session_proposal",subscribing_to_pairing_topic:"subscribing_to_pairing_topic"},bt={no_wss_connection:"no_wss_connection",no_internet_connection:"no_internet_connection",malformed_pairing_uri:"malformed_pairing_uri",active_pairing_already_exists:"active_pairing_already_exists",subscribe_pairing_topic_failure:"subscribe_pairing_topic_failure",pairing_expired:"pairing_expired",proposal_expired:"proposal_expired",proposal_listener_not_found:"proposal_listener_not_found"},et={session_approve_started:"session_approve_started",proposal_not_expired:"proposal_not_expired",session_namespaces_validation_success:"session_namespaces_validation_success",create_session_topic:"create_session_topic",subscribing_session_topic:"subscribing_session_topic",subscribe_session_topic_success:"subscribe_session_topic_success",publishing_session_approve:"publishing_session_approve",session_approve_publish_success:"session_approve_publish_success",store_session:"store_session",publishing_session_settle:"publishing_session_settle",session_settle_publish_success:"session_settle_publish_success"},Yt={no_internet_connection:"no_internet_connection",no_wss_connection:"no_wss_connection",proposal_expired:"proposal_expired",subscribe_session_topic_failure:"subscribe_session_topic_failure",session_approve_publish_failure:"session_approve_publish_failure",session_settle_publish_failure:"session_settle_publish_failure",session_approve_namespace_validation_failure:"session_approve_namespace_validation_failure",proposal_not_found:"proposal_not_found"},Jt={authenticated_session_approve_started:"authenticated_session_approve_started",authenticated_session_not_expired:"authenticated_session_not_expired",chains_caip2_compliant:"chains_caip2_compliant",chains_evm_compliant:"chains_evm_compliant",create_authenticated_session_topic:"create_authenticated_session_topic",cacaos_verified:"cacaos_verified",store_authenticated_session:"store_authenticated_session",subscribing_authenticated_session_topic:"subscribing_authenticated_session_topic",subscribe_authenticated_session_topic_success:"subscribe_authenticated_session_topic_success",publishing_authenticated_session_approve:"publishing_authenticated_session_approve",authenticated_session_approve_publish_success:"authenticated_session_approve_publish_success"},qs={no_internet_connection:"no_internet_connection",no_wss_connection:"no_wss_connection",missing_session_authenticate_request:"missing_session_authenticate_request",session_authenticate_request_expired:"session_authenticate_request_expired",chains_caip2_compliant_failure:"chains_caip2_compliant_failure",chains_evm_compliant_failure:"chains_evm_compliant_failure",invalid_cacao:"invalid_cacao",subscribe_authenticated_session_topic_failure:"subscribe_authenticated_session_topic_failure",authenticated_session_approve_publish_failure:"authenticated_session_approve_publish_failure",authenticated_session_pending_request_not_found:"authenticated_session_pending_request_not_found"},Tg=.1,Og="event-client",Rg=86400,xg="https://pulse.walletconnect.org/batch";function kg(s,e){if(s.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),i=0;i<t.length;i++)t[i]=255;for(var r=0;r<s.length;r++){var n=s.charAt(r),o=n.charCodeAt(0);if(t[o]!==255)throw new TypeError(n+" is ambiguous");t[o]=r}var a=s.length,c=s.charAt(0),l=Math.log(a)/Math.log(256),h=Math.log(256)/Math.log(a);function p(f){if(f instanceof Uint8Array||(ArrayBuffer.isView(f)?f=new Uint8Array(f.buffer,f.byteOffset,f.byteLength):Array.isArray(f)&&(f=Uint8Array.from(f))),!(f instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(f.length===0)return"";for(var m=0,u=0,w=0,y=f.length;w!==y&&f[w]===0;)w++,m++;for(var v=(y-w)*h+1>>>0,_=new Uint8Array(v);w!==y;){for(var O=f[w],P=0,N=v-1;(O!==0||P<u)&&N!==-1;N--,P++)O+=256*_[N]>>>0,_[N]=O%a>>>0,O=O/a>>>0;if(O!==0)throw new Error("Non-zero carry");u=P,w++}for(var x=v-u;x!==v&&_[x]===0;)x++;for(var b=c.repeat(m);x<v;++x)b+=s.charAt(_[x]);return b}function d(f){if(typeof f!="string")throw new TypeError("Expected String");if(f.length===0)return new Uint8Array;var m=0;if(f[m]!==" "){for(var u=0,w=0;f[m]===c;)u++,m++;for(var y=(f.length-m)*l+1>>>0,v=new Uint8Array(y);f[m];){var _=t[f.charCodeAt(m)];if(_===255)return;for(var O=0,P=y-1;(_!==0||O<w)&&P!==-1;P--,O++)_+=a*v[P]>>>0,v[P]=_%256>>>0,_=_/256>>>0;if(_!==0)throw new Error("Non-zero carry");w=O,m++}if(f[m]!==" "){for(var N=y-w;N!==y&&v[N]===0;)N++;for(var x=new Uint8Array(u+(y-N)),b=u;N!==y;)x[b++]=v[N++];return x}}}function g(f){var m=d(f);if(m)return m;throw new Error(`Non-${e} character`)}return{encode:p,decodeUnsafe:d,decode:g}}var Ug=kg,Dg=Ug,sh=s=>{if(s instanceof Uint8Array&&s.constructor.name==="Uint8Array")return s;if(s instanceof ArrayBuffer)return new Uint8Array(s);if(ArrayBuffer.isView(s))return new Uint8Array(s.buffer,s.byteOffset,s.byteLength);throw new Error("Unknown type, must be binary type")},Fg=s=>new TextEncoder().encode(s),Lg=s=>new TextDecoder().decode(s),zn=class{constructor(e,t,i){this.name=e,this.prefix=t,this.baseEncode=i}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},Kn=class{constructor(e,t,i){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=i}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return ih(this,e)}},Wn=class{constructor(e){this.decoders=e}or(e){return ih(this,e)}decode(e){let t=e[0],i=this.decoders[t];if(i)return i.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}},ih=(s,e)=>new Wn({...s.decoders||{[s.prefix]:s},...e.decoders||{[e.prefix]:e}}),Gn=class{constructor(e,t,i,r){this.name=e,this.prefix=t,this.baseEncode=i,this.baseDecode=r,this.encoder=new zn(e,t,i),this.decoder=new Kn(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}},yr=({name:s,prefix:e,encode:t,decode:i})=>new Gn(s,e,t,i),Oi=({prefix:s,name:e,alphabet:t})=>{let{encode:i,decode:r}=Dg(t,e);return yr({prefix:s,name:e,encode:i,decode:n=>sh(r(n))})},qg=(s,e,t,i)=>{let r={};for(let h=0;h<e.length;++h)r[e[h]]=h;let n=s.length;for(;s[n-1]==="=";)--n;let o=new Uint8Array(n*t/8|0),a=0,c=0,l=0;for(let h=0;h<n;++h){let p=r[s[h]];if(p===void 0)throw new SyntaxError(`Non-${i} character`);c=c<<t|p,a+=t,a>=8&&(a-=8,o[l++]=255&c>>a)}if(a>=t||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return o},jg=(s,e,t)=>{let i=e[e.length-1]==="=",r=(1<<t)-1,n="",o=0,a=0;for(let c=0;c<s.length;++c)for(a=a<<8|s[c],o+=8;o>t;)o-=t,n+=e[r&a>>o];if(o&&(n+=e[r&a<<t-o]),i)for(;n.length*t&7;)n+="=";return n},Ne=({name:s,prefix:e,bitsPerChar:t,alphabet:i})=>yr({prefix:e,name:s,encode(r){return jg(r,i,t)},decode(r){return qg(r,i,t,s)}}),$g=yr({prefix:"\0",name:"identity",encode:s=>Lg(s),decode:s=>Fg(s)}),Bg=Object.freeze({__proto__:null,identity:$g}),Mg=Ne({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),Vg=Object.freeze({__proto__:null,base2:Mg}),Hg=Ne({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),zg=Object.freeze({__proto__:null,base8:Hg}),Kg=Oi({prefix:"9",name:"base10",alphabet:"0123456789"}),Wg=Object.freeze({__proto__:null,base10:Kg}),Gg=Ne({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Yg=Ne({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),Jg=Object.freeze({__proto__:null,base16:Gg,base16upper:Yg}),Xg=Ne({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Zg=Ne({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Qg=Ne({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),ef=Ne({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),tf=Ne({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),sf=Ne({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),rf=Ne({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),nf=Ne({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),of=Ne({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),af=Object.freeze({__proto__:null,base32:Xg,base32upper:Zg,base32pad:Qg,base32padupper:ef,base32hex:tf,base32hexupper:sf,base32hexpad:rf,base32hexpadupper:nf,base32z:of}),cf=Oi({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),lf=Oi({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),hf=Object.freeze({__proto__:null,base36:cf,base36upper:lf}),pf=Oi({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),df=Oi({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),uf=Object.freeze({__proto__:null,base58btc:pf,base58flickr:df}),gf=Ne({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),ff=Ne({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),mf=Ne({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),yf=Ne({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),wf=Object.freeze({__proto__:null,base64:gf,base64pad:ff,base64url:mf,base64urlpad:yf}),rh=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),vf=rh.reduce((s,e,t)=>(s[t]=e,s),[]),bf=rh.reduce((s,e,t)=>(s[e.codePointAt(0)]=t,s),[]);function Ef(s){return s.reduce((e,t)=>(e+=vf[t],e),"")}function If(s){let e=[];for(let t of s){let i=bf[t.codePointAt(0)];if(i===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(i)}return new Uint8Array(e)}var Cf=yr({prefix:"\u{1F680}",name:"base256emoji",encode:Ef,decode:If}),_f=Object.freeze({__proto__:null,base256emoji:Cf}),Pf=nh,Ol=128,Af=127,Nf=~Af,Sf=Math.pow(2,31);function nh(s,e,t){e=e||[],t=t||0;for(var i=t;s>=Sf;)e[t++]=s&255|Ol,s/=128;for(;s&Nf;)e[t++]=s&255|Ol,s>>>=7;return e[t]=s|0,nh.bytes=t-i+1,e}var Tf=Yn,Of=128,Rl=127;function Yn(s,i){var t=0,i=i||0,r=0,n=i,o,a=s.length;do{if(n>=a)throw Yn.bytes=0,new RangeError("Could not decode varint");o=s[n++],t+=r<28?(o&Rl)<<r:(o&Rl)*Math.pow(2,r),r+=7}while(o>=Of);return Yn.bytes=n-i,t}var Rf=Math.pow(2,7),xf=Math.pow(2,14),kf=Math.pow(2,21),Uf=Math.pow(2,28),Df=Math.pow(2,35),Ff=Math.pow(2,42),Lf=Math.pow(2,49),qf=Math.pow(2,56),jf=Math.pow(2,63),$f=function(s){return s<Rf?1:s<xf?2:s<kf?3:s<Uf?4:s<Df?5:s<Ff?6:s<Lf?7:s<qf?8:s<jf?9:10},Bf={encode:Pf,decode:Tf,encodingLength:$f},oh=Bf,xl=(s,e,t=0)=>(oh.encode(s,e,t),e),kl=s=>oh.encodingLength(s),Jn=(s,e)=>{let t=e.byteLength,i=kl(s),r=i+kl(t),n=new Uint8Array(r+t);return xl(s,n,0),xl(t,n,i),n.set(e,r),new Xn(s,t,e,n)},Xn=class{constructor(e,t,i,r){this.code=e,this.size=t,this.digest=i,this.bytes=r}},ah=({name:s,code:e,encode:t})=>new Zn(s,e,t),Zn=class{constructor(e,t,i){this.name=e,this.code=t,this.encode=i}digest(e){if(e instanceof Uint8Array){let t=this.encode(e);return t instanceof Uint8Array?Jn(this.code,t):t.then(i=>Jn(this.code,i))}else throw Error("Unknown type, must be binary type")}},ch=s=>async e=>new Uint8Array(await crypto.subtle.digest(s,e)),Mf=ah({name:"sha2-256",code:18,encode:ch("SHA-256")}),Vf=ah({name:"sha2-512",code:19,encode:ch("SHA-512")}),Hf=Object.freeze({__proto__:null,sha256:Mf,sha512:Vf}),lh=0,zf="identity",hh=sh,Kf=s=>Jn(lh,hh(s)),Wf={code:lh,name:zf,encode:hh,digest:Kf},Gf=Object.freeze({__proto__:null,identity:Wf});new TextEncoder,new TextDecoder;var Ul={...Bg,...Vg,...zg,...Wg,...Jg,...af,...hf,...uf,...wf,..._f};({...Hf,...Gf});function Yf(s=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?globalThis.Buffer.allocUnsafe(s):new Uint8Array(s)}function ph(s,e,t,i){return{name:s,prefix:e,encoder:{name:s,prefix:e,encode:t},decoder:{decode:i}}}var Dl=ph("utf8","u",s=>"u"+new TextDecoder("utf8").decode(s),s=>new TextEncoder().encode(s.substring(1))),$n=ph("ascii","a",s=>{let e="a";for(let t=0;t<s.length;t++)e+=String.fromCharCode(s[t]);return e},s=>{s=s.substring(1);let e=Yf(s.length);for(let t=0;t<s.length;t++)e[t]=s.charCodeAt(t);return e}),Jf={utf8:Dl,"utf-8":Dl,hex:Ul.base16,latin1:$n,ascii:$n,binary:$n,...Ul};function Xf(s,e="utf8"){let t=Jf[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(s,"utf8"):t.decoder.decode(`${t.prefix}${s}`)}var Zf=Object.defineProperty,Qf=(s,e,t)=>e in s?Zf(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,vt=(s,e,t)=>Qf(s,typeof e!="symbol"?e+"":e,t),Qn=class{constructor(e,t){this.core=e,this.logger=t,vt(this,"keychain",new Map),vt(this,"name",rg),vt(this,"version",ng),vt(this,"initialized",!1),vt(this,"storagePrefix",Et),vt(this,"init",async()=>{if(!this.initialized){let i=await this.getKeyChain();typeof i<"u"&&(this.keychain=i),this.initialized=!0}}),vt(this,"has",i=>(this.isInitialized(),this.keychain.has(i))),vt(this,"set",async(i,r)=>{this.isInitialized(),this.keychain.set(i,r),await this.persist()}),vt(this,"get",i=>{this.isInitialized();let r=this.keychain.get(i);if(typeof r>"u"){let{message:n}=R("NO_MATCHING_KEY",`${this.name}: ${i}`);throw new Error(n)}return r}),vt(this,"del",async i=>{this.isInitialized(),this.keychain.delete(i),await this.persist()}),this.core=e,this.logger=Ie(t,this.name)}get context(){return ke(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}async setKeyChain(e){await this.core.storage.setItem(this.storageKey,ir(e))}async getKeyChain(){let e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?rr(e):void 0}async persist(){await this.setKeyChain(this.keychain)}isInitialized(){if(!this.initialized){let{message:e}=R("NOT_INITIALIZED",this.name);throw new Error(e)}}},em=Object.defineProperty,tm=(s,e,t)=>e in s?em(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Pe=(s,e,t)=>tm(s,typeof e!="symbol"?e+"":e,t),eo=class{constructor(e,t,i){this.core=e,this.logger=t,Pe(this,"name",sg),Pe(this,"keychain"),Pe(this,"randomSessionIdentifier",dr()),Pe(this,"initialized",!1),Pe(this,"init",async()=>{this.initialized||(await this.keychain.init(),this.initialized=!0)}),Pe(this,"hasKeys",r=>(this.isInitialized(),this.keychain.has(r))),Pe(this,"getClientId",async()=>{this.isInitialized();let r=await this.getClientSeed(),n=Dr(r);return oa(n.publicKey)}),Pe(this,"generateKeyPair",()=>{this.isInitialized();let r=Jc();return this.setPrivateKey(r.publicKey,r.privateKey)}),Pe(this,"signJWT",async r=>{this.isInitialized();let n=await this.getClientSeed(),o=Dr(n),a=this.randomSessionIdentifier;return await aa(a,r,ig,o)}),Pe(this,"generateSharedKey",(r,n,o)=>{this.isInitialized();let a=this.getPrivateKey(r),c=Xc(a,n);return this.setSymKey(c,o)}),Pe(this,"setSymKey",async(r,n)=>{this.isInitialized();let o=n||xs(r);return await this.keychain.set(o,r),o}),Pe(this,"deleteKeyPair",async r=>{this.isInitialized(),await this.keychain.del(r)}),Pe(this,"deleteSymKey",async r=>{this.isInitialized(),await this.keychain.del(r)}),Pe(this,"encode",async(r,n,o)=>{this.isInitialized();let a=Tn(o),c=na(n);if(Rn(a))return il(c,o?.encoding);if(On(a)){let d=a.senderPublicKey,g=a.receiverPublicKey;r=await this.generateSharedKey(d,g)}let l=this.getSymKey(r),{type:h,senderPublicKey:p}=a;return tl({type:h,symKey:l,message:c,senderPublicKey:p,encoding:o?.encoding})}),Pe(this,"decode",async(r,n,o)=>{this.isInitialized();let a=ol(n,o);if(Rn(a)){let c=rl(n,o?.encoding);return Ur(c)}if(On(a)){let c=a.receiverPublicKey,l=a.senderPublicKey;r=await this.generateSharedKey(c,l)}try{let c=this.getSymKey(r),l=sl({symKey:c,encoded:n,encoding:o?.encoding});return Ur(l)}catch(c){this.logger.error(`Failed to decode message from topic: '${r}', clientId: '${await this.getClientId()}'`),this.logger.error(c)}}),Pe(this,"getPayloadType",(r,n=Ke)=>{let o=ks({encoded:r,encoding:n});return zt(o.type)}),Pe(this,"getPayloadSenderPublicKey",(r,n=Ke)=>{let o=ks({encoded:r,encoding:n});return o.senderPublicKey?Te(o.senderPublicKey,Oe):void 0}),this.core=e,this.logger=Ie(t,this.name),this.keychain=i||new Qn(this.core,this.logger)}get context(){return ke(this.logger)}async setPrivateKey(e,t){return await this.keychain.set(e,t),e}getPrivateKey(e){return this.keychain.get(e)}async getClientSeed(){let e="";try{e=this.keychain.get(Nl)}catch{e=dr(),await this.keychain.set(Nl,e)}return Xf(e,"base16")}getSymKey(e){return this.keychain.get(e)}isInitialized(){if(!this.initialized){let{message:e}=R("NOT_INITIALIZED",this.name);throw new Error(e)}}},sm=Object.defineProperty,im=Object.defineProperties,rm=Object.getOwnPropertyDescriptors,Fl=Object.getOwnPropertySymbols,nm=Object.prototype.hasOwnProperty,om=Object.prototype.propertyIsEnumerable,to=(s,e,t)=>e in s?sm(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,am=(s,e)=>{for(var t in e||(e={}))nm.call(e,t)&&to(s,t,e[t]);if(Fl)for(var t of Fl(e))om.call(e,t)&&to(s,t,e[t]);return s},cm=(s,e)=>im(s,rm(e)),We=(s,e,t)=>to(s,typeof e!="symbol"?e+"":e,t),so=class extends $i{constructor(e,t){super(e,t),this.logger=e,this.core=t,We(this,"messages",new Map),We(this,"messagesWithoutClientAck",new Map),We(this,"name",og),We(this,"version",ag),We(this,"initialized",!1),We(this,"storagePrefix",Et),We(this,"init",async()=>{if(!this.initialized){this.logger.trace("Initialized");try{let i=await this.getRelayerMessages();typeof i<"u"&&(this.messages=i);let r=await this.getRelayerMessagesWithoutClientAck();typeof r<"u"&&(this.messagesWithoutClientAck=r),this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",size:this.messages.size})}catch(i){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(i)}finally{this.initialized=!0}}}),We(this,"set",async(i,r,n)=>{this.isInitialized();let o=Ze(r),a=this.messages.get(i);if(typeof a>"u"&&(a={}),typeof a[o]<"u")return o;if(a[o]=r,this.messages.set(i,a),n===fr.inbound){let c=this.messagesWithoutClientAck.get(i)||{};this.messagesWithoutClientAck.set(i,cm(am({},c),{[o]:r}))}return await this.persist(),o}),We(this,"get",i=>{this.isInitialized();let r=this.messages.get(i);return typeof r>"u"&&(r={}),r}),We(this,"getWithoutAck",i=>{this.isInitialized();let r={};for(let n of i){let o=this.messagesWithoutClientAck.get(n)||{};r[n]=Object.values(o)}return r}),We(this,"has",(i,r)=>{this.isInitialized();let n=this.get(i),o=Ze(r);return typeof n[o]<"u"}),We(this,"ack",async(i,r)=>{this.isInitialized();let n=this.messagesWithoutClientAck.get(i);if(typeof n>"u")return;let o=Ze(r);delete n[o],Object.keys(n).length===0?this.messagesWithoutClientAck.delete(i):this.messagesWithoutClientAck.set(i,n),await this.persist()}),We(this,"del",async i=>{this.isInitialized(),this.messages.delete(i),this.messagesWithoutClientAck.delete(i),await this.persist()}),this.logger=Ie(e,this.name),this.core=t}get context(){return ke(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get storageKeyWithoutClientAck(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name+"_withoutClientAck"}async setRelayerMessages(e){await this.core.storage.setItem(this.storageKey,ir(e))}async setRelayerMessagesWithoutClientAck(e){await this.core.storage.setItem(this.storageKeyWithoutClientAck,ir(e))}async getRelayerMessages(){let e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?rr(e):void 0}async getRelayerMessagesWithoutClientAck(){let e=await this.core.storage.getItem(this.storageKeyWithoutClientAck);return typeof e<"u"?rr(e):void 0}async persist(){await this.setRelayerMessages(this.messages),await this.setRelayerMessagesWithoutClientAck(this.messagesWithoutClientAck)}isInitialized(){if(!this.initialized){let{message:e}=R("NOT_INITIALIZED",this.name);throw new Error(e)}}},lm=Object.defineProperty,hm=Object.defineProperties,pm=Object.getOwnPropertyDescriptors,Ll=Object.getOwnPropertySymbols,dm=Object.prototype.hasOwnProperty,um=Object.prototype.propertyIsEnumerable,io=(s,e,t)=>e in s?lm(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,gr=(s,e)=>{for(var t in e||(e={}))dm.call(e,t)&&io(s,t,e[t]);if(Ll)for(var t of Ll(e))um.call(e,t)&&io(s,t,e[t]);return s},Bn=(s,e)=>hm(s,pm(e)),lt=(s,e,t)=>io(s,typeof e!="symbol"?e+"":e,t),ro=class extends Bi{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,lt(this,"events",new Lt.EventEmitter),lt(this,"name",cg),lt(this,"queue",new Map),lt(this,"publishTimeout",(0,q.toMiliseconds)(q.ONE_MINUTE)),lt(this,"initialPublishTimeout",(0,q.toMiliseconds)(q.ONE_SECOND*15)),lt(this,"needsTransportRestart",!1),lt(this,"publish",async(i,r,n)=>{var o;this.logger.debug("Publishing Payload"),this.logger.trace({type:"method",method:"publish",params:{topic:i,message:r,opts:n}});let a=n?.ttl||Sl,c=Ii(n),l=n?.prompt||!1,h=n?.tag||0,p=n?.id||jt().toString(),d={topic:i,message:r,opts:{ttl:a,relay:c,prompt:l,tag:h,id:p,attestation:n?.attestation,tvf:n?.tvf}},g=`Failed to publish payload, please try again. id:${p} tag:${h}`;try{let f=new Promise(async m=>{let u=({id:y})=>{d.opts.id===y&&(this.removeRequestFromQueue(y),this.relayer.events.removeListener(me.publish,u),m(d))};this.relayer.events.on(me.publish,u);let w=Dt(new Promise((y,v)=>{this.rpcPublish({topic:i,message:r,ttl:a,prompt:l,tag:h,id:p,attestation:n?.attestation,tvf:n?.tvf}).then(y).catch(_=>{this.logger.warn(_,_?.message),v(_)})}),this.initialPublishTimeout,`Failed initial publish, retrying.... id:${p} tag:${h}`);try{await w,this.events.removeListener(me.publish,u)}catch(y){this.queue.set(p,Bn(gr({},d),{attempt:1})),this.logger.warn(y,y?.message)}});this.logger.trace({type:"method",method:"publish",params:{id:p,topic:i,message:r,opts:n}}),await Dt(f,this.publishTimeout,g)}catch(f){if(this.logger.debug("Failed to Publish Payload"),this.logger.error(f),(o=n?.internal)!=null&&o.throwOnFailedPublish)throw f}finally{this.queue.delete(p)}}),lt(this,"on",(i,r)=>{this.events.on(i,r)}),lt(this,"once",(i,r)=>{this.events.once(i,r)}),lt(this,"off",(i,r)=>{this.events.off(i,r)}),lt(this,"removeListener",(i,r)=>{this.events.removeListener(i,r)}),this.relayer=e,this.logger=Ie(t,this.name),this.registerEventListeners()}get context(){return ke(this.logger)}async rpcPublish(e){var t,i,r,n;let{topic:o,message:a,ttl:c=Sl,prompt:l,tag:h,id:p,attestation:d,tvf:g}=e,f={method:Us(Ii().protocol).publish,params:gr({topic:o,message:a,ttl:c,prompt:l,tag:h,attestation:d},g),id:p};fe((t=f.params)==null?void 0:t.prompt)&&((i=f.params)==null||delete i.prompt),fe((r=f.params)==null?void 0:r.tag)&&((n=f.params)==null||delete n.tag),this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"message",direction:"outgoing",request:f});let m=await this.relayer.request(f);return this.relayer.events.emit(me.publish,e),this.logger.debug("Successfully Published Payload"),m}removeRequestFromQueue(e){this.queue.delete(e)}checkQueue(){this.queue.forEach(async(e,t)=>{let i=e.attempt+1;this.queue.set(t,Bn(gr({},e),{attempt:i}));let{topic:r,message:n,opts:o,attestation:a}=e;this.logger.warn({},`Publisher: queue->publishing: ${e.opts.id}, tag: ${e.opts.tag}, attempt: ${i}`),await this.rpcPublish(Bn(gr({},e),{topic:r,message:n,ttl:o.ttl,prompt:o.prompt,tag:o.tag,id:o.id,attestation:a,tvf:o.tvf})),this.logger.warn({},`Publisher: queue->published: ${e.opts.id}`)})}registerEventListeners(){this.relayer.core.heartbeat.on(Qt.pulse,()=>{if(this.needsTransportRestart){this.needsTransportRestart=!1,this.relayer.events.emit(me.connection_stalled);return}this.checkQueue()}),this.relayer.on(me.message_ack,e=>{this.removeRequestFromQueue(e.id.toString())})}},gm=Object.defineProperty,fm=(s,e,t)=>e in s?gm(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Fs=(s,e,t)=>fm(s,typeof e!="symbol"?e+"":e,t),no=class{constructor(){Fs(this,"map",new Map),Fs(this,"set",(e,t)=>{let i=this.get(e);this.exists(e,t)||this.map.set(e,[...i,t])}),Fs(this,"get",e=>this.map.get(e)||[]),Fs(this,"exists",(e,t)=>this.get(e).includes(t)),Fs(this,"delete",(e,t)=>{if(typeof t>"u"){this.map.delete(e);return}if(!this.map.has(e))return;let i=this.get(e);if(!this.exists(e,t))return;let r=i.filter(n=>n!==t);if(!r.length){this.map.delete(e);return}this.map.set(e,r)}),Fs(this,"clear",()=>{this.map.clear()})}get topics(){return Array.from(this.map.keys())}},mm=Object.defineProperty,ym=Object.defineProperties,wm=Object.getOwnPropertyDescriptors,ql=Object.getOwnPropertySymbols,vm=Object.prototype.hasOwnProperty,bm=Object.prototype.propertyIsEnumerable,oo=(s,e,t)=>e in s?mm(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ai=(s,e)=>{for(var t in e||(e={}))vm.call(e,t)&&oo(s,t,e[t]);if(ql)for(var t of ql(e))bm.call(e,t)&&oo(s,t,e[t]);return s},Mn=(s,e)=>ym(s,wm(e)),te=(s,e,t)=>oo(s,typeof e!="symbol"?e+"":e,t),ao=class extends Hi{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,te(this,"subscriptions",new Map),te(this,"topicMap",new no),te(this,"events",new Lt.EventEmitter),te(this,"name",fg),te(this,"version",mg),te(this,"pending",new Map),te(this,"cached",[]),te(this,"initialized",!1),te(this,"storagePrefix",Et),te(this,"subscribeTimeout",(0,q.toMiliseconds)(q.ONE_MINUTE)),te(this,"initialSubscribeTimeout",(0,q.toMiliseconds)(q.ONE_SECOND*15)),te(this,"clientId"),te(this,"batchSubscribeTopicsLimit",500),te(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),this.registerEventListeners(),await this.restore()),this.initialized=!0}),te(this,"subscribe",async(i,r)=>{this.isInitialized(),this.logger.debug("Subscribing Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:i,opts:r}});try{let n=Ii(r),o={topic:i,relay:n,transportType:r?.transportType};this.pending.set(i,o);let a=await this.rpcSubscribe(i,n,r);return typeof a=="string"&&(this.onSubscribe(a,o),this.logger.debug("Successfully Subscribed Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:i,opts:r}})),a}catch(n){throw this.logger.debug("Failed to Subscribe Topic"),this.logger.error(n),n}}),te(this,"unsubscribe",async(i,r)=>{this.isInitialized(),typeof r?.id<"u"?await this.unsubscribeById(i,r.id,r):await this.unsubscribeByTopic(i,r)}),te(this,"isSubscribed",i=>new Promise(r=>{r(this.topicMap.topics.includes(i))})),te(this,"isKnownTopic",i=>new Promise(r=>{r(this.topicMap.topics.includes(i)||this.pending.has(i)||this.cached.some(n=>n.topic===i))})),te(this,"on",(i,r)=>{this.events.on(i,r)}),te(this,"once",(i,r)=>{this.events.once(i,r)}),te(this,"off",(i,r)=>{this.events.off(i,r)}),te(this,"removeListener",(i,r)=>{this.events.removeListener(i,r)}),te(this,"start",async()=>{await this.onConnect()}),te(this,"stop",async()=>{await this.onDisconnect()}),te(this,"restart",async()=>{await this.restore(),await this.onRestart()}),te(this,"checkPending",async()=>{if(this.pending.size===0&&(!this.initialized||!this.relayer.connected))return;let i=[];this.pending.forEach(r=>{i.push(r)}),await this.batchSubscribe(i)}),te(this,"registerEventListeners",()=>{this.relayer.core.heartbeat.on(Qt.pulse,async()=>{await this.checkPending()}),this.events.on(Ge.created,async i=>{let r=Ge.created;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,data:i}),await this.persist()}),this.events.on(Ge.deleted,async i=>{let r=Ge.deleted;this.logger.info(`Emitting ${r}`),this.logger.debug({type:"event",event:r,data:i}),await this.persist()})}),this.relayer=e,this.logger=Ie(t,this.name),this.clientId=""}get context(){return ke(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.relayer.core.customStoragePrefix+"//"+this.name}get length(){return this.subscriptions.size}get ids(){return Array.from(this.subscriptions.keys())}get values(){return Array.from(this.subscriptions.values())}get topics(){return this.topicMap.topics}get hasAnyTopics(){return this.topicMap.topics.length>0||this.pending.size>0||this.cached.length>0||this.subscriptions.size>0}hasSubscription(e,t){let i=!1;try{i=this.getSubscription(e).topic===t}catch{}return i}reset(){this.cached=[],this.initialized=!0}onDisable(){this.values.length>0&&(this.cached=this.values),this.subscriptions.clear(),this.topicMap.clear()}async unsubscribeByTopic(e,t){let i=this.topicMap.get(e);await Promise.all(i.map(async r=>await this.unsubscribeById(e,r,t)))}async unsubscribeById(e,t,i){this.logger.debug("Unsubscribing Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:i}});try{let r=Ii(i);await this.restartToComplete({topic:e,id:t,relay:r}),await this.rpcUnsubscribe(e,t,r);let n=Z("USER_DISCONNECTED",`${this.name}, ${e}`);await this.onUnsubscribe(e,t,n),this.logger.debug("Successfully Unsubscribed Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:i}})}catch(r){throw this.logger.debug("Failed to Unsubscribe Topic"),this.logger.error(r),r}}async rpcSubscribe(e,t,i){var r;(!i||i?.transportType===ne.relay)&&await this.restartToComplete({topic:e,id:e,relay:t});let n={method:Us(t.protocol).subscribe,params:{topic:e}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:n});let o=(r=i?.internal)==null?void 0:r.throwOnFailedPublish;try{let a=await this.getSubscriptionId(e);if(i?.transportType===ne.link_mode)return setTimeout(()=>{(this.relayer.connected||this.relayer.connecting)&&this.relayer.request(n).catch(h=>this.logger.warn(h))},(0,q.toMiliseconds)(q.ONE_SECOND)),a;let c=new Promise(async h=>{let p=d=>{d.topic===e&&(this.events.removeListener(Ge.created,p),h(d.id))};this.events.on(Ge.created,p);try{let d=await Dt(new Promise((g,f)=>{this.relayer.request(n).catch(m=>{this.logger.warn(m,m?.message),f(m)}).then(g)}),this.initialSubscribeTimeout,`Subscribing to ${e} failed, please try again`);this.events.removeListener(Ge.created,p),h(d)}catch{}}),l=await Dt(c,this.subscribeTimeout,`Subscribing to ${e} failed, please try again`);if(!l&&o)throw new Error(`Subscribing to ${e} failed, please try again`);return l?a:null}catch(a){if(this.logger.debug("Outgoing Relay Subscribe Payload stalled"),this.relayer.events.emit(me.connection_stalled),o)throw a}return null}async rpcBatchSubscribe(e){if(!e.length)return;let t=e[0].relay,i={method:Us(t.protocol).batchSubscribe,params:{topics:e.map(r=>r.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:i});try{await await Dt(new Promise(r=>{this.relayer.request(i).catch(n=>this.logger.warn(n)).then(r)}),this.subscribeTimeout,"rpcBatchSubscribe failed, please try again")}catch{this.relayer.events.emit(me.connection_stalled)}}async rpcBatchFetchMessages(e){if(!e.length)return;let t=e[0].relay,i={method:Us(t.protocol).batchFetchMessages,params:{topics:e.map(n=>n.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:i});let r;try{r=await await Dt(new Promise((n,o)=>{this.relayer.request(i).catch(a=>{this.logger.warn(a),o(a)}).then(n)}),this.subscribeTimeout,"rpcBatchFetchMessages failed, please try again")}catch{this.relayer.events.emit(me.connection_stalled)}return r}rpcUnsubscribe(e,t,i){let r={method:Us(i.protocol).unsubscribe,params:{topic:e,id:t}};return this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:r}),this.relayer.request(r)}onSubscribe(e,t){this.setSubscription(e,Mn(Ai({},t),{id:e})),this.pending.delete(t.topic)}onBatchSubscribe(e){e.length&&e.forEach(t=>{this.setSubscription(t.id,Ai({},t)),this.pending.delete(t.topic)})}async onUnsubscribe(e,t,i){this.events.removeAllListeners(t),this.hasSubscription(t,e)&&this.deleteSubscription(t,i),await this.relayer.messages.del(e)}async setRelayerSubscriptions(e){await this.relayer.core.storage.setItem(this.storageKey,e)}async getRelayerSubscriptions(){return await this.relayer.core.storage.getItem(this.storageKey)}setSubscription(e,t){this.logger.debug("Setting subscription"),this.logger.trace({type:"method",method:"setSubscription",id:e,subscription:t}),this.addSubscription(e,t)}addSubscription(e,t){this.subscriptions.set(e,Ai({},t)),this.topicMap.set(t.topic,e),this.events.emit(Ge.created,t)}getSubscription(e){this.logger.debug("Getting subscription"),this.logger.trace({type:"method",method:"getSubscription",id:e});let t=this.subscriptions.get(e);if(!t){let{message:i}=R("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(i)}return t}deleteSubscription(e,t){this.logger.debug("Deleting subscription"),this.logger.trace({type:"method",method:"deleteSubscription",id:e,reason:t});let i=this.getSubscription(e);this.subscriptions.delete(e),this.topicMap.delete(i.topic,e),this.events.emit(Ge.deleted,Mn(Ai({},i),{reason:t}))}async persist(){await this.setRelayerSubscriptions(this.values),this.events.emit(Ge.sync)}async onRestart(){if(this.cached.length){let e=[...this.cached],t=Math.ceil(this.cached.length/this.batchSubscribeTopicsLimit);for(let i=0;i<t;i++){let r=e.splice(0,this.batchSubscribeTopicsLimit);await this.batchSubscribe(r)}}this.events.emit(Ge.resubscribed)}async restore(){try{let e=await this.getRelayerSubscriptions();if(typeof e>"u"||!e.length)return;if(this.subscriptions.size){let{message:t}=R("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),this.logger.error(`${this.name}: ${JSON.stringify(this.values)}`),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored subscriptions for ${this.name}`),this.logger.trace({type:"method",method:"restore",subscriptions:this.values})}catch(e){this.logger.debug(`Failed to Restore subscriptions for ${this.name}`),this.logger.error(e)}}async batchSubscribe(e){e.length&&(await this.rpcBatchSubscribe(e),this.onBatchSubscribe(await Promise.all(e.map(async t=>Mn(Ai({},t),{id:await this.getSubscriptionId(t.topic)})))))}async batchFetchMessages(e){if(!e.length)return;this.logger.trace(`Fetching batch messages for ${e.length} subscriptions`);let t=await this.rpcBatchFetchMessages(e);t&&t.messages&&(await Ic((0,q.toMiliseconds)(q.ONE_SECOND)),await this.relayer.handleBatchMessageEvents(t.messages))}async onConnect(){await this.restart(),this.reset()}onDisconnect(){this.onDisable()}isInitialized(){if(!this.initialized){let{message:e}=R("NOT_INITIALIZED",this.name);throw new Error(e)}}async restartToComplete(e){!this.relayer.connected&&!this.relayer.connecting&&(this.cached.push(e),await this.relayer.transportOpen())}async getClientId(){return this.clientId||(this.clientId=await this.relayer.core.crypto.getClientId()),this.clientId}async getSubscriptionId(e){return Ze(e+await this.getClientId())}},Em=Object.defineProperty,jl=Object.getOwnPropertySymbols,Im=Object.prototype.hasOwnProperty,Cm=Object.prototype.propertyIsEnumerable,co=(s,e,t)=>e in s?Em(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,$l=(s,e)=>{for(var t in e||(e={}))Im.call(e,t)&&co(s,t,e[t]);if(jl)for(var t of jl(e))Cm.call(e,t)&&co(s,t,e[t]);return s},J=(s,e,t)=>co(s,typeof e!="symbol"?e+"":e,t),lo=class extends Mi{constructor(e){super(e),J(this,"protocol","wc"),J(this,"version",2),J(this,"core"),J(this,"logger"),J(this,"events",new Lt.EventEmitter),J(this,"provider"),J(this,"messages"),J(this,"subscriber"),J(this,"publisher"),J(this,"name",hg),J(this,"transportExplicitlyClosed",!1),J(this,"initialized",!1),J(this,"connectionAttemptInProgress",!1),J(this,"relayUrl"),J(this,"projectId"),J(this,"packageName"),J(this,"bundleId"),J(this,"hasExperiencedNetworkDisruption",!1),J(this,"pingTimeout"),J(this,"heartBeatTimeout",(0,q.toMiliseconds)(q.THIRTY_SECONDS+q.FIVE_SECONDS)),J(this,"reconnectTimeout"),J(this,"connectPromise"),J(this,"reconnectInProgress",!1),J(this,"requestsInFlight",[]),J(this,"connectTimeout",(0,q.toMiliseconds)(q.ONE_SECOND*15)),J(this,"request",async t=>{var i,r;this.logger.debug("Publishing Request Payload");let n=t.id||jt().toString();await this.toEstablishConnection();try{this.logger.trace({id:n,method:t.method,topic:(i=t.params)==null?void 0:i.topic},"relayer.request - publishing...");let o=`${n}:${((r=t.params)==null?void 0:r.tag)||""}`;this.requestsInFlight.push(o);let a=await this.provider.request(t);return this.requestsInFlight=this.requestsInFlight.filter(c=>c!==o),a}catch(o){throw this.logger.debug(`Failed to Publish Request: ${n}`),o}}),J(this,"resetPingTimeout",()=>{ui()&&(clearTimeout(this.pingTimeout),this.pingTimeout=setTimeout(()=>{var t,i,r,n;try{this.logger.debug({},"pingTimeout: Connection stalled, terminating..."),(n=(r=(i=(t=this.provider)==null?void 0:t.connection)==null?void 0:i.socket)==null?void 0:r.terminate)==null||n.call(r)}catch(o){this.logger.warn(o,o?.message)}},this.heartBeatTimeout))}),J(this,"onPayloadHandler",t=>{this.onProviderPayload(t),this.resetPingTimeout()}),J(this,"onConnectHandler",()=>{this.logger.warn({},"Relayer connected \u{1F6DC}"),this.startPingTimeout(),this.events.emit(me.connect)}),J(this,"onDisconnectHandler",()=>{this.logger.warn({},"Relayer disconnected \u{1F6D1}"),this.requestsInFlight=[],this.onProviderDisconnect()}),J(this,"onProviderErrorHandler",t=>{this.logger.fatal(`Fatal socket error: ${t.message}`),this.events.emit(me.error,t),this.logger.fatal("Fatal socket error received, closing transport"),this.transportClose()}),J(this,"registerProviderListeners",()=>{this.provider.on(Qe.payload,this.onPayloadHandler),this.provider.on(Qe.connect,this.onConnectHandler),this.provider.on(Qe.disconnect,this.onDisconnectHandler),this.provider.on(Qe.error,this.onProviderErrorHandler)}),this.core=e.core,this.logger=typeof e.logger<"u"&&typeof e.logger!="string"?Ie(e.logger,this.name):(0,fs.default)(es({level:e.logger||lg})),this.messages=new so(this.logger,e.core),this.subscriber=new ao(this,this.logger),this.publisher=new ro(this,this.logger),this.relayUrl=e?.relayUrl||eh,this.projectId=e.projectId,dc()?this.packageName=fn():uc()&&(this.bundleId=fn()),this.provider={}}async init(){if(this.logger.trace("Initialized"),this.registerEventListeners(),await Promise.all([this.messages.init(),this.subscriber.init()]),this.initialized=!0,this.subscriber.hasAnyTopics)try{await this.transportOpen()}catch(e){this.logger.warn(e,e?.message)}}get context(){return ke(this.logger)}get connected(){var e,t,i;return((i=(t=(e=this.provider)==null?void 0:e.connection)==null?void 0:t.socket)==null?void 0:i.readyState)===1||!1}get connecting(){var e,t,i;return((i=(t=(e=this.provider)==null?void 0:e.connection)==null?void 0:t.socket)==null?void 0:i.readyState)===0||this.connectPromise!==void 0||!1}async publish(e,t,i){this.isInitialized(),await this.publisher.publish(e,t,i),await this.recordMessageEvent({topic:e,message:t,publishedAt:Date.now(),transportType:ne.relay},fr.outbound)}async subscribe(e,t){var i,r,n;this.isInitialized(),(!(t!=null&&t.transportType)||t?.transportType==="relay")&&await this.toEstablishConnection();let o=typeof((i=t?.internal)==null?void 0:i.throwOnFailedPublish)>"u"?!0:(r=t?.internal)==null?void 0:r.throwOnFailedPublish,a=((n=this.subscriber.topicMap.get(e))==null?void 0:n[0])||"",c,l=h=>{h.topic===e&&(this.subscriber.off(Ge.created,l),c())};return await Promise.all([new Promise(h=>{c=h,this.subscriber.on(Ge.created,l)}),new Promise(async(h,p)=>{a=await this.subscriber.subscribe(e,$l({internal:{throwOnFailedPublish:o}},t)).catch(d=>{o&&p(d)})||a,h()})]),a}async unsubscribe(e,t){this.isInitialized(),await this.subscriber.unsubscribe(e,t)}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}off(e,t){this.events.off(e,t)}removeListener(e,t){this.events.removeListener(e,t)}async transportDisconnect(){this.provider.disconnect&&(this.hasExperiencedNetworkDisruption||this.connected)?await Dt(this.provider.disconnect(),2e3,"provider.disconnect()").catch(()=>this.onProviderDisconnect()):this.onProviderDisconnect()}async transportClose(){this.transportExplicitlyClosed=!0,await this.transportDisconnect()}async transportOpen(e){if(!this.subscriber.hasAnyTopics){this.logger.warn("Starting WS connection skipped because the client has no topics to work with.");return}if(this.connectPromise?(this.logger.debug({},"Waiting for existing connection attempt to resolve..."),await this.connectPromise,this.logger.debug({},"Existing connection attempt resolved")):(this.connectPromise=new Promise(async(t,i)=>{await this.connect(e).then(t).catch(i).finally(()=>{this.connectPromise=void 0})}),await this.connectPromise),!this.connected)throw new Error(`Couldn't establish socket connection to the relay server: ${this.relayUrl}`)}async restartTransport(e){this.logger.debug({},"Restarting transport..."),!this.connectionAttemptInProgress&&(this.relayUrl=e||this.relayUrl,await this.confirmOnlineStateOrThrow(),await this.transportClose(),await this.transportOpen())}async confirmOnlineStateOrThrow(){if(!await jn())throw new Error("No internet connection detected. Please restart your network and try again.")}async handleBatchMessageEvents(e){if(e?.length===0){this.logger.trace("Batch message events is empty. Ignoring...");return}let t=e.sort((i,r)=>i.publishedAt-r.publishedAt);this.logger.debug(`Batch of ${t.length} message events sorted`);for(let i of t)try{await this.onMessageEvent(i)}catch(r){this.logger.warn(r,"Error while processing batch message event: "+r?.message)}this.logger.trace(`Batch of ${t.length} message events processed`)}async onLinkMessageEvent(e,t){let{topic:i}=e;if(!t.sessionExists){let r=he(q.FIVE_MINUTES),n={topic:i,expiry:r,relay:{protocol:"irn"},active:!1};await this.core.pairing.pairings.set(i,n)}this.events.emit(me.message,e),await this.recordMessageEvent(e,fr.inbound)}async connect(e){await this.confirmOnlineStateOrThrow(),e&&e!==this.relayUrl&&(this.relayUrl=e,await this.transportDisconnect()),this.connectionAttemptInProgress=!0,this.transportExplicitlyClosed=!1;let t=1;for(;t<6;){try{if(this.transportExplicitlyClosed)break;this.logger.debug({},`Connecting to ${this.relayUrl}, attempt: ${t}...`),await this.createProvider(),await new Promise(async(i,r)=>{let n=()=>{r(new Error("Connection interrupted while trying to subscribe"))};this.provider.once(Qe.disconnect,n),await Dt(new Promise((o,a)=>{this.provider.connect().then(o).catch(a)}),this.connectTimeout,`Socket stalled when trying to connect to ${this.relayUrl}`).catch(o=>{r(o)}).finally(()=>{this.provider.off(Qe.disconnect,n),clearTimeout(this.reconnectTimeout)}),await new Promise(async(o,a)=>{let c=()=>{a(new Error("Connection interrupted while trying to subscribe"))};this.provider.once(Qe.disconnect,c),await this.subscriber.start().then(o).catch(a).finally(()=>{this.provider.off(Qe.disconnect,c)})}),this.hasExperiencedNetworkDisruption=!1,i()})}catch(i){await this.subscriber.stop();let r=i;this.logger.warn({},r.message),this.hasExperiencedNetworkDisruption=!0}finally{this.connectionAttemptInProgress=!1}if(this.connected){this.logger.debug({},`Connected to ${this.relayUrl} successfully on attempt: ${t}`);break}await new Promise(i=>setTimeout(i,(0,q.toMiliseconds)(t*1))),t++}}startPingTimeout(){var e,t,i,r,n;if(ui())try{(t=(e=this.provider)==null?void 0:e.connection)!=null&&t.socket&&((n=(r=(i=this.provider)==null?void 0:i.connection)==null?void 0:r.socket)==null||n.on("ping",()=>{this.resetPingTimeout()})),this.resetPingTimeout()}catch(o){this.logger.warn(o,o?.message)}}async createProvider(){this.provider.connection&&this.unregisterProviderListeners();let e=await this.core.crypto.signJWT(this.relayUrl);this.provider=new Fe(new da(fc({sdkVersion:Hn,protocol:this.protocol,version:this.version,relayUrl:this.relayUrl,projectId:this.projectId,auth:e,useOnCloseEvent:!0,bundleId:this.bundleId,packageName:this.packageName}))),this.registerProviderListeners()}async recordMessageEvent(e,t){let{topic:i,message:r}=e;await this.messages.set(i,r,t)}async shouldIgnoreMessageEvent(e){let{topic:t,message:i}=e;if(!i||i.length===0)return this.logger.warn(`Ignoring invalid/empty message: ${i}`),!0;if(!await this.subscriber.isKnownTopic(t))return this.logger.warn(`Ignoring message for unknown topic ${t}`),!0;let r=this.messages.has(t,i);return r&&this.logger.warn(`Ignoring duplicate message: ${i}`),r}async onProviderPayload(e){if(this.logger.debug("Incoming Relay Payload"),this.logger.trace({type:"payload",direction:"incoming",payload:e}),si(e)){if(!e.method.endsWith(pg))return;let t=e.params,{topic:i,message:r,publishedAt:n,attestation:o}=t.data,a={topic:i,message:r,publishedAt:n,transportType:ne.relay,attestation:o};this.logger.debug("Emitting Relayer Payload"),this.logger.trace($l({type:"event",event:t.id},a)),this.events.emit(t.id,a),await this.acknowledgePayload(e),await this.onMessageEvent(a)}else ii(e)&&this.events.emit(me.message_ack,e)}async onMessageEvent(e){await this.shouldIgnoreMessageEvent(e)||(await this.recordMessageEvent(e,fr.inbound),this.events.emit(me.message,e))}async acknowledgePayload(e){let t=ts(e.id,!0);await this.provider.connection.send(t)}unregisterProviderListeners(){this.provider.off(Qe.payload,this.onPayloadHandler),this.provider.off(Qe.connect,this.onConnectHandler),this.provider.off(Qe.disconnect,this.onDisconnectHandler),this.provider.off(Qe.error,this.onProviderErrorHandler),clearTimeout(this.pingTimeout)}async registerEventListeners(){let e=await jn();Pl(async t=>{e!==t&&(e=t,t?await this.transportOpen().catch(i=>this.logger.error(i,i?.message)):(this.hasExperiencedNetworkDisruption=!0,await this.transportDisconnect(),this.transportExplicitlyClosed=!1))}),this.core.heartbeat.on(Qt.pulse,async()=>{if(!this.transportExplicitlyClosed&&!this.connected&&Al())try{await this.confirmOnlineStateOrThrow(),await this.transportOpen()}catch(t){this.logger.warn(t,t?.message)}})}async onProviderDisconnect(){clearTimeout(this.pingTimeout),this.events.emit(me.disconnect),this.connectionAttemptInProgress=!1,!this.reconnectInProgress&&(this.reconnectInProgress=!0,await this.subscriber.stop(),this.subscriber.hasAnyTopics&&(this.transportExplicitlyClosed||(this.reconnectTimeout=setTimeout(async()=>{await this.transportOpen().catch(e=>this.logger.error(e,e?.message)),this.reconnectTimeout=void 0,this.reconnectInProgress=!1},(0,q.toMiliseconds)(dg)))))}isInitialized(){if(!this.initialized){let{message:e}=R("NOT_INITIALIZED",this.name);throw new Error(e)}}async toEstablishConnection(){if(await this.confirmOnlineStateOrThrow(),!this.connected){if(this.connectPromise){await this.connectPromise;return}await this.connect()}}};function _m(){}function Bl(s){if(!s||typeof s!="object")return!1;let e=Object.getPrototypeOf(s);return e===null||e===Object.prototype||Object.getPrototypeOf(e)===null?Object.prototype.toString.call(s)==="[object Object]":!1}function Ml(s){return Object.getOwnPropertySymbols(s).filter(e=>Object.prototype.propertyIsEnumerable.call(s,e))}function Vl(s){return s==null?s===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(s)}var Pm="[object RegExp]",Am="[object String]",Nm="[object Number]",Sm="[object Boolean]",Hl="[object Arguments]",Tm="[object Symbol]",Om="[object Date]",Rm="[object Map]",xm="[object Set]",km="[object Array]",Um="[object Function]",Dm="[object ArrayBuffer]",Vn="[object Object]",Fm="[object Error]",Lm="[object DataView]",qm="[object Uint8Array]",jm="[object Uint8ClampedArray]",$m="[object Uint16Array]",Bm="[object Uint32Array]",Mm="[object BigUint64Array]",Vm="[object Int8Array]",Hm="[object Int16Array]",zm="[object Int32Array]",Km="[object BigInt64Array]",Wm="[object Float32Array]",Gm="[object Float64Array]";function Ym(s,e){return s===e||Number.isNaN(s)&&Number.isNaN(e)}function Jm(s,e,t){return Si(s,e,void 0,void 0,void 0,void 0,t)}function Si(s,e,t,i,r,n,o){let a=o(s,e,t,i,r,n);if(a!==void 0)return a;if(typeof s==typeof e)switch(typeof s){case"bigint":case"string":case"boolean":case"symbol":case"undefined":return s===e;case"number":return s===e||Object.is(s,e);case"function":return s===e;case"object":return Ti(s,e,n,o)}return Ti(s,e,n,o)}function Ti(s,e,t,i){if(Object.is(s,e))return!0;let r=Vl(s),n=Vl(e);if(r===Hl&&(r=Vn),n===Hl&&(n=Vn),r!==n)return!1;switch(r){case Am:return s.toString()===e.toString();case Nm:{let c=s.valueOf(),l=e.valueOf();return Ym(c,l)}case Sm:case Om:case Tm:return Object.is(s.valueOf(),e.valueOf());case Pm:return s.source===e.source&&s.flags===e.flags;case Um:return s===e}t=t??new Map;let o=t.get(s),a=t.get(e);if(o!=null&&a!=null)return o===e;t.set(s,e),t.set(e,s);try{switch(r){case Rm:{if(s.size!==e.size)return!1;for(let[c,l]of s.entries())if(!e.has(c)||!Si(l,e.get(c),c,s,e,t,i))return!1;return!0}case xm:{if(s.size!==e.size)return!1;let c=Array.from(s.values()),l=Array.from(e.values());for(let h=0;h<c.length;h++){let p=c[h],d=l.findIndex(g=>Si(p,g,void 0,s,e,t,i));if(d===-1)return!1;l.splice(d,1)}return!0}case km:case qm:case jm:case $m:case Bm:case Mm:case Vm:case Hm:case zm:case Km:case Wm:case Gm:{if(typeof Buffer<"u"&&Buffer.isBuffer(s)!==Buffer.isBuffer(e)||s.length!==e.length)return!1;for(let c=0;c<s.length;c++)if(!Si(s[c],e[c],c,s,e,t,i))return!1;return!0}case Dm:return s.byteLength!==e.byteLength?!1:Ti(new Uint8Array(s),new Uint8Array(e),t,i);case Lm:return s.byteLength!==e.byteLength||s.byteOffset!==e.byteOffset?!1:Ti(new Uint8Array(s),new Uint8Array(e),t,i);case Fm:return s.name===e.name&&s.message===e.message;case Vn:{if(!(Ti(s.constructor,e.constructor,t,i)||Bl(s)&&Bl(e)))return!1;let c=[...Object.keys(s),...Ml(s)],l=[...Object.keys(e),...Ml(e)];if(c.length!==l.length)return!1;for(let h=0;h<c.length;h++){let p=c[h],d=s[p];if(!Object.hasOwn(e,p))return!1;let g=e[p];if(!Si(d,g,p,s,e,t,i))return!1}return!0}default:return!1}}finally{t.delete(s),t.delete(e)}}function Xm(s,e){return Jm(s,e,_m)}var Zm=Object.defineProperty,zl=Object.getOwnPropertySymbols,Qm=Object.prototype.hasOwnProperty,ey=Object.prototype.propertyIsEnumerable,ho=(s,e,t)=>e in s?Zm(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Kl=(s,e)=>{for(var t in e||(e={}))Qm.call(e,t)&&ho(s,t,e[t]);if(zl)for(var t of zl(e))ey.call(e,t)&&ho(s,t,e[t]);return s},je=(s,e,t)=>ho(s,typeof e!="symbol"?e+"":e,t),It=class extends Vi{constructor(e,t,i,r=Et,n=void 0){super(e,t,i,r),this.core=e,this.logger=t,this.name=i,je(this,"map",new Map),je(this,"version",ug),je(this,"cached",[]),je(this,"initialized",!1),je(this,"getKey"),je(this,"storagePrefix",Et),je(this,"recentlyDeleted",[]),je(this,"recentlyDeletedLimit",200),je(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(o=>{this.getKey&&o!==null&&!fe(o)?this.map.set(this.getKey(o),o):pl(o)?this.map.set(o.id,o):dl(o)&&this.map.set(o.topic,o)}),this.cached=[],this.initialized=!0)}),je(this,"set",async(o,a)=>{this.isInitialized(),this.map.has(o)?await this.update(o,a):(this.logger.debug("Setting value"),this.logger.trace({type:"method",method:"set",key:o,value:a}),this.map.set(o,a),await this.persist())}),je(this,"get",o=>(this.isInitialized(),this.logger.debug("Getting value"),this.logger.trace({type:"method",method:"get",key:o}),this.getData(o))),je(this,"getAll",o=>(this.isInitialized(),o?this.values.filter(a=>Object.keys(o).every(c=>Xm(a[c],o[c]))):this.values)),je(this,"update",async(o,a)=>{this.isInitialized(),this.logger.debug("Updating value"),this.logger.trace({type:"method",method:"update",key:o,update:a});let c=Kl(Kl({},this.getData(o)),a);this.map.set(o,c),await this.persist()}),je(this,"delete",async(o,a)=>{this.isInitialized(),this.map.has(o)&&(this.logger.debug("Deleting value"),this.logger.trace({type:"method",method:"delete",key:o,reason:a}),this.map.delete(o),this.addToRecentlyDeleted(o),await this.persist())}),this.logger=Ie(t,this.name),this.storagePrefix=r,this.getKey=n}get context(){return ke(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.map.size}get keys(){return Array.from(this.map.keys())}get values(){return Array.from(this.map.values())}addToRecentlyDeleted(e){this.recentlyDeleted.push(e),this.recentlyDeleted.length>=this.recentlyDeletedLimit&&this.recentlyDeleted.splice(0,this.recentlyDeletedLimit/2)}async setDataStore(e){await this.core.storage.setItem(this.storageKey,e)}async getDataStore(){return await this.core.storage.getItem(this.storageKey)}getData(e){let t=this.map.get(e);if(!t){if(this.recentlyDeleted.includes(e)){let{message:r}=R("MISSING_OR_INVALID",`Record was recently deleted - ${this.name}: ${e}`);throw this.logger.error(r),new Error(r)}let{message:i}=R("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.error(i),new Error(i)}return t}async persist(){await this.setDataStore(this.values)}async restore(){try{let e=await this.getDataStore();if(typeof e>"u"||!e.length)return;if(this.map.size){let{message:t}=R("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored value for ${this.name}`),this.logger.trace({type:"method",method:"restore",value:this.values})}catch(e){this.logger.debug(`Failed to Restore value for ${this.name}`),this.logger.error(e)}}isInitialized(){if(!this.initialized){let{message:e}=R("NOT_INITIALIZED",this.name);throw new Error(e)}}},ty=Object.defineProperty,sy=(s,e,t)=>e in s?ty(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,K=(s,e,t)=>sy(s,typeof e!="symbol"?e+"":e,t),po=class{constructor(e,t){this.core=e,this.logger=t,K(this,"name",yg),K(this,"version",wg),K(this,"events",new Lt.default),K(this,"pairings"),K(this,"initialized",!1),K(this,"storagePrefix",Et),K(this,"ignoredPayloadTypes",[at]),K(this,"registeredMethods",[]),K(this,"init",async()=>{this.initialized||(await this.pairings.init(),await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.initialized=!0,this.logger.trace("Initialized"))}),K(this,"register",({methods:i})=>{this.isInitialized(),this.registeredMethods=[...new Set([...this.registeredMethods,...i])]}),K(this,"create",async i=>{this.isInitialized();let r=dr(),n=await this.core.crypto.setSymKey(r),o=he(q.FIVE_MINUTES),a={protocol:Eo},c={topic:n,expiry:o,relay:a,active:!1,methods:i?.methods},l=kn({protocol:this.core.protocol,version:this.core.version,topic:n,symKey:r,relay:a,expiryTimestamp:o,methods:i?.methods});return this.events.emit(Gt.create,c),this.core.expirer.set(n,o),await this.pairings.set(n,c),await this.core.relayer.subscribe(n,{transportType:i?.transportType}),{topic:n,uri:l}}),K(this,"pair",async i=>{this.isInitialized();let r=this.core.eventClient.createEvent({properties:{topic:i?.uri,trace:[ht.pairing_started]}});this.isValidPair(i,r);let{topic:n,symKey:o,relay:a,expiryTimestamp:c,methods:l}=xn(i.uri);r.props.properties.topic=n,r.addTrace(ht.pairing_uri_validation_success),r.addTrace(ht.pairing_uri_not_expired);let h;if(this.pairings.keys.includes(n)){if(h=this.pairings.get(n),r.addTrace(ht.existing_pairing),h.active)throw r.setError(bt.active_pairing_already_exists),new Error(`Pairing already exists: ${n}. Please try again with a new connection URI.`);r.addTrace(ht.pairing_not_expired)}let p=c||he(q.FIVE_MINUTES),d={topic:n,relay:a,expiry:p,active:!1,methods:l};this.core.expirer.set(n,p),await this.pairings.set(n,d),r.addTrace(ht.store_new_pairing),i.activatePairing&&await this.activate({topic:n}),this.events.emit(Gt.create,d),r.addTrace(ht.emit_inactive_pairing),this.core.crypto.keychain.has(n)||await this.core.crypto.setSymKey(o,n),r.addTrace(ht.subscribing_pairing_topic);try{await this.core.relayer.confirmOnlineStateOrThrow()}catch{r.setError(bt.no_internet_connection)}try{await this.core.relayer.subscribe(n,{relay:a})}catch(g){throw r.setError(bt.subscribe_pairing_topic_failure),g}return r.addTrace(ht.subscribe_pairing_topic_success),d}),K(this,"activate",async({topic:i})=>{this.isInitialized();let r=he(q.FIVE_MINUTES);this.core.expirer.set(i,r),await this.pairings.update(i,{active:!0,expiry:r})}),K(this,"ping",async i=>{this.isInitialized(),await this.isValidPing(i),this.logger.warn("ping() is deprecated and will be removed in the next major release.");let{topic:r}=i;if(this.pairings.keys.includes(r)){let n=await this.sendRequest(r,"wc_pairingPing",{}),{done:o,resolve:a,reject:c}=Ut();this.events.once(Y("pairing_ping",n),({error:l})=>{l?c(l):a()}),await o()}}),K(this,"updateExpiry",async({topic:i,expiry:r})=>{this.isInitialized(),await this.pairings.update(i,{expiry:r})}),K(this,"updateMetadata",async({topic:i,metadata:r})=>{this.isInitialized(),await this.pairings.update(i,{peerMetadata:r})}),K(this,"getPairings",()=>(this.isInitialized(),this.pairings.values)),K(this,"disconnect",async i=>{this.isInitialized(),await this.isValidDisconnect(i);let{topic:r}=i;this.pairings.keys.includes(r)&&(await this.sendRequest(r,"wc_pairingDelete",Z("USER_DISCONNECTED")),await this.deletePairing(r))}),K(this,"formatUriFromPairing",i=>{this.isInitialized();let{topic:r,relay:n,expiry:o,methods:a}=i,c=this.core.crypto.keychain.get(r);return kn({protocol:this.core.protocol,version:this.core.version,topic:r,symKey:c,relay:n,expiryTimestamp:o,methods:a})}),K(this,"sendRequest",async(i,r,n)=>{let o=ut(r,n),a=await this.core.crypto.encode(i,o),c=Pi[r].req;return this.core.history.set(i,o),this.core.relayer.publish(i,a,c),o.id}),K(this,"sendResult",async(i,r,n)=>{let o=ts(i,n),a=await this.core.crypto.encode(r,o),c=(await this.core.history.get(r,i)).request.method,l=Pi[c].res;await this.core.relayer.publish(r,a,l),await this.core.history.resolve(o)}),K(this,"sendError",async(i,r,n)=>{let o=Ui(i,n),a=await this.core.crypto.encode(r,o),c=(await this.core.history.get(r,i)).request.method,l=Pi[c]?Pi[c].res:Pi.unregistered_method.res;await this.core.relayer.publish(r,a,l),await this.core.history.resolve(o)}),K(this,"deletePairing",async(i,r)=>{await this.core.relayer.unsubscribe(i),await Promise.all([this.pairings.delete(i,Z("USER_DISCONNECTED")),this.core.crypto.deleteSymKey(i),r?Promise.resolve():this.core.expirer.del(i)])}),K(this,"cleanup",async()=>{let i=this.pairings.getAll().filter(r=>mt(r.expiry));await Promise.all(i.map(r=>this.deletePairing(r.topic)))}),K(this,"onRelayEventRequest",async i=>{let{topic:r,payload:n}=i;switch(n.method){case"wc_pairingPing":return await this.onPairingPingRequest(r,n);case"wc_pairingDelete":return await this.onPairingDeleteRequest(r,n);default:return await this.onUnknownRpcMethodRequest(r,n)}}),K(this,"onRelayEventResponse",async i=>{let{topic:r,payload:n}=i,o=(await this.core.history.get(r,n.id)).request.method;switch(o){case"wc_pairingPing":return this.onPairingPingResponse(r,n);default:return this.onUnknownRpcMethodResponse(o)}}),K(this,"onPairingPingRequest",async(i,r)=>{let{id:n}=r;try{this.isValidPing({topic:i}),await this.sendResult(n,i,!0),this.events.emit(Gt.ping,{id:n,topic:i})}catch(o){await this.sendError(n,i,o),this.logger.error(o)}}),K(this,"onPairingPingResponse",(i,r)=>{let{id:n}=r;setTimeout(()=>{it(r)?this.events.emit(Y("pairing_ping",n),{}):Xe(r)&&this.events.emit(Y("pairing_ping",n),{error:r.error})},500)}),K(this,"onPairingDeleteRequest",async(i,r)=>{let{id:n}=r;try{this.isValidDisconnect({topic:i}),await this.deletePairing(i),this.events.emit(Gt.delete,{id:n,topic:i})}catch(o){await this.sendError(n,i,o),this.logger.error(o)}}),K(this,"onUnknownRpcMethodRequest",async(i,r)=>{let{id:n,method:o}=r;try{if(this.registeredMethods.includes(o))return;let a=Z("WC_METHOD_UNSUPPORTED",o);await this.sendError(n,i,a),this.logger.error(a)}catch(a){await this.sendError(n,i,a),this.logger.error(a)}}),K(this,"onUnknownRpcMethodResponse",i=>{this.registeredMethods.includes(i)||this.logger.error(Z("WC_METHOD_UNSUPPORTED",i))}),K(this,"isValidPair",(i,r)=>{var n;if(!Re(i)){let{message:a}=R("MISSING_OR_INVALID",`pair() params: ${i}`);throw r.setError(bt.malformed_pairing_uri),new Error(a)}if(!hl(i.uri)){let{message:a}=R("MISSING_OR_INVALID",`pair() uri: ${i.uri}`);throw r.setError(bt.malformed_pairing_uri),new Error(a)}let o=xn(i?.uri);if(!((n=o?.relay)!=null&&n.protocol)){let{message:a}=R("MISSING_OR_INVALID","pair() uri#relay-protocol");throw r.setError(bt.malformed_pairing_uri),new Error(a)}if(!(o!=null&&o.symKey)){let{message:a}=R("MISSING_OR_INVALID","pair() uri#symKey");throw r.setError(bt.malformed_pairing_uri),new Error(a)}if(o!=null&&o.expiryTimestamp&&(0,q.toMiliseconds)(o?.expiryTimestamp)<Date.now()){r.setError(bt.pairing_expired);let{message:a}=R("EXPIRED","pair() URI has expired. Please try again with a new connection URI.");throw new Error(a)}}),K(this,"isValidPing",async i=>{if(!Re(i)){let{message:n}=R("MISSING_OR_INVALID",`ping() params: ${i}`);throw new Error(n)}let{topic:r}=i;await this.isValidPairingTopic(r)}),K(this,"isValidDisconnect",async i=>{if(!Re(i)){let{message:n}=R("MISSING_OR_INVALID",`disconnect() params: ${i}`);throw new Error(n)}let{topic:r}=i;await this.isValidPairingTopic(r)}),K(this,"isValidPairingTopic",async i=>{if(!ce(i,!1)){let{message:r}=R("MISSING_OR_INVALID",`pairing topic should be a string: ${i}`);throw new Error(r)}if(!this.pairings.keys.includes(i)){let{message:r}=R("NO_MATCHING_KEY",`pairing topic doesn't exist: ${i}`);throw new Error(r)}if(mt(this.pairings.get(i).expiry)){await this.deletePairing(i);let{message:r}=R("EXPIRED",`pairing topic: ${i}`);throw new Error(r)}}),this.core=e,this.logger=Ie(t,this.name),this.pairings=new It(this.core,this.logger,this.name,this.storagePrefix)}get context(){return ke(this.logger)}isInitialized(){if(!this.initialized){let{message:e}=R("NOT_INITIALIZED",this.name);throw new Error(e)}}registerRelayerEvents(){this.core.relayer.on(me.message,async e=>{let{topic:t,message:i,transportType:r}=e;if(this.pairings.keys.includes(t)&&r!==ne.link_mode&&!this.ignoredPayloadTypes.includes(this.core.crypto.getPayloadType(i)))try{let n=await this.core.crypto.decode(t,i);si(n)?(this.core.history.set(t,n),await this.onRelayEventRequest({topic:t,payload:n})):ii(n)&&(await this.core.history.resolve(n),await this.onRelayEventResponse({topic:t,payload:n}),this.core.history.delete(t,n.id)),await this.core.relayer.messages.ack(t,i)}catch(n){this.logger.error(n)}})}registerExpirerEvents(){this.core.expirer.on(Ye.expired,async e=>{let{topic:t}=nr(e.target);t&&this.pairings.keys.includes(t)&&(await this.deletePairing(t,!0),this.events.emit(Gt.expire,{topic:t}))})}},iy=Object.defineProperty,ry=(s,e,t)=>e in s?iy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ae=(s,e,t)=>ry(s,typeof e!="symbol"?e+"":e,t),uo=class extends ji{constructor(e,t){super(e,t),this.core=e,this.logger=t,Ae(this,"records",new Map),Ae(this,"events",new Lt.EventEmitter),Ae(this,"name",vg),Ae(this,"version",bg),Ae(this,"cached",[]),Ae(this,"initialized",!1),Ae(this,"storagePrefix",Et),Ae(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(i=>this.records.set(i.id,i)),this.cached=[],this.registerEventListeners(),this.initialized=!0)}),Ae(this,"set",(i,r,n)=>{if(this.isInitialized(),this.logger.debug("Setting JSON-RPC request history record"),this.logger.trace({type:"method",method:"set",topic:i,request:r,chainId:n}),this.records.has(r.id))return;let o={id:r.id,topic:i,request:{method:r.method,params:r.params||null},chainId:n,expiry:he(q.THIRTY_DAYS)};this.records.set(o.id,o),this.persist(),this.events.emit(ct.created,o)}),Ae(this,"resolve",async i=>{if(this.isInitialized(),this.logger.debug("Updating JSON-RPC response history record"),this.logger.trace({type:"method",method:"update",response:i}),!this.records.has(i.id))return;let r=await this.getRecord(i.id);typeof r.response>"u"&&(r.response=Xe(i)?{error:i.error}:{result:i.result},this.records.set(r.id,r),this.persist(),this.events.emit(ct.updated,r))}),Ae(this,"get",async(i,r)=>(this.isInitialized(),this.logger.debug("Getting record"),this.logger.trace({type:"method",method:"get",topic:i,id:r}),await this.getRecord(r))),Ae(this,"delete",(i,r)=>{this.isInitialized(),this.logger.debug("Deleting record"),this.logger.trace({type:"method",method:"delete",id:r}),this.values.forEach(n=>{if(n.topic===i){if(typeof r<"u"&&n.id!==r)return;this.records.delete(n.id),this.events.emit(ct.deleted,n)}}),this.persist()}),Ae(this,"exists",async(i,r)=>(this.isInitialized(),this.records.has(r)?(await this.getRecord(r)).topic===i:!1)),Ae(this,"on",(i,r)=>{this.events.on(i,r)}),Ae(this,"once",(i,r)=>{this.events.once(i,r)}),Ae(this,"off",(i,r)=>{this.events.off(i,r)}),Ae(this,"removeListener",(i,r)=>{this.events.removeListener(i,r)}),this.logger=Ie(t,this.name)}get context(){return ke(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get size(){return this.records.size}get keys(){return Array.from(this.records.keys())}get values(){return Array.from(this.records.values())}get pending(){let e=[];return this.values.forEach(t=>{if(typeof t.response<"u")return;let i={topic:t.topic,request:ut(t.request.method,t.request.params,t.id),chainId:t.chainId};return e.push(i)}),e}async setJsonRpcRecords(e){await this.core.storage.setItem(this.storageKey,e)}async getJsonRpcRecords(){return await this.core.storage.getItem(this.storageKey)}getRecord(e){this.isInitialized();let t=this.records.get(e);if(!t){let{message:i}=R("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(i)}return t}async persist(){await this.setJsonRpcRecords(this.values),this.events.emit(ct.sync)}async restore(){try{let e=await this.getJsonRpcRecords();if(typeof e>"u"||!e.length)return;if(this.records.size){let{message:t}=R("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",records:this.values})}catch(e){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(e)}}registerEventListeners(){this.events.on(ct.created,e=>{let t=ct.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.events.on(ct.updated,e=>{let t=ct.updated;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.events.on(ct.deleted,e=>{let t=ct.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.core.heartbeat.on(Qt.pulse,()=>{this.cleanup()})}cleanup(){try{this.isInitialized();let e=!1;this.records.forEach(t=>{(0,q.toMiliseconds)(t.expiry||0)-Date.now()<=0&&(this.logger.info(`Deleting expired history log: ${t.id}`),this.records.delete(t.id),this.events.emit(ct.deleted,t,!1),e=!0)}),e&&this.persist()}catch(e){this.logger.warn(e)}}isInitialized(){if(!this.initialized){let{message:e}=R("NOT_INITIALIZED",this.name);throw new Error(e)}}},ny=Object.defineProperty,oy=(s,e,t)=>e in s?ny(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,xe=(s,e,t)=>oy(s,typeof e!="symbol"?e+"":e,t),go=class extends zi{constructor(e,t){super(e,t),this.core=e,this.logger=t,xe(this,"expirations",new Map),xe(this,"events",new Lt.EventEmitter),xe(this,"name",Eg),xe(this,"version",Ig),xe(this,"cached",[]),xe(this,"initialized",!1),xe(this,"storagePrefix",Et),xe(this,"init",async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(i=>this.expirations.set(i.target,i)),this.cached=[],this.registerEventListeners(),this.initialized=!0)}),xe(this,"has",i=>{try{let r=this.formatTarget(i);return typeof this.getExpiration(r)<"u"}catch{return!1}}),xe(this,"set",(i,r)=>{this.isInitialized();let n=this.formatTarget(i),o={target:n,expiry:r};this.expirations.set(n,o),this.checkExpiry(n,o),this.events.emit(Ye.created,{target:n,expiration:o})}),xe(this,"get",i=>{this.isInitialized();let r=this.formatTarget(i);return this.getExpiration(r)}),xe(this,"del",i=>{if(this.isInitialized(),this.has(i)){let r=this.formatTarget(i),n=this.getExpiration(r);this.expirations.delete(r),this.events.emit(Ye.deleted,{target:r,expiration:n})}}),xe(this,"on",(i,r)=>{this.events.on(i,r)}),xe(this,"once",(i,r)=>{this.events.once(i,r)}),xe(this,"off",(i,r)=>{this.events.off(i,r)}),xe(this,"removeListener",(i,r)=>{this.events.removeListener(i,r)}),this.logger=Ie(t,this.name)}get context(){return ke(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.expirations.size}get keys(){return Array.from(this.expirations.keys())}get values(){return Array.from(this.expirations.values())}formatTarget(e){if(typeof e=="string")return yc(e);if(typeof e=="number")return wc(e);let{message:t}=R("UNKNOWN_TYPE",`Target type: ${typeof e}`);throw new Error(t)}async setExpirations(e){await this.core.storage.setItem(this.storageKey,e)}async getExpirations(){return await this.core.storage.getItem(this.storageKey)}async persist(){await this.setExpirations(this.values),this.events.emit(Ye.sync)}async restore(){try{let e=await this.getExpirations();if(typeof e>"u"||!e.length)return;if(this.expirations.size){let{message:t}=R("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored expirations for ${this.name}`),this.logger.trace({type:"method",method:"restore",expirations:this.values})}catch(e){this.logger.debug(`Failed to Restore expirations for ${this.name}`),this.logger.error(e)}}getExpiration(e){let t=this.expirations.get(e);if(!t){let{message:i}=R("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.warn(i),new Error(i)}return t}checkExpiry(e,t){let{expiry:i}=t;(0,q.toMiliseconds)(i)-Date.now()<=0&&this.expire(e,t)}expire(e,t){this.expirations.delete(e),this.events.emit(Ye.expired,{target:e,expiration:t})}checkExpirations(){this.core.relayer.connected&&this.expirations.forEach((e,t)=>this.checkExpiry(t,e))}registerEventListeners(){this.core.heartbeat.on(Qt.pulse,()=>this.checkExpirations()),this.events.on(Ye.created,e=>{let t=Ye.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on(Ye.expired,e=>{let t=Ye.expired;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on(Ye.deleted,e=>{let t=Ye.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()})}isInitialized(){if(!this.initialized){let{message:e}=R("NOT_INITIALIZED",this.name);throw new Error(e)}}},ay=Object.defineProperty,cy=(s,e,t)=>e in s?ay(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,de=(s,e,t)=>cy(s,typeof e!="symbol"?e+"":e,t),fo=class extends Ki{constructor(e,t,i){super(e,t,i),this.core=e,this.logger=t,this.store=i,de(this,"name",Cg),de(this,"abortController"),de(this,"isDevEnv"),de(this,"verifyUrlV3",Pg),de(this,"storagePrefix",Et),de(this,"version",Ql),de(this,"publicKey"),de(this,"fetchPromise"),de(this,"init",async()=>{var r;this.isDevEnv||(this.publicKey=await this.store.getItem(this.storeKey),this.publicKey&&(0,q.toMiliseconds)((r=this.publicKey)==null?void 0:r.expiresAt)<Date.now()&&(this.logger.debug("verify v2 public key expired"),await this.removePublicKey()))}),de(this,"register",async r=>{if(!cs()||this.isDevEnv)return;let n=window.location.origin,{id:o,decryptedId:a}=r,c=`${this.verifyUrlV3}/attestation?projectId=${this.core.projectId}&origin=${n}&id=${o}&decryptedId=${a}`;try{let l=(0,Xl.getDocument)(),h=this.startAbortTimer(q.ONE_SECOND*5),p=await new Promise((d,g)=>{let f=()=>{window.removeEventListener("message",u),l.body.removeChild(m),g("attestation aborted")};this.abortController.signal.addEventListener("abort",f);let m=l.createElement("iframe");m.src=c,m.style.display="none",m.addEventListener("error",f,{signal:this.abortController.signal});let u=w=>{if(w.data&&typeof w.data=="string")try{let y=JSON.parse(w.data);if(y.type==="verify_attestation"){if(ti(y.attestation).payload.id!==o)return;clearInterval(h),l.body.removeChild(m),this.abortController.signal.removeEventListener("abort",f),window.removeEventListener("message",u),d(y.attestation===null?"":y.attestation)}}catch(y){this.logger.warn(y)}};l.body.appendChild(m),window.addEventListener("message",u,{signal:this.abortController.signal})});return this.logger.debug("jwt attestation",p),p}catch(l){this.logger.warn(l)}return""}),de(this,"resolve",async r=>{if(this.isDevEnv)return"";let{attestationId:n,hash:o,encryptedId:a}=r;if(n===""){this.logger.debug("resolve: attestationId is empty, skipping");return}if(n){if(ti(n).payload.id!==a)return;let l=await this.isValidJwtAttestation(n);if(l){if(!l.isVerified){this.logger.warn("resolve: jwt attestation: origin url not verified");return}return l}}if(!o)return;let c=this.getVerifyUrl(r?.verifyUrl);return this.fetchAttestation(o,c)}),de(this,"fetchAttestation",async(r,n)=>{this.logger.debug(`resolving attestation: ${r} from url: ${n}`);let o=this.startAbortTimer(q.ONE_SECOND*5),a=await fetch(`${n}/attestation/${r}?v2Supported=true`,{signal:this.abortController.signal});return clearTimeout(o),a.status===200?await a.json():void 0}),de(this,"getVerifyUrl",r=>{let n=r||Ls;return Ag.includes(n)||(this.logger.info(`verify url: ${n}, not included in trusted list, assigning default: ${Ls}`),n=Ls),n}),de(this,"fetchPublicKey",async()=>{try{this.logger.debug(`fetching public key from: ${this.verifyUrlV3}`);let r=this.startAbortTimer(q.FIVE_SECONDS),n=await fetch(`${this.verifyUrlV3}/public-key`,{signal:this.abortController.signal});return clearTimeout(r),await n.json()}catch(r){this.logger.warn(r)}}),de(this,"persistPublicKey",async r=>{this.logger.debug("persisting public key to local storage",r),await this.store.setItem(this.storeKey,r),this.publicKey=r}),de(this,"removePublicKey",async()=>{this.logger.debug("removing verify v2 public key from storage"),await this.store.removeItem(this.storeKey),this.publicKey=void 0}),de(this,"isValidJwtAttestation",async r=>{let n=await this.getPublicKey();try{if(n)return this.validateAttestation(r,n)}catch(a){this.logger.error(a),this.logger.warn("error validating attestation")}let o=await this.fetchAndPersistPublicKey();try{if(o)return this.validateAttestation(r,o)}catch(a){this.logger.error(a),this.logger.warn("error validating attestation")}}),de(this,"getPublicKey",async()=>this.publicKey?this.publicKey:await this.fetchAndPersistPublicKey()),de(this,"fetchAndPersistPublicKey",async()=>{if(this.fetchPromise)return await this.fetchPromise,this.publicKey;this.fetchPromise=new Promise(async n=>{let o=await this.fetchPublicKey();o&&(await this.persistPublicKey(o),n(o))});let r=await this.fetchPromise;return this.fetchPromise=void 0,r}),de(this,"validateAttestation",(r,n)=>{let o=al(r,n.publicKey),a={hasExpired:(0,q.toMiliseconds)(o.exp)<Date.now(),payload:o};if(a.hasExpired)throw this.logger.warn("resolve: jwt attestation expired"),new Error("JWT attestation expired");return{origin:a.payload.origin,isScam:a.payload.isScam,isVerified:a.payload.isVerified}}),this.logger=Ie(t,this.name),this.abortController=new AbortController,this.isDevEnv=fi(),this.init()}get storeKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//verify:public:key"}get context(){return ke(this.logger)}startAbortTimer(e){return this.abortController=new AbortController,setTimeout(()=>this.abortController.abort(),(0,q.toMiliseconds)(e))}},ly=Object.defineProperty,hy=(s,e,t)=>e in s?ly(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Wl=(s,e,t)=>hy(s,typeof e!="symbol"?e+"":e,t),mo=class extends Wi{constructor(e,t){super(e,t),this.projectId=e,this.logger=t,Wl(this,"context",Ng),Wl(this,"registerDeviceToken",async i=>{let{clientId:r,token:n,notificationType:o,enableEncrypted:a=!1}=i,c=`${Sg}/${this.projectId}/clients`;await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:r,type:o,token:n,always_raw:a})})}),this.logger=Ie(t,this.context)}},py=Object.defineProperty,Gl=Object.getOwnPropertySymbols,dy=Object.prototype.hasOwnProperty,uy=Object.prototype.propertyIsEnumerable,yo=(s,e,t)=>e in s?py(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ni=(s,e)=>{for(var t in e||(e={}))dy.call(e,t)&&yo(s,t,e[t]);if(Gl)for(var t of Gl(e))uy.call(e,t)&&yo(s,t,e[t]);return s},be=(s,e,t)=>yo(s,typeof e!="symbol"?e+"":e,t),wo=class extends Gi{constructor(e,t,i=!0){super(e,t,i),this.core=e,this.logger=t,be(this,"context",Og),be(this,"storagePrefix",Et),be(this,"storageVersion",Tg),be(this,"events",new Map),be(this,"shouldPersist",!1),be(this,"init",async()=>{if(!fi())try{let r={eventId:vn(),timestamp:Date.now(),domain:this.getAppDomain(),props:{event:"INIT",type:"",properties:{client_id:await this.core.crypto.getClientId(),user_agent:yn(this.core.relayer.protocol,this.core.relayer.version,Hn)}}};await this.sendEvent([r])}catch(r){this.logger.warn(r)}}),be(this,"createEvent",r=>{let{event:n="ERROR",type:o="",properties:{topic:a,trace:c}}=r,l=vn(),h=this.core.projectId||"",p=Date.now(),d=Ni({eventId:l,timestamp:p,props:{event:n,type:o,properties:{topic:a,trace:c}},bundleId:h,domain:this.getAppDomain()},this.setMethods(l));return this.telemetryEnabled&&(this.events.set(l,d),this.shouldPersist=!0),d}),be(this,"getEvent",r=>{let{eventId:n,topic:o}=r;if(n)return this.events.get(n);let a=Array.from(this.events.values()).find(c=>c.props.properties.topic===o);if(a)return Ni(Ni({},a),this.setMethods(a.eventId))}),be(this,"deleteEvent",r=>{let{eventId:n}=r;this.events.delete(n),this.shouldPersist=!0}),be(this,"setEventListeners",()=>{this.core.heartbeat.on(Qt.pulse,async()=>{this.shouldPersist&&await this.persist(),this.events.forEach(r=>{(0,q.fromMiliseconds)(Date.now())-(0,q.fromMiliseconds)(r.timestamp)>Rg&&(this.events.delete(r.eventId),this.shouldPersist=!0)})})}),be(this,"setMethods",r=>({addTrace:n=>this.addTrace(r,n),setError:n=>this.setError(r,n)})),be(this,"addTrace",(r,n)=>{let o=this.events.get(r);o&&(o.props.properties.trace.push(n),this.events.set(r,o),this.shouldPersist=!0)}),be(this,"setError",(r,n)=>{let o=this.events.get(r);o&&(o.props.type=n,o.timestamp=Date.now(),this.events.set(r,o),this.shouldPersist=!0)}),be(this,"persist",async()=>{await this.core.storage.setItem(this.storageKey,Array.from(this.events.values())),this.shouldPersist=!1}),be(this,"restore",async()=>{try{let r=await this.core.storage.getItem(this.storageKey)||[];if(!r.length)return;r.forEach(n=>{this.events.set(n.eventId,Ni(Ni({},n),this.setMethods(n.eventId)))})}catch(r){this.logger.warn(r)}}),be(this,"submit",async()=>{if(!this.telemetryEnabled||this.events.size===0)return;let r=[];for(let[n,o]of this.events)o.props.type&&r.push(o);if(r.length!==0)try{if((await this.sendEvent(r)).ok)for(let n of r)this.events.delete(n.eventId),this.shouldPersist=!0}catch(n){this.logger.warn(n)}}),be(this,"sendEvent",async r=>{let n=this.getAppDomain()?"":"&sp=desktop";return await fetch(`${xg}?projectId=${this.core.projectId}&st=events_sdk&sv=js-${Hn}${n}`,{method:"POST",body:JSON.stringify(r)})}),be(this,"getAppDomain",()=>mn().url),this.logger=Ie(t,this.context),this.telemetryEnabled=i,i?this.restore().then(async()=>{await this.submit(),this.setEventListeners()}):this.persist()}get storageKey(){return this.storagePrefix+this.storageVersion+this.core.customStoragePrefix+"//"+this.context}},gy=Object.defineProperty,Yl=Object.getOwnPropertySymbols,fy=Object.prototype.hasOwnProperty,my=Object.prototype.propertyIsEnumerable,vo=(s,e,t)=>e in s?gy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Jl=(s,e)=>{for(var t in e||(e={}))fy.call(e,t)&&vo(s,t,e[t]);if(Yl)for(var t of Yl(e))my.call(e,t)&&vo(s,t,e[t]);return s},re=(s,e,t)=>vo(s,typeof e!="symbol"?e+"":e,t),bo=class s extends qi{constructor(e){var t;super(e),re(this,"protocol",Zl),re(this,"version",Ql),re(this,"name",mr),re(this,"relayUrl"),re(this,"projectId"),re(this,"customStoragePrefix"),re(this,"events",new Lt.EventEmitter),re(this,"logger"),re(this,"heartbeat"),re(this,"relayer"),re(this,"crypto"),re(this,"storage"),re(this,"history"),re(this,"expirer"),re(this,"pairing"),re(this,"verify"),re(this,"echoClient"),re(this,"linkModeSupportedApps"),re(this,"eventClient"),re(this,"initialized",!1),re(this,"logChunkController"),re(this,"on",(a,c)=>this.events.on(a,c)),re(this,"once",(a,c)=>this.events.once(a,c)),re(this,"off",(a,c)=>this.events.off(a,c)),re(this,"removeListener",(a,c)=>this.events.removeListener(a,c)),re(this,"dispatchEnvelope",({topic:a,message:c,sessionExists:l})=>{if(!a||!c)return;let h={topic:a,message:c,publishedAt:Date.now(),transportType:ne.link_mode};this.relayer.onLinkMessageEvent(h,{sessionExists:l})});let i=this.getGlobalCore(e?.customStoragePrefix);if(i)try{return this.customStoragePrefix=i.customStoragePrefix,this.logger=i.logger,this.heartbeat=i.heartbeat,this.crypto=i.crypto,this.history=i.history,this.expirer=i.expirer,this.storage=i.storage,this.relayer=i.relayer,this.pairing=i.pairing,this.verify=i.verify,this.echoClient=i.echoClient,this.linkModeSupportedApps=i.linkModeSupportedApps,this.eventClient=i.eventClient,this.initialized=i.initialized,this.logChunkController=i.logChunkController,i}catch(a){console.warn("Failed to copy global core",a)}this.projectId=e?.projectId,this.relayUrl=e?.relayUrl||eh,this.customStoragePrefix=e!=null&&e.customStoragePrefix?`:${e.customStoragePrefix}`:"";let r=es({level:typeof e?.logger=="string"&&e.logger?e.logger:eg.logger,name:mr}),{logger:n,chunkLoggerController:o}=pa({opts:r,maxSizeInBytes:e?.maxLogBlobSizeInBytes,loggerOverride:e?.logger});this.logChunkController=o,(t=this.logChunkController)!=null&&t.downloadLogsBlobInBrowser&&(window.downloadLogsBlobInBrowser=async()=>{var a,c;(a=this.logChunkController)!=null&&a.downloadLogsBlobInBrowser&&((c=this.logChunkController)==null||c.downloadLogsBlobInBrowser({clientId:await this.crypto.getClientId()}))}),this.logger=Ie(n,this.name),this.heartbeat=new la,this.crypto=new eo(this,this.logger,e?.keychain),this.history=new uo(this,this.logger),this.expirer=new go(this,this.logger),this.storage=e!=null&&e.storage?e.storage:new ha(Jl(Jl({},tg),e?.storageOptions)),this.relayer=new lo({core:this,logger:this.logger,relayUrl:this.relayUrl,projectId:this.projectId}),this.pairing=new po(this,this.logger),this.verify=new fo(this,this.logger,this.storage),this.echoClient=new mo(this.projectId||"",this.logger),this.linkModeSupportedApps=[],this.eventClient=new wo(this,this.logger,e?.telemetryEnabled),this.setGlobalCore(this)}static async init(e){let t=new s(e);await t.initialize();let i=await t.crypto.getClientId();return await t.storage.setItem(gg,i),t}get context(){return ke(this.logger)}async start(){this.initialized||await this.initialize()}async getLogsBlob(){var e;return(e=this.logChunkController)==null?void 0:e.logsToBlob({clientId:await this.crypto.getClientId()})}async addLinkModeSupportedApp(e){this.linkModeSupportedApps.includes(e)||(this.linkModeSupportedApps.push(e),await this.storage.setItem(Tl,this.linkModeSupportedApps))}async initialize(){this.logger.trace("Initialized");try{await this.crypto.init(),await this.history.init(),await this.expirer.init(),await this.relayer.init(),await this.heartbeat.init(),await this.pairing.init(),this.linkModeSupportedApps=await this.storage.getItem(Tl)||[],this.initialized=!0,this.logger.info("Core Initialization Success")}catch(e){throw this.logger.warn(`Core Initialization Failure at epoch ${Date.now()}`,e),this.logger.error(e.message),e}}getGlobalCore(e=""){try{if(this.isGlobalCoreDisabled())return;let t=`_walletConnectCore_${e}`,i=`${t}_count`;return globalThis[i]=(globalThis[i]||0)+1,globalThis[i]>1&&console.warn(`WalletConnect Core is already initialized. This is probably a mistake and can lead to unexpected behavior. Init() was called ${globalThis[i]} times.`),globalThis[t]}catch(t){console.warn("Failed to get global WalletConnect core",t);return}}setGlobalCore(e){var t;try{if(this.isGlobalCoreDisabled())return;let i=`_walletConnectCore_${((t=e.opts)==null?void 0:t.customStoragePrefix)||""}`;globalThis[i]=e}catch(i){console.warn("Failed to set global WalletConnect core",i)}}isGlobalCoreDisabled(){try{return typeof process<"u"&&process.env.DISABLE_GLOBAL_CORE==="true"}catch{return!0}}},dh=bo;var z=dt(kr());var br=dt(ki());var yh="wc",wh=2,vh="client",Uo=`${yh}@${wh}:${vh}:`,Io={name:vh,logger:"error",controller:!1,relayUrl:"wss://relay.walletconnect.org"};var uh="WALLETCONNECT_DEEPLINK_CHOICE";var yy="proposal";var gh="Proposal expired",wy="session",js=z.SEVEN_DAYS,vy="engine",Ee={wc_sessionPropose:{req:{ttl:z.FIVE_MINUTES,prompt:!0,tag:1100},res:{ttl:z.FIVE_MINUTES,prompt:!1,tag:1101},reject:{ttl:z.FIVE_MINUTES,prompt:!1,tag:1120},autoReject:{ttl:z.FIVE_MINUTES,prompt:!1,tag:1121}},wc_sessionSettle:{req:{ttl:z.FIVE_MINUTES,prompt:!1,tag:1102},res:{ttl:z.FIVE_MINUTES,prompt:!1,tag:1103}},wc_sessionUpdate:{req:{ttl:z.ONE_DAY,prompt:!1,tag:1104},res:{ttl:z.ONE_DAY,prompt:!1,tag:1105}},wc_sessionExtend:{req:{ttl:z.ONE_DAY,prompt:!1,tag:1106},res:{ttl:z.ONE_DAY,prompt:!1,tag:1107}},wc_sessionRequest:{req:{ttl:z.FIVE_MINUTES,prompt:!0,tag:1108},res:{ttl:z.FIVE_MINUTES,prompt:!1,tag:1109}},wc_sessionEvent:{req:{ttl:z.FIVE_MINUTES,prompt:!0,tag:1110},res:{ttl:z.FIVE_MINUTES,prompt:!1,tag:1111}},wc_sessionDelete:{req:{ttl:z.ONE_DAY,prompt:!1,tag:1112},res:{ttl:z.ONE_DAY,prompt:!1,tag:1113}},wc_sessionPing:{req:{ttl:z.ONE_DAY,prompt:!1,tag:1114},res:{ttl:z.ONE_DAY,prompt:!1,tag:1115}},wc_sessionAuthenticate:{req:{ttl:z.ONE_HOUR,prompt:!0,tag:1116},res:{ttl:z.ONE_HOUR,prompt:!1,tag:1117},reject:{ttl:z.FIVE_MINUTES,prompt:!1,tag:1118},autoReject:{ttl:z.FIVE_MINUTES,prompt:!1,tag:1119}}},Co={min:z.FIVE_MINUTES,max:z.SEVEN_DAYS},Ct={idle:"IDLE",active:"ACTIVE"},fh={eth_sendTransaction:{key:""},eth_sendRawTransaction:{key:""},wallet_sendCalls:{key:""},solana_signTransaction:{key:"signature"},solana_signAllTransactions:{key:"transactions"},solana_signAndSendTransaction:{key:"signature"}},by="request",Ey=["wc_sessionPropose","wc_sessionRequest","wc_authRequest","wc_sessionAuthenticate"],Iy="wc";var Cy="auth",_y="authKeys",Py="pairingTopics",Ay="requests",Er=`${Iy}@${1.5}:${Cy}:`,wr=`${Er}:PUB_KEY`,Ny=Object.defineProperty,Sy=Object.defineProperties,Ty=Object.getOwnPropertyDescriptors,mh=Object.getOwnPropertySymbols,Oy=Object.prototype.hasOwnProperty,Ry=Object.prototype.propertyIsEnumerable,Po=(s,e,t)=>e in s?Ny(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,se=(s,e)=>{for(var t in e||(e={}))Oy.call(e,t)&&Po(s,t,e[t]);if(mh)for(var t of mh(e))Ry.call(e,t)&&Po(s,t,e[t]);return s},De=(s,e)=>Sy(s,Ty(e)),E=(s,e,t)=>Po(s,typeof e!="symbol"?e+"":e,t),Ao=class extends Ji{constructor(e){super(e),E(this,"name",vy),E(this,"events",new br.default),E(this,"initialized",!1),E(this,"requestQueue",{state:Ct.idle,queue:[]}),E(this,"sessionRequestQueue",{state:Ct.idle,queue:[]}),E(this,"requestQueueDelay",z.ONE_SECOND),E(this,"expectedPairingMethodMap",new Map),E(this,"recentlyDeletedMap",new Map),E(this,"recentlyDeletedLimit",200),E(this,"relayMessageCache",[]),E(this,"pendingSessions",new Map),E(this,"init",async()=>{this.initialized||(await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.registerPairingEvents(),await this.registerLinkModeListeners(),this.client.core.pairing.register({methods:Object.keys(Ee)}),this.initialized=!0,setTimeout(async()=>{await this.processPendingMessageEvents(),this.sessionRequestQueue.queue=this.getPendingSessionRequests(),this.processSessionRequestQueue()},(0,z.toMiliseconds)(this.requestQueueDelay)))}),E(this,"connect",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();let i=De(se({},t),{requiredNamespaces:t.requiredNamespaces||{},optionalNamespaces:t.optionalNamespaces||{}});await this.isValidConnect(i),i.optionalNamespaces=cl(i.requiredNamespaces,i.optionalNamespaces),i.requiredNamespaces={};let{pairingTopic:r,requiredNamespaces:n,optionalNamespaces:o,sessionProperties:a,scopedProperties:c,relays:l}=i,h=r,p,d=!1;try{if(h){let P=this.client.core.pairing.pairings.get(h);this.client.logger.warn("connect() with existing pairing topic is deprecated and will be removed in the next major release."),d=P.active}}catch(P){throw this.client.logger.error(`connect() -> pairing.get(${h}) failed`),P}if(!h||!d){let{topic:P,uri:N}=await this.client.core.pairing.create();h=P,p=N}if(!h){let{message:P}=R("NO_MATCHING_KEY",`connect() pairing topic: ${h}`);throw new Error(P)}let g=await this.client.core.crypto.generateKeyPair(),f=Ee.wc_sessionPropose.req.ttl||z.FIVE_MINUTES,m=he(f),u=De(se(se({requiredNamespaces:n,optionalNamespaces:o,relays:l??[{protocol:Eo}],proposer:{publicKey:g,metadata:this.client.metadata},expiryTimestamp:m,pairingTopic:h},a&&{sessionProperties:a}),c&&{scopedProperties:c}),{id:At()}),w=Y("session_connect",u.id),{reject:y,resolve:v,done:_}=Ut(f,gh),O=({id:P})=>{P===u.id&&(this.client.events.off("proposal_expire",O),this.pendingSessions.delete(u.id),this.events.emit(w,{error:{message:gh,code:0}}))};return this.client.events.on("proposal_expire",O),this.events.once(w,({error:P,session:N})=>{this.client.events.off("proposal_expire",O),P?y(P):N&&v(N)}),await this.sendRequest({topic:h,method:"wc_sessionPropose",params:u,throwOnFailedPublish:!0,clientRpcId:u.id}),await this.setProposal(u.id,u),{uri:p,approval:_}}),E(this,"pair",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{return await this.client.core.pairing.pair(t)}catch(i){throw this.client.logger.error("pair() failed"),i}}),E(this,"approve",async t=>{var i,r,n;let o=this.client.core.eventClient.createEvent({properties:{topic:(i=t?.id)==null?void 0:i.toString(),trace:[et.session_approve_started]}});try{this.isInitialized(),await this.confirmOnlineStateOrThrow()}catch(b){throw o.setError(Yt.no_internet_connection),b}try{await this.isValidProposalId(t?.id)}catch(b){throw this.client.logger.error(`approve() -> proposal.get(${t?.id}) failed`),o.setError(Yt.proposal_not_found),b}try{await this.isValidApprove(t)}catch(b){throw this.client.logger.error("approve() -> isValidApprove() failed"),o.setError(Yt.session_approve_namespace_validation_failure),b}let{id:a,relayProtocol:c,namespaces:l,sessionProperties:h,scopedProperties:p,sessionConfig:d}=t,g=this.client.proposal.get(a);this.client.core.eventClient.deleteEvent({eventId:o.eventId});let{pairingTopic:f,proposer:m,requiredNamespaces:u,optionalNamespaces:w}=g,y=(r=this.client.core.eventClient)==null?void 0:r.getEvent({topic:f});y||(y=(n=this.client.core.eventClient)==null?void 0:n.createEvent({type:et.session_approve_started,properties:{topic:f,trace:[et.session_approve_started,et.session_namespaces_validation_success]}}));let v=await this.client.core.crypto.generateKeyPair(),_=m.publicKey,O=await this.client.core.crypto.generateSharedKey(v,_),P=se(se(se({relay:{protocol:c??"irn"},namespaces:l,controller:{publicKey:v,metadata:this.client.metadata},expiry:he(js)},h&&{sessionProperties:h}),p&&{scopedProperties:p}),d&&{sessionConfig:d}),N=ne.relay;y.addTrace(et.subscribing_session_topic);try{await this.client.core.relayer.subscribe(O,{transportType:N})}catch(b){throw y.setError(Yt.subscribe_session_topic_failure),b}y.addTrace(et.subscribe_session_topic_success);let x=De(se({},P),{topic:O,requiredNamespaces:u,optionalNamespaces:w,pairingTopic:f,acknowledged:!1,self:P.controller,peer:{publicKey:m.publicKey,metadata:m.metadata},controller:v,transportType:ne.relay});await this.client.session.set(O,x),y.addTrace(et.store_session);try{y.addTrace(et.publishing_session_settle),await this.sendRequest({topic:O,method:"wc_sessionSettle",params:P,throwOnFailedPublish:!0}).catch(b=>{throw y?.setError(Yt.session_settle_publish_failure),b}),y.addTrace(et.session_settle_publish_success),y.addTrace(et.publishing_session_approve),await this.sendResult({id:a,topic:f,result:{relay:{protocol:c??"irn"},responderPublicKey:v},throwOnFailedPublish:!0}).catch(b=>{throw y?.setError(Yt.session_approve_publish_failure),b}),y.addTrace(et.session_approve_publish_success)}catch(b){throw this.client.logger.error(b),this.client.session.delete(O,Z("USER_DISCONNECTED")),await this.client.core.relayer.unsubscribe(O),b}return this.client.core.eventClient.deleteEvent({eventId:y.eventId}),await this.client.core.pairing.updateMetadata({topic:f,metadata:m.metadata}),await this.client.proposal.delete(a,Z("USER_DISCONNECTED")),await this.client.core.pairing.activate({topic:f}),await this.setExpiry(O,he(js)),{topic:O,acknowledged:()=>Promise.resolve(this.client.session.get(O))}}),E(this,"reject",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidReject(t)}catch(o){throw this.client.logger.error("reject() -> isValidReject() failed"),o}let{id:i,reason:r}=t,n;try{n=this.client.proposal.get(i).pairingTopic}catch(o){throw this.client.logger.error(`reject() -> proposal.get(${i}) failed`),o}n&&(await this.sendError({id:i,topic:n,error:r,rpcOpts:Ee.wc_sessionPropose.reject}),await this.client.proposal.delete(i,Z("USER_DISCONNECTED")))}),E(this,"update",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidUpdate(t)}catch(p){throw this.client.logger.error("update() -> isValidUpdate() failed"),p}let{topic:i,namespaces:r}=t,{done:n,resolve:o,reject:a}=Ut(),c=At(),l=jt().toString(),h=this.client.session.get(i).namespaces;return this.events.once(Y("session_update",c),({error:p})=>{p?a(p):o()}),await this.client.session.update(i,{namespaces:r}),await this.sendRequest({topic:i,method:"wc_sessionUpdate",params:{namespaces:r},throwOnFailedPublish:!0,clientRpcId:c,relayRpcId:l}).catch(p=>{this.client.logger.error(p),this.client.session.update(i,{namespaces:h}),a(p)}),{acknowledged:n}}),E(this,"extend",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidExtend(t)}catch(c){throw this.client.logger.error("extend() -> isValidExtend() failed"),c}let{topic:i}=t,r=At(),{done:n,resolve:o,reject:a}=Ut();return this.events.once(Y("session_extend",r),({error:c})=>{c?a(c):o()}),await this.setExpiry(i,he(js)),this.sendRequest({topic:i,method:"wc_sessionExtend",params:{},clientRpcId:r,throwOnFailedPublish:!0}).catch(c=>{a(c)}),{acknowledged:n}}),E(this,"request",async t=>{this.isInitialized();try{await this.isValidRequest(t)}catch(w){throw this.client.logger.error("request() -> isValidRequest() failed"),w}let{chainId:i,request:r,topic:n,expiry:o=Ee.wc_sessionRequest.req.ttl}=t,a=this.client.session.get(n);a?.transportType===ne.relay&&await this.confirmOnlineStateOrThrow();let c=At(),l=jt().toString(),{done:h,resolve:p,reject:d}=Ut(o,"Request expired. Please try again.");this.events.once(Y("session_request",c),({error:w,result:y})=>{w?d(w):p(y)});let g="wc_sessionRequest",f=this.getAppLinkIfEnabled(a.peer.metadata,a.transportType);if(f)return await this.sendRequest({clientRpcId:c,relayRpcId:l,topic:n,method:g,params:{request:De(se({},r),{expiryTimestamp:he(o)}),chainId:i},expiry:o,throwOnFailedPublish:!0,appLink:f}).catch(w=>d(w)),this.client.events.emit("session_request_sent",{topic:n,request:r,chainId:i,id:c}),await h();let m={request:De(se({},r),{expiryTimestamp:he(o)}),chainId:i},u=this.shouldSetTVF(g,m);return await Promise.all([new Promise(async w=>{await this.sendRequest(se({clientRpcId:c,relayRpcId:l,topic:n,method:g,params:m,expiry:o,throwOnFailedPublish:!0},u&&{tvf:this.getTVFParams(c,m)})).catch(y=>d(y)),this.client.events.emit("session_request_sent",{topic:n,request:r,chainId:i,id:c}),w()}),new Promise(async w=>{var y;if(!((y=a.sessionConfig)!=null&&y.disableDeepLink)){let v=await bc(this.client.core.storage,uh);await vc({id:c,topic:n,wcDeepLink:v})}w()}),h()]).then(w=>w[2])}),E(this,"respond",async t=>{this.isInitialized(),await this.isValidRespond(t);let{topic:i,response:r}=t,{id:n}=r,o=this.client.session.get(i);o.transportType===ne.relay&&await this.confirmOnlineStateOrThrow();let a=this.getAppLinkIfEnabled(o.peer.metadata,o.transportType);it(r)?await this.sendResult({id:n,topic:i,result:r.result,throwOnFailedPublish:!0,appLink:a}):Xe(r)&&await this.sendError({id:n,topic:i,error:r.error,appLink:a}),this.cleanupAfterResponse(t)}),E(this,"ping",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidPing(t)}catch(r){throw this.client.logger.error("ping() -> isValidPing() failed"),r}let{topic:i}=t;if(this.client.session.keys.includes(i)){let r=At(),n=jt().toString(),{done:o,resolve:a,reject:c}=Ut();this.events.once(Y("session_ping",r),({error:l})=>{l?c(l):a()}),await Promise.all([this.sendRequest({topic:i,method:"wc_sessionPing",params:{},throwOnFailedPublish:!0,clientRpcId:r,relayRpcId:n}),o()])}else this.client.core.pairing.pairings.keys.includes(i)&&(this.client.logger.warn("ping() on pairing topic is deprecated and will be removed in the next major release."),await this.client.core.pairing.ping({topic:i}))}),E(this,"emit",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow(),await this.isValidEmit(t);let{topic:i,event:r,chainId:n}=t,o=jt().toString(),a=At();await this.sendRequest({topic:i,method:"wc_sessionEvent",params:{event:r,chainId:n},throwOnFailedPublish:!0,relayRpcId:o,clientRpcId:a})}),E(this,"disconnect",async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow(),await this.isValidDisconnect(t);let{topic:i}=t;if(this.client.session.keys.includes(i))await this.sendRequest({topic:i,method:"wc_sessionDelete",params:Z("USER_DISCONNECTED"),throwOnFailedPublish:!0}),await this.deleteSession({topic:i,emitEvent:!1});else if(this.client.core.pairing.pairings.keys.includes(i))await this.client.core.pairing.disconnect({topic:i});else{let{message:r}=R("MISMATCHED_TOPIC",`Session or pairing topic not found: ${i}`);throw new Error(r)}}),E(this,"find",t=>(this.isInitialized(),this.client.session.getAll().filter(i=>ll(i,t)))),E(this,"getPendingSessionRequests",()=>this.client.pendingRequest.getAll()),E(this,"authenticate",async(t,i)=>{var r;this.isInitialized(),this.isValidAuthenticate(t);let n=i&&this.client.core.linkModeSupportedApps.includes(i)&&((r=this.client.metadata.redirect)==null?void 0:r.linkMode),o=n?ne.link_mode:ne.relay;o===ne.relay&&await this.confirmOnlineStateOrThrow();let{chains:a,statement:c="",uri:l,domain:h,nonce:p,type:d,exp:g,nbf:f,methods:m=[],expiry:u}=t,w=[...t.resources||[]],{topic:y,uri:v}=await this.client.core.pairing.create({methods:["wc_sessionAuthenticate"],transportType:o});this.client.logger.info({message:"Generated new pairing",pairing:{topic:y,uri:v}});let _=await this.client.core.crypto.generateKeyPair(),O=xs(_);if(await Promise.all([this.client.auth.authKeys.set(wr,{responseTopic:O,publicKey:_}),this.client.auth.pairingTopics.set(O,{topic:O,pairingTopic:y})]),await this.client.core.relayer.subscribe(O,{transportType:o}),this.client.logger.info(`sending request to new pairing topic: ${y}`),m.length>0){let{namespace:A}=Wt(a[0]),$=Rc(A,"request",m);wi(w)&&($=xc($,w.pop())),w.push($)}let P=u&&u>Ee.wc_sessionAuthenticate.req.ttl?u:Ee.wc_sessionAuthenticate.req.ttl,N={authPayload:{type:d??"caip122",chains:a,statement:c,aud:l,domain:h,version:"1",nonce:p,iat:new Date().toISOString(),exp:g,nbf:f,resources:w},requester:{publicKey:_,metadata:this.client.metadata},expiryTimestamp:he(P)},x={eip155:{chains:a,methods:[...new Set(["personal_sign",...m])],events:["chainChanged","accountsChanged"]}},b={requiredNamespaces:{},optionalNamespaces:x,relays:[{protocol:"irn"}],pairingTopic:y,proposer:{publicKey:_,metadata:this.client.metadata},expiryTimestamp:he(Ee.wc_sessionPropose.req.ttl),id:At()},{done:j,resolve:U,reject:F}=Ut(P,"Request expired"),B=At(),I=Y("session_connect",b.id),T=Y("session_request",B),S=async({error:A,session:$})=>{this.events.off(T,k),A?F(A):$&&U({session:$})},k=async A=>{var $,M,V;if(await this.deletePendingAuthRequest(B,{message:"fulfilled",code:0}),A.error){let ge=Z("WC_METHOD_UNSUPPORTED","wc_sessionAuthenticate");return A.error.code===ge.code?void 0:(this.events.off(I,S),F(A.error.message))}await this.deleteProposal(b.id),this.events.off(I,S);let{cacaos:ie,responder:Q}=A.result,pe=[],ye=[];for(let ge of ie){await In({cacao:ge,projectId:this.client.core.projectId})||(this.client.logger.error(ge,"Signature verification failed"),F(Z("SESSION_SETTLEMENT_FAILED","Signature verification failed")));let{p:Xt}=ge,_t=wi(Xt.resources),pt=[or(Xt.iss)],Pt=yi(Xt.iss);if(_t){let us=_n(_t),xi=Pn(_t);pe.push(...us),pt.push(...xi)}for(let us of pt)ye.push(`${us}:${Pt}`)}let Se=await this.client.core.crypto.generateSharedKey(_,Q.publicKey),ue;pe.length>0&&(ue={topic:Se,acknowledged:!0,self:{publicKey:_,metadata:this.client.metadata},peer:Q,controller:Q.publicKey,expiry:he(js),requiredNamespaces:{},optionalNamespaces:{},relay:{protocol:"irn"},pairingTopic:y,namespaces:Un([...new Set(pe)],[...new Set(ye)]),transportType:o},await this.client.core.relayer.subscribe(Se,{transportType:o}),await this.client.session.set(Se,ue),y&&await this.client.core.pairing.updateMetadata({topic:y,metadata:Q.metadata}),ue=this.client.session.get(Se)),($=this.client.metadata.redirect)!=null&&$.linkMode&&(M=Q.metadata.redirect)!=null&&M.linkMode&&(V=Q.metadata.redirect)!=null&&V.universal&&i&&(this.client.core.addLinkModeSupportedApp(Q.metadata.redirect.universal),this.client.session.update(Se,{transportType:ne.link_mode})),U({auths:ie,session:ue})};this.events.once(I,S),this.events.once(T,k);let D;try{if(n){let A=ut("wc_sessionAuthenticate",N,B);this.client.core.history.set(y,A);let $=await this.client.core.crypto.encode("",A,{type:Rs,encoding:Ft});D=Ci(i,y,$)}else await Promise.all([this.sendRequest({topic:y,method:"wc_sessionAuthenticate",params:N,expiry:t.expiry,throwOnFailedPublish:!0,clientRpcId:B}),this.sendRequest({topic:y,method:"wc_sessionPropose",params:b,expiry:Ee.wc_sessionPropose.req.ttl,throwOnFailedPublish:!0,clientRpcId:b.id})])}catch(A){throw this.events.off(I,S),this.events.off(T,k),A}return await this.setProposal(b.id,b),await this.setAuthRequest(B,{request:De(se({},N),{verifyContext:{}}),pairingTopic:y,transportType:o}),{uri:D??v,response:j}}),E(this,"approveSessionAuthenticate",async t=>{let{id:i,auths:r}=t,n=this.client.core.eventClient.createEvent({properties:{topic:i.toString(),trace:[Jt.authenticated_session_approve_started]}});try{this.isInitialized()}catch(u){throw n.setError(qs.no_internet_connection),u}let o=this.getPendingAuthRequest(i);if(!o)throw n.setError(qs.authenticated_session_pending_request_not_found),new Error(`Could not find pending auth request with id ${i}`);let a=o.transportType||ne.relay;a===ne.relay&&await this.confirmOnlineStateOrThrow();let c=o.requester.publicKey,l=await this.client.core.crypto.generateKeyPair(),h=xs(c),p={type:at,receiverPublicKey:c,senderPublicKey:l},d=[],g=[];for(let u of r){if(!await In({cacao:u,projectId:this.client.core.projectId})){n.setError(qs.invalid_cacao);let O=Z("SESSION_SETTLEMENT_FAILED","Signature verification failed");throw await this.sendError({id:i,topic:h,error:O,encodeOpts:p}),new Error(O.message)}n.addTrace(Jt.cacaos_verified);let{p:w}=u,y=wi(w.resources),v=[or(w.iss)],_=yi(w.iss);if(y){let O=_n(y),P=Pn(y);d.push(...O),v.push(...P)}for(let O of v)g.push(`${O}:${_}`)}let f=await this.client.core.crypto.generateSharedKey(l,c);n.addTrace(Jt.create_authenticated_session_topic);let m;if(d?.length>0){m={topic:f,acknowledged:!0,self:{publicKey:l,metadata:this.client.metadata},peer:{publicKey:c,metadata:o.requester.metadata},controller:c,expiry:he(js),authentication:r,requiredNamespaces:{},optionalNamespaces:{},relay:{protocol:"irn"},pairingTopic:o.pairingTopic,namespaces:Un([...new Set(d)],[...new Set(g)]),transportType:a},n.addTrace(Jt.subscribing_authenticated_session_topic);try{await this.client.core.relayer.subscribe(f,{transportType:a})}catch(u){throw n.setError(qs.subscribe_authenticated_session_topic_failure),u}n.addTrace(Jt.subscribe_authenticated_session_topic_success),await this.client.session.set(f,m),n.addTrace(Jt.store_authenticated_session),await this.client.core.pairing.updateMetadata({topic:o.pairingTopic,metadata:o.requester.metadata})}n.addTrace(Jt.publishing_authenticated_session_approve);try{await this.sendResult({topic:h,id:i,result:{cacaos:r,responder:{publicKey:l,metadata:this.client.metadata}},encodeOpts:p,throwOnFailedPublish:!0,appLink:this.getAppLinkIfEnabled(o.requester.metadata,a)})}catch(u){throw n.setError(qs.authenticated_session_approve_publish_failure),u}return await this.client.auth.requests.delete(i,{message:"fulfilled",code:0}),await this.client.core.pairing.activate({topic:o.pairingTopic}),this.client.core.eventClient.deleteEvent({eventId:n.eventId}),{session:m}}),E(this,"rejectSessionAuthenticate",async t=>{this.isInitialized();let{id:i,reason:r}=t,n=this.getPendingAuthRequest(i);if(!n)throw new Error(`Could not find pending auth request with id ${i}`);n.transportType===ne.relay&&await this.confirmOnlineStateOrThrow();let o=n.requester.publicKey,a=await this.client.core.crypto.generateKeyPair(),c=xs(o),l={type:at,receiverPublicKey:o,senderPublicKey:a};await this.sendError({id:i,topic:c,error:r,encodeOpts:l,rpcOpts:Ee.wc_sessionAuthenticate.reject,appLink:this.getAppLinkIfEnabled(n.requester.metadata,n.transportType)}),await this.client.auth.requests.delete(i,{message:"rejected",code:0}),await this.client.proposal.delete(i,Z("USER_DISCONNECTED"))}),E(this,"formatAuthMessage",t=>{this.isInitialized();let{request:i,iss:r}=t;return Cn(i,r)}),E(this,"processRelayMessageCache",()=>{setTimeout(async()=>{if(this.relayMessageCache.length!==0)for(;this.relayMessageCache.length>0;)try{let t=this.relayMessageCache.shift();t&&await this.onRelayMessage(t)}catch(t){this.client.logger.error(t)}},50)}),E(this,"cleanupDuplicatePairings",async t=>{if(t.pairingTopic)try{let i=this.client.core.pairing.pairings.get(t.pairingTopic),r=this.client.core.pairing.pairings.getAll().filter(n=>{var o,a;return((o=n.peerMetadata)==null?void 0:o.url)&&((a=n.peerMetadata)==null?void 0:a.url)===t.peer.metadata.url&&n.topic&&n.topic!==i.topic});if(r.length===0)return;this.client.logger.info(`Cleaning up ${r.length} duplicate pairing(s)`),await Promise.all(r.map(n=>this.client.core.pairing.disconnect({topic:n.topic}))),this.client.logger.info("Duplicate pairings clean up finished")}catch(i){this.client.logger.error(i)}}),E(this,"deleteSession",async t=>{var i;let{topic:r,expirerHasDeleted:n=!1,emitEvent:o=!0,id:a=0}=t,{self:c}=this.client.session.get(r);await this.client.core.relayer.unsubscribe(r),await this.client.session.delete(r,Z("USER_DISCONNECTED")),this.addToRecentlyDeleted(r,"session"),this.client.core.crypto.keychain.has(c.publicKey)&&await this.client.core.crypto.deleteKeyPair(c.publicKey),this.client.core.crypto.keychain.has(r)&&await this.client.core.crypto.deleteSymKey(r),n||this.client.core.expirer.del(r),this.client.core.storage.removeItem(uh).catch(l=>this.client.logger.warn(l)),this.getPendingSessionRequests().forEach(l=>{l.topic===r&&this.deletePendingSessionRequest(l.id,Z("USER_DISCONNECTED"))}),r===((i=this.sessionRequestQueue.queue[0])==null?void 0:i.topic)&&(this.sessionRequestQueue.state=Ct.idle),o&&this.client.events.emit("session_delete",{id:a,topic:r})}),E(this,"deleteProposal",async(t,i)=>{if(i)try{let r=this.client.proposal.get(t);this.client.core.eventClient.getEvent({topic:r.pairingTopic})?.setError(Yt.proposal_expired)}catch{}await Promise.all([this.client.proposal.delete(t,Z("USER_DISCONNECTED")),i?Promise.resolve():this.client.core.expirer.del(t)]),this.addToRecentlyDeleted(t,"proposal")}),E(this,"deletePendingSessionRequest",async(t,i,r=!1)=>{await Promise.all([this.client.pendingRequest.delete(t,i),r?Promise.resolve():this.client.core.expirer.del(t)]),this.addToRecentlyDeleted(t,"request"),this.sessionRequestQueue.queue=this.sessionRequestQueue.queue.filter(n=>n.id!==t),r&&(this.sessionRequestQueue.state=Ct.idle,this.client.events.emit("session_request_expire",{id:t}))}),E(this,"deletePendingAuthRequest",async(t,i,r=!1)=>{await Promise.all([this.client.auth.requests.delete(t,i),r?Promise.resolve():this.client.core.expirer.del(t)])}),E(this,"setExpiry",async(t,i)=>{this.client.session.keys.includes(t)&&(this.client.core.expirer.set(t,i),await this.client.session.update(t,{expiry:i}))}),E(this,"setProposal",async(t,i)=>{this.client.core.expirer.set(t,he(Ee.wc_sessionPropose.req.ttl)),await this.client.proposal.set(t,i)}),E(this,"setAuthRequest",async(t,i)=>{let{request:r,pairingTopic:n,transportType:o=ne.relay}=i;this.client.core.expirer.set(t,r.expiryTimestamp),await this.client.auth.requests.set(t,{authPayload:r.authPayload,requester:r.requester,expiryTimestamp:r.expiryTimestamp,id:t,pairingTopic:n,verifyContext:r.verifyContext,transportType:o})}),E(this,"setPendingSessionRequest",async t=>{let{id:i,topic:r,params:n,verifyContext:o}=t,a=n.request.expiryTimestamp||he(Ee.wc_sessionRequest.req.ttl);this.client.core.expirer.set(i,a),await this.client.pendingRequest.set(i,{id:i,topic:r,params:n,verifyContext:o})}),E(this,"sendRequest",async t=>{let{topic:i,method:r,params:n,expiry:o,relayRpcId:a,clientRpcId:c,throwOnFailedPublish:l,appLink:h,tvf:p}=t,d=ut(r,n,c),g,f=!!h;try{let w=f?Ft:Ke;g=await this.client.core.crypto.encode(i,d,{encoding:w})}catch(w){throw await this.cleanup(),this.client.logger.error(`sendRequest() -> core.crypto.encode() for topic ${i} failed`),w}let m;if(Ey.includes(r)){let w=Ze(JSON.stringify(d)),y=Ze(g);m=await this.client.core.verify.register({id:y,decryptedId:w})}let u=Ee[r].req;if(u.attestation=m,o&&(u.ttl=o),a&&(u.id=a),this.client.core.history.set(i,d),f){let w=Ci(h,i,g);await global.Linking.openURL(w,this.client.name)}else{let w=Ee[r].req;o&&(w.ttl=o),a&&(w.id=a),w.tvf=De(se({},p),{correlationId:d.id}),l?(w.internal=De(se({},w.internal),{throwOnFailedPublish:!0}),await this.client.core.relayer.publish(i,g,w)):this.client.core.relayer.publish(i,g,w).catch(y=>this.client.logger.error(y))}return d.id}),E(this,"sendResult",async t=>{let{id:i,topic:r,result:n,throwOnFailedPublish:o,encodeOpts:a,appLink:c}=t,l=ts(i,n),h,p=c&&typeof(global==null?void 0:global.Linking)<"u";try{let f=p?Ft:Ke;h=await this.client.core.crypto.encode(r,l,De(se({},a||{}),{encoding:f}))}catch(f){throw await this.cleanup(),this.client.logger.error(`sendResult() -> core.crypto.encode() for topic ${r} failed`),f}let d,g;try{d=await this.client.core.history.get(r,i);let f=d.request;try{this.shouldSetTVF(f.method,f.params)&&(g=this.getTVFParams(i,f.params,n))}catch(m){this.client.logger.warn("sendResult() -> getTVFParams() failed",m)}}catch(f){throw this.client.logger.error(`sendResult() -> history.get(${r}, ${i}) failed`),f}if(p){let f=Ci(c,r,h);await global.Linking.openURL(f,this.client.name)}else{let f=d.request.method,m=Ee[f].res;m.tvf=De(se({},g),{correlationId:i}),o?(m.internal=De(se({},m.internal),{throwOnFailedPublish:!0}),await this.client.core.relayer.publish(r,h,m)):this.client.core.relayer.publish(r,h,m).catch(u=>this.client.logger.error(u))}await this.client.core.history.resolve(l)}),E(this,"sendError",async t=>{let{id:i,topic:r,error:n,encodeOpts:o,rpcOpts:a,appLink:c}=t,l=Ui(i,n),h,p=c&&typeof(global==null?void 0:global.Linking)<"u";try{let g=p?Ft:Ke;h=await this.client.core.crypto.encode(r,l,De(se({},o||{}),{encoding:g}))}catch(g){throw await this.cleanup(),this.client.logger.error(`sendError() -> core.crypto.encode() for topic ${r} failed`),g}let d;try{d=await this.client.core.history.get(r,i)}catch(g){throw this.client.logger.error(`sendError() -> history.get(${r}, ${i}) failed`),g}if(p){let g=Ci(c,r,h);await global.Linking.openURL(g,this.client.name)}else{let g=d.request.method,f=a||Ee[g].res;this.client.core.relayer.publish(r,h,f)}await this.client.core.history.resolve(l)}),E(this,"cleanup",async()=>{let t=[],i=[];this.client.session.getAll().forEach(r=>{let n=!1;mt(r.expiry)&&(n=!0),this.client.core.crypto.keychain.has(r.topic)||(n=!0),n&&t.push(r.topic)}),this.client.proposal.getAll().forEach(r=>{mt(r.expiryTimestamp)&&i.push(r.id)}),await Promise.all([...t.map(r=>this.deleteSession({topic:r})),...i.map(r=>this.deleteProposal(r))])}),E(this,"onProviderMessageEvent",async t=>{!this.initialized||this.relayMessageCache.length>0?this.relayMessageCache.push(t):await this.onRelayMessage(t)}),E(this,"onRelayEventRequest",async t=>{this.requestQueue.queue.push(t),await this.processRequestsQueue()}),E(this,"processRequestsQueue",async()=>{if(this.requestQueue.state===Ct.active){this.client.logger.info("Request queue already active, skipping...");return}for(this.client.logger.info(`Request queue starting with ${this.requestQueue.queue.length} requests`);this.requestQueue.queue.length>0;){this.requestQueue.state=Ct.active;let t=this.requestQueue.queue.shift();if(t)try{await this.processRequest(t)}catch(i){this.client.logger.warn(i)}}this.requestQueue.state=Ct.idle}),E(this,"processRequest",async t=>{let{topic:i,payload:r,attestation:n,transportType:o,encryptedId:a}=t,c=r.method;if(!this.shouldIgnorePairingRequest({topic:i,requestMethod:c}))switch(c){case"wc_sessionPropose":return await this.onSessionProposeRequest({topic:i,payload:r,attestation:n,encryptedId:a});case"wc_sessionSettle":return await this.onSessionSettleRequest(i,r);case"wc_sessionUpdate":return await this.onSessionUpdateRequest(i,r);case"wc_sessionExtend":return await this.onSessionExtendRequest(i,r);case"wc_sessionPing":return await this.onSessionPingRequest(i,r);case"wc_sessionDelete":return await this.onSessionDeleteRequest(i,r);case"wc_sessionRequest":return await this.onSessionRequest({topic:i,payload:r,attestation:n,encryptedId:a,transportType:o});case"wc_sessionEvent":return await this.onSessionEventRequest(i,r);case"wc_sessionAuthenticate":return await this.onSessionAuthenticateRequest({topic:i,payload:r,attestation:n,encryptedId:a,transportType:o});default:return this.client.logger.info(`Unsupported request method ${c}`)}}),E(this,"onRelayEventResponse",async t=>{let{topic:i,payload:r,transportType:n}=t,o=(await this.client.core.history.get(i,r.id)).request.method;switch(o){case"wc_sessionPropose":return this.onSessionProposeResponse(i,r,n);case"wc_sessionSettle":return this.onSessionSettleResponse(i,r);case"wc_sessionUpdate":return this.onSessionUpdateResponse(i,r);case"wc_sessionExtend":return this.onSessionExtendResponse(i,r);case"wc_sessionPing":return this.onSessionPingResponse(i,r);case"wc_sessionRequest":return this.onSessionRequestResponse(i,r);case"wc_sessionAuthenticate":return this.onSessionAuthenticateResponse(i,r);default:return this.client.logger.info(`Unsupported response method ${o}`)}}),E(this,"onRelayEventUnknownPayload",t=>{let{topic:i}=t,{message:r}=R("MISSING_OR_INVALID",`Decoded payload on topic ${i} is not identifiable as a JSON-RPC request or a response.`);throw new Error(r)}),E(this,"shouldIgnorePairingRequest",t=>{let{topic:i,requestMethod:r}=t,n=this.expectedPairingMethodMap.get(i);return!n||n.includes(r)?!1:!!(n.includes("wc_sessionAuthenticate")&&this.client.events.listenerCount("session_authenticate")>0)}),E(this,"onSessionProposeRequest",async t=>{let{topic:i,payload:r,attestation:n,encryptedId:o}=t,{params:a,id:c}=r;try{let l=this.client.core.eventClient.getEvent({topic:i});this.client.events.listenerCount("session_proposal")===0&&(console.warn("No listener for session_proposal event"),l?.setError(bt.proposal_listener_not_found)),this.isValidConnect(se({},r.params));let h=a.expiryTimestamp||he(Ee.wc_sessionPropose.req.ttl),p=se({id:c,pairingTopic:i,expiryTimestamp:h},a);await this.setProposal(c,p);let d=await this.getVerifyContext({attestationId:n,hash:Ze(JSON.stringify(r)),encryptedId:o,metadata:p.proposer.metadata});l?.addTrace(ht.emit_session_proposal),this.client.events.emit("session_proposal",{id:c,params:p,verifyContext:d})}catch(l){await this.sendError({id:c,topic:i,error:l,rpcOpts:Ee.wc_sessionPropose.autoReject}),this.client.logger.error(l)}}),E(this,"onSessionProposeResponse",async(t,i,r)=>{let{id:n}=i;if(it(i)){let{result:o}=i;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",result:o});let a=this.client.proposal.get(n);this.client.logger.trace({type:"method",method:"onSessionProposeResponse",proposal:a});let c=a.proposer.publicKey;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",selfPublicKey:c});let l=o.responderPublicKey;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",peerPublicKey:l});let h=await this.client.core.crypto.generateSharedKey(c,l);this.pendingSessions.set(n,{sessionTopic:h,pairingTopic:t,proposalId:n,publicKey:c});let p=await this.client.core.relayer.subscribe(h,{transportType:r});this.client.logger.trace({type:"method",method:"onSessionProposeResponse",subscriptionId:p}),await this.client.core.pairing.activate({topic:t})}else if(Xe(i)){await this.client.proposal.delete(n,Z("USER_DISCONNECTED"));let o=Y("session_connect",n);if(this.events.listenerCount(o)===0)throw new Error(`emitting ${o} without any listeners, 954`);this.events.emit(o,{error:i.error})}}),E(this,"onSessionSettleRequest",async(t,i)=>{let{id:r,params:n}=i;try{this.isValidSessionSettleRequest(n);let{relay:o,controller:a,expiry:c,namespaces:l,sessionProperties:h,scopedProperties:p,sessionConfig:d}=i.params,g=[...this.pendingSessions.values()].find(u=>u.sessionTopic===t);if(!g)return this.client.logger.error(`Pending session not found for topic ${t}`);let f=this.client.proposal.get(g.proposalId),m=De(se(se(se({topic:t,relay:o,expiry:c,namespaces:l,acknowledged:!0,pairingTopic:g.pairingTopic,requiredNamespaces:f.requiredNamespaces,optionalNamespaces:f.optionalNamespaces,controller:a.publicKey,self:{publicKey:g.publicKey,metadata:this.client.metadata},peer:{publicKey:a.publicKey,metadata:a.metadata}},h&&{sessionProperties:h}),p&&{scopedProperties:p}),d&&{sessionConfig:d}),{transportType:ne.relay});await this.client.session.set(m.topic,m),await this.setExpiry(m.topic,m.expiry),await this.client.core.pairing.updateMetadata({topic:g.pairingTopic,metadata:m.peer.metadata}),this.client.events.emit("session_connect",{session:m}),this.events.emit(Y("session_connect",g.proposalId),{session:m}),this.pendingSessions.delete(g.proposalId),this.deleteProposal(g.proposalId,!1),this.cleanupDuplicatePairings(m),await this.sendResult({id:i.id,topic:t,result:!0,throwOnFailedPublish:!0})}catch(o){await this.sendError({id:r,topic:t,error:o}),this.client.logger.error(o)}}),E(this,"onSessionSettleResponse",async(t,i)=>{let{id:r}=i;it(i)?(await this.client.session.update(t,{acknowledged:!0}),this.events.emit(Y("session_approve",r),{})):Xe(i)&&(await this.client.session.delete(t,Z("USER_DISCONNECTED")),this.events.emit(Y("session_approve",r),{error:i.error}))}),E(this,"onSessionUpdateRequest",async(t,i)=>{let{params:r,id:n}=i;try{let o=`${t}_session_update`,a=Kt.get(o);if(a&&this.isRequestOutOfSync(a,n)){this.client.logger.warn(`Discarding out of sync request - ${n}`),this.sendError({id:n,topic:t,error:Z("INVALID_UPDATE_REQUEST")});return}this.isValidUpdate(se({topic:t},r));try{Kt.set(o,n),await this.client.session.update(t,{namespaces:r.namespaces}),await this.sendResult({id:n,topic:t,result:!0,throwOnFailedPublish:!0})}catch(c){throw Kt.delete(o),c}this.client.events.emit("session_update",{id:n,topic:t,params:r})}catch(o){await this.sendError({id:n,topic:t,error:o}),this.client.logger.error(o)}}),E(this,"isRequestOutOfSync",(t,i)=>i.toString().slice(0,-3)<t.toString().slice(0,-3)),E(this,"onSessionUpdateResponse",(t,i)=>{let{id:r}=i,n=Y("session_update",r);if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners`);it(i)?this.events.emit(Y("session_update",r),{}):Xe(i)&&this.events.emit(Y("session_update",r),{error:i.error})}),E(this,"onSessionExtendRequest",async(t,i)=>{let{id:r}=i;try{this.isValidExtend({topic:t}),await this.setExpiry(t,he(js)),await this.sendResult({id:r,topic:t,result:!0,throwOnFailedPublish:!0}),this.client.events.emit("session_extend",{id:r,topic:t})}catch(n){await this.sendError({id:r,topic:t,error:n}),this.client.logger.error(n)}}),E(this,"onSessionExtendResponse",(t,i)=>{let{id:r}=i,n=Y("session_extend",r);if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners`);it(i)?this.events.emit(Y("session_extend",r),{}):Xe(i)&&this.events.emit(Y("session_extend",r),{error:i.error})}),E(this,"onSessionPingRequest",async(t,i)=>{let{id:r}=i;try{this.isValidPing({topic:t}),await this.sendResult({id:r,topic:t,result:!0,throwOnFailedPublish:!0}),this.client.events.emit("session_ping",{id:r,topic:t})}catch(n){await this.sendError({id:r,topic:t,error:n}),this.client.logger.error(n)}}),E(this,"onSessionPingResponse",(t,i)=>{let{id:r}=i,n=Y("session_ping",r);setTimeout(()=>{if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners 2176`);it(i)?this.events.emit(Y("session_ping",r),{}):Xe(i)&&this.events.emit(Y("session_ping",r),{error:i.error})},500)}),E(this,"onSessionDeleteRequest",async(t,i)=>{let{id:r}=i;try{this.isValidDisconnect({topic:t,reason:i.params}),Promise.all([new Promise(n=>{this.client.core.relayer.once(me.publish,async()=>{n(await this.deleteSession({topic:t,id:r}))})}),this.sendResult({id:r,topic:t,result:!0,throwOnFailedPublish:!0}),this.cleanupPendingSentRequestsForTopic({topic:t,error:Z("USER_DISCONNECTED")})]).catch(n=>this.client.logger.error(n))}catch(n){this.client.logger.error(n)}}),E(this,"onSessionRequest",async t=>{var i,r,n;let{topic:o,payload:a,attestation:c,encryptedId:l,transportType:h}=t,{id:p,params:d}=a;try{await this.isValidRequest(se({topic:o},d));let g=this.client.session.get(o),f=await this.getVerifyContext({attestationId:c,hash:Ze(JSON.stringify(ut("wc_sessionRequest",d,p))),encryptedId:l,metadata:g.peer.metadata,transportType:h}),m={id:p,topic:o,params:d,verifyContext:f};await this.setPendingSessionRequest(m),h===ne.link_mode&&(i=g.peer.metadata.redirect)!=null&&i.universal&&this.client.core.addLinkModeSupportedApp((r=g.peer.metadata.redirect)==null?void 0:r.universal),(n=this.client.signConfig)!=null&&n.disableRequestQueue?this.emitSessionRequest(m):(this.addSessionRequestToSessionRequestQueue(m),this.processSessionRequestQueue())}catch(g){await this.sendError({id:p,topic:o,error:g}),this.client.logger.error(g)}}),E(this,"onSessionRequestResponse",(t,i)=>{let{id:r}=i,n=Y("session_request",r);if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners`);it(i)?this.events.emit(Y("session_request",r),{result:i.result}):Xe(i)&&this.events.emit(Y("session_request",r),{error:i.error})}),E(this,"onSessionEventRequest",async(t,i)=>{let{id:r,params:n}=i;try{let o=`${t}_session_event_${n.event.name}`,a=Kt.get(o);if(a&&this.isRequestOutOfSync(a,r)){this.client.logger.info(`Discarding out of sync request - ${r}`);return}this.isValidEmit(se({topic:t},n)),this.client.events.emit("session_event",{id:r,topic:t,params:n}),Kt.set(o,r)}catch(o){await this.sendError({id:r,topic:t,error:o}),this.client.logger.error(o)}}),E(this,"onSessionAuthenticateResponse",(t,i)=>{let{id:r}=i;this.client.logger.trace({type:"method",method:"onSessionAuthenticateResponse",topic:t,payload:i}),it(i)?this.events.emit(Y("session_request",r),{result:i.result}):Xe(i)&&this.events.emit(Y("session_request",r),{error:i.error})}),E(this,"onSessionAuthenticateRequest",async t=>{var i;let{topic:r,payload:n,attestation:o,encryptedId:a,transportType:c}=t;try{let{requester:l,authPayload:h,expiryTimestamp:p}=n.params,d=await this.getVerifyContext({attestationId:o,hash:Ze(JSON.stringify(n)),encryptedId:a,metadata:l.metadata,transportType:c}),g={requester:l,pairingTopic:r,id:n.id,authPayload:h,verifyContext:d,expiryTimestamp:p};await this.setAuthRequest(n.id,{request:g,pairingTopic:r,transportType:c}),c===ne.link_mode&&(i=l.metadata.redirect)!=null&&i.universal&&this.client.core.addLinkModeSupportedApp(l.metadata.redirect.universal),this.client.events.emit("session_authenticate",{topic:r,params:n.params,id:n.id,verifyContext:d})}catch(l){this.client.logger.error(l);let h=n.params.requester.publicKey,p=await this.client.core.crypto.generateKeyPair(),d=this.getAppLinkIfEnabled(n.params.requester.metadata,c),g={type:at,receiverPublicKey:h,senderPublicKey:p};await this.sendError({id:n.id,topic:r,error:l,encodeOpts:g,rpcOpts:Ee.wc_sessionAuthenticate.autoReject,appLink:d})}}),E(this,"addSessionRequestToSessionRequestQueue",t=>{this.sessionRequestQueue.queue.push(t)}),E(this,"cleanupAfterResponse",t=>{this.deletePendingSessionRequest(t.response.id,{message:"fulfilled",code:0}),setTimeout(()=>{this.sessionRequestQueue.state=Ct.idle,this.processSessionRequestQueue()},(0,z.toMiliseconds)(this.requestQueueDelay))}),E(this,"cleanupPendingSentRequestsForTopic",({topic:t,error:i})=>{let r=this.client.core.history.pending;r.length>0&&r.filter(n=>n.topic===t&&n.request.method==="wc_sessionRequest").forEach(n=>{let o=n.request.id,a=Y("session_request",o);if(this.events.listenerCount(a)===0)throw new Error(`emitting ${a} without any listeners`);this.events.emit(Y("session_request",n.request.id),{error:i})})}),E(this,"processSessionRequestQueue",()=>{if(this.sessionRequestQueue.state===Ct.active){this.client.logger.info("session request queue is already active.");return}let t=this.sessionRequestQueue.queue[0];if(!t){this.client.logger.info("session request queue is empty.");return}try{this.sessionRequestQueue.state=Ct.active,this.emitSessionRequest(t)}catch(i){this.client.logger.error(i)}}),E(this,"emitSessionRequest",t=>{this.client.events.emit("session_request",t)}),E(this,"onPairingCreated",t=>{if(t.methods&&this.expectedPairingMethodMap.set(t.topic,t.methods),t.active)return;let i=this.client.proposal.getAll().find(r=>r.pairingTopic===t.topic);i&&this.onSessionProposeRequest({topic:t.topic,payload:ut("wc_sessionPropose",De(se({},i),{requiredNamespaces:i.requiredNamespaces,optionalNamespaces:i.optionalNamespaces,relays:i.relays,proposer:i.proposer,sessionProperties:i.sessionProperties,scopedProperties:i.scopedProperties}),i.id)})}),E(this,"isValidConnect",async t=>{if(!Re(t)){let{message:l}=R("MISSING_OR_INVALID",`connect() params: ${JSON.stringify(t)}`);throw new Error(l)}let{pairingTopic:i,requiredNamespaces:r,optionalNamespaces:n,sessionProperties:o,scopedProperties:a,relays:c}=t;if(fe(i)||await this.isValidPairingTopic(i),!ml(c,!0)){let{message:l}=R("MISSING_OR_INVALID",`connect() relays: ${c}`);throw new Error(l)}if(!fe(r)&&wt(r)!==0){let l="requiredNamespaces are deprecated and are automatically assigned to optionalNamespaces";["fatal","error","silent"].includes(this.client.logger.level)?console.warn(l):this.client.logger.warn(l),this.validateNamespaces(r,"requiredNamespaces")}if(!fe(n)&&wt(n)!==0&&this.validateNamespaces(n,"optionalNamespaces"),fe(o)||this.validateSessionProps(o,"sessionProperties"),!fe(a)){this.validateSessionProps(a,"scopedProperties");let l=Object.keys(r||{}).concat(Object.keys(n||{}));if(!Object.keys(a).every(h=>l.includes(h)))throw new Error(`Scoped properties must be a subset of required/optional namespaces, received: ${JSON.stringify(a)}, required/optional namespaces: ${JSON.stringify(l)}`)}}),E(this,"validateNamespaces",(t,i)=>{let r=fl(t,"connect()",i);if(r)throw new Error(r.message)}),E(this,"isValidApprove",async t=>{if(!Re(t))throw new Error(R("MISSING_OR_INVALID",`approve() params: ${t}`).message);let{id:i,namespaces:r,relayProtocol:n,sessionProperties:o,scopedProperties:a}=t;this.checkRecentlyDeleted(i),await this.isValidProposalId(i);let c=this.client.proposal.get(i),l=ur(r,"approve()");if(l)throw new Error(l.message);let h=qn(c.requiredNamespaces,r,"approve()");if(h)throw new Error(h.message);if(!ce(n,!0)){let{message:p}=R("MISSING_OR_INVALID",`approve() relayProtocol: ${n}`);throw new Error(p)}if(fe(o)||this.validateSessionProps(o,"sessionProperties"),!fe(a)){this.validateSessionProps(a,"scopedProperties");let p=new Set(Object.keys(r));if(!Object.keys(a).every(d=>p.has(d)))throw new Error(`Scoped properties must be a subset of approved namespaces, received: ${JSON.stringify(a)}, approved namespaces: ${Array.from(p).join(", ")}`)}}),E(this,"isValidReject",async t=>{if(!Re(t)){let{message:n}=R("MISSING_OR_INVALID",`reject() params: ${t}`);throw new Error(n)}let{id:i,reason:r}=t;if(this.checkRecentlyDeleted(i),await this.isValidProposalId(i),!wl(r)){let{message:n}=R("MISSING_OR_INVALID",`reject() reason: ${JSON.stringify(r)}`);throw new Error(n)}}),E(this,"isValidSessionSettleRequest",t=>{if(!Re(t)){let{message:l}=R("MISSING_OR_INVALID",`onSessionSettleRequest() params: ${t}`);throw new Error(l)}let{relay:i,controller:r,namespaces:n,expiry:o}=t;if(!Fn(i)){let{message:l}=R("MISSING_OR_INVALID","onSessionSettleRequest() relay protocol should be a string");throw new Error(l)}let a=ul(r,"onSessionSettleRequest()");if(a)throw new Error(a.message);let c=ur(n,"onSessionSettleRequest()");if(c)throw new Error(c.message);if(mt(o)){let{message:l}=R("EXPIRED","onSessionSettleRequest()");throw new Error(l)}}),E(this,"isValidUpdate",async t=>{if(!Re(t)){let{message:c}=R("MISSING_OR_INVALID",`update() params: ${t}`);throw new Error(c)}let{topic:i,namespaces:r}=t;this.checkRecentlyDeleted(i),await this.isValidSessionTopic(i);let n=this.client.session.get(i),o=ur(r,"update()");if(o)throw new Error(o.message);let a=qn(n.requiredNamespaces,r,"update()");if(a)throw new Error(a.message)}),E(this,"isValidExtend",async t=>{if(!Re(t)){let{message:r}=R("MISSING_OR_INVALID",`extend() params: ${t}`);throw new Error(r)}let{topic:i}=t;this.checkRecentlyDeleted(i),await this.isValidSessionTopic(i)}),E(this,"isValidRequest",async t=>{if(!Re(t)){let{message:c}=R("MISSING_OR_INVALID",`request() params: ${t}`);throw new Error(c)}let{topic:i,request:r,chainId:n,expiry:o}=t;this.checkRecentlyDeleted(i),await this.isValidSessionTopic(i);let{namespaces:a}=this.client.session.get(i);if(!Ln(a,n)){let{message:c}=R("MISSING_OR_INVALID",`request() chainId: ${n}`);throw new Error(c)}if(!vl(r)){let{message:c}=R("MISSING_OR_INVALID",`request() ${JSON.stringify(r)}`);throw new Error(c)}if(!Il(a,n,r.method)){let{message:c}=R("MISSING_OR_INVALID",`request() method: ${r.method}`);throw new Error(c)}if(o&&!_l(o,Co)){let{message:c}=R("MISSING_OR_INVALID",`request() expiry: ${o}. Expiry must be a number (in seconds) between ${Co.min} and ${Co.max}`);throw new Error(c)}}),E(this,"isValidRespond",async t=>{var i;if(!Re(t)){let{message:o}=R("MISSING_OR_INVALID",`respond() params: ${t}`);throw new Error(o)}let{topic:r,response:n}=t;try{await this.isValidSessionTopic(r)}catch(o){throw(i=t?.response)!=null&&i.id&&this.cleanupAfterResponse(t),o}if(!bl(n)){let{message:o}=R("MISSING_OR_INVALID",`respond() response: ${JSON.stringify(n)}`);throw new Error(o)}}),E(this,"isValidPing",async t=>{if(!Re(t)){let{message:r}=R("MISSING_OR_INVALID",`ping() params: ${t}`);throw new Error(r)}let{topic:i}=t;await this.isValidSessionOrPairingTopic(i)}),E(this,"isValidEmit",async t=>{if(!Re(t)){let{message:a}=R("MISSING_OR_INVALID",`emit() params: ${t}`);throw new Error(a)}let{topic:i,event:r,chainId:n}=t;await this.isValidSessionTopic(i);let{namespaces:o}=this.client.session.get(i);if(!Ln(o,n)){let{message:a}=R("MISSING_OR_INVALID",`emit() chainId: ${n}`);throw new Error(a)}if(!El(r)){let{message:a}=R("MISSING_OR_INVALID",`emit() event: ${JSON.stringify(r)}`);throw new Error(a)}if(!Cl(o,n,r.name)){let{message:a}=R("MISSING_OR_INVALID",`emit() event: ${JSON.stringify(r)}`);throw new Error(a)}}),E(this,"isValidDisconnect",async t=>{if(!Re(t)){let{message:r}=R("MISSING_OR_INVALID",`disconnect() params: ${t}`);throw new Error(r)}let{topic:i}=t;await this.isValidSessionOrPairingTopic(i)}),E(this,"isValidAuthenticate",t=>{let{chains:i,uri:r,domain:n,nonce:o}=t;if(!Array.isArray(i)||i.length===0)throw new Error("chains is required and must be a non-empty array");if(!ce(r,!1))throw new Error("uri is required parameter");if(!ce(n,!1))throw new Error("domain is required parameter");if(!ce(o,!1))throw new Error("nonce is required parameter");if([...new Set(i.map(c=>Wt(c).namespace))].length>1)throw new Error("Multi-namespace requests are not supported. Please request single namespace only.");let{namespace:a}=Wt(i[0]);if(a!=="eip155")throw new Error("Only eip155 namespace is supported for authenticated sessions. Please use .connect() for non-eip155 chains.")}),E(this,"getVerifyContext",async t=>{let{attestationId:i,hash:r,encryptedId:n,metadata:o,transportType:a}=t,c={verified:{verifyUrl:o.verifyUrl||Ls,validation:"UNKNOWN",origin:o.url||""}};try{if(a===ne.link_mode){let h=this.getAppLinkIfEnabled(o,a);return c.verified.validation=h&&new URL(h).origin===new URL(o.url).origin?"VALID":"INVALID",c}let l=await this.client.core.verify.resolve({attestationId:i,hash:r,encryptedId:n,verifyUrl:o.verifyUrl});l&&(c.verified.origin=l.origin,c.verified.isScam=l.isScam,c.verified.validation=l.origin===new URL(o.url).origin?"VALID":"INVALID")}catch(l){this.client.logger.warn(l)}return this.client.logger.debug(`Verify context: ${JSON.stringify(c)}`),c}),E(this,"validateSessionProps",(t,i)=>{Object.values(t).forEach((r,n)=>{if(r==null){let{message:o}=R("MISSING_OR_INVALID",`${i} must contain an existing value for each key. Received: ${r} for key ${Object.keys(t)[n]}`);throw new Error(o)}})}),E(this,"getPendingAuthRequest",t=>{let i=this.client.auth.requests.get(t);return typeof i=="object"?i:void 0}),E(this,"addToRecentlyDeleted",(t,i)=>{if(this.recentlyDeletedMap.set(t,i),this.recentlyDeletedMap.size>=this.recentlyDeletedLimit){let r=0,n=this.recentlyDeletedLimit/2;for(let o of this.recentlyDeletedMap.keys()){if(r++>=n)break;this.recentlyDeletedMap.delete(o)}}}),E(this,"checkRecentlyDeleted",t=>{let i=this.recentlyDeletedMap.get(t);if(i){let{message:r}=R("MISSING_OR_INVALID",`Record was recently deleted - ${i}: ${t}`);throw new Error(r)}}),E(this,"isLinkModeEnabled",(t,i)=>{var r,n,o,a,c,l,h,p,d;return!t||i!==ne.link_mode?!1:((n=(r=this.client.metadata)==null?void 0:r.redirect)==null?void 0:n.linkMode)===!0&&((a=(o=this.client.metadata)==null?void 0:o.redirect)==null?void 0:a.universal)!==void 0&&((l=(c=this.client.metadata)==null?void 0:c.redirect)==null?void 0:l.universal)!==""&&((h=t?.redirect)==null?void 0:h.universal)!==void 0&&((p=t?.redirect)==null?void 0:p.universal)!==""&&((d=t?.redirect)==null?void 0:d.linkMode)===!0&&this.client.core.linkModeSupportedApps.includes(t.redirect.universal)&&typeof(global==null?void 0:global.Linking)<"u"}),E(this,"getAppLinkIfEnabled",(t,i)=>{var r;return this.isLinkModeEnabled(t,i)?(r=t?.redirect)==null?void 0:r.universal:void 0}),E(this,"handleLinkModeMessage",({url:t})=>{if(!t||!t.includes("wc_ev")||!t.includes("topic"))return;let i=wn(t,"topic")||"",r=decodeURIComponent(wn(t,"wc_ev")||""),n=this.client.session.keys.includes(i);n&&this.client.session.update(i,{transportType:ne.link_mode}),this.client.core.dispatchEnvelope({topic:i,message:r,sessionExists:n})}),E(this,"registerLinkModeListeners",async()=>{var t;if(fi()||kt()&&(t=this.client.metadata.redirect)!=null&&t.linkMode){let i=global==null?void 0:global.Linking;if(typeof i<"u"){i.addEventListener("url",this.handleLinkModeMessage,this.client.name);let r=await i.getInitialURL();r&&setTimeout(()=>{this.handleLinkModeMessage({url:r})},50)}}}),E(this,"shouldSetTVF",(t,i)=>{if(!i||t!=="wc_sessionRequest")return!1;let{request:r}=i;return Object.keys(fh).includes(r.method)}),E(this,"getTVFParams",(t,i,r)=>{var n,o;try{let a=i.request.method,c=this.extractTxHashesFromResult(a,r);return De(se({correlationId:t,rpcMethods:[a],chainId:i.chainId},this.isValidContractData(i.request.params)&&{contractAddresses:[(o=(n=i.request.params)==null?void 0:n[0])==null?void 0:o.to]}),{txHashes:c})}catch(a){this.client.logger.warn("Error getting TVF params",a)}return{}}),E(this,"isValidContractData",t=>{var i;if(!t)return!1;try{let r=t?.data||((i=t?.[0])==null?void 0:i.data);if(!r.startsWith("0x"))return!1;let n=r.slice(2);return/^[0-9a-fA-F]*$/.test(n)?n.length%2===0:!1}catch{}return!1}),E(this,"extractTxHashesFromResult",(t,i)=>{try{let r=fh[t];if(typeof i=="string")return[i];let n=i[r.key];if(yt(n))return t==="solana_signAllTransactions"?n.map(o=>Tc(o)):n;if(typeof n=="string")return[n]}catch(r){this.client.logger.warn("Error extracting tx hashes from result",r)}return[]})}async processPendingMessageEvents(){try{let e=this.client.session.keys,t=this.client.core.relayer.messages.getWithoutAck(e);for(let[i,r]of Object.entries(t))for(let n of r)try{await this.onProviderMessageEvent({topic:i,message:n,publishedAt:Date.now()})}catch{this.client.logger.warn(`Error processing pending message event for topic: ${i}, message: ${n}`)}}catch(e){this.client.logger.warn("processPendingMessageEvents failed",e)}}isInitialized(){if(!this.initialized){let{message:e}=R("NOT_INITIALIZED",this.name);throw new Error(e)}}async confirmOnlineStateOrThrow(){await this.client.core.relayer.confirmOnlineStateOrThrow()}registerRelayerEvents(){this.client.core.relayer.on(me.message,e=>{this.onProviderMessageEvent(e)})}async onRelayMessage(e){let{topic:t,message:i,attestation:r,transportType:n}=e,{publicKey:o}=this.client.auth.authKeys.keys.includes(wr)?this.client.auth.authKeys.get(wr):{responseTopic:void 0,publicKey:void 0};try{let a=await this.client.core.crypto.decode(t,i,{receiverPublicKey:o,encoding:n===ne.link_mode?Ft:Ke});si(a)?(this.client.core.history.set(t,a),await this.onRelayEventRequest({topic:t,payload:a,attestation:r,transportType:n,encryptedId:Ze(i)})):ii(a)?(await this.client.core.history.resolve(a),await this.onRelayEventResponse({topic:t,payload:a,transportType:n}),this.client.core.history.delete(t,a.id)):await this.onRelayEventUnknownPayload({topic:t,payload:a,transportType:n}),await this.client.core.relayer.messages.ack(t,i)}catch(a){this.client.logger.error(a)}}registerExpirerEvents(){this.client.core.expirer.on(Ye.expired,async e=>{let{topic:t,id:i}=nr(e.target);if(i&&this.client.pendingRequest.keys.includes(i))return await this.deletePendingSessionRequest(i,R("EXPIRED"),!0);if(i&&this.client.auth.requests.keys.includes(i))return await this.deletePendingAuthRequest(i,R("EXPIRED"),!0);t?this.client.session.keys.includes(t)&&(await this.deleteSession({topic:t,expirerHasDeleted:!0}),this.client.events.emit("session_expire",{topic:t})):i&&(await this.deleteProposal(i,!0),this.client.events.emit("proposal_expire",{id:i}))})}registerPairingEvents(){this.client.core.pairing.events.on(Gt.create,e=>this.onPairingCreated(e)),this.client.core.pairing.events.on(Gt.delete,e=>{this.addToRecentlyDeleted(e.topic,"pairing")})}isValidPairingTopic(e){if(!ce(e,!1)){let{message:t}=R("MISSING_OR_INVALID",`pairing topic should be a string: ${e}`);throw new Error(t)}if(!this.client.core.pairing.pairings.keys.includes(e)){let{message:t}=R("NO_MATCHING_KEY",`pairing topic doesn't exist: ${e}`);throw new Error(t)}if(mt(this.client.core.pairing.pairings.get(e).expiry)){let{message:t}=R("EXPIRED",`pairing topic: ${e}`);throw new Error(t)}}async isValidSessionTopic(e){if(!ce(e,!1)){let{message:t}=R("MISSING_OR_INVALID",`session topic should be a string: ${e}`);throw new Error(t)}if(this.checkRecentlyDeleted(e),!this.client.session.keys.includes(e)){let{message:t}=R("NO_MATCHING_KEY",`session topic doesn't exist: ${e}`);throw new Error(t)}if(mt(this.client.session.get(e).expiry)){await this.deleteSession({topic:e});let{message:t}=R("EXPIRED",`session topic: ${e}`);throw new Error(t)}if(!this.client.core.crypto.keychain.has(e)){let{message:t}=R("MISSING_OR_INVALID",`session topic does not exist in keychain: ${e}`);throw await this.deleteSession({topic:e}),new Error(t)}}async isValidSessionOrPairingTopic(e){if(this.checkRecentlyDeleted(e),this.client.session.keys.includes(e))await this.isValidSessionTopic(e);else if(this.client.core.pairing.pairings.keys.includes(e))this.isValidPairingTopic(e);else if(ce(e,!1)){let{message:t}=R("NO_MATCHING_KEY",`session or pairing topic doesn't exist: ${e}`);throw new Error(t)}else{let{message:t}=R("MISSING_OR_INVALID",`session or pairing topic should be a string: ${e}`);throw new Error(t)}}async isValidProposalId(e){if(!yl(e)){let{message:t}=R("MISSING_OR_INVALID",`proposal id should be a number: ${e}`);throw new Error(t)}if(!this.client.proposal.keys.includes(e)){let{message:t}=R("NO_MATCHING_KEY",`proposal id doesn't exist: ${e}`);throw new Error(t)}if(mt(this.client.proposal.get(e).expiryTimestamp)){await this.deleteProposal(e);let{message:t}=R("EXPIRED",`proposal id: ${e}`);throw new Error(t)}}},No=class extends It{constructor(e,t){super(e,t,yy,Uo),this.core=e,this.logger=t}},So=class extends It{constructor(e,t){super(e,t,wy,Uo),this.core=e,this.logger=t}},To=class extends It{constructor(e,t){super(e,t,by,Uo,i=>i.id),this.core=e,this.logger=t}},Oo=class extends It{constructor(e,t){super(e,t,_y,Er,()=>wr),this.core=e,this.logger=t}},Ro=class extends It{constructor(e,t){super(e,t,Py,Er),this.core=e,this.logger=t}},xo=class extends It{constructor(e,t){super(e,t,Ay,Er,i=>i.id),this.core=e,this.logger=t}},xy=Object.defineProperty,ky=(s,e,t)=>e in s?xy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,_o=(s,e,t)=>ky(s,typeof e!="symbol"?e+"":e,t),ko=class{constructor(e,t){this.core=e,this.logger=t,_o(this,"authKeys"),_o(this,"pairingTopics"),_o(this,"requests"),this.authKeys=new Oo(this.core,this.logger),this.pairingTopics=new Ro(this.core,this.logger),this.requests=new xo(this.core,this.logger)}async init(){await this.authKeys.init(),await this.pairingTopics.init(),await this.requests.init()}},Uy=Object.defineProperty,Dy=(s,e,t)=>e in s?Uy(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,W=(s,e,t)=>Dy(s,typeof e!="symbol"?e+"":e,t),vr=class s extends Yi{constructor(e){super(e),W(this,"protocol",yh),W(this,"version",wh),W(this,"name",Io.name),W(this,"metadata"),W(this,"core"),W(this,"logger"),W(this,"events",new br.EventEmitter),W(this,"engine"),W(this,"session"),W(this,"proposal"),W(this,"pendingRequest"),W(this,"auth"),W(this,"signConfig"),W(this,"on",(i,r)=>this.events.on(i,r)),W(this,"once",(i,r)=>this.events.once(i,r)),W(this,"off",(i,r)=>this.events.off(i,r)),W(this,"removeListener",(i,r)=>this.events.removeListener(i,r)),W(this,"removeAllListeners",i=>this.events.removeAllListeners(i)),W(this,"connect",async i=>{try{return await this.engine.connect(i)}catch(r){throw this.logger.error(r.message),r}}),W(this,"pair",async i=>{try{return await this.engine.pair(i)}catch(r){throw this.logger.error(r.message),r}}),W(this,"approve",async i=>{try{return await this.engine.approve(i)}catch(r){throw this.logger.error(r.message),r}}),W(this,"reject",async i=>{try{return await this.engine.reject(i)}catch(r){throw this.logger.error(r.message),r}}),W(this,"update",async i=>{try{return await this.engine.update(i)}catch(r){throw this.logger.error(r.message),r}}),W(this,"extend",async i=>{try{return await this.engine.extend(i)}catch(r){throw this.logger.error(r.message),r}}),W(this,"request",async i=>{try{return await this.engine.request(i)}catch(r){throw this.logger.error(r.message),r}}),W(this,"respond",async i=>{try{return await this.engine.respond(i)}catch(r){throw this.logger.error(r.message),r}}),W(this,"ping",async i=>{try{return await this.engine.ping(i)}catch(r){throw this.logger.error(r.message),r}}),W(this,"emit",async i=>{try{return await this.engine.emit(i)}catch(r){throw this.logger.error(r.message),r}}),W(this,"disconnect",async i=>{try{return await this.engine.disconnect(i)}catch(r){throw this.logger.error(r.message),r}}),W(this,"find",i=>{try{return this.engine.find(i)}catch(r){throw this.logger.error(r.message),r}}),W(this,"getPendingSessionRequests",()=>{try{return this.engine.getPendingSessionRequests()}catch(i){throw this.logger.error(i.message),i}}),W(this,"authenticate",async(i,r)=>{try{return await this.engine.authenticate(i,r)}catch(n){throw this.logger.error(n.message),n}}),W(this,"formatAuthMessage",i=>{try{return this.engine.formatAuthMessage(i)}catch(r){throw this.logger.error(r.message),r}}),W(this,"approveSessionAuthenticate",async i=>{try{return await this.engine.approveSessionAuthenticate(i)}catch(r){throw this.logger.error(r.message),r}}),W(this,"rejectSessionAuthenticate",async i=>{try{return await this.engine.rejectSessionAuthenticate(i)}catch(r){throw this.logger.error(r.message),r}}),this.name=e?.name||Io.name,this.metadata=gc(e?.metadata),this.signConfig=e?.signConfig;let t=typeof e?.logger<"u"&&typeof e?.logger!="string"?e.logger:(0,fs.default)(es({level:e?.logger||Io.logger}));this.core=e?.core||new dh(e),this.logger=Ie(t,this.name),this.session=new So(this.core,this.logger),this.proposal=new No(this.core,this.logger),this.pendingRequest=new To(this.core,this.logger),this.engine=new Ao(this),this.auth=new ko(this.core,this.logger)}static async init(e){let t=new s(e);return await t.initialize(),t}get context(){return ke(this.logger)}get pairing(){return this.core.pairing.pairings}async initialize(){this.logger.trace("Initialized");try{await this.core.start(),await this.session.init(),await this.proposal.init(),await this.pendingRequest.init(),await this.auth.init(),await this.engine.init(),this.logger.info("SignClient Initialization Success"),setTimeout(()=>{this.engine.processRelayMessageCache()},(0,z.toMiliseconds)(z.ONE_SECOND))}catch(e){throw this.logger.info("SignClient Initialization Failure"),this.logger.error(e.message),e}}};var kh=dt(ki()),bh="error",Fy="wss://relay.walletconnect.org",Ly="wc",qy="universal_provider",Ir=`${Ly}@2:${qy}:`,Uh="https://rpc.walletconnect.org/v1/",Xs="generic",jy=`${Uh}bundler`,st={DEFAULT_CHAIN_CHANGED:"default_chain_changed"};function $y(){}function Zo(s){return s==null||typeof s!="object"&&typeof s!="function"}function Qo(s){return ArrayBuffer.isView(s)&&!(s instanceof DataView)}function By(s){if(Zo(s))return s;if(Array.isArray(s)||Qo(s)||s instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&s instanceof SharedArrayBuffer)return s.slice(0);let e=Object.getPrototypeOf(s),t=e.constructor;if(s instanceof Date||s instanceof Map||s instanceof Set)return new t(s);if(s instanceof RegExp){let i=new t(s);return i.lastIndex=s.lastIndex,i}if(s instanceof DataView)return new t(s.buffer.slice(0));if(s instanceof Error){let i=new t(s.message);return i.stack=s.stack,i.name=s.name,i.cause=s.cause,i}if(typeof File<"u"&&s instanceof File)return new t([s],s.name,{type:s.type,lastModified:s.lastModified});if(typeof s=="object"){let i=Object.create(e);return Object.assign(i,s)}return s}function Eh(s){return typeof s=="object"&&s!==null}function Dh(s){return Object.getOwnPropertySymbols(s).filter(e=>Object.prototype.propertyIsEnumerable.call(s,e))}function Fh(s){return s==null?s===void 0?"[object Undefined]":"[object Null]":Object.prototype.toString.call(s)}var My="[object RegExp]",Lh="[object String]",qh="[object Number]",jh="[object Boolean]",$h="[object Arguments]",Vy="[object Symbol]",Hy="[object Date]",zy="[object Map]",Ky="[object Set]",Wy="[object Array]",Gy="[object ArrayBuffer]",Yy="[object Object]",Jy="[object DataView]",Xy="[object Uint8Array]",Zy="[object Uint8ClampedArray]",Qy="[object Uint16Array]",ew="[object Uint32Array]",tw="[object Int8Array]",sw="[object Int16Array]",iw="[object Int32Array]",rw="[object Float32Array]",nw="[object Float64Array]";function ow(s,e){return Zs(s,void 0,s,new Map,e)}function Zs(s,e,t,i=new Map,r=void 0){let n=r?.(s,e,t,i);if(n!=null)return n;if(Zo(s))return s;if(i.has(s))return i.get(s);if(Array.isArray(s)){let o=new Array(s.length);i.set(s,o);for(let a=0;a<s.length;a++)o[a]=Zs(s[a],a,t,i,r);return Object.hasOwn(s,"index")&&(o.index=s.index),Object.hasOwn(s,"input")&&(o.input=s.input),o}if(s instanceof Date)return new Date(s.getTime());if(s instanceof RegExp){let o=new RegExp(s.source,s.flags);return o.lastIndex=s.lastIndex,o}if(s instanceof Map){let o=new Map;i.set(s,o);for(let[a,c]of s)o.set(a,Zs(c,a,t,i,r));return o}if(s instanceof Set){let o=new Set;i.set(s,o);for(let a of s)o.add(Zs(a,void 0,t,i,r));return o}if(typeof Buffer<"u"&&Buffer.isBuffer(s))return s.subarray();if(Qo(s)){let o=new(Object.getPrototypeOf(s)).constructor(s.length);i.set(s,o);for(let a=0;a<s.length;a++)o[a]=Zs(s[a],a,t,i,r);return o}if(s instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&s instanceof SharedArrayBuffer)return s.slice(0);if(s instanceof DataView){let o=new DataView(s.buffer.slice(0),s.byteOffset,s.byteLength);return i.set(s,o),hs(o,s,t,i,r),o}if(typeof File<"u"&&s instanceof File){let o=new File([s],s.name,{type:s.type});return i.set(s,o),hs(o,s,t,i,r),o}if(s instanceof Blob){let o=new Blob([s],{type:s.type});return i.set(s,o),hs(o,s,t,i,r),o}if(s instanceof Error){let o=new s.constructor;return i.set(s,o),o.message=s.message,o.name=s.name,o.stack=s.stack,o.cause=s.cause,hs(o,s,t,i,r),o}if(typeof s=="object"&&aw(s)){let o=Object.create(Object.getPrototypeOf(s));return i.set(s,o),hs(o,s,t,i,r),o}return s}function hs(s,e,t=s,i,r){let n=[...Object.keys(e),...Dh(e)];for(let o=0;o<n.length;o++){let a=n[o],c=Object.getOwnPropertyDescriptor(s,a);(c==null||c.writable)&&(s[a]=Zs(e[a],a,t,i,r))}}function aw(s){switch(Fh(s)){case $h:case Wy:case Gy:case Jy:case jh:case Hy:case rw:case nw:case tw:case sw:case iw:case zy:case qh:case Yy:case My:case Ky:case Lh:case Vy:case Xy:case Zy:case Qy:case ew:return!0;default:return!1}}function cw(s,e){return ow(s,(t,i,r,n)=>{let o=e?.(t,i,r,n);if(o!=null)return o;if(typeof s=="object")switch(Object.prototype.toString.call(s)){case qh:case Lh:case jh:{let a=new s.constructor(s?.valueOf());return hs(a,s),a}case $h:{let a={};return hs(a,s),a.length=s.length,a[Symbol.iterator]=s[Symbol.iterator],a}default:return}})}function Ih(s){return cw(s)}function Ch(s){return s!==null&&typeof s=="object"&&Fh(s)==="[object Arguments]"}function lw(s){return Qo(s)}function hw(s){if(typeof s!="object"||s==null)return!1;if(Object.getPrototypeOf(s)===null)return!0;if(Object.prototype.toString.call(s)!=="[object Object]"){let t=s[Symbol.toStringTag];return t==null||!Object.getOwnPropertyDescriptor(s,Symbol.toStringTag)?.writable?!1:s.toString()===`[object ${t}]`}let e=s;for(;Object.getPrototypeOf(e)!==null;)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(s)===e}function pw(s,...e){let t=e.slice(0,-1),i=e[e.length-1],r=s;for(let n=0;n<t.length;n++){let o=t[n];r=qo(r,o,i,new Map)}return r}function qo(s,e,t,i){if(Zo(s)&&(s=Object(s)),e==null||typeof e!="object")return s;if(i.has(e))return By(i.get(e));if(i.set(e,s),Array.isArray(e)){e=e.slice();for(let n=0;n<e.length;n++)e[n]=e[n]??void 0}let r=[...Object.keys(e),...Dh(e)];for(let n=0;n<r.length;n++){let o=r[n],a=e[o],c=s[o];if(Ch(a)&&(a={...a}),Ch(c)&&(c={...c}),typeof Buffer<"u"&&Buffer.isBuffer(a)&&(a=Ih(a)),Array.isArray(a))if(typeof c=="object"&&c!=null){let h=[],p=Reflect.ownKeys(c);for(let d=0;d<p.length;d++){let g=p[d];h[g]=c[g]}c=h}else c=[];let l=t(c,a,o,s,e,i);l!=null?s[o]=l:Array.isArray(a)||Eh(c)&&Eh(a)?s[o]=qo(c,a,t,i):c==null&&hw(a)?s[o]=qo({},a,t,i):c==null&&lw(a)?s[o]=Ih(a):(c===void 0||a!==void 0)&&(s[o]=a)}return s}function dw(s,...e){return pw(s,...e,$y)}var uw=Object.defineProperty,gw=Object.defineProperties,fw=Object.getOwnPropertyDescriptors,_h=Object.getOwnPropertySymbols,mw=Object.prototype.hasOwnProperty,yw=Object.prototype.propertyIsEnumerable,Ph=(s,e,t)=>e in s?uw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Cr=(s,e)=>{for(var t in e||(e={}))mw.call(e,t)&&Ph(s,t,e[t]);if(_h)for(var t of _h(e))yw.call(e,t)&&Ph(s,t,e[t]);return s},ww=(s,e)=>gw(s,fw(e));function Je(s,e,t){var i;let r=Wt(s);return((i=e.rpcMap)==null?void 0:i[r.reference])||`${Uh}?chainId=${r.namespace}:${r.reference}&projectId=${t}`}function ps(s){return s.includes(":")?s.split(":")[1]:s}function Bh(s){return s.map(e=>`${e.split(":")[0]}:${e.split(":")[1]}`)}function vw(s,e){let t=Object.keys(e.namespaces).filter(r=>r.includes(s));if(!t.length)return[];let i=[];return t.forEach(r=>{let n=e.namespaces[r].accounts;i.push(...n)}),i}function _r(s={},e={}){let t=Ah(s),i=Ah(e);return dw(t,i)}function Ah(s){var e,t,i,r,n;let o={};if(!wt(s))return o;for(let[a,c]of Object.entries(s)){let l=_i(a)?[a]:c.chains,h=c.methods||[],p=c.events||[],d=c.rpcMap||{},g=ls(a);o[g]=ww(Cr(Cr({},o[g]),c),{chains:nt(l,(e=o[g])==null?void 0:e.chains),methods:nt(h,(t=o[g])==null?void 0:t.methods),events:nt(p,(i=o[g])==null?void 0:i.events)}),(wt(d)||wt(((r=o[g])==null?void 0:r.rpcMap)||{}))&&(o[g].rpcMap=Cr(Cr({},d),(n=o[g])==null?void 0:n.rpcMap))}return o}function Nh(s){return s.includes(":")?s.split(":")[2]:s}function Sh(s){let e={};for(let[t,i]of Object.entries(s)){let r=i.methods||[],n=i.events||[],o=i.accounts||[],a=_i(t)?[t]:i.chains?i.chains:Bh(i.accounts);e[t]={chains:a,methods:r,events:n,accounts:o}}return e}function Do(s){return typeof s=="number"?s:s.includes("0x")?parseInt(s,16):(s=s.includes(":")?s.split(":")[1]:s,isNaN(Number(s))?s:Number(s))}var Mh={},X=s=>Mh[s],Fo=(s,e)=>{Mh[s]=e},bw=Object.defineProperty,Ew=(s,e,t)=>e in s?bw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,$s=(s,e,t)=>Ew(s,typeof e!="symbol"?e+"":e,t),jo=class{constructor(e){$s(this,"name","polkadot"),$s(this,"client"),$s(this,"httpProviders"),$s(this,"events"),$s(this,"namespace"),$s(this,"chainId"),this.namespace=e.namespace,this.events=X("events"),this.client=X("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(st.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}getAccounts(){let e=this.namespace.accounts;return e?e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2])||[]:[]}createHttpProviders(){let e={};return this.namespace.chains.forEach(t=>{var i;let r=ps(t);e[r]=this.createHttpProvider(r,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getHttpProvider(){let e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){let i=t||Je(e,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new Fe(new Be(i,X("disableProviderPing")))}},Iw=Object.defineProperty,Cw=Object.defineProperties,_w=Object.getOwnPropertyDescriptors,Th=Object.getOwnPropertySymbols,Pw=Object.prototype.hasOwnProperty,Aw=Object.prototype.propertyIsEnumerable,$o=(s,e,t)=>e in s?Iw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Oh=(s,e)=>{for(var t in e||(e={}))Pw.call(e,t)&&$o(s,t,e[t]);if(Th)for(var t of Th(e))Aw.call(e,t)&&$o(s,t,e[t]);return s},Rh=(s,e)=>Cw(s,_w(e)),Bs=(s,e,t)=>$o(s,typeof e!="symbol"?e+"":e,t),Bo=class{constructor(e){Bs(this,"name","eip155"),Bs(this,"client"),Bs(this,"chainId"),Bs(this,"namespace"),Bs(this,"httpProviders"),Bs(this,"events"),this.namespace=e.namespace,this.events=X("events"),this.client=X("client"),this.httpProviders=this.createHttpProviders(),this.chainId=parseInt(this.getDefaultChain())}async request(e){switch(e.request.method){case"eth_requestAccounts":return this.getAccounts();case"eth_accounts":return this.getAccounts();case"wallet_switchEthereumChain":return await this.handleSwitchChain(e);case"eth_chainId":return parseInt(this.getDefaultChain());case"wallet_getCapabilities":return await this.getCapabilities(e);case"wallet_getCallsStatus":return await this.getCallStatus(e)}return this.namespace.methods.includes(e.request.method)?await this.client.request(e):this.getHttpProvider().request(e.request)}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(parseInt(e),t),this.chainId=parseInt(e),this.events.emit(st.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId.toString();if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}createHttpProvider(e,t){let i=t||Je(`${this.name}:${e}`,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new Fe(new Be(i,X("disableProviderPing")))}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProviders(){let e={};return this.namespace.chains.forEach(t=>{var i;let r=parseInt(ps(t));e[r]=this.createHttpProvider(r,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getAccounts(){let e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}getHttpProvider(){let e=this.chainId,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}async handleSwitchChain(e){var t,i;let r=e.request.params?(t=e.request.params[0])==null?void 0:t.chainId:"0x0";r=r.startsWith("0x")?r:`0x${r}`;let n=parseInt(r,16);if(this.isChainApproved(n))this.setDefaultChain(`${n}`);else if(this.namespace.methods.includes("wallet_switchEthereumChain"))await this.client.request({topic:e.topic,request:{method:e.request.method,params:[{chainId:r}]},chainId:(i=this.namespace.chains)==null?void 0:i[0]}),this.setDefaultChain(`${n}`);else throw new Error(`Failed to switch to chain 'eip155:${n}'. The chain is not approved or the wallet does not support 'wallet_switchEthereumChain' method.`);return null}isChainApproved(e){return this.namespace.chains.includes(`${this.name}:${e}`)}async getCapabilities(e){var t,i,r,n,o;let a=(i=(t=e.request)==null?void 0:t.params)==null?void 0:i[0],c=((n=(r=e.request)==null?void 0:r.params)==null?void 0:n[1])||[],l=`${a}${c.join(",")}`;if(!a)throw new Error("Missing address parameter in `wallet_getCapabilities` request");let h=this.client.session.get(e.topic),p=((o=h?.sessionProperties)==null?void 0:o.capabilities)||{};if(p!=null&&p[l])return p?.[l];let d=await this.client.request(e);try{await this.client.session.update(e.topic,{sessionProperties:Rh(Oh({},h.sessionProperties||{}),{capabilities:Rh(Oh({},p||{}),{[l]:d})})})}catch(g){console.warn("Failed to update session with capabilities",g)}return d}async getCallStatus(e){var t,i;let r=this.client.session.get(e.topic),n=(t=r.sessionProperties)==null?void 0:t.bundler_name;if(n){let a=this.getBundlerUrl(e.chainId,n);try{return await this.getUserOperationReceipt(a,e)}catch(c){console.warn("Failed to fetch call status from bundler",c,a)}}let o=(i=r.sessionProperties)==null?void 0:i.bundler_url;if(o)try{return await this.getUserOperationReceipt(o,e)}catch(a){console.warn("Failed to fetch call status from custom bundler",a,o)}if(this.namespace.methods.includes(e.request.method))return await this.client.request(e);throw new Error("Fetching call status not approved by the wallet.")}async getUserOperationReceipt(e,t){var i;let r=new URL(e),n=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ut("eth_getUserOperationReceipt",[(i=t.request.params)==null?void 0:i[0]]))});if(!n.ok)throw new Error(`Failed to fetch user operation receipt - ${n.status}`);return await n.json()}getBundlerUrl(e,t){return`${jy}?projectId=${this.client.core.projectId}&chainId=${e}&bundler=${t}`}},Nw=Object.defineProperty,Sw=(s,e,t)=>e in s?Nw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ms=(s,e,t)=>Sw(s,typeof e!="symbol"?e+"":e,t),Mo=class{constructor(e){Ms(this,"name","solana"),Ms(this,"client"),Ms(this,"httpProviders"),Ms(this,"events"),Ms(this,"namespace"),Ms(this,"chainId"),this.namespace=e.namespace,this.events=X("events"),this.client=X("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(st.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}getAccounts(){let e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){let e={};return this.namespace.chains.forEach(t=>{var i;let r=ps(t);e[r]=this.createHttpProvider(r,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getHttpProvider(){let e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){let i=t||Je(e,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new Fe(new Be(i,X("disableProviderPing")))}},Tw=Object.defineProperty,Ow=(s,e,t)=>e in s?Tw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Vs=(s,e,t)=>Ow(s,typeof e!="symbol"?e+"":e,t),Vo=class{constructor(e){Vs(this,"name","cosmos"),Vs(this,"client"),Vs(this,"httpProviders"),Vs(this,"events"),Vs(this,"namespace"),Vs(this,"chainId"),this.namespace=e.namespace,this.events=X("events"),this.client=X("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(st.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getAccounts(){let e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){let e={};return this.namespace.chains.forEach(t=>{var i;let r=ps(t);e[r]=this.createHttpProvider(r,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getHttpProvider(){let e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){let i=t||Je(e,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new Fe(new Be(i,X("disableProviderPing")))}},Rw=Object.defineProperty,xw=(s,e,t)=>e in s?Rw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Hs=(s,e,t)=>xw(s,typeof e!="symbol"?e+"":e,t),Ho=class{constructor(e){Hs(this,"name","algorand"),Hs(this,"client"),Hs(this,"httpProviders"),Hs(this,"events"),Hs(this,"namespace"),Hs(this,"chainId"),this.namespace=e.namespace,this.events=X("events"),this.client=X("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){if(!this.httpProviders[e]){let i=t||Je(`${this.name}:${e}`,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);this.setHttpProvider(e,i)}this.chainId=e,this.events.emit(st.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}getAccounts(){let e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){let e={};return this.namespace.chains.forEach(t=>{var i;e[t]=this.createHttpProvider(t,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getHttpProvider(){let e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){let i=t||Je(e,this.namespace,this.client.core.projectId);return typeof i>"u"?void 0:new Fe(new Be(i,X("disableProviderPing")))}},kw=Object.defineProperty,Uw=(s,e,t)=>e in s?kw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,zs=(s,e,t)=>Uw(s,typeof e!="symbol"?e+"":e,t),zo=class{constructor(e){zs(this,"name","cip34"),zs(this,"client"),zs(this,"httpProviders"),zs(this,"events"),zs(this,"namespace"),zs(this,"chainId"),this.namespace=e.namespace,this.events=X("events"),this.client=X("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(st.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getAccounts(){let e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){let e={};return this.namespace.chains.forEach(t=>{let i=this.getCardanoRPCUrl(t),r=ps(t);e[r]=this.createHttpProvider(r,i)}),e}getHttpProvider(){let e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}getCardanoRPCUrl(e){let t=this.namespace.rpcMap;if(t)return t[e]}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){let i=t||this.getCardanoRPCUrl(e);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new Fe(new Be(i,X("disableProviderPing")))}},Dw=Object.defineProperty,Fw=(s,e,t)=>e in s?Dw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ks=(s,e,t)=>Fw(s,typeof e!="symbol"?e+"":e,t),Ko=class{constructor(e){Ks(this,"name","elrond"),Ks(this,"client"),Ks(this,"httpProviders"),Ks(this,"events"),Ks(this,"namespace"),Ks(this,"chainId"),this.namespace=e.namespace,this.events=X("events"),this.client=X("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(st.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}getAccounts(){let e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){let e={};return this.namespace.chains.forEach(t=>{var i;let r=ps(t);e[r]=this.createHttpProvider(r,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getHttpProvider(){let e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){let i=t||Je(e,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new Fe(new Be(i,X("disableProviderPing")))}},Lw=Object.defineProperty,qw=(s,e,t)=>e in s?Lw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ws=(s,e,t)=>qw(s,typeof e!="symbol"?e+"":e,t),Wo=class{constructor(e){Ws(this,"name","multiversx"),Ws(this,"client"),Ws(this,"httpProviders"),Ws(this,"events"),Ws(this,"namespace"),Ws(this,"chainId"),this.namespace=e.namespace,this.events=X("events"),this.client=X("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(st.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}getAccounts(){let e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){let e={};return this.namespace.chains.forEach(t=>{var i;let r=ps(t);e[r]=this.createHttpProvider(r,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getHttpProvider(){let e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){let i=t||Je(e,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new Fe(new Be(i,X("disableProviderPing")))}},jw=Object.defineProperty,$w=(s,e,t)=>e in s?jw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Gs=(s,e,t)=>$w(s,typeof e!="symbol"?e+"":e,t),Go=class{constructor(e){Gs(this,"name","near"),Gs(this,"client"),Gs(this,"httpProviders"),Gs(this,"events"),Gs(this,"namespace"),Gs(this,"chainId"),this.namespace=e.namespace,this.events=X("events"),this.client=X("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){if(this.chainId=e,!this.httpProviders[e]){let i=t||Je(`${this.name}:${e}`,this.namespace);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);this.setHttpProvider(e,i)}this.events.emit(st.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getAccounts(){let e=this.namespace.accounts;return e?e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2])||[]:[]}createHttpProviders(){let e={};return this.namespace.chains.forEach(t=>{var i;e[t]=this.createHttpProvider(t,(i=this.namespace.rpcMap)==null?void 0:i[t])}),e}getHttpProvider(){let e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){let i=t||Je(e,this.namespace);return typeof i>"u"?void 0:new Fe(new Be(i,X("disableProviderPing")))}},Bw=Object.defineProperty,Mw=(s,e,t)=>e in s?Bw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Ys=(s,e,t)=>Mw(s,typeof e!="symbol"?e+"":e,t),Yo=class{constructor(e){Ys(this,"name","tezos"),Ys(this,"client"),Ys(this,"httpProviders"),Ys(this,"events"),Ys(this,"namespace"),Ys(this,"chainId"),this.namespace=e.namespace,this.events=X("events"),this.client=X("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace=Object.assign(this.namespace,e)}requestAccounts(){return this.getAccounts()}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider().request(e.request)}setDefaultChain(e,t){if(this.chainId=e,!this.httpProviders[e]){let i=t||Je(`${this.name}:${e}`,this.namespace);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);this.setHttpProvider(e,i)}this.events.emit(st.DEFAULT_CHAIN_CHANGED,`${this.name}:${this.chainId}`)}getAccounts(){let e=this.namespace.accounts;return e?e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2])||[]:[]}createHttpProviders(){let e={};return this.namespace.chains.forEach(t=>{e[t]=this.createHttpProvider(t)}),e}getHttpProvider(){let e=`${this.name}:${this.chainId}`,t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){let i=t||Je(e,this.namespace);return typeof i>"u"?void 0:new Fe(new Be(i))}},Vw=Object.defineProperty,Hw=(s,e,t)=>e in s?Vw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Js=(s,e,t)=>Hw(s,typeof e!="symbol"?e+"":e,t),Jo=class{constructor(e){Js(this,"name",Xs),Js(this,"client"),Js(this,"httpProviders"),Js(this,"events"),Js(this,"namespace"),Js(this,"chainId"),this.namespace=e.namespace,this.events=X("events"),this.client=X("client"),this.chainId=this.getDefaultChain(),this.httpProviders=this.createHttpProviders()}updateNamespace(e){this.namespace.chains=[...new Set((this.namespace.chains||[]).concat(e.chains||[]))],this.namespace.accounts=[...new Set((this.namespace.accounts||[]).concat(e.accounts||[]))],this.namespace.methods=[...new Set((this.namespace.methods||[]).concat(e.methods||[]))],this.namespace.events=[...new Set((this.namespace.events||[]).concat(e.events||[]))],this.httpProviders=this.createHttpProviders()}requestAccounts(){return this.getAccounts()}request(e){return this.namespace.methods.includes(e.request.method)?this.client.request(e):this.getHttpProvider(e.chainId).request(e.request)}setDefaultChain(e,t){this.httpProviders[e]||this.setHttpProvider(e,t),this.chainId=e,this.events.emit(st.DEFAULT_CHAIN_CHANGED,`${this.name}:${e}`)}getDefaultChain(){if(this.chainId)return this.chainId;if(this.namespace.defaultChain)return this.namespace.defaultChain;let e=this.namespace.chains[0];if(!e)throw new Error("ChainId not found");return e.split(":")[1]}getAccounts(){let e=this.namespace.accounts;return e?[...new Set(e.filter(t=>t.split(":")[1]===this.chainId.toString()).map(t=>t.split(":")[2]))]:[]}createHttpProviders(){var e,t;let i={};return(t=(e=this.namespace)==null?void 0:e.accounts)==null||t.forEach(r=>{let n=Wt(r);i[`${n.namespace}:${n.reference}`]=this.createHttpProvider(r)}),i}getHttpProvider(e){let t=this.httpProviders[e];if(typeof t>"u")throw new Error(`JSON-RPC provider for ${e} not found`);return t}setHttpProvider(e,t){let i=this.createHttpProvider(e,t);i&&(this.httpProviders[e]=i)}createHttpProvider(e,t){let i=t||Je(e,this.namespace,this.client.core.projectId);if(!i)throw new Error(`No RPC url provided for chainId: ${e}`);return new Fe(new Be(i,X("disableProviderPing")))}},zw=Object.defineProperty,Kw=Object.defineProperties,Ww=Object.getOwnPropertyDescriptors,xh=Object.getOwnPropertySymbols,Gw=Object.prototype.hasOwnProperty,Yw=Object.prototype.propertyIsEnumerable,Xo=(s,e,t)=>e in s?zw(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,Pr=(s,e)=>{for(var t in e||(e={}))Gw.call(e,t)&&Xo(s,t,e[t]);if(xh)for(var t of xh(e))Yw.call(e,t)&&Xo(s,t,e[t]);return s},Lo=(s,e)=>Kw(s,Ww(e)),tt=(s,e,t)=>Xo(s,typeof e!="symbol"?e+"":e,t),Ar=class s{constructor(e){tt(this,"client"),tt(this,"namespaces"),tt(this,"optionalNamespaces"),tt(this,"sessionProperties"),tt(this,"scopedProperties"),tt(this,"events",new kh.default),tt(this,"rpcProviders",{}),tt(this,"session"),tt(this,"providerOpts"),tt(this,"logger"),tt(this,"uri"),tt(this,"disableProviderPing",!1),this.providerOpts=e,this.logger=typeof e?.logger<"u"&&typeof e?.logger!="string"?e.logger:(0,fs.default)(es({level:e?.logger||bh})),this.disableProviderPing=e?.disableProviderPing||!1}static async init(e){let t=new s(e);return await t.initialize(),t}async request(e,t,i){let[r,n]=this.validateChain(t);if(!this.session)throw new Error("Please call connect() before request()");return await this.getProvider(r).request({request:Pr({},e),chainId:`${r}:${n}`,topic:this.session.topic,expiry:i})}sendAsync(e,t,i,r){let n=new Date().getTime();this.request(e,i,r).then(o=>t(null,ts(n,o))).catch(o=>t(o,void 0))}async enable(){if(!this.client)throw new Error("Sign Client not initialized");return this.session||await this.connect({namespaces:this.namespaces,optionalNamespaces:this.optionalNamespaces,sessionProperties:this.sessionProperties,scopedProperties:this.scopedProperties}),await this.requestAccounts()}async disconnect(){var e;if(!this.session)throw new Error("Please call connect() before enable()");await this.client.disconnect({topic:(e=this.session)==null?void 0:e.topic,reason:Z("USER_DISCONNECTED")}),await this.cleanup()}async connect(e){if(!this.client)throw new Error("Sign Client not initialized");if(this.setNamespaces(e),await this.cleanupPendingPairings(),!e.skipPairing)return await this.pair(e.pairingTopic)}async authenticate(e,t){if(!this.client)throw new Error("Sign Client not initialized");this.setNamespaces(e),await this.cleanupPendingPairings();let{uri:i,response:r}=await this.client.authenticate(e,t);i&&(this.uri=i,this.events.emit("display_uri",i));let n=await r();if(this.session=n.session,this.session){let o=Sh(this.session.namespaces);this.namespaces=_r(this.namespaces,o),await this.persist("namespaces",this.namespaces),this.onConnect()}return n}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}removeListener(e,t){this.events.removeListener(e,t)}off(e,t){this.events.off(e,t)}get isWalletConnect(){return!0}async pair(e){let{uri:t,approval:i}=await this.client.connect({pairingTopic:e,requiredNamespaces:this.namespaces,optionalNamespaces:this.optionalNamespaces,sessionProperties:this.sessionProperties,scopedProperties:this.scopedProperties});t&&(this.uri=t,this.events.emit("display_uri",t));let r=await i();this.session=r;let n=Sh(r.namespaces);return this.namespaces=_r(this.namespaces,n),await this.persist("namespaces",this.namespaces),await this.persist("optionalNamespaces",this.optionalNamespaces),this.onConnect(),this.session}setDefaultChain(e,t){try{if(!this.session)return;let[i,r]=this.validateChain(e),n=this.getProvider(i);n.name===Xs?n.setDefaultChain(`${i}:${r}`,t):n.setDefaultChain(r,t)}catch(i){if(!/Please call connect/.test(i.message))throw i}}async cleanupPendingPairings(e={}){this.logger.info("Cleaning up inactive pairings...");let t=this.client.pairing.getAll();if(yt(t)){for(let i of t)e.deletePairings?this.client.core.expirer.set(i.topic,0):await this.client.core.relayer.subscriber.unsubscribe(i.topic);this.logger.info(`Inactive pairings cleared: ${t.length}`)}}abortPairingAttempt(){this.logger.warn("abortPairingAttempt is deprecated. This is now a no-op.")}async checkStorage(){this.namespaces=await this.getFromStore("namespaces")||{},this.optionalNamespaces=await this.getFromStore("optionalNamespaces")||{},this.session&&this.createProviders()}async initialize(){this.logger.trace("Initialized"),await this.createClient(),await this.checkStorage(),this.registerEventListeners()}async createClient(){var e,t;if(this.client=this.providerOpts.client||await vr.init({core:this.providerOpts.core,logger:this.providerOpts.logger||bh,relayUrl:this.providerOpts.relayUrl||Fy,projectId:this.providerOpts.projectId,metadata:this.providerOpts.metadata,storageOptions:this.providerOpts.storageOptions,storage:this.providerOpts.storage,name:this.providerOpts.name,customStoragePrefix:this.providerOpts.customStoragePrefix,telemetryEnabled:this.providerOpts.telemetryEnabled}),this.providerOpts.session)try{this.session=this.client.session.get(this.providerOpts.session.topic)}catch(i){throw this.logger.error("Failed to get session",i),new Error(`The provided session: ${(t=(e=this.providerOpts)==null?void 0:e.session)==null?void 0:t.topic} doesn't exist in the Sign client`)}else{let i=this.client.session.getAll();this.session=i[0]}this.logger.trace("SignClient Initialized")}createProviders(){if(!this.client)throw new Error("Sign Client not initialized");if(!this.session)throw new Error("Session not initialized. Please call connect() before enable()");let e=[...new Set(Object.keys(this.session.namespaces).map(t=>ls(t)))];Fo("client",this.client),Fo("events",this.events),Fo("disableProviderPing",this.disableProviderPing),e.forEach(t=>{if(!this.session)return;let i=vw(t,this.session),r=Bh(i),n=_r(this.namespaces,this.optionalNamespaces),o=Lo(Pr({},n[t]),{accounts:i,chains:r});switch(t){case"eip155":this.rpcProviders[t]=new Bo({namespace:o});break;case"algorand":this.rpcProviders[t]=new Ho({namespace:o});break;case"solana":this.rpcProviders[t]=new Mo({namespace:o});break;case"cosmos":this.rpcProviders[t]=new Vo({namespace:o});break;case"polkadot":this.rpcProviders[t]=new jo({namespace:o});break;case"cip34":this.rpcProviders[t]=new zo({namespace:o});break;case"elrond":this.rpcProviders[t]=new Ko({namespace:o});break;case"multiversx":this.rpcProviders[t]=new Wo({namespace:o});break;case"near":this.rpcProviders[t]=new Go({namespace:o});break;case"tezos":this.rpcProviders[t]=new Yo({namespace:o});break;default:this.rpcProviders[Xs]?this.rpcProviders[Xs].updateNamespace(o):this.rpcProviders[Xs]=new Jo({namespace:o})}})}registerEventListeners(){if(typeof this.client>"u")throw new Error("Sign Client is not initialized");this.client.on("session_ping",e=>{var t;let{topic:i}=e;i===((t=this.session)==null?void 0:t.topic)&&this.events.emit("session_ping",e)}),this.client.on("session_event",e=>{var t;let{params:i,topic:r}=e;if(r!==((t=this.session)==null?void 0:t.topic))return;let{event:n}=i;if(n.name==="accountsChanged"){let o=n.data;o&&yt(o)&&this.events.emit("accountsChanged",o.map(Nh))}else if(n.name==="chainChanged"){let o=i.chainId,a=i.event.data,c=ls(o),l=Do(o)!==Do(a)?`${c}:${Do(a)}`:o;this.onChainChanged(l)}else this.events.emit(n.name,n.data);this.events.emit("session_event",e)}),this.client.on("session_update",({topic:e,params:t})=>{var i,r;if(e!==((i=this.session)==null?void 0:i.topic))return;let{namespaces:n}=t,o=(r=this.client)==null?void 0:r.session.get(e);this.session=Lo(Pr({},o),{namespaces:n}),this.onSessionUpdate(),this.events.emit("session_update",{topic:e,params:t})}),this.client.on("session_delete",async e=>{var t;e.topic===((t=this.session)==null?void 0:t.topic)&&(await this.cleanup(),this.events.emit("session_delete",e),this.events.emit("disconnect",Lo(Pr({},Z("USER_DISCONNECTED")),{data:e.topic})))}),this.on(st.DEFAULT_CHAIN_CHANGED,e=>{this.onChainChanged(e,!0)})}getProvider(e){return this.rpcProviders[e]||this.rpcProviders[Xs]}onSessionUpdate(){Object.keys(this.rpcProviders).forEach(e=>{var t;this.getProvider(e).updateNamespace((t=this.session)==null?void 0:t.namespaces[e])})}setNamespaces(e){let{namespaces:t={},optionalNamespaces:i={},sessionProperties:r,scopedProperties:n}=e;this.optionalNamespaces=_r(t,i),this.sessionProperties=r,this.scopedProperties=n}validateChain(e){let[t,i]=e?.split(":")||["",""];if(!this.namespaces||!Object.keys(this.namespaces).length)return[t,i];if(t&&!Object.keys(this.namespaces||{}).map(o=>ls(o)).includes(t))throw new Error(`Namespace '${t}' is not configured. Please call connect() first with namespace config.`);if(t&&i)return[t,i];let r=ls(Object.keys(this.namespaces)[0]),n=this.rpcProviders[r].getDefaultChain();return[r,n]}async requestAccounts(){let[e]=this.validateChain();return await this.getProvider(e).requestAccounts()}async onChainChanged(e,t=!1){if(!this.namespaces)return;let[i,r]=this.validateChain(e);if(!r)return;this.updateNamespaceChain(i,r),this.events.emit("chainChanged",r);let n=this.getProvider(i).getDefaultChain();t||this.getProvider(i).setDefaultChain(r),this.emitAccountsChangedOnChainChange({namespace:i,previousChainId:n,newChainId:e}),await this.persist("namespaces",this.namespaces)}emitAccountsChangedOnChainChange({namespace:e,previousChainId:t,newChainId:i}){var r,n;try{if(t===i)return;let o=(n=(r=this.session)==null?void 0:r.namespaces[e])==null?void 0:n.accounts;if(!o)return;let a=o.filter(c=>c.includes(`${i}:`)).map(Nh);if(!yt(a))return;this.events.emit("accountsChanged",a)}catch(o){this.logger.warn("Failed to emit accountsChanged on chain change",o)}}updateNamespaceChain(e,t){if(!this.namespaces)return;let i=this.namespaces[e]?e:`${e}:${t}`,r={chains:[],methods:[],events:[],defaultChain:t};this.namespaces[i]?this.namespaces[i]&&(this.namespaces[i].defaultChain=t):this.namespaces[i]=r}onConnect(){this.createProviders(),this.events.emit("connect",{session:this.session})}async cleanup(){this.namespaces=void 0,this.optionalNamespaces=void 0,this.sessionProperties=void 0,await this.deleteFromStore("namespaces"),await this.deleteFromStore("optionalNamespaces"),await this.deleteFromStore("sessionProperties"),this.session=void 0,await this.cleanupPendingPairings({deletePairings:!0}),await this.cleanupStorage()}async persist(e,t){var i;let r=((i=this.session)==null?void 0:i.topic)||"";await this.client.core.storage.setItem(`${Ir}/${e}${r}`,t)}async getFromStore(e){var t;let i=((t=this.session)==null?void 0:t.topic)||"";return await this.client.core.storage.getItem(`${Ir}/${e}${i}`)}async deleteFromStore(e){var t;let i=((t=this.session)==null?void 0:t.topic)||"";await this.client.core.storage.removeItem(`${Ir}/${e}${i}`)}async cleanupStorage(){var e;try{if(((e=this.client)==null?void 0:e.session.length)>0)return;let t=await this.client.core.storage.getKeys();for(let i of t)i.startsWith(Ir)&&await this.client.core.storage.removeItem(i)}catch(t){this.logger.warn("Failed to cleanup storage",t)}}};function Ri(s,e){return oe.getConnectorId(s)===e}function ea(s){let e=Array.from(C.state.chains.keys()),t=[];return s?(t.push([s,C.state.chains.get(s)]),Ri(s,ee.CONNECTOR_ID.WALLET_CONNECT)?e.forEach(i=>{i!==s&&Ri(i,ee.CONNECTOR_ID.WALLET_CONNECT)&&t.push([i,C.state.chains.get(i)])}):Ri(s,ee.CONNECTOR_ID.AUTH)&&e.forEach(i=>{i!==s&&Ri(i,ee.CONNECTOR_ID.AUTH)&&t.push([i,C.state.chains.get(i)])})):t=Array.from(C.state.chains.entries()),t}var ds={ERROR_CODE_UNRECOGNIZED_CHAIN_ID:4902,ERROR_CODE_DEFAULT:5e3,ERROR_INVALID_CHAIN_ID:32603,DEFAULT_ALLOWED_ANCESTORS:["http://localhost:*","https://*.pages.dev","https://*.vercel.app","https://*.ngrok-free.app","https://secure-mobile.walletconnect.com","https://secure-mobile.walletconnect.org"]};function qt(s){return{formatters:void 0,fees:void 0,serializers:void 0,...s}}var ta=qt({id:"5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp",name:"Solana",network:"solana-mainnet",nativeCurrency:{name:"Solana",symbol:"SOL",decimals:9},rpcUrls:{default:{http:["https://rpc.walletconnect.org/v1"]}},blockExplorers:{default:{name:"Solscan",url:"https://solscan.io"}},testnet:!1,chainNamespace:"solana",caipNetworkId:"solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp",deprecatedCaipNetworkId:"solana:4sGjMW1sUnHzSxGspuhpqLDx6wiyjNtZ"});var sa=qt({id:"EtWTRABZaYq6iMfeYKouRu166VU2xqa1",name:"Solana Devnet",network:"solana-devnet",nativeCurrency:{name:"Solana",symbol:"SOL",decimals:9},rpcUrls:{default:{http:["https://rpc.walletconnect.org/v1"]}},blockExplorers:{default:{name:"Solscan",url:"https://solscan.io"}},testnet:!0,chainNamespace:"solana",caipNetworkId:"solana:EtWTRABZaYq6iMfeYKouRu166VU2xqa1",deprecatedCaipNetworkId:"solana:8E9rvCKLFQia2Y35HXjjpWzj8weVo44K"});var fb=qt({id:"4uhcVJyU9pJkvQyS88uRDiswHXSCkY3z",name:"Solana Testnet",network:"solana-testnet",nativeCurrency:{name:"Solana",symbol:"SOL",decimals:9},rpcUrls:{default:{http:["https://rpc.walletconnect.org/v1"]}},blockExplorers:{default:{name:"Solscan",url:"https://solscan.io"}},testnet:!0,chainNamespace:"solana",caipNetworkId:"solana:4uhcVJyU9pJkvQyS88uRDiswHXSCkY3z"});var Ib=qt({id:"000000000019d6689c085ae165831e93",caipNetworkId:"bip122:000000000019d6689c085ae165831e93",chainNamespace:"bip122",name:"Bitcoin",nativeCurrency:{name:"Bitcoin",symbol:"BTC",decimals:8},rpcUrls:{default:{http:["https://rpc.walletconnect.org/v1"]}}}),Cb=qt({id:"000000000933ea01ad0ee984209779ba",caipNetworkId:"bip122:000000000933ea01ad0ee984209779ba",chainNamespace:"bip122",name:"Bitcoin Testnet",nativeCurrency:{name:"Bitcoin",symbol:"BTC",decimals:8},rpcUrls:{default:{http:["https://rpc.walletconnect.org/v1"]}},testnet:!0});var Jw={solana:["solana_signMessage","solana_signTransaction","solana_requestAccounts","solana_getAccounts","solana_signAllTransactions","solana_signAndSendTransaction"],eip155:["eth_accounts","eth_requestAccounts","eth_sendRawTransaction","eth_sign","eth_signTransaction","eth_signTypedData","eth_signTypedData_v3","eth_signTypedData_v4","eth_sendTransaction","personal_sign","wallet_switchEthereumChain","wallet_addEthereumChain","wallet_getPermissions","wallet_requestPermissions","wallet_registerOnboarding","wallet_watchAsset","wallet_scanQRCode","wallet_getCallsStatus","wallet_showCallsStatus","wallet_sendCalls","wallet_getCapabilities","wallet_grantPermissions","wallet_revokePermissions","wallet_getAssets"],bip122:["sendTransfer","signMessage","signPsbt","getAccountAddresses"]},Qs={getMethodsByChainNamespace(s){return Jw[s]||[]},createDefaultNamespace(s){return{methods:this.getMethodsByChainNamespace(s),events:["accountsChanged","chainChanged"],chains:[],rpcMap:{}}},applyNamespaceOverrides(s,e){if(!e)return{...s};let t={...s},i=new Set;if(e.methods&&Object.keys(e.methods).forEach(r=>i.add(r)),e.chains&&Object.keys(e.chains).forEach(r=>i.add(r)),e.events&&Object.keys(e.events).forEach(r=>i.add(r)),e.rpcMap&&Object.keys(e.rpcMap).forEach(r=>{let[n]=r.split(":");n&&i.add(n)}),i.forEach(r=>{t[r]||(t[r]=this.createDefaultNamespace(r))}),e.methods&&Object.entries(e.methods).forEach(([r,n])=>{t[r]&&(t[r].methods=n)}),e.chains&&Object.entries(e.chains).forEach(([r,n])=>{t[r]&&(t[r].chains=n)}),e.events&&Object.entries(e.events).forEach(([r,n])=>{t[r]&&(t[r].events=n)}),e.rpcMap){let r=new Set;Object.entries(e.rpcMap).forEach(([n,o])=>{let[a,c]=n.split(":");!a||!c||!t[a]||(t[a].rpcMap||(t[a].rpcMap={}),r.has(a)||(t[a].rpcMap={},r.add(a)),t[a].rpcMap[c]=o)})}return t},createNamespaces(s,e){let t=s.reduce((i,r)=>{let{id:n,chainNamespace:o,rpcUrls:a}=r,c=a.default.http[0];i[o]||(i[o]=this.createDefaultNamespace(o));let l=`${o}:${n}`,h=i[o];switch(h.chains.push(l),l){case ta.caipNetworkId:h.chains.push(ta.deprecatedCaipNetworkId);break;case sa.caipNetworkId:h.chains.push(sa.deprecatedCaipNetworkId);break;default:}return h?.rpcMap&&c&&(h.rpcMap[n]=c),i},{});return this.applyNamespaceOverrides(t,e)},resolveReownName:async s=>{let e=await Fi.resolveName(s);return(Object.values(e?.addresses)||[])[0]?.address||!1},getChainsFromNamespaces(s={}){return Object.values(s).flatMap(e=>{let t=e.chains||[],i=e.accounts.map(r=>{let[n,o]=r.split(":");return`${n}:${o}`});return Array.from(new Set([...t,...i]))})},isSessionEventData(s){return typeof s=="object"&&s!==null&&"id"in s&&"topic"in s&&"params"in s&&typeof s.params=="object"&&s.params!==null&&"chainId"in s.params&&"event"in s.params&&typeof s.params.event=="object"&&s.params.event!==null},isOriginAllowed(s,e,t){for(let i of[...e,...t])if(i.includes("*")){let n=`^${i.replace(/[.*+?^${}()|[\]\\]/gu,"\\$&").replace(/\\\*/gu,".*")}$`;if(new RegExp(n,"u").test(s))return!0}else try{if(new URL(i).origin===s)return!0}catch{if(i===s)return!0}return!1}};var ei=class{constructor({provider:e,namespace:t}){this.id=ee.CONNECTOR_ID.WALLET_CONNECT,this.name=ni.ConnectorNamesMap[ee.CONNECTOR_ID.WALLET_CONNECT],this.type="WALLET_CONNECT",this.imageId=ni.ConnectorImageIds[ee.CONNECTOR_ID.WALLET_CONNECT],this.getCaipNetworks=C.getCaipNetworks.bind(C),this.caipNetworks=this.getCaipNetworks(),this.provider=e,this.chain=t}get chains(){return this.getCaipNetworks()}async connectWalletConnect(){if(!await this.authenticate()){let t=this.getCaipNetworks(),i=L.state.universalProviderConfigOverride,r=Qs.createNamespaces(t,i);await this.provider.connect({optionalNamespaces:r})}return{clientId:await this.provider.client.core.crypto.getClientId(),session:this.provider.session}}async disconnect(){await this.provider.disconnect()}async authenticate(){let e=this.chains.map(t=>t.caipNetworkId);return Li.universalProviderAuthenticate({universalProvider:this.provider,chains:e,methods:Xw})}},Xw=["eth_accounts","eth_requestAccounts","eth_sendRawTransaction","eth_sign","eth_signTransaction","eth_signTypedData","eth_signTypedData_v3","eth_signTypedData_v4","eth_sendTransaction","personal_sign","wallet_switchEthereumChain","wallet_addEthereumChain","wallet_getPermissions","wallet_requestPermissions","wallet_registerOnboarding","wallet_watchAsset","wallet_scanQRCode","wallet_getCallsStatus","wallet_sendCalls","wallet_getCapabilities","wallet_grantPermissions","wallet_revokePermissions","wallet_getAssets"];var Nr=class{constructor(e){this.availableConnectors=[],this.eventListeners=new Map,this.getCaipNetworks=t=>C.getCaipNetworks(t),e&&this.construct(e)}construct(e){this.projectId=e.projectId,this.namespace=e.namespace,this.adapterType=e.adapterType}get connectors(){return this.availableConnectors}get networks(){return this.getCaipNetworks(this.namespace)}setAuthProvider(e){this.addConnector({id:ee.CONNECTOR_ID.AUTH,type:"AUTH",name:ee.CONNECTOR_NAMES.AUTH,provider:e,imageId:ni.ConnectorImageIds[ee.CONNECTOR_ID.AUTH],chain:this.namespace,chains:[]})}addConnector(...e){let t=new Set;this.availableConnectors=[...e,...this.availableConnectors].filter(i=>t.has(i.id)?!1:(t.add(i.id),!0)),this.emit("connectors",this.availableConnectors)}setStatus(e,t){H.setStatus(e,t)}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e)?.add(t)}off(e,t){let i=this.eventListeners.get(e);i&&i.delete(t)}removeAllEventListeners(){this.eventListeners.forEach(e=>{e.clear()})}emit(e,t){let i=this.eventListeners.get(e);i&&i.forEach(r=>r(t))}async connectWalletConnect(e){return{clientId:(await this.getWalletConnectConnector().connectWalletConnect()).clientId}}async switchNetwork(e){let{caipNetwork:t,providerType:i}=e;if(!e.provider)return;let r="provider"in e.provider?e.provider.provider:e.provider;if(i==="WALLET_CONNECT"){r.setDefaultChain(t.caipNetworkId);return}if(r&&i==="AUTH"){let n=r,o=H.state.preferredAccountTypes?.[t.chainNamespace];await n.switchNetwork(t.caipNetworkId);let a=await n.getUser({chainId:t.caipNetworkId,preferredAccountType:o});this.emit("switchNetwork",a)}}getWalletConnectConnector(){let e=this.connectors.find(t=>t instanceof ei);if(!e)throw new Error("WalletConnectConnector not found");return e}};var Sr=class extends Nr{setUniversalProvider(e){this.addConnector(new ei({provider:e,caipNetworks:this.getCaipNetworks(),namespace:this.namespace}))}async connect(e){return Promise.resolve({id:"WALLET_CONNECT",type:"WALLET_CONNECT",chainId:Number(e.chainId),provider:this.provider,address:""})}async disconnect(){try{await this.getWalletConnectConnector().disconnect()}catch(e){console.warn("UniversalAdapter:disconnect - error",e)}}async getAccounts({namespace:e}){let i=this.provider?.session?.namespaces?.[e]?.accounts?.map(r=>{let[,,n]=r.split(":");return n}).filter((r,n,o)=>o.indexOf(r)===n)||[];return Promise.resolve({accounts:i.map(r=>Me.createAccount(e,r,e==="bip122"?"payment":"eoa"))})}async syncConnectors(){return Promise.resolve()}async getBalance(e){if(!(e.caipNetwork&&Ce.BALANCE_SUPPORTED_CHAINS.includes(e.caipNetwork?.chainNamespace))||e.caipNetwork?.testnet)return{balance:"0.00",symbol:e.caipNetwork?.nativeCurrency.symbol||""};if(H.state.balanceLoading&&e.chainId===C.state.activeCaipNetwork?.id)return{balance:H.state.balance||"0.00",symbol:H.state.balanceSymbol||""};let r=(await H.fetchTokenBalance()).find(n=>n.chainId===`${e.caipNetwork?.chainNamespace}:${e.chainId}`&&n.symbol===e.caipNetwork?.nativeCurrency.symbol);return{balance:r?.quantity.numeric||"0.00",symbol:r?.symbol||e.caipNetwork?.nativeCurrency.symbol||""}}async signMessage(e){let{provider:t,message:i,address:r}=e;if(!t)throw new Error("UniversalAdapter:signMessage - provider is undefined");let n="";return C.state.activeCaipNetwork?.chainNamespace===ee.CHAIN.SOLANA?n=(await t.request({method:"solana_signMessage",params:{message:Xi.encode(new TextEncoder().encode(i)),pubkey:r}},C.state.activeCaipNetwork?.caipNetworkId)).signature:n=await t.request({method:"personal_sign",params:[i,r]},C.state.activeCaipNetwork?.caipNetworkId),{signature:n}}async estimateGas(){return Promise.resolve({gas:BigInt(0)})}async sendTransaction(){return Promise.resolve({hash:""})}walletGetAssets(e){return Promise.resolve({})}async writeContract(){return Promise.resolve({hash:""})}parseUnits(){return 0n}formatUnits(){return"0"}async getCapabilities(){return Promise.resolve({})}async grantPermissions(){return Promise.resolve({})}async revokePermissions(){return Promise.resolve("0x")}async syncConnection(){return Promise.resolve({id:"WALLET_CONNECT",type:"WALLET_CONNECT",chainId:1,provider:this.provider,address:""})}async switchNetwork(e){let{caipNetwork:t}=e,i=this.getWalletConnectConnector();if(t.chainNamespace===ee.CHAIN.EVM)try{await i.provider?.request({method:"wallet_switchEthereumChain",params:[{chainId:xr(t.id)}]})}catch(r){if(r.code===ds.ERROR_CODE_UNRECOGNIZED_CHAIN_ID||r.code===ds.ERROR_INVALID_CHAIN_ID||r.code===ds.ERROR_CODE_DEFAULT||r?.data?.originalError?.code===ds.ERROR_CODE_UNRECOGNIZED_CHAIN_ID)try{await i.provider?.request({method:"wallet_addEthereumChain",params:[{chainId:xr(t.id),rpcUrls:[t?.rpcUrls.chainDefault?.http],chainName:t.name,nativeCurrency:t.nativeCurrency,blockExplorerUrls:[t.blockExplorers?.default.url]}]})}catch{throw new Error("Chain is not supported")}}i.provider.setDefaultChain(t.caipNetworkId)}getWalletConnectProvider(){return this.connectors.find(i=>i.type==="WALLET_CONNECT")?.provider}};var Zw=["email","socials","swaps","onramp","activity","reownBranding"],Tr={email:{apiFeatureName:"social_login",localFeatureName:"email",returnType:!1,isLegacy:!1,isAvailableOnBasic:!1,processApi:s=>{if(!s?.config)return!1;let e=s.config;return!!s.isEnabled&&e.includes("email")},processFallback:s=>s===void 0?Ce.DEFAULT_REMOTE_FEATURES.email:!!s},socials:{apiFeatureName:"social_login",localFeatureName:"socials",returnType:!1,isLegacy:!1,isAvailableOnBasic:!1,processApi:s=>{if(!s?.config)return!1;let e=s.config;return s.isEnabled&&e.length>0?e.filter(t=>t!=="email"):!1},processFallback:s=>s===void 0?Ce.DEFAULT_REMOTE_FEATURES.socials:typeof s=="boolean"?s?Ce.DEFAULT_REMOTE_FEATURES.socials:!1:s},swaps:{apiFeatureName:"swap",localFeatureName:"swaps",returnType:!1,isLegacy:!1,isAvailableOnBasic:!1,processApi:s=>{if(!s?.config)return!1;let e=s.config;return s.isEnabled&&e.length>0?e:!1},processFallback:s=>s===void 0?Ce.DEFAULT_REMOTE_FEATURES.swaps:typeof s=="boolean"?s?Ce.DEFAULT_REMOTE_FEATURES.swaps:!1:s},onramp:{apiFeatureName:"onramp",localFeatureName:"onramp",returnType:!1,isLegacy:!1,isAvailableOnBasic:!1,processApi:s=>{if(!s?.config)return!1;let e=s.config;return s.isEnabled&&e.length>0?e:!1},processFallback:s=>s===void 0?Ce.DEFAULT_REMOTE_FEATURES.onramp:typeof s=="boolean"?s?Ce.DEFAULT_REMOTE_FEATURES.onramp:!1:s},activity:{apiFeatureName:"activity",localFeatureName:"history",returnType:!1,isLegacy:!0,isAvailableOnBasic:!1,processApi:s=>!!s.isEnabled,processFallback:s=>s===void 0?Ce.DEFAULT_REMOTE_FEATURES.activity:!!s},reownBranding:{apiFeatureName:"reown_branding",localFeatureName:"reownBranding",returnType:!1,isLegacy:!1,isAvailableOnBasic:!1,processApi:s=>!!s.isEnabled,processFallback:s=>s===void 0?Ce.DEFAULT_REMOTE_FEATURES.reownBranding:!!s}},Vh={localSettingsOverridden:new Set,getApiConfig(s,e){return e?.find(t=>t.id===s)},addWarning(s,e){if(s!==void 0){let t=Tr[e],i=t.isLegacy?`"features.${t.localFeatureName}" (now "${e}")`:`"features.${e}"`;this.localSettingsOverridden.add(i)}},processFeature(s,e,t,i,r){let n=Tr[s],o=e[n.localFeatureName];if(r&&!n.isAvailableOnBasic)return!1;if(i){let a=this.getApiConfig(n.apiFeatureName,t);return a?.config===null?this.processFallbackFeature(s,o):a?.config?(o!==void 0&&this.addWarning(o,s),this.processApiFeature(s,a)):!1}return this.processFallbackFeature(s,o)},processApiFeature(s,e){return Tr[s].processApi(e)},processFallbackFeature(s,e){return Tr[s].processFallback(e)},async fetchRemoteFeatures(s){let e=s.basic??!1,t=s.features||{};this.localSettingsOverridden.clear();let i=null,r=!1;try{i=await Di.fetchProjectConfig(),r=i!=null}catch(o){console.warn("[Reown Config] Failed to fetch remote project configuration. Using local/default values.",o)}let n=r&&!e?Ce.DEFAULT_REMOTE_FEATURES:Ce.DEFAULT_REMOTE_FEATURES_DISABLED;try{for(let o of Zw){let a=this.processFeature(o,t,i,r,e);Object.assign(n,{[o]:a})}}catch(o){return console.warn("[Reown Config] Failed to process the configuration from Cloud. Using default values.",o),Ce.DEFAULT_REMOTE_FEATURES}if(r&&this.localSettingsOverridden.size>0){let o=`Your local configuration for ${Array.from(this.localSettingsOverridden).join(", ")} was ignored because a remote configuration was successfully fetched. Please manage these features via your project dashboard on dashboard.reown.com.`;$t.open({shortMessage:"Local configuration ignored",longMessage:`[Reown Config Notice] ${o}`},"warning")}return n}};var Or=class{constructor(e){this.chainNamespaces=[],this.remoteFeatures={},this.reportedAlertErrors={},this.getCaipNetwork=(t,i)=>{if(t){let r=C.getNetworkData(t)?.requestedCaipNetworks?.find(a=>a.id===i);if(r)return r;let n=C.getNetworkData(t)?.caipNetwork;return n||C.getRequestedCaipNetworks(t).filter(a=>a.chainNamespace===t)?.[0]}return C.state.activeCaipNetwork||this.defaultCaipNetwork},this.getCaipNetworkId=()=>{let t=this.getCaipNetwork();if(t)return t.id},this.getCaipNetworks=t=>C.getCaipNetworks(t),this.getActiveChainNamespace=()=>C.state.activeChain,this.setRequestedCaipNetworks=(t,i)=>{C.setRequestedCaipNetworks(t,i)},this.getApprovedCaipNetworkIds=()=>C.getAllApprovedCaipNetworkIds(),this.getCaipAddress=t=>C.state.activeChain===t||!t?C.state.activeCaipAddress:C.getAccountProp("caipAddress",t),this.setClientId=t=>{jr.setClientId(t)},this.getProvider=t=>ae.getProvider(t),this.getProviderType=t=>ae.getProviderId(t),this.getPreferredAccountType=t=>H.state.preferredAccountTypes?.[t],this.setCaipAddress=(t,i)=>{H.setCaipAddress(t,i),t&&L.state.enableEmbedded&&this.close()},this.setBalance=(t,i,r)=>{H.setBalance(t,i,r)},this.setProfileName=(t,i)=>{H.setProfileName(t,i)},this.setProfileImage=(t,i)=>{H.setProfileImage(t,i)},this.setUser=(t,i)=>{H.setUser(t,i)},this.resetAccount=t=>{H.resetAccount(t)},this.setCaipNetwork=t=>{C.setActiveCaipNetwork(t)},this.setCaipNetworkOfNamespace=(t,i)=>{C.setChainNetworkData(i,{caipNetwork:t})},this.setAllAccounts=(t,i)=>{H.setAllAccounts(t,i),L.setHasMultipleAddresses(t?.length>1)},this.setStatus=(t,i)=>{H.setStatus(t,i),oe.isConnected()?Ue.setConnectionStatus("connected"):Ue.setConnectionStatus("disconnected")},this.getAddressByChainNamespace=t=>C.getAccountProp("address",t),this.setConnectors=t=>{let i=[...oe.state.allConnectors,...t];oe.setConnectors(i)},this.setConnections=(t,i)=>{Ve.setConnections(t,i)},this.fetchIdentity=t=>jr.fetchIdentity(t),this.getReownName=t=>Fi.getNamesForAddress(t),this.getConnectors=()=>oe.getConnectors(),this.getConnectorImage=t=>ga.getConnectorImage(t),this.setConnectedWalletInfo=(t,i)=>{let r=ae.getProviderId(i),n=t?{...t,type:r}:void 0;H.setConnectedWalletInfo(n,i)},this.getIsConnectedState=()=>!!C.state.activeCaipAddress,this.addAddressLabel=(t,i,r)=>{H.addAddressLabel(t,i,r)},this.removeAddressLabel=(t,i)=>{H.removeAddressLabel(t,i)},this.getAddress=t=>C.state.activeChain===t||!t?H.state.address:C.getAccountProp("address",t),this.setApprovedCaipNetworksData=t=>C.setApprovedCaipNetworksData(t),this.resetNetwork=t=>{C.resetNetwork(t)},this.addConnector=t=>{oe.addConnector(t)},this.resetWcConnection=()=>{Ve.resetWcConnection()},this.setAddressExplorerUrl=(t,i)=>{H.setAddressExplorerUrl(t,i)},this.setSmartAccountDeployed=(t,i)=>{H.setSmartAccountDeployed(t,i)},this.setSmartAccountEnabledNetworks=(t,i)=>{C.setSmartAccountEnabledNetworks(t,i)},this.setPreferredAccountType=(t,i)=>{H.setPreferredAccountType(t,i)},this.setEIP6963Enabled=t=>{L.setEIP6963Enabled(t)},this.handleUnsafeRPCRequest=()=>{if(this.isOpen()){if(this.isTransactionStackEmpty())return;this.redirect("ApproveTransaction")}else this.open({view:"ApproveTransaction"})},this.options=e,this.version=e.sdkVersion,this.caipNetworks=this.extendCaipNetworks(e),this.chainNamespaces=this.getChainNamespacesSet(e.adapters,this.caipNetworks),this.defaultCaipNetwork=this.extendDefaultCaipNetwork(e),this.chainAdapters=this.createAdapters(e.adapters),this.readyPromise=this.initialize(e)}getChainNamespacesSet(e,t){let i=e?.map(n=>n.namespace).filter(n=>!!n);if(i?.length)return[...new Set(i)];let r=t?.map(n=>n.chainNamespace);return[...new Set(r)]}async initialize(e){this.initializeProjectSettings(e),this.initControllers(e),await this.initChainAdapters(),this.sendInitializeEvent(e),await this.syncExistingConnection(),this.remoteFeatures=await Vh.fetchRemoteFeatures(e),L.setRemoteFeatures(this.remoteFeatures),this.remoteFeatures.onramp&&ma.setOnrampProviders(this.remoteFeatures.onramp),(L.state.remoteFeatures?.email||Array.isArray(L.state.remoteFeatures?.socials)&&L.state.remoteFeatures?.socials.length>0)&&await this.checkAllowedOrigins()}async checkAllowedOrigins(){let e=await Di.fetchAllowedOrigins();if(e&&Me.isClient()){let t=window.location.origin;Qs.isOriginAllowed(t,e,ds.DEFAULT_ALLOWED_ANCESTORS)||$t.open(ss.ALERT_ERRORS.INVALID_APP_CONFIGURATION,"error")}else $t.open(ss.ALERT_ERRORS.PROJECT_ID_NOT_CONFIGURED,"error")}sendInitializeEvent(e){let{...t}=e;delete t.adapters,delete t.universalProvider,ms.sendEvent({type:"track",event:"INITIALIZE",properties:{...t,networks:e.networks.map(i=>i.id),siweConfig:{options:e.siweConfig?.options||{}}}})}initControllers(e){this.initializeOptionsController(e),this.initializeChainController(e),this.initializeThemeController(e),this.initializeConnectionController(e),this.initializeConnectorController()}initializeThemeController(e){e.themeMode&&gt.setThemeMode(e.themeMode),e.themeVariables&&gt.setThemeVariables(e.themeVariables)}initializeChainController(e){if(!this.connectionControllerClient||!this.networkControllerClient)throw new Error("ConnectionControllerClient and NetworkControllerClient must be set");C.initialize(e.adapters??[],this.caipNetworks,{connectionControllerClient:this.connectionControllerClient,networkControllerClient:this.networkControllerClient});let t=this.getDefaultNetwork();t&&C.setActiveCaipNetwork(t)}initializeConnectionController(e){Ve.setWcBasic(e.basic??!1)}initializeConnectorController(){oe.initialize(this.chainNamespaces)}initializeProjectSettings(e){L.setProjectId(e.projectId),L.setSdkVersion(e.sdkVersion)}initializeOptionsController(e){L.setDebug(e.debug!==!1),L.setEnableWalletConnect(e.enableWalletConnect!==!1),L.setEnableWalletGuide(e.enableWalletGuide!==!1),L.setEnableWallets(e.enableWallets!==!1),L.setEIP6963Enabled(e.enableEIP6963!==!1),L.setEnableNetworkSwitch(e.enableNetworkSwitch!==!1),L.setEnableAuthLogger(e.enableAuthLogger!==!1),L.setCustomRpcUrls(e.customRpcUrls),L.setEnableEmbedded(e.enableEmbedded),L.setAllWallets(e.allWallets),L.setIncludeWalletIds(e.includeWalletIds),L.setExcludeWalletIds(e.excludeWalletIds),L.setFeaturedWalletIds(e.featuredWalletIds),L.setTokens(e.tokens),L.setTermsConditionsUrl(e.termsConditionsUrl),L.setPrivacyPolicyUrl(e.privacyPolicyUrl),L.setCustomWallets(e.customWallets),L.setFeatures(e.features),L.setAllowUnsupportedChain(e.allowUnsupportedChain),L.setUniversalProviderConfigOverride(e.universalProviderConfigOverride),L.setPreferUniversalLinks(e.experimental_preferUniversalLinks),L.setDefaultAccountTypes(e.defaultAccountTypes);let t=Ue.getPreferredAccountTypes()||{},i={...L.state.defaultAccountTypes,...t};H.setPreferredAccountTypes(i);let r=this.getDefaultMetaData();if(!e.metadata&&r&&(e.metadata=r),L.setMetadata(e.metadata),L.setDisableAppend(e.disableAppend),L.setEnableEmbedded(e.enableEmbedded),L.setSIWX(e.siwx),!e.projectId){$t.open(ss.ALERT_ERRORS.PROJECT_ID_NOT_CONFIGURED,"error");return}if(e.adapters?.find(o=>o.namespace===ee.CHAIN.EVM)&&e.siweConfig){if(e.siwx)throw new Error("Cannot set both `siweConfig` and `siwx` options");L.setSIWX(e.siweConfig.mapToSIWX())}}getDefaultMetaData(){return Me.isClient()?{name:document.getElementsByTagName("title")?.[0]?.textContent||"",description:document.querySelector('meta[property="og:description"]')?.content||"",url:window.location.origin,icons:[document.querySelector('link[rel~="icon"]')?.href||""]}:null}setUnsupportedNetwork(e){let t=this.getActiveChainNamespace();if(t){let i=ws.getUnsupportedNetwork(`${t}:${e}`);C.setActiveCaipNetwork(i)}}getDefaultNetwork(){return ws.getCaipNetworkFromStorage(this.defaultCaipNetwork)}extendCaipNetwork(e,t){return ws.extendCaipNetwork(e,{customNetworkImageUrls:t.chainImages,projectId:t.projectId})}extendCaipNetworks(e){return ws.extendCaipNetworks(e.networks,{customNetworkImageUrls:e.chainImages,customRpcUrls:e.customRpcUrls,projectId:e.projectId})}extendDefaultCaipNetwork(e){let t=e.networks.find(r=>r.id===e.defaultNetwork?.id);return t?ws.extendCaipNetwork(t,{customNetworkImageUrls:e.chainImages,customRpcUrls:e.customRpcUrls,projectId:e.projectId}):void 0}async disconnectNamespace(e){try{let t=this.getAdapter(e),i=ae.getProvider(e),r=ae.getProviderId(e),{caipAddress:n}=C.getAccountData(e)||{};this.setLoading(!0,e),n&&t?.disconnect&&await t.disconnect({provider:i,providerType:r}),Ue.removeConnectedNamespace(e),ae.resetChain(e),this.setUser(void 0,e),this.setStatus("disconnected",e),this.setConnectedWalletInfo(void 0,e),oe.removeConnectorId(e),C.resetAccount(e),C.resetNetwork(e),this.setLoading(!1,e)}catch(t){throw this.setLoading(!1,e),new Error(`Failed to disconnect chain ${e}: ${t.message}`)}}createClients(){this.connectionControllerClient={connectWalletConnect:async()=>{let e=C.state.activeChain,t=this.getAdapter(e),i=this.getCaipNetwork(e)?.id;if(!t)throw new Error("Adapter not found");let r=await t.connectWalletConnect(i);this.close(),this.setClientId(r?.clientId||null),Ue.setConnectedNamespaces([...C.state.chains.keys()]),this.chainNamespaces.forEach(n=>{oe.setConnectorId(Bt.CONNECTOR_TYPE_WALLET_CONNECT,n)}),await this.syncWalletConnectAccount()},connectExternal:async({id:e,info:t,type:i,provider:r,chain:n,caipNetwork:o,socialUri:a})=>{let c=C.state.activeChain,l=n||c,h=this.getAdapter(l);if(n&&n!==c&&!o){let m=this.getCaipNetworks().find(u=>u.chainNamespace===n);m&&this.setCaipNetwork(m)}if(!h)throw new Error("Adapter not found");let p=this.getCaipNetwork(l),d=await h.connect({id:e,info:t,type:i,provider:r,socialUri:a,chainId:o?.id||p?.id,rpcUrl:o?.rpcUrls?.default?.http?.[0]||p?.rpcUrls?.default?.http?.[0]});if(!d)return;Ue.addConnectedNamespace(l),this.syncProvider({...d,chainNamespace:l});let g=H.state.allAccounts,{accounts:f}=g?.length>0?{accounts:[...g]}:await h.getAccounts({namespace:l,id:e});this.setAllAccounts(f,l),this.setStatus("connected",l),this.syncConnectedWalletInfo(l)},reconnectExternal:async({id:e,info:t,type:i,provider:r})=>{let n=C.state.activeChain,o=this.getAdapter(n);o?.reconnect&&(await o?.reconnect({id:e,info:t,type:i,provider:r,chainId:this.getCaipNetwork()?.id}),Ue.addConnectedNamespace(n),this.syncConnectedWalletInfo(n))},disconnect:async e=>{let t=ea(e);try{let i=await Promise.allSettled(t.map(async([n])=>this.disconnectNamespace(n)));fa.resetSend(),Ve.resetWcConnection(),await Li.clearSessions(),oe.setFilterByNamespace(void 0);let r=i.filter(n=>n.status==="rejected");if(r.length>0)throw new Error(r.map(n=>n.reason.message).join(", "));Ue.deleteConnectedSocialProvider(),ms.sendEvent({type:"track",event:"DISCONNECT_SUCCESS",properties:{namespace:e||"all"}})}catch(i){throw new Error(`Failed to disconnect chains: ${i.message}`)}},checkInstalled:e=>e?e.some(t=>!!window.ethereum?.[String(t)]):!!window.ethereum,signMessage:async e=>(await this.getAdapter(C.state.activeChain)?.signMessage({message:e,address:H.state.address,provider:ae.getProvider(C.state.activeChain)}))?.signature||"",sendTransaction:async e=>{let t=e.chainNamespace;if(Ce.SEND_SUPPORTED_NAMESPACES.includes(t)){let i=this.getAdapter(C.state.activeChain),r=ae.getProvider(t);return(await i?.sendTransaction({...e,caipNetwork:this.getCaipNetwork(),provider:r}))?.hash||""}return""},estimateGas:async e=>{if(e.chainNamespace===ee.CHAIN.EVM){let t=this.getAdapter(C.state.activeChain),i=ae.getProvider(C.state.activeChain),r=this.getCaipNetwork();if(!r)throw new Error("CaipNetwork is undefined");return(await t?.estimateGas({...e,provider:i,caipNetwork:r}))?.gas||0n}return 0n},getEnsAvatar:async()=>(await this.syncIdentity({address:H.state.address,chainId:Number(this.getCaipNetwork()?.id),chainNamespace:C.state.activeChain}),H.state.profileImage||!1),getEnsAddress:async e=>await Qs.resolveReownName(e),writeContract:async e=>{let t=this.getAdapter(C.state.activeChain),i=this.getCaipNetwork(),r=this.getCaipAddress(),n=ae.getProvider(C.state.activeChain);if(!i||!r)throw new Error("CaipNetwork or CaipAddress is undefined");return(await t?.writeContract({...e,caipNetwork:i,provider:n,caipAddress:r}))?.hash},parseUnits:(e,t)=>this.getAdapter(C.state.activeChain)?.parseUnits({value:e,decimals:t})??0n,formatUnits:(e,t)=>this.getAdapter(C.state.activeChain)?.formatUnits({value:e,decimals:t})??"0",getCapabilities:async e=>await this.getAdapter(C.state.activeChain)?.getCapabilities(e),grantPermissions:async e=>await this.getAdapter(C.state.activeChain)?.grantPermissions(e),revokePermissions:async e=>{let t=this.getAdapter(C.state.activeChain);return t?.revokePermissions?await t.revokePermissions(e):"0x"},walletGetAssets:async e=>await this.getAdapter(C.state.activeChain)?.walletGetAssets(e)??{},updateBalance:e=>{let t=this.getCaipNetwork(e);!t||!H.state.address||this.updateNativeBalance(H.state.address,t?.id,e)}},this.networkControllerClient={switchCaipNetwork:async e=>await this.switchCaipNetwork(e),getApprovedCaipNetworksData:async()=>this.getApprovedCaipNetworksData()},Ve.setClient(this.connectionControllerClient)}getApprovedCaipNetworksData(){if(ae.getProviderId(C.state.activeChain)===Bt.CONNECTOR_TYPE_WALLET_CONNECT){let t=this.universalProvider?.session?.namespaces;return{supportsAllNetworks:this.universalProvider?.session?.peer?.metadata.name==="MetaMask Wallet",approvedCaipNetworkIds:this.getChainsFromNamespaces(t)}}return{supportsAllNetworks:!0,approvedCaipNetworkIds:[]}}async switchCaipNetwork(e){if(!e)return;let t=e.chainNamespace;if(this.getAddressByChainNamespace(e.chainNamespace)){let r=ae.getProvider(t),n=ae.getProviderId(t);if(e.chainNamespace===C.state.activeChain)await this.getAdapter(t)?.switchNetwork({caipNetwork:e,provider:r,providerType:n});else if(this.setCaipNetwork(e),n===Bt.CONNECTOR_TYPE_WALLET_CONNECT)this.syncWalletConnectAccount();else{let o=this.getAddressByChainNamespace(t);o&&this.syncAccount({address:o,chainId:e.id,chainNamespace:t})}}else this.setCaipNetwork(e)}getChainsFromNamespaces(e={}){return Object.values(e).flatMap(t=>{let i=t.chains||[],r=t.accounts.map(n=>{let{chainId:o,chainNamespace:a}=Nt.parseCaipAddress(n);return`${a}:${o}`});return Array.from(new Set([...i,...r]))})}createAdapters(e){return this.createClients(),this.chainNamespaces.reduce((t,i)=>{let r=e?.find(n=>n.namespace===i);return r?(r.construct({namespace:i,projectId:this.options?.projectId,networks:this.getCaipNetworks()}),t[i]=r):t[i]=new Sr({namespace:i,networks:this.getCaipNetworks()}),t},{})}async initChainAdapter(e){this.onConnectors(e),this.listenAdapter(e),await this.chainAdapters?.[e].syncConnectors(this.options,this),await this.createUniversalProviderForAdapter(e)}async initChainAdapters(){await Promise.all(this.chainNamespaces.map(async e=>{await this.initChainAdapter(e)}))}onConnectors(e){this.getAdapter(e)?.on("connectors",this.setConnectors.bind(this))}listenAdapter(e){let t=this.getAdapter(e);if(!t)return;let i=Ue.getConnectionStatus();i==="connected"?this.setStatus("connecting",e):i==="disconnected"?(Ue.clearAddressCache(),this.setStatus(i,e)):this.setStatus(i,e),t.on("switchNetwork",({address:r,chainId:n})=>{let o=this.getCaipNetworks().find(l=>l.id===n||l.caipNetworkId===n),a=C.state.activeChain===e,c=C.getAccountProp("address",e);if(o){let l=a&&r?r:c;l&&this.syncAccount({address:l,chainId:o.id,chainNamespace:e})}else this.setUnsupportedNetwork(n)}),t.on("disconnect",this.disconnect.bind(this,e)),t.on("connections",r=>{this.setConnections(r,e)}),t.on("pendingTransactions",()=>{let r=H.state.address,n=C.state.activeCaipNetwork;!r||!n?.id||this.updateNativeBalance(r,n.id,n.chainNamespace)}),t.on("accountChanged",({address:r,chainId:n})=>{let o=C.state.activeChain===e;o&&n?this.syncAccount({address:r,chainId:n,chainNamespace:e}):o&&C.state.activeCaipNetwork?.id?this.syncAccount({address:r,chainId:C.state.activeCaipNetwork?.id,chainNamespace:e}):this.syncAccountInfo(r,n,e),this.syncAllAccounts(e)})}async createUniversalProviderForAdapter(e){await this.getUniversalProvider(),this.universalProvider&&this.chainAdapters?.[e]?.setUniversalProvider?.(this.universalProvider)}async syncExistingConnection(){await Promise.allSettled(this.chainNamespaces.map(e=>this.syncNamespaceConnection(e)))}async syncNamespaceConnection(e){try{e===ee.CHAIN.EVM&&Me.isSafeApp()&&oe.setConnectorId(ee.CONNECTOR_ID.SAFE,e);let t=oe.getConnectorId(e);switch(this.setStatus("connecting",e),t){case ee.CONNECTOR_ID.WALLET_CONNECT:await this.syncWalletConnectAccount();break;case ee.CONNECTOR_ID.AUTH:break;default:await this.syncAdapterConnection(e)}}catch(t){console.warn("AppKit couldn't sync existing connection",t),this.setStatus("disconnected",e)}}async syncAdapterConnection(e){let t=this.getAdapter(e),i=oe.getConnectorId(e),r=this.getCaipNetwork(e),o=oe.getConnectors(e).find(a=>a.id===i);try{if(!t||!o)throw new Error(`Adapter or connector not found for namespace ${e}`);if(!r?.id)throw new Error("CaipNetwork not found");let a=await t?.syncConnection({namespace:e,id:o.id,chainId:r.id,rpcUrl:r?.rpcUrls?.default?.http?.[0]});if(a){let c=await t?.getAccounts({namespace:e,id:o.id});c&&c.accounts.length>0?this.setAllAccounts(c.accounts,e):this.setAllAccounts([Me.createAccount(e,a.address,"eoa")],e),this.syncProvider({...a,chainNamespace:e}),await this.syncAccount({...a,chainNamespace:e}),this.setStatus("connected",e)}else this.setStatus("disconnected",e)}catch{this.setStatus("disconnected",e)}}async syncWalletConnectAccount(){let e=this.chainNamespaces.map(async t=>{let i=this.getAdapter(t),r=this.universalProvider?.session?.namespaces?.[t]?.accounts||[],n=C.state.activeCaipNetwork?.id,o=r.find(a=>{let{chainId:c}=Nt.parseCaipAddress(a);return c===n?.toString()})||r[0];if(o){let a=Nt.validateCaipAddress(o),{chainId:c,address:l}=Nt.parseCaipAddress(a);if(ae.setProviderId(t,Bt.CONNECTOR_TYPE_WALLET_CONNECT),this.caipNetworks&&C.state.activeCaipNetwork&&i?.namespace!==ee.CHAIN.EVM){let h=i?.getWalletConnectProvider({caipNetworks:this.getCaipNetworks(),provider:this.universalProvider,activeCaipNetwork:C.state.activeCaipNetwork});ae.setProvider(t,h)}else ae.setProvider(t,this.universalProvider);oe.setConnectorId(ee.CONNECTOR_ID.WALLET_CONNECT,t),Ue.addConnectedNamespace(t),this.syncWalletConnectAccounts(t),await this.syncAccount({address:l,chainId:c,chainNamespace:t})}else this.setStatus("disconnected",t);this.syncConnectedWalletInfo(t),await C.setApprovedCaipNetworksData(t)});await Promise.all(e)}syncWalletConnectAccounts(e){let t=this.universalProvider?.session?.namespaces?.[e]?.accounts?.map(i=>{let{address:r}=Nt.parseCaipAddress(i);return r}).filter((i,r,n)=>n.indexOf(i)===r);t&&this.setAllAccounts(t.map(i=>Me.createAccount(e,i,e==="bip122"?"payment":"eoa")),e)}syncProvider({type:e,provider:t,id:i,chainNamespace:r}){ae.setProviderId(r,e),ae.setProvider(r,t),oe.setConnectorId(i,r)}async syncAllAccounts(e){let t=oe.getConnectorId(e);if(!t)return;let r=await this.getAdapter(e)?.getAccounts({namespace:e,id:t});r&&r.accounts.length>0&&this.setAllAccounts(r.accounts,e)}async syncAccount(e){let t=e.chainNamespace===C.state.activeChain,i=C.getCaipNetworkByNamespace(e.chainNamespace,e.chainId),{address:r,chainId:n,chainNamespace:o}=e,{chainId:a}=Ue.getActiveNetworkProps(),c=n||a,l=C.state.activeCaipNetwork?.name===ee.UNSUPPORTED_NETWORK_NAME,h=C.getNetworkProp("supportsAllNetworks",o);if(this.setStatus("connected",o),!(l&&!h)&&c){let p=this.getCaipNetworks().find(f=>f.id.toString()===c.toString()),d=this.getCaipNetworks().find(f=>f.chainNamespace===o);if(!h&&!p&&!d){let f=this.getApprovedCaipNetworkIds()||[],m=f.find(w=>Nt.parseCaipNetworkId(w)?.chainId===c.toString()),u=f.find(w=>Nt.parseCaipNetworkId(w)?.chainNamespace===o);p=this.getCaipNetworks().find(w=>w.caipNetworkId===m),d=this.getCaipNetworks().find(w=>w.caipNetworkId===u||"deprecatedCaipNetworkId"in w&&w.deprecatedCaipNetworkId===u)}let g=p||d;g?.chainNamespace===C.state.activeChain?L.state.enableNetworkSwitch&&!L.state.allowUnsupportedChain&&C.state.activeCaipNetwork?.name===ee.UNSUPPORTED_NETWORK_NAME?C.showUnsupportedChainUI():this.setCaipNetwork(g):t||i&&this.setCaipNetworkOfNamespace(i,o),this.syncConnectedWalletInfo(o),ba.isLowerCaseMatch(r,H.state.address)||this.syncAccountInfo(r,g?.id,o),t?await this.syncBalance({address:r,chainId:g?.id,chainNamespace:o}):await this.syncBalance({address:r,chainId:i?.id,chainNamespace:o})}}async syncAccountInfo(e,t,i){let r=this.getCaipAddress(i),n=t||r?.split(":")[1];if(!n)return;let o=`${i}:${n}:${e}`;this.setCaipAddress(o,i),await this.syncIdentity({address:e,chainId:n,chainNamespace:i})}async syncReownName(e,t){try{let i=await this.getReownName(e);if(i[0]){let r=i[0];this.setProfileName(r.name,t)}else this.setProfileName(null,t)}catch{this.setProfileName(null,t)}}syncConnectedWalletInfo(e){let t=oe.getConnectorId(e),i=ae.getProviderId(e);if(i===Bt.CONNECTOR_TYPE_ANNOUNCED||i===Bt.CONNECTOR_TYPE_INJECTED){if(t){let r=this.getConnectors().find(n=>n.id===t);if(r){let{info:n,name:o,imageUrl:a}=r,c=a||this.getConnectorImage(r);this.setConnectedWalletInfo({name:o,icon:c,...n},e)}}}else if(i===Bt.CONNECTOR_TYPE_WALLET_CONNECT){let r=ae.getProvider(e);r?.session&&this.setConnectedWalletInfo({...r.session.peer.metadata,name:r.session.peer.metadata.name,icon:r.session.peer.metadata.icons?.[0]},e)}else if(t&&t===ee.CONNECTOR_ID.COINBASE){let r=this.getConnectors().find(n=>n.id===ee.CONNECTOR_ID.COINBASE);this.setConnectedWalletInfo({name:"Coinbase Wallet",icon:this.getConnectorImage(r)},e)}}async syncBalance(e){!ua.getNetworksByNamespace(this.getCaipNetworks(),e.chainNamespace).find(i=>i.id.toString()===e.chainId?.toString())||!e.chainId||await this.updateNativeBalance(e.address,e.chainId,e.chainNamespace)}async ready(){await this.readyPromise}async updateNativeBalance(e,t,i){let r=this.getAdapter(i),n=C.getCaipNetworkByNamespace(i,t);if(r){let o=await r.getBalance({address:e,chainId:t,caipNetwork:n,tokens:this.options.tokens});return this.setBalance(o.balance,o.symbol,i),o}}async initializeUniversalAdapter(){let e=Ea.createLogger((i,...r)=>{i&&this.handleAlertError(i),console.error(...r)}),t={projectId:this.options?.projectId,metadata:{name:this.options?.metadata?this.options?.metadata.name:"",description:this.options?.metadata?this.options?.metadata.description:"",url:this.options?.metadata?this.options?.metadata.url:"",icons:this.options?.metadata?this.options?.metadata.icons:[""]},logger:e};L.setManualWCControl(!!this.options?.manualWCControl),this.universalProvider=this.options.universalProvider??await Ar.init(t),this.listenWalletConnect()}listenWalletConnect(){this.universalProvider&&(this.universalProvider.on("display_uri",e=>{Ve.setUri(e)}),this.universalProvider.on("connect",Ve.finalizeWcConnection),this.universalProvider.on("disconnect",()=>{this.chainNamespaces.forEach(e=>{this.resetAccount(e)}),Ve.resetWcConnection()}),this.universalProvider.on("chainChanged",e=>{let t=this.getCaipNetworks().find(r=>r.id==e),i=this.getCaipNetwork();if(!t){this.setUnsupportedNetwork(e);return}i?.id!==t?.id&&this.setCaipNetwork(t)}),this.universalProvider.on("session_event",e=>{if(Qs.isSessionEventData(e)){let{name:t,data:i}=e.params.event;t==="accountsChanged"&&Array.isArray(i)&&Me.isCaipAddress(i[0])&&this.syncAccount(Nt.parseCaipAddress(i[0]))}}))}createUniversalProvider(){return!this.universalProviderInitPromise&&Me.isClient()&&this.options?.projectId&&(this.universalProviderInitPromise=this.initializeUniversalAdapter()),this.universalProviderInitPromise}async getUniversalProvider(){if(!this.universalProvider)try{await this.createUniversalProvider()}catch(e){ms.sendEvent({type:"error",event:"INTERNAL_SDK_ERROR",properties:{errorType:"UniversalProviderInitError",errorMessage:e instanceof Error?e.message:"Unknown",uncaught:!1}}),console.error("AppKit:getUniversalProvider - Cannot create provider",e)}return this.universalProvider}handleAlertError(e){let t=Object.entries(ss.UniversalProviderErrors).find(([,{message:a}])=>e.message.includes(a)),[i,r]=t??[],{message:n,alertErrorKey:o}=r??{};if(i&&n&&!this.reportedAlertErrors[i]){let a=ss.ALERT_ERRORS[o];a&&($t.open(a,"error"),this.reportedAlertErrors[i]=!0)}}getAdapter(e){if(e)return this.chainAdapters?.[e]}createAdapter(e){if(!e)return;let t=e.namespace;if(!t)return;this.createClients();let i=e;i.namespace=t,i.construct({namespace:t,projectId:this.options?.projectId,networks:this.getCaipNetworks()}),this.chainNamespaces.includes(t)||this.chainNamespaces.push(t),this.chainAdapters&&(this.chainAdapters[t]=i)}async open(e){if(await this.injectModalUi(),e?.uri&&Ve.setUri(e.uri),e?.arguments)switch(e?.view){case"Swap":return ys.open({...e,data:{swap:e.arguments}});default:}return ys.open(e)}async close(){await this.injectModalUi(),ys.close()}setLoading(e,t){ys.setLoading(e,t)}async disconnect(e){await Ve.disconnect(e)}getSIWX(){return L.state.siwx}getError(){return""}getChainId(){return C.state.activeCaipNetwork?.id}async switchNetwork(e){let t=this.getCaipNetworks().find(i=>i.id===e.id);if(!t){$t.open(ss.ALERT_ERRORS.SWITCH_NETWORK_NOT_FOUND,"error");return}await C.switchActiveNetwork(t)}getWalletProvider(){return C.state.activeChain?ae.state.providers[C.state.activeChain]:null}getWalletProviderType(){return ae.getProviderId(C.state.activeChain)}subscribeProviders(e){return ae.subscribeProviders(e)}getThemeMode(){return gt.state.themeMode}getThemeVariables(){return gt.state.themeVariables}setThemeMode(e){gt.setThemeMode(e),Ca(gt.state.themeMode)}setTermsConditionsUrl(e){L.setTermsConditionsUrl(e)}setPrivacyPolicyUrl(e){L.setPrivacyPolicyUrl(e)}setThemeVariables(e){gt.setThemeVariables(e),_a(gt.state.themeVariables)}subscribeTheme(e){return gt.subscribe(e)}getWalletInfo(){return H.state.connectedWalletInfo}getAccount(e){let t=oe.getAuthConnector(e),i=C.getAccountData(e),r=C.state.activeChain,n=Ue.getConnectedConnectorId(e||r);if(i)return{allAccounts:i.allAccounts,caipAddress:i.caipAddress,address:Me.getPlainAddress(i.caipAddress),isConnected:!!i.caipAddress,status:i.status,embeddedWalletInfo:t&&n===ee.CONNECTOR_ID.AUTH?{user:i.user?{...i.user,username:Ue.getConnectedSocialUsername()}:void 0,authProvider:i.socialProvider||"email",accountType:i.preferredAccountTypes?.[e||r],isSmartAccountDeployed:!!i.smartAccountDeployed}:void 0}}subscribeAccount(e,t){let i=()=>{let r=this.getAccount(t);r&&e(r)};t?C.subscribeChainProp("accountState",i,t):C.subscribe(i),oe.subscribe(i)}subscribeNetwork(e){return C.subscribe(({activeCaipNetwork:t})=>{e({caipNetwork:t,chainId:t?.id,caipNetworkId:t?.caipNetworkId})})}subscribeWalletInfo(e){return H.subscribeKey("connectedWalletInfo",e)}subscribeShouldUpdateToAddress(e){H.subscribeKey("shouldUpdateToAddress",e)}subscribeCaipNetworkChange(e){C.subscribeKey("activeCaipNetwork",e)}getState(){return qr.state}subscribeState(e){return qr.subscribe(e)}showErrorMessage(e){Lr.showError(e)}showSuccessMessage(e){Lr.showSuccess(e)}getEvent(){return{...ms.state}}subscribeEvents(e){return ms.subscribe(e)}replace(e){ri.replace(e)}redirect(e){ri.push(e)}popTransactionStack(e){ri.popTransactionStack(e)}isOpen(){return ys.state.open}isTransactionStackEmpty(){return ri.state.transactionStack.length===0}static getInstance(){return this.instance}updateFeatures(e){L.setFeatures(e)}updateRemoteFeatures(e){L.setRemoteFeatures(e)}updateOptions(e){let i={...L.state||{},...e};L.setOptions(i)}setConnectMethodsOrder(e){L.setConnectMethodsOrder(e)}setWalletFeaturesOrder(e){L.setWalletFeaturesOrder(e)}setCollapseWallets(e){L.setCollapseWallets(e)}setSocialsOrder(e){L.setSocialsOrder(e)}getConnectMethodsOrder(){return Ia.getConnectOrderMethod(L.state.features,oe.getConnectors())}addNetwork(e,t){if(this.chainAdapters&&!this.chainAdapters[e])throw new Error(`Adapter for namespace ${e} doesn't exist`);let i=this.extendCaipNetwork(t,this.options);this.getCaipNetworks().find(r=>r.id===i.id)||C.addNetwork(i)}removeNetwork(e,t){if(this.chainAdapters&&!this.chainAdapters[e])throw new Error(`Adapter for namespace ${e} doesn't exist`);this.getCaipNetworks().find(r=>r.id===t)&&C.removeNetwork(e,t)}};var Hh=!1,Rr=class extends Or{async open(e){oe.isConnected()||await super.open(e)}async close(){await super.close(),this.options.manualWCControl&&Ve.finalizeWcConnection()}async syncIdentity(e){return Promise.resolve()}async syncBalance(e){return Promise.resolve()}async injectModalUi(){if(!Hh&&Me.isClient()){if(await import("./pretix-eth-5-basic-ZNMD6HIS.js"),await import("./pretix-eth-5-w3m-modal-66HZIBPM.js"),!document.querySelector("w3m-modal")){let t=document.createElement("w3m-modal");!L.state.disableAppend&&!L.state.enableEmbedded&&document.body.insertAdjacentElement("beforeend",t)}Hh=!0}}};var zh="1.7.8";function PE(s){return new Rr({...s,basic:!0,sdkVersion:`html-core-${zh}`})}export{Rr as AppKit,PE as createAppKit};
/*! Bundled license information:

@walletconnect/utils/dist/index.es.js:
  (*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) *)
*/
